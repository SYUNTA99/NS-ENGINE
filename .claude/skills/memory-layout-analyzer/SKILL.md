---
description: "Chunk ãƒ¡ãƒ¢ãƒªãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå¯è¦–åŒ–"
context: fork
---

# Memory Layout Analyzer

ECSã®Chunkãƒ¡ãƒ¢ãƒªãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’ASCIIå›³ã§å¯è¦–åŒ–ã—ã€æœ€é©åŒ–ææ¡ˆã‚’è¡Œã„ã¾ã™ã€‚

## ä½¿ç”¨æ–¹æ³•

`/memory-layout-analyzer [component_names...]`

- å¼•æ•°ãªã—: ä¸»è¦ãªArchetypeã‚’åˆ†æ
- ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆåæŒ‡å®š: ç‰¹å®šã®çµ„ã¿åˆã‚ã›ã‚’åˆ†æ

ä¾‹:
- `/memory-layout-analyzer` â†’ å…¨Archetypeæ¦‚è¦
- `/memory-layout-analyzer LocalTransform VelocityData` â†’ ç‰¹å®šã®çµ„ã¿åˆã‚ã›
- `/memory-layout-analyzer TransformData` â†’ å˜ä¸€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

## åˆ†æå¯¾è±¡

### 1. ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚µã‚¤ã‚ºã¨ã‚¢ãƒ©ã‚¤ãƒ¡ãƒ³ãƒˆ

ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‹ã‚‰æŠ½å‡º:
- `sizeof(T)` ã¨ `alignof(T)`
- `alignas()` æŒ‡å®š
- ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°

### 2. Chunkãƒ¡ãƒ¢ãƒªãƒãƒƒãƒ—

16KB Chunkå†…ã®SoAï¼ˆStructure of Arraysï¼‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        16KB CHUNK                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ACTOR ARRAY (capacity Ã— 4 bytes)                                â”‚
â”‚ [Actor0][Actor1][Actor2]...[ActorN]                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ PADDING (64-byte alignment)                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ COMPONENT ARRAY: LocalTransform (capacity Ã— 48 bytes)          â”‚
â”‚ [LT0][LT1][LT2]...[LTN]                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ COMPONENT ARRAY: VelocityData (capacity Ã— 16 bytes)            â”‚
â”‚ [V0][V1][V2]...[VN]                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ UNUSED SPACE                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ©ã‚¤ãƒ³å¢ƒç•Œ

64ãƒã‚¤ãƒˆå¢ƒç•Œã‚’è¡¨ç¤º:

```
Offset    Content              Cache Line
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
0x0000    Actor[0-15]          â”œâ”€ CL 0
0x0040    Actor[16-31]         â”œâ”€ CL 1
0x0080    Padding              â”œâ”€ CL 2
0x00C0    LocalTransform[0]    â”œâ”€ CL 3  â† ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆé–‹å§‹
0x0100    LocalTransform[1]    â”œâ”€ CL 4
...
```

## å®Ÿè¡Œæ‰‹é †

### 1. ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆæƒ…å ±ã‚’åé›†

`source/engine/ecs/components/` ã‹ã‚‰ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå®šç¾©ã‚’èª­ã¿å–ã‚Š:

```cpp
struct alignas(16) VelocityData : public IComponentData {
    Vector3 value;   // 12 bytes
    float _pad0;     // 4 bytes
};  // Total: 16 bytes, align: 16
```

### 2. Archetypeãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’è¨ˆç®—

```
1 Actor ã‚ãŸã‚Š:
  - Actor: 4 bytes
  - LocalTransform: 48 bytes (alignas(16))
  - VelocityData: 16 bytes (alignas(16))
  = 68 bytes/entity

Chunkå®¹é‡: floor(16384 / 68) = 240 entities
```

### 3. ASCIIå›³ã‚’ç”Ÿæˆ

è©³ç´°ãªãƒ¡ãƒ¢ãƒªãƒãƒƒãƒ—ã‚’å‡ºåŠ›ã€‚

## ãƒ¬ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ

```
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“Š CHUNK MEMORY LAYOUT ANALYSIS
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ—ï¸ Archetype: LocalTransform + VelocityData

ğŸ“ COMPONENT SIZES
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Component          â”‚ Size   â”‚ Align â”‚ Padding  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Actor              â”‚ 4B     â”‚ 4     â”‚ 0B       â”‚
â”‚ LocalTransform     â”‚ 48B    â”‚ 16    â”‚ 0B       â”‚
â”‚ VelocityData       â”‚ 16B    â”‚ 16    â”‚ 0B       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Total per entity: 68 bytes

ğŸ“¦ CHUNK LAYOUT (16KB = 16,384 bytes)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Capacity: 240 entities

Offset      Size        Content
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
0x0000      960B        Actor[0..239]
0x03C0      64B         Padding (64B align)
0x0400      11520B      LocalTransform[0..239]
0x3100      3840B       VelocityData[0..239]
0x4000      ---         End of Chunk

Used: 16,384B / 16,384B (100.0%)

ğŸ“Š CACHE LINE ANALYSIS (64B lines)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Actor array:
  â””â”€ 15 cache lines (960B), 16 Actors/line

LocalTransform array:
  â””â”€ 180 cache lines (11,520B), 1.33 transforms/line
  âš ï¸ Cross-boundary access: 33% of entities

VelocityData array:
  â””â”€ 60 cache lines (3,840B), 4 velocities/line
  âœ“ Aligned access: 100%

ğŸ’¡ OPTIMIZATION SUGGESTIONS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

1. LocalTransform (48B) ã¯64Bã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ©ã‚¤ãƒ³ã«åã¾ã‚‰ãªã„
   â†’ 2/3ã®ã‚¢ã‚¯ã‚»ã‚¹ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ©ã‚¤ãƒ³ã‚’ã¾ãŸã
   â†’ Position(16B) + Rotation(16B) + Scale(16B) ã«åˆ†å‰²æ¤œè¨

2. VelocityData ã¯4è¦ç´ /ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ©ã‚¤ãƒ³ã§åŠ¹ç‡çš„ âœ“

3. æ¨å¥¨: é«˜é »åº¦ã‚¢ã‚¯ã‚»ã‚¹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¯ã‚µã‚¤ã‚ºã‚’
   16B, 32B, 64B ã®ã„ãšã‚Œã‹ã«æƒãˆã‚‹

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

## ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚µã‚¤ã‚ºä¸€è¦§

ä¸»è¦ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼ˆå‚è€ƒï¼‰:

| Component | Size | Align | Fields |
|-----------|------|-------|--------|
| Actor | 4B | 4 | index(20bit) + gen(12bit) |
| LocalTransform | 48B | 16 | position(16) + rotation(16) + scale(16) |
| VelocityData | 16B | 16 | value(12) + pad(4) |
| SpriteData | 64B | 16 | texture + uv + color + flags |
| MeshData | 32B | 8 | mesh + material handles |

## æœ€é©åŒ–ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³

### ã‚­ãƒ£ãƒƒã‚·ãƒ¥åŠ¹ç‡

| ã‚µã‚¤ã‚º | è¦ç´ /CL | åŠ¹ç‡ |
|--------|---------|------|
| 16B | 4 | â˜…â˜…â˜…â˜…â˜… |
| 32B | 2 | â˜…â˜…â˜…â˜…â˜† |
| 48B | 1.33 | â˜…â˜…â˜…â˜†â˜† |
| 64B | 1 | â˜…â˜…â˜…â˜…â˜† |

### Chunkå……å¡«ç‡ç›®æ¨™

- **95%ä»¥ä¸Š**: å„ªç§€
- **80-95%**: è‰¯å¥½
- **80%æœªæº€**: æ”¹å–„æ¨å¥¨ï¼ˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆåˆ†å‰²ã‚’æ¤œè¨ï¼‰

## æ³¨æ„äº‹é …

- **SoAãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ**: å„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå‹ã¯é€£ç¶šé…ç½®
- **Actoré…åˆ—å…ˆé ­**: Chunkå…ˆé ­ã«Actor IDãŒä¸¦ã¶
- **ã‚¢ãƒ©ã‚¤ãƒ¡ãƒ³ãƒˆãƒ‘ãƒ‡ã‚£ãƒ³ã‚°**: 64Bå¢ƒç•Œã«ã‚¢ãƒ©ã‚¤ãƒ³
