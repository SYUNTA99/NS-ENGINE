---
name: plan-doc-checker
description: |
  計画とドキュメントの整合性チェッカー。参照ドキュメント（設計書、要件定義書、SDK/APIリファレンス等）に基づいて作成された計画の齟齬・完全性・矛盾を検証する。

  使用タイミング:
  - ExitPlanMode前に計画品質を自動チェック
  - 「計画をチェックして」「ドキュメントと照合して」「整合性を確認して」で明示的に起動
  - 「この計画で大丈夫？」「漏れがないか確認」などの確認依頼時
---

# Plan-Doc Checker

計画と参照ドキュメントの整合性を検証し、スコアとカテゴリ別分析を出力する。

## チェック対象

1. **齟齬 (Discrepancy)**: ドキュメントの記述と計画の内容が矛盾していないか
2. **完全性 (Completeness)**: ドキュメントの要件・仕様が計画で網羅されているか
3. **矛盾 (Contradiction)**: 計画内部で自己矛盾がないか

## 実行手順

### 1. 入力の特定

計画ファイルと参照ドキュメントを特定する:

```
計画ファイル:
- .claude/plans/current/task_plan.md
- ユーザーが指定した計画ファイル
- 直前のPlan Modeで作成した計画

参照ドキュメント:
- 計画作成時に参照したドキュメント（設計書、仕様書、SDK docs等）
- ユーザーが明示的に指定したドキュメント
```

### 2. ドキュメント分析

参照ドキュメントから以下を抽出:

- **必須要件**: MUST、必須、required等で示される要件
- **制約条件**: 技術的制約、禁止事項、注意事項
- **API/インターフェース仕様**: 関数シグネチャ、型定義、戻り値
- **依存関係**: 前提条件、実行順序の制約

### 3. 計画との照合

| チェック項目 | 検証内容 |
|-------------|---------|
| 齟齬 | API名、型、引数がドキュメントと一致するか |
| 齟齬 | 処理フローがドキュメントの記述と整合するか |
| 完全性 | 必須要件が全て計画に含まれているか |
| 完全性 | エラーハンドリング要件が網羅されているか |
| 矛盾 | 計画内のステップ間で前提条件が矛盾しないか |
| 矛盾 | 同一機能の複数記述が一貫しているか |

### 4. 出力フォーマット

```markdown
## 整合性チェック結果

### スコア: XX/100

| カテゴリ | スコア | 問題数 |
|---------|-------|-------|
| 齟齬    | XX/100 | N件   |
| 完全性  | XX/100 | N件   |
| 矛盾    | XX/100 | N件   |

### 詳細分析

#### 齟齬 (Discrepancy)
- [CRITICAL/WARNING/INFO] 問題の説明
  - ドキュメント: 該当箇所の引用
  - 計画: 該当箇所の引用
  - 推奨修正: 修正案

#### 完全性 (Completeness)
- [CRITICAL/WARNING/INFO] 欠落している要件
  - ドキュメント: 要件の引用
  - 推奨: 追加すべき計画ステップ

#### 矛盾 (Contradiction)
- [CRITICAL/WARNING/INFO] 矛盾の説明
  - 計画ステップA: 該当箇所
  - 計画ステップB: 矛盾する箇所
  - 推奨解決: 解決案

### 総評
スコアに基づく総合評価と、実装に進む前に修正すべき優先事項。
```

## スコア計算

```
基礎点: 100点
減点:
- CRITICAL: -20点/件
- WARNING: -5点/件
- INFO: -1点/件

最低点: 0点
```

## 重大度判定

| 重大度 | 条件 |
|-------|------|
| CRITICAL | 実装が失敗する、または仕様違反になる問題 |
| WARNING | 実装は可能だが品質・保守性に影響する問題 |
| INFO | 改善推奨だが影響は軽微 |

## 自動トリガー

ExitPlanMode前に以下を確認:
1. 参照ドキュメントが存在するか
2. 存在する場合、整合性チェックを実行
3. スコア70未満の場合、警告を表示し修正を推奨
