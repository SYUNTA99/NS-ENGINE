# 2層計画システム ワークフロー

## 概要

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          大規模機能の実装フロー                              │
└─────────────────────────────────────────────────────────────────────────────┘

Phase 0: 調査 (/planning-with-files 調査モード)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  ユーザー: 「RHI実装したい」
       │
       ▼
  ┌──────────────────────────────────────────────────────────────────────────┐
  │ 1. current/ を調査用に初期化                                             │
  │                                                                          │
  │    .claude/plans/current/                                                │
  │    ├── task_plan.md    ← Mode: investigation                             │
  │    ├── findings.md     ← 調査結果を蓄積                                  │
  │    └── progress.md     ← 調査ログ                                        │
  └──────────────────────────────────────────────────────────────────────────┘
       │
       ▼
  ┌──────────────────────────────────────────────────────────────────────────┐
  │ 2. コードベース調査                                                      │
  │                                                                          │
  │    - 関連モジュール/ファイルを探索                                       │
  │    - 既存パターンを発見                                                  │
  │    - 依存関係を特定                                                      │
  │    - 必要なAPI/機能を洗い出し                                            │
  │                                                                          │
  │    findings.md に記録:                                                   │
  │    - 関連ファイル一覧                                                    │
  │    - 既存パターンの説明                                                  │
  │    - 依存関係                                                            │
  │    - 必要な機能リスト                                                    │
  └──────────────────────────────────────────────────────────────────────────┘
       │
       ▼
  ┌──────────────────────────────────────────────────────────────────────────┐
  │ 3. 調査結果の報告                                                        │
  │                                                                          │
  │    ユーザーに提示:                                                       │
  │    - 調査で判明した事項                                                  │
  │    - 必要な機能のリスト                                                  │
  │    - 推奨するサブ計画分割案                                              │
  │    - リスク・懸念点                                                      │
  └──────────────────────────────────────────────────────────────────────────┘
       │
       ▼
  ユーザー確認・承認
       │
       ▼

Phase 1: 計画作成 (/plan-large-scale)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  ┌──────────────────────────────────────────────────────────────────────────┐
  │ 1. 調査結果を精査し、機能を分析                                          │
  │    - 全体の目的を明確化                                                  │
  │    - 必要なサブシステムを洗い出し                                        │
  │    - 依存関係・実行順序を決定                                            │
  └──────────────────────────────────────────────────────────────────────────┘
       │
       ▼
  ┌──────────────────────────────────────────────────────────────────────────┐
  │ 2. サブ計画に分割                                                        │
  │    - 各サブ計画は TODO 5項目以内                                         │
  │    - 1セッションで完了できるサイズ                                       │
  │    - 実行順に番号を付ける（01-, 02-, ...）                               │
  └──────────────────────────────────────────────────────────────────────────┘
       │
       ▼
  ┌──────────────────────────────────────────────────────────────────────────┐
  │ 3. 計画ファイル作成                                                      │
  │                                                                          │
  │    .claude/plans/rhi/                                                    │
  │    ├── 00-investigation.md   ← 調査結果のアーカイブ                      │
  │    ├── README.md             ← 概要 + サブ計画リンク                     │
  │    ├── 01-gpu-device.md      ← サブ計画1 (TODO 5項目以内)                │
  │    ├── 02-texture-resource.md ← サブ計画2                                │
  │    └── 03-command-buffer.md  ← サブ計画3                                 │
  └──────────────────────────────────────────────────────────────────────────┘
       │
       ▼
  ユーザー承認待ち
       │
       ▼

Phase 2〜N: サブ計画の実装 (ループ)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  ┌──────────────────────────────────────────────────────────────────────────┐
  │ A. 実装開始 (/planning-with-files 実装モード)                            │
  │                                                                          │
  │    1. current/ ディレクトリを実装用に初期化                              │
  │                                                                          │
  │       .claude/plans/current/                                             │
  │       ├── task_plan.md    ← Mode: implementation                         │
  │       ├── findings.md     ← 調査結果・発見                               │
  │       └── progress.md     ← セッションログ                               │
  │                                                                          │
  │    2. task_plan.md 冒頭に親計画へのリンクを記録:                         │
  │       「実装中: rhi/01-gpu-device.md」                                   │
  │                                                                          │
  │    3. サブ計画の TODO を task_plan.md にコピー                           │
  └──────────────────────────────────────────────────────────────────────────┘
       │
       ▼
  ┌──────────────────────────────────────────────────────────────────────────┐
  │ B. 実装作業                                                              │
  │                                                                          │
  │    while (TODO が残っている):                                            │
  │        1. task_plan.md を読む（ゴールを確認）                            │
  │        2. 次の TODO に取り組む                                           │
  │        3. 発見事項があれば findings.md に記録                            │
  │        4. 完了した TODO にチェックを付ける                               │
  │        5. progress.md に進捗を記録                                       │
  │                                                                          │
  │    エラー発生時:                                                         │
  │        → task_plan.md の「Errors Encountered」に記録                     │
  │        → 3回失敗したらユーザーに相談                                     │
  └──────────────────────────────────────────────────────────────────────────┘
       │
       ▼
  ┌──────────────────────────────────────────────────────────────────────────┐
  │ C. サブ計画完了                                                          │
  │                                                                          │
  │    1. 検証（ビルド/テスト）                                              │
  │                                                                          │
  │    2. 知見の転記                                                         │
  │       current/findings.md の重要な発見                                   │
  │           ↓                                                              │
  │       rhi/01-gpu-device.md の「知見」セクション                          │
  │                                                                          │
  │    3. README.md 更新                                                     │
  │       | # | 計画 | 状態 |                                                │
  │       |---|------|------|                                                │
  │       | 1 | [GPUデバイス](01-gpu-device.md) | complete |                 │
  │       | 2 | [テクスチャ](02-texture-resource.md) | pending |             │
  └──────────────────────────────────────────────────────────────────────────┘
       │
       ▼
  ┌──────────────────────────────────────────────────────────────────────────┐
  │ D. 次のサブ計画へ                                                        │
  │                                                                          │
  │    - current/ の内容を上書き（アーカイブ不要、知見は転記済み）           │
  │    - task_plan.md に「実装中: rhi/02-texture-resource.md」を記録         │
  │    - Phase B へ戻る                                                      │
  └──────────────────────────────────────────────────────────────────────────┘
       │
       ▼
  全サブ計画完了?
       │
       ├─ No → Phase B へ戻る
       │
       └─ Yes ↓

Phase 完了: 機能全体の完了
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  ┌──────────────────────────────────────────────────────────────────────────┐
  │ 1. 全体検証                                                              │
  │    - 統合テスト                                                          │
  │    - パフォーマンス確認                                                  │
  │                                                                          │
  │ 2. current/ をクリーンアップ                                             │
  │    rm -rf .claude/plans/current/                                         │
  │                                                                          │
  │ 3. README.md に完了を明記                                                │
  │    # RHI                                                                 │
  │    状態: ✅ 完了 (2024-01-15)                                            │
  └──────────────────────────────────────────────────────────────────────────┘
```

## セッション再開時

```
┌──────────────────────────────────────────────────────────────────────────┐
│ 新セッション / /compact 後                                               │
└──────────────────────────────────────────────────────────────────────────┘
       │
       ▼
  .claude/plans/ を確認
       │
       ├─ current/ が存在する?
       │      │
       │      ├─ Yes → current/task_plan.md を読む
       │      │            │
       │      │            ├─ Mode: investigation
       │      │            │    → 調査を継続
       │      │            │
       │      │            └─ Mode: implementation
       │      │                 → 「実装中: rhi/01-xxx.md」を確認
       │      │                 → 中断した TODO から再開
       │      │
       │      └─ No → 計画フォルダの README.md を確認
       │                   │
       │                   ▼
       │               未完了のサブ計画から開始
       │
       └─ 計画フォルダがない → 新規タスク開始
```

## ファイル構造

```
.claude/plans/
│
├── current/                     # 作業レイヤー（揮発性）
│   ├── task_plan.md             # Mode: investigation | implementation
│   ├── findings.md              # 調査結果・発見
│   └── progress.md              # セッションログ
│
└── <feature>/                   # 計画レイヤー（永続）
    ├── 00-investigation.md      # 調査結果のアーカイブ
    ├── README.md                # 機能全体の概要・進捗
    ├── 01-<topic>.md            # サブ計画1 + 転記された知見
    ├── 02-<topic>.md            # サブ計画2 + 転記された知見
    └── ...
```

## current/ のルール

| ルール | 調査モード | 実装モード |
|--------|------------|------------|
| **固定配置** | current/ | current/ |
| **1作業のみ** | 1機能の調査 | 1サブ計画の実装 |
| **終了処理** | findings.md を計画側にコピー | findings.md を親計画に転記 |
| **上書きタイミング** | 計画作成開始時 | 次のサブ計画開始時 |

## スキルの使い分け

| スキル | 用途 | 配置場所 |
|--------|------|----------|
| `/plan-large-scale` | 大規模機能の分割・追跡 | `.claude/plans/<feature>/` |
| `/planning-with-files` | 作業記憶の永続化 | `.claude/plans/current/` |
