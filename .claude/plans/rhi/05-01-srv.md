# 05-01: シェーダーリソースビュー (SRV)

## 目的

シェーダーからの読み取り用ビュー（RV（インターフェースを定義する。

## 参照ドキュメント

- 03-02-buffer-interface.md (IRHIBuffer)
- 04-02-texture-interface.md (IRHITexture)
- 01-04-types-descriptor.md (RHICPUDescriptorHandle)

## 変更対象ファイル

新規作成:
- `Source/Engine/RHI/Public/IRHIViews.h` (部分

## TODO

### 1. SRV記述構造体

```cpp
#pragma once

#include "IRHIResource.h"
#include "RHIEnums.h"
#include "RHITypes.h"
#include "RHIPixelFormat.h"

namespace NS::RHI
{
    /// バッファSRV記述
    struct RHI_API RHIBufferSRVDesc
    {
        /// バッファ
        IRHIBuffer* buffer = nullptr;

        /// SRVフォーマット
        ERHIBufferSRVFormat srvFormat = ERHIBufferSRVFormat::Structured;

        /// 型付きバッファ用フォーマット
        EPixelFormat format = EPixelFormat::Unknown;

        /// 開始要素インデックス
        uint32 firstElement = 0;

        /// 要素数（ = 残り全て）。
        uint32 numElements = 0;

        /// 構造体バイトストライド（StructuredBufferの場合）
        /// 0 = バッファのストライドを使用
        uint32 structureByteStride = 0;

        /// ビルダー
        static RHIBufferSRVDesc Structured(IRHIBuffer* buf, uint32 first = 0, uint32 count = 0) {
            RHIBufferSRVDesc desc;
            desc.buffer = buf;
            desc.srvFormat = ERHIBufferSRVFormat::Structured;
            desc.firstElement = first;
            desc.numElements = count;
            return desc;
        }

        static RHIBufferSRVDesc Raw(IRHIBuffer* buf, uint32 firstByte = 0, uint32 numBytes = 0) {
            RHIBufferSRVDesc desc;
            desc.buffer = buf;
            desc.srvFormat = ERHIBufferSRVFormat::Raw;
            desc.firstElement = firstByte / 4;  // DWORD単位
            desc.numElements = (numBytes > 0) ? numBytes / 4 : 0;
            return desc;
        }

        static RHIBufferSRVDesc Typed(IRHIBuffer* buf, EPixelFormat fmt, uint32 first = 0, uint32 count = 0) {
            RHIBufferSRVDesc desc;
            desc.buffer = buf;
            desc.srvFormat = ERHIBufferSRVFormat::Typed;
            desc.format = fmt;
            desc.firstElement = first;
            desc.numElements = count;
            return desc;
        }
    };

    /// テクスチャSRV記述
    struct RHI_API RHITextureSRVDesc
    {
        /// テクスチャ
        IRHITexture* texture = nullptr;

        /// ビューフォーマット（Unknown = テクスチャのフォーマットを使用）。
        EPixelFormat format = EPixelFormat::Unknown;

        /// 次元（Unknown = テクスチャの次元を使用）。
        ERHITextureDimension dimension = ERHITextureDimension::Texture2D;

        /// MIPレベル範囲
        uint32 mostDetailedMip = 0;
        uint32 mipLevels = 0;  // 0 = 残り全て

        /// 配列範囲
        uint32 firstArraySlice = 0;
        uint32 arraySize = 0;  // 0 = 残り全て

        /// 平面スライス（デプス/ステンシル分離用）。
        uint32 planeSlice = 0;

        /// 最小LODクランプ
        float minLODClamp = 0.0f;

        /// コンポーネントマッチング
        RHIComponentMapping componentMapping = RHIComponentMapping::Identity();

        /// ビルダー
        static RHITextureSRVDesc Default(IRHITexture* tex) {
            RHITextureSRVDesc desc;
            desc.texture = tex;
            return desc;
        }

        static RHITextureSRVDesc MipRange(IRHITexture* tex, uint32 mostDetailed, uint32 count) {
            RHITextureSRVDesc desc;
            desc.texture = tex;
            desc.mostDetailedMip = mostDetailed;
            desc.mipLevels = count;
            return desc;
        }

        static RHITextureSRVDesc ArraySlice(IRHITexture* tex, uint32 slice) {
            RHITextureSRVDesc desc;
            desc.texture = tex;
            desc.firstArraySlice = slice;
            desc.arraySize = 1;
            return desc;
        }

        static RHITextureSRVDesc CubeFace(IRHITexture* tex, ERHICubeFace face) {
            RHITextureSRVDesc desc;
            desc.texture = tex;
            desc.dimension = ERHITextureDimension::Texture2D;
            desc.firstArraySlice = static_cast<uint32>(face);
            desc.arraySize = 1;
            return desc;
        }
    };
}
```

- [ ] RHIBufferSRVDesc 構造体
- [ ] RHITextureSRVDesc 構造体
- [ ] ビルダーメソッド

### 2. IRHIShaderResourceView インターフェース

```cpp
namespace NS::RHI
{
    /// シェーダーリソースビュー
    class RHI_API IRHIShaderResourceView : public IRHIResource
    {
    public:
        DECLARE_RHI_RESOURCE_TYPE(ShaderResourceView)

        virtual ~IRHIShaderResourceView() = default;

        //=====================================================================
        // 基本プロパティ
        //=====================================================================

        /// 所属デバイス取得
        virtual IRHIDevice* GetDevice() const = 0;

        /// CPUディスクリプタハンドル取得
        virtual RHICPUDescriptorHandle GetCPUHandle() const = 0;

        /// GPUディスクリプタハンドル取得（オンラインヒープの場合）
        virtual RHIGPUDescriptorHandle GetGPUHandle() const = 0;

        /// Bindlessインデックス取得
        virtual BindlessIndex GetBindlessIndex() const = 0;

        //=====================================================================
        // ソースリソース
        //=====================================================================

        /// ソースリソース取得
        virtual IRHIResource* GetResource() const = 0;

        /// バッファビューか
        virtual bool IsBufferView() const = 0;

        /// テクスチャビューか
        bool IsTextureView() const { return !IsBufferView(); }

        /// ソースバッファ取得（バッファビューの場合）
        IRHIBuffer* GetBuffer() const {
            return IsBufferView() ? static_cast<IRHIBuffer*>(GetResource()) : nullptr;
        }

        /// ソーステクスチャ取得（テクスチャビューの場合）
        IRHITexture* GetTexture() const {
            return IsTextureView() ? static_cast<IRHITexture*>(GetResource()) : nullptr;
        }
    };

    using RHIShaderResourceViewRef = TRefCountPtr<IRHIShaderResourceView>;
}
```

- [ ] IRHIShaderResourceView インターフェース
- [ ] GetCPUHandle / GetGPUHandle
- [ ] GetResource / GetBuffer / GetTexture

### 3. SRV作成インターフェース

```cpp
namespace NS::RHI
{
    /// SRV作成インターフェース（IRHIDeviceに追加）。
    class IRHIDevice
    {
    public:
        //=====================================================================
        // SRV作成
        //=====================================================================

        /// バッファSRV作成
        virtual IRHIShaderResourceView* CreateShaderResourceView(
            const RHIBufferSRVDesc& desc,
            const char* debugName = nullptr) = 0;

        /// テクスチャSRV作成
        virtual IRHIShaderResourceView* CreateShaderResourceView(
            const RHITextureSRVDesc& desc,
            const char* debugName = nullptr) = 0;

        /// テクスチャからデフォルトRV作成（便利関数）。
        IRHIShaderResourceView* CreateDefaultSRV(
            IRHITexture* texture,
            const char* debugName = nullptr)
        {
            return CreateShaderResourceView(RHITextureSRVDesc::Default(texture), debugName);
        }

        /// バッファからデフォルトRV作成（便利関数）。
        IRHIShaderResourceView* CreateDefaultSRV(
            IRHIBuffer* buffer,
            const char* debugName = nullptr)
        {
            return CreateShaderResourceView(RHIBufferSRVDesc::Structured(buffer), debugName);
        }
    };
}
```

- [ ] CreateShaderResourceView（バッファ版）
- [ ] CreateShaderResourceView（テクスチャ版）
- [ ] CreateDefaultSRV 便利関数

### 4. NullSRV

```cpp
namespace NS::RHI
{
    /// Null SRV
    /// シェーダーにnullをバインドする場合に使用
    class IRHIDevice
    {
    public:
        /// Null バッファSRV取得
        /// @param format 型付きバッファの場合のフォーマット
        virtual IRHIShaderResourceView* GetNullBufferSRV(
            ERHIBufferSRVFormat format = ERHIBufferSRVFormat::Structured) = 0;

        /// Null テクスチャSRV取得
        /// @param dimension テクスチャ次元
        virtual IRHIShaderResourceView* GetNullTextureSRV(
            ERHITextureDimension dimension = ERHITextureDimension::Texture2D) = 0;
    };
}
```

- [ ] GetNullBufferSRV
- [ ] GetNullTextureSRV

### 5. SRV配列ヘルパー

```cpp
namespace NS::RHI
{
    /// SRV配列ラッパー
    /// 連続したSRVスロットへのバインド用
    class RHI_API RHISRVArray
    {
    public:
        RHISRVArray() = default;

        /// 最大サイズ指定で作成
        explicit RHISRVArray(uint32 maxSize)
            : m_srvs(maxSize, nullptr)
        {}

        /// SRV設定
        void Set(uint32 index, IRHIShaderResourceView* srv) {
            if (index < m_srvs.size()) {
                m_srvs[index] = srv;
            }
        }

        /// SRV取得
        IRHIShaderResourceView* Get(uint32 index) const {
            return index < m_srvs.size() ? m_srvs[index] : nullptr;
        }

        /// サイズ取得
        uint32 GetSize() const { return static_cast<uint32>(m_srvs.size()); }

        /// 配列先頭取得
        IRHIShaderResourceView* const* GetData() const { return m_srvs.data(); }

        /// 有効なSRV数取得
        uint32 GetValidCount() const {
            uint32 count = 0;
            for (auto* srv : m_srvs) {
                if (srv) ++count;
            }
            return count;
        }

        /// クリア
        void Clear() {
            std::fill(m_srvs.begin(), m_srvs.end(), nullptr);
        }

    private:
        std::vector<IRHIShaderResourceView*> m_srvs;
    };
}
```

- [ ] RHISRVArray ヘルパークラス

## 検証方法

- [ ] バッファSRVの作成と参照整合性
- [ ] テクスチャSRVの作成と参照整合性
- [ ] NullSRVの正常動作
- [ ] Bindlessインデックスの有効性
