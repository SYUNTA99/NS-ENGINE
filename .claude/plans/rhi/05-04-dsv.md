# 05-04: デプスステンシルビュー (DSV)

## 目的

デプス・ステンシル出力用ビュー（DSVインターフェース）を定義する。

## 参照ドキュメント

- 05-03-rtv.md (RTV設計パターン)
- 04-02-texture-interface.md (IRHITexture)

## 変更対象ファイル

新規作成:
- `Source/Engine/RHI/Public/IRHIViews.h` (部分

## TODO

### 1. DSV記述構造体

```cpp
namespace NS::RHI
{
    /// DSVフラグ
    enum class ERHIDSVFlags : uint8
    {
        None = 0,

        /// デプス読み取り専用
        ReadOnlyDepth = 1 << 0,

        /// ステンシル読み取り専用
        ReadOnlyStencil = 1 << 1,

        /// 両方読み取り専用
        ReadOnly = ReadOnlyDepth | ReadOnlyStencil,
    };
    RHI_ENUM_CLASS_FLAGS(ERHIDSVFlags)

    /// デプスステンシルビュー記述
    struct RHI_API RHIDepthStencilViewDesc
    {
        /// テクスチャ
        IRHITexture* texture = nullptr;

        /// ビューフォーマット（Unknown = テクスチャのフォーマットを使用）。
        EPixelFormat format = EPixelFormat::Unknown;

        /// 次元
        ERHITextureDimension dimension = ERHITextureDimension::Texture2D;

        /// MIPレベル
        uint32 mipSlice = 0;

        /// 配列範囲
        uint32 firstArraySlice = 0;
        uint32 arraySize = 0;  // 0 = 残り全て

        /// DSVフラグ
        ERHIDSVFlags flags = ERHIDSVFlags::None;

        //=====================================================================
        // ビルダー
        //=====================================================================

        /// 2Dテクスチャ用
        static RHIDepthStencilViewDesc Texture2D(
            IRHITexture* tex,
            uint32 mip = 0,
            ERHIDSVFlags dsvFlags = ERHIDSVFlags::None)
        {
            RHIDepthStencilViewDesc desc;
            desc.texture = tex;
            desc.dimension = ERHITextureDimension::Texture2D;
            desc.mipSlice = mip;
            desc.flags = dsvFlags;
            return desc;
        }

        /// 読み取り専用2D
        static RHIDepthStencilViewDesc Texture2DReadOnly(
            IRHITexture* tex,
            uint32 mip = 0)
        {
            return Texture2D(tex, mip, ERHIDSVFlags::ReadOnly);
        }

        /// デプスのみ読み取り専用（ステンシル書き込み可）。
        static RHIDepthStencilViewDesc Texture2DReadOnlyDepth(
            IRHITexture* tex,
            uint32 mip = 0)
        {
            return Texture2D(tex, mip, ERHIDSVFlags::ReadOnlyDepth);
        }

        /// マルチサンプル用
        static RHIDepthStencilViewDesc Texture2DMS(
            IRHITexture* tex,
            ERHIDSVFlags dsvFlags = ERHIDSVFlags::None)
        {
            RHIDepthStencilViewDesc desc;
            desc.texture = tex;
            desc.dimension = ERHITextureDimension::Texture2DMS;
            desc.flags = dsvFlags;
            return desc;
        }

        /// 2D配列スライス
        static RHIDepthStencilViewDesc Texture2DArray(
            IRHITexture* tex,
            uint32 mip,
            uint32 firstSlice,
            uint32 count = 1,
            ERHIDSVFlags dsvFlags = ERHIDSVFlags::None)
        {
            RHIDepthStencilViewDesc desc;
            desc.texture = tex;
            desc.dimension = ERHITextureDimension::Texture2DArray;
            desc.mipSlice = mip;
            desc.firstArraySlice = firstSlice;
            desc.arraySize = count;
            desc.flags = dsvFlags;
            return desc;
        }

        /// キューブマップの面
        static RHIDepthStencilViewDesc CubeFace(
            IRHITexture* tex,
            ERHICubeFace face,
            uint32 mip = 0)
        {
            return Texture2DArray(tex, mip, static_cast<uint32>(face), 1);
        }
    };
}
```

- [ ] ERHIDSVFlags 列挙型
- [ ] RHIDepthStencilViewDesc 構造体
- [ ] ReadOnly系ビルダー

### 2. IRHIDepthStencilView インターフェース

```cpp
namespace NS::RHI
{
    /// デプスステンシルビュー
    class RHI_API IRHIDepthStencilView : public IRHIResource
    {
    public:
        DECLARE_RHI_RESOURCE_TYPE(DepthStencilView)

        virtual ~IRHIDepthStencilView() = default;

        //=====================================================================
        // 基本プロパティ
        //=====================================================================

        /// 所属デバイス取得
        virtual IRHIDevice* GetDevice() const = 0;

        /// CPUディスクリプタハンドル取得
        virtual RHICPUDescriptorHandle GetCPUHandle() const = 0;

        //=====================================================================
        // ソースリソース
        //=====================================================================

        /// ソーステクスチャ取得
        virtual IRHITexture* GetTexture() const = 0;

        /// MIPレベル取得
        virtual uint32 GetMipSlice() const = 0;

        /// 配列スライス取得
        virtual uint32 GetFirstArraySlice() const = 0;

        /// 配列サイズ取得
        virtual uint32 GetArraySize() const = 0;

        //=====================================================================
        // サイズ情報
        //=====================================================================

        /// ビューの幅取得
        uint32 GetWidth() const {
            IRHITexture* tex = GetTexture();
            return tex ? CalculateMipSize(tex->GetWidth(), GetMipSlice()) : 0;
        }

        /// ビューの高さ取得
        uint32 GetHeight() const {
            IRHITexture* tex = GetTexture();
            return tex ? CalculateMipSize(tex->GetHeight(), GetMipSlice()) : 0;
        }

        Extent2D GetSize() const {
            return Extent2D{GetWidth(), GetHeight()};
        }

        //=====================================================================
        // フォーマット
        //=====================================================================

        /// ビューフォーマット取得
        virtual EPixelFormat GetFormat() const = 0;

        /// サンプル数取得
        ERHISampleCount GetSampleCount() const {
            IRHITexture* tex = GetTexture();
            return tex ? tex->GetSampleCount() : ERHISampleCount::Count1;
        }

        //=====================================================================
        // 読み取り専用状態
        //=====================================================================

        /// DSVフラグ取得
        virtual ERHIDSVFlags GetFlags() const = 0;

        /// デプス読み取り専用か
        bool IsDepthReadOnly() const {
            return EnumHasAnyFlags(GetFlags(), ERHIDSVFlags::ReadOnlyDepth);
        }

        /// ステンシル読み取り専用か
        bool IsStencilReadOnly() const {
            return EnumHasAnyFlags(GetFlags(), ERHIDSVFlags::ReadOnlyStencil);
        }

        /// 完全に読み取り専用か
        bool IsReadOnly() const {
            return IsDepthReadOnly() && IsStencilReadOnly();
        }

        //=====================================================================
        // フォーマットの機能
        //=====================================================================

        /// デプスフォーマットを持つか
        bool HasDepth() const {
            return IsDepthFormat(GetFormat());
        }

        /// ステンシルフォーマットを持つか
        bool HasStencil() const {
            return IsStencilFormat(GetFormat());
        }
    };

    using RHIDepthStencilViewRef = TRefCountPtr<IRHIDepthStencilView>;
}
```

- [ ] IRHIDepthStencilView インターフェース
- [ ] ReadOnly判定

### 3. DSV作成インターフェース

```cpp
namespace NS::RHI
{
    class IRHIDevice
    {
    public:
        //=====================================================================
        // DSV作成
        //=====================================================================

        /// デプスステンシルビュー作成
        virtual IRHIDepthStencilView* CreateDepthStencilView(
            const RHIDepthStencilViewDesc& desc,
            const char* debugName = nullptr) = 0;

        /// テクスチャからデフォルトSV作成
        IRHIDepthStencilView* CreateDefaultDSV(
            IRHITexture* texture,
            const char* debugName = nullptr)
        {
            return CreateDepthStencilView(
                RHIDepthStencilViewDesc::Texture2D(texture), debugName);
        }

        /// 読み取り専用DSV作成
        IRHIDepthStencilView* CreateReadOnlyDSV(
            IRHITexture* texture,
            const char* debugName = nullptr)
        {
            return CreateDepthStencilView(
                RHIDepthStencilViewDesc::Texture2DReadOnly(texture), debugName);
        }

        /// Null DSV取得
        virtual IRHIDepthStencilView* GetNullDSV() = 0;
    };
}
```

- [ ] CreateDepthStencilView
- [ ] CreateDefaultDSV / CreateReadOnlyDSV
- [ ] GetNullDSV

### 4. デプスステンシルクリア

```cpp
namespace NS::RHI
{
    /// デプスステンシルクリアフラグ
    enum class ERHIClearDSFlags : uint8
    {
        None = 0,
        Depth = 1 << 0,
        Stencil = 1 << 1,
        Both = Depth | Stencil,
    };
    RHI_ENUM_CLASS_FLAGS(ERHIClearDSFlags)

    /// デプスステンシルクリア値
    struct RHI_API RHIDSVClearValue
    {
        float depth = 1.0f;
        uint8 stencil = 0;
        ERHIClearDSFlags flags = ERHIClearDSFlags::Both;

        RHIDSVClearValue() = default;

        RHIDSVClearValue(float d, uint8 s = 0, ERHIClearDSFlags f = ERHIClearDSFlags::Both)
            : depth(d), stencil(s), flags(f)
        {}

        /// デプスのみクリア
        static RHIDSVClearValue DepthOnly(float d = 1.0f) {
            return RHIDSVClearValue(d, 0, ERHIClearDSFlags::Depth);
        }

        /// ステンシルのみクリア
        static RHIDSVClearValue StencilOnly(uint8 s = 0) {
            return RHIDSVClearValue(1.0f, s, ERHIClearDSFlags::Stencil);
        }

        /// リバースZ用（Near = 0）。
        static RHIDSVClearValue ReversedDepth(uint8 s = 0) {
            return RHIDSVClearValue(0.0f, s);
        }
    };

    /// デプスステンシルクリア操作
    class IRHICommandContext
    {
    public:
        /// デプスステンシルクリア
        virtual void ClearDepthStencilView(
            IRHIDepthStencilView* dsv,
            bool clearDepth, float depth,
            bool clearStencil, uint8 stencil) = 0;

        /// 便利関数
        void ClearDSV(IRHIDepthStencilView* dsv, const RHIDSVClearValue& value) {
            ClearDepthStencilView(
                dsv,
                EnumHasAnyFlags(value.flags, ERHIClearDSFlags::Depth),
                value.depth,
                EnumHasAnyFlags(value.flags, ERHIClearDSFlags::Stencil),
                value.stencil);
        }

        /// デプスのみクリア
        void ClearDepth(IRHIDepthStencilView* dsv, float depth = 1.0f) {
            ClearDepthStencilView(dsv, true, depth, false, 0);
        }

        /// ステンシルのみクリア
        void ClearStencil(IRHIDepthStencilView* dsv, uint8 stencil = 0) {
            ClearDepthStencilView(dsv, false, 1.0f, true, stencil);
        }
    };
}
```

- [ ] ERHIClearDSFlags 列挙型
- [ ] RHIDSVClearValue 構造体
- [ ] ClearDepthStencilView

### 5. デプスバウンド

```cpp
namespace NS::RHI
{
    /// デプスバウンド（深度範囲テスト）
    struct RHI_API RHIDepthBounds
    {
        float minDepth = 0.0f;
        float maxDepth = 1.0f;

        bool IsEnabled() const {
            return minDepth > 0.0f || maxDepth < 1.0f;
        }

        static RHIDepthBounds Disabled() {
            return RHIDepthBounds{0.0f, 1.0f};
        }

        static RHIDepthBounds Range(float min, float max) {
            return RHIDepthBounds{min, max};
        }
    };

    /// デプスバウンド設定（RHICommandContextに追加）。
    class IRHICommandContext
    {
    public:
        /// デプスバウンドテスト設定
        /// @note ハードウェアサポートが必要。
        virtual void SetDepthBounds(float minDepth, float maxDepth) = 0;

        void SetDepthBounds(const RHIDepthBounds& bounds) {
            SetDepthBounds(bounds.minDepth, bounds.maxDepth);
        }

        void DisableDepthBounds() {
            SetDepthBounds(0.0f, 1.0f);
        }
    };
}
```

- [ ] RHIDepthBounds 構造体
- [ ] SetDepthBounds

## 検証方法

- [ ] DSV作成と参照整合性
- [ ] ReadOnlyフラグの動作
- [ ] クリア操作の動作確認
- [ ] デプスバウンドの動作確認
