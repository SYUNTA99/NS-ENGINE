# 05-02: アンオーダードアクセスビュー (UAV)

## 目的

シェーダーからの読み書き用ビュー（AV（インターフェースを定義する。

## 参照ドキュメント

- 05-01-srv.md (SRV設計パターン)
- 03-02-buffer-interface.md (IRHIBuffer)
- 04-02-texture-interface.md (IRHITexture)

## 変更対象ファイル

新規作成:
- `Source/Engine/RHI/Public/IRHIViews.h` (部分

## TODO

### 1. UAV記述構造体

```cpp
namespace NS::RHI
{
    /// バッファUAV記述
    struct RHI_API RHIBufferUAVDesc
    {
        /// バッファ
        IRHIBuffer* buffer = nullptr;

        /// UAVフォーマット
        ERHIBufferSRVFormat uavFormat = ERHIBufferSRVFormat::Structured;

        /// 型付きバッファ用フォーマット
        EPixelFormat format = EPixelFormat::Unknown;

        /// 開始要素インデックス
        uint32 firstElement = 0;

        /// 要素数（ = 残り全て）。
        uint32 numElements = 0;

        /// 構造体バイトストライド
        uint32 structureByteStride = 0;

        //=====================================================================
        // UAV固有オプション
        //=====================================================================

        /// カウンターバッファ（AppendStructuredBuffer用）。
        IRHIBuffer* counterBuffer = nullptr;

        /// カウンターバッファオフセット
        uint64 counterOffset = 0;

        /// UAVフラグ
        enum class Flags : uint32 {
            None = 0,
            /// Raw（バイトアドレス）。
            Raw = 1 << 0,
            /// Append可能
            Append = 1 << 1,
            /// Counter付き
            Counter = 1 << 2,
        };
        Flags flags = Flags::None;

        /// ビルダー
        static RHIBufferUAVDesc Structured(IRHIBuffer* buf, uint32 first = 0, uint32 count = 0) {
            RHIBufferUAVDesc desc;
            desc.buffer = buf;
            desc.uavFormat = ERHIBufferSRVFormat::Structured;
            desc.firstElement = first;
            desc.numElements = count;
            return desc;
        }

        static RHIBufferUAVDesc Raw(IRHIBuffer* buf, uint32 firstByte = 0, uint32 numBytes = 0) {
            RHIBufferUAVDesc desc;
            desc.buffer = buf;
            desc.uavFormat = ERHIBufferSRVFormat::Raw;
            desc.firstElement = firstByte / 4;
            desc.numElements = (numBytes > 0) ? numBytes / 4 : 0;
            desc.flags = Flags::Raw;
            return desc;
        }

        static RHIBufferUAVDesc Typed(IRHIBuffer* buf, EPixelFormat fmt, uint32 first = 0, uint32 count = 0) {
            RHIBufferUAVDesc desc;
            desc.buffer = buf;
            desc.uavFormat = ERHIBufferSRVFormat::Typed;
            desc.format = fmt;
            desc.firstElement = first;
            desc.numElements = count;
            return desc;
        }

        static RHIBufferUAVDesc WithCounter(
            IRHIBuffer* buf,
            IRHIBuffer* counter,
            uint64 counterOff = 0)
        {
            RHIBufferUAVDesc desc = Structured(buf);
            desc.counterBuffer = counter;
            desc.counterOffset = counterOff;
            desc.flags = Flags::Counter;
            return desc;
        }
    };
    RHI_ENUM_CLASS_FLAGS(RHIBufferUAVDesc::Flags)

    /// テクスチャUAV記述
    struct RHI_API RHITextureUAVDesc
    {
        /// テクスチャ
        IRHITexture* texture = nullptr;

        /// ビューフォーマット（Unknown = テクスチャのフォーマットを使用）。
        EPixelFormat format = EPixelFormat::Unknown;

        /// MIPレベル（単一MIPのみ指定可能）。
        uint32 mipSlice = 0;

        /// 配列範囲（2D配列/3Dの場合）
        uint32 firstArraySlice = 0;
        uint32 arraySize = 0;  // 0 = 残り全て（3Dの場合はW方向の全体）

        /// 平面スライス
        uint32 planeSlice = 0;

        /// ビルダー
        static RHITextureUAVDesc Default(IRHITexture* tex, uint32 mip = 0) {
            RHITextureUAVDesc desc;
            desc.texture = tex;
            desc.mipSlice = mip;
            return desc;
        }

        static RHITextureUAVDesc ArraySlice(IRHITexture* tex, uint32 mip, uint32 slice) {
            RHITextureUAVDesc desc;
            desc.texture = tex;
            desc.mipSlice = mip;
            desc.firstArraySlice = slice;
            desc.arraySize = 1;
            return desc;
        }

        static RHITextureUAVDesc Slice3D(IRHITexture* tex, uint32 mip, uint32 firstW, uint32 wSize) {
            RHITextureUAVDesc desc;
            desc.texture = tex;
            desc.mipSlice = mip;
            desc.firstArraySlice = firstW;
            desc.arraySize = wSize;
            return desc;
        }
    };
}
```

- [ ] RHIBufferUAVDesc 構造体
- [ ] RHITextureUAVDesc 構造体
- [ ] カウンターバッファサポート

### 2. IRHIUnorderedAccessView インターフェース

```cpp
namespace NS::RHI
{
    /// アンオーダードアクセスビュー
    class RHI_API IRHIUnorderedAccessView : public IRHIResource
    {
    public:
        DECLARE_RHI_RESOURCE_TYPE(UnorderedAccessView)

        virtual ~IRHIUnorderedAccessView() = default;

        //=====================================================================
        // 基本プロパティ
        //=====================================================================

        /// 所属デバイス取得
        virtual IRHIDevice* GetDevice() const = 0;

        /// CPUディスクリプタハンドル取得
        virtual RHICPUDescriptorHandle GetCPUHandle() const = 0;

        /// GPUディスクリプタハンドル取得
        virtual RHIGPUDescriptorHandle GetGPUHandle() const = 0;

        /// Bindlessインデックス取得
        virtual BindlessIndex GetBindlessIndex() const = 0;

        //=====================================================================
        // ソースリソース
        //=====================================================================

        /// ソースリソース取得
        virtual IRHIResource* GetResource() const = 0;

        /// バッファビューか
        virtual bool IsBufferView() const = 0;

        /// テクスチャビューか
        bool IsTextureView() const { return !IsBufferView(); }

        /// ソースバッファ取得
        IRHIBuffer* GetBuffer() const {
            return IsBufferView() ? static_cast<IRHIBuffer*>(GetResource()) : nullptr;
        }

        /// ソーステクスチャ取得
        IRHITexture* GetTexture() const {
            return IsTextureView() ? static_cast<IRHITexture*>(GetResource()) : nullptr;
        }

        //=====================================================================
        // カウンター
        //=====================================================================

        /// カウンターを持つか
        virtual bool HasCounter() const = 0;

        /// カウンターリソース取得
        virtual IRHIBuffer* GetCounterResource() const = 0;

        /// カウンターオフセット取得
        virtual uint64 GetCounterOffset() const = 0;
    };

    using RHIUnorderedAccessViewRef = TRefCountPtr<IRHIUnorderedAccessView>;
}
```

- [ ] IRHIUnorderedAccessView インターフェース
- [ ] カウンター関連メソッド

### 3. UAV作成インターフェース

```cpp
namespace NS::RHI
{
    class IRHIDevice
    {
    public:
        //=====================================================================
        // UAV作成
        //=====================================================================

        /// バッファUAV作成
        virtual IRHIUnorderedAccessView* CreateUnorderedAccessView(
            const RHIBufferUAVDesc& desc,
            const char* debugName = nullptr) = 0;

        /// テクスチャUAV作成
        virtual IRHIUnorderedAccessView* CreateUnorderedAccessView(
            const RHITextureUAVDesc& desc,
            const char* debugName = nullptr) = 0;

        /// バッファからデフォルトAV作成
        IRHIUnorderedAccessView* CreateDefaultUAV(
            IRHIBuffer* buffer,
            const char* debugName = nullptr)
        {
            return CreateUnorderedAccessView(RHIBufferUAVDesc::Structured(buffer), debugName);
        }

        /// テクスチャからデフォルトAV作成
        IRHIUnorderedAccessView* CreateDefaultUAV(
            IRHITexture* texture,
            uint32 mipSlice = 0,
            const char* debugName = nullptr)
        {
            return CreateUnorderedAccessView(RHITextureUAVDesc::Default(texture, mipSlice), debugName);
        }

        /// Null UAV取得
        virtual IRHIUnorderedAccessView* GetNullBufferUAV() = 0;
        virtual IRHIUnorderedAccessView* GetNullTextureUAV(
            ERHITextureDimension dimension = ERHITextureDimension::Texture2D) = 0;
    };
}
```

- [ ] CreateUnorderedAccessView（バッファ版）
- [ ] CreateUnorderedAccessView（テクスチャ版）
- [ ] GetNullBufferUAV / GetNullTextureUAV

### 4. UAVクリア操作

```cpp
namespace NS::RHI
{
    /// UAVクリア値
    union RHI_API RHIUAVClearValue
    {
        float floatValue[4];
        uint32 uintValue[4];

        RHIUAVClearValue() {
            uintValue[0] = uintValue[1] = uintValue[2] = uintValue[3] = 0;
        }

        static RHIUAVClearValue Float(float r, float g = 0, float b = 0, float a = 0) {
            RHIUAVClearValue v;
            v.floatValue[0] = r;
            v.floatValue[1] = g;
            v.floatValue[2] = b;
            v.floatValue[3] = a;
            return v;
        }

        static RHIUAVClearValue Uint(uint32 r, uint32 g = 0, uint32 b = 0, uint32 a = 0) {
            RHIUAVClearValue v;
            v.uintValue[0] = r;
            v.uintValue[1] = g;
            v.uintValue[2] = b;
            v.uintValue[3] = a;
            return v;
        }

        static RHIUAVClearValue Zero() { return RHIUAVClearValue(); }
    };

    /// UAVクリア操作（RHIComputeContextに追加）。
    class IRHIComputeContext
    {
    public:
        /// UAVをuint値でクリア
        virtual void ClearUnorderedAccessViewUint(
            IRHIUnorderedAccessView* uav,
            const uint32 values[4]) = 0;

        /// UAVをfloat値でクリア
        virtual void ClearUnorderedAccessViewFloat(
            IRHIUnorderedAccessView* uav,
            const float values[4]) = 0;

        /// UAVをクリア（ユニオン版）
        void ClearUAV(IRHIUnorderedAccessView* uav, const RHIUAVClearValue& value, bool asFloat = false) {
            if (asFloat) {
                ClearUnorderedAccessViewFloat(uav, value.floatValue);
            } else {
                ClearUnorderedAccessViewUint(uav, value.uintValue);
            }
        }
    };
}
```

- [ ] RHIUAVClearValue 共用作
- [ ] ClearUnorderedAccessViewUint / Float

### 5. UAVカウンター操作

```cpp
namespace NS::RHI
{
    /// UAVカウンター操作ヘルパー
    class RHI_API RHIUAVCounterHelper
    {
    public:
        /// カウンターをリセット
        static void ResetCounter(
            IRHICommandContext* context,
            IRHIUnorderedAccessView* uav,
            uint32 value = 0);

        /// カウンター値をバッファにコピー
        static void CopyCounterToBuffer(
            IRHICommandContext* context,
            IRHIUnorderedAccessView* uav,
            IRHIBuffer* destBuffer,
            uint64 destOffset = 0);

        /// カウンター値をバッファからセット
        static void SetCounterFromBuffer(
            IRHICommandContext* context,
            IRHIUnorderedAccessView* uav,
            IRHIBuffer* srcBuffer,
            uint64 srcOffset = 0);
    };
}
```

- [ ] RHIUAVCounterHelper クラス
- [ ] ResetCounter / CopyCounterToBuffer

## 検証方法

- [ ] バッファUAVの作成と参照整合性
- [ ] テクスチャUAVの作成と参照整合性
- [ ] カウンター操作の正確性
- [ ] UAVクリアの動作確認
