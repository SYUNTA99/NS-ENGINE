# RHI 実装ガイド Part 3: シェーダー、パイプライン、同期、デスクリプタ

このドキュメントでは、RHI実装において重要な以下のコンポーネントを詳細に解説します：

- シェーダー実装
- パイプラインステート実装
- ルートシグネチャ/バインディングレイアウト
- 同期/フェンス実装
- デスクリプタ管理
- メモリアロケーション詳細

---

## 1. シェーダー実装

### 1.1 シェーダーの種類

```
┌─────────────────────────────────────────────────────────────────┐
│                      シェーダーの種類                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│   ┌──────────────────┐  ┌──────────────────┐                    │
│   │  FRHIVertexShader │  │  FRHIPixelShader │   グラフィックス   │
│   └──────────────────┘  └──────────────────┘   パイプライン     │
│                                                                  │
│   ┌──────────────────┐  ┌──────────────────┐                    │
│   │ FRHIGeometryShader│  │ FRHIMeshShader   │   オプショナル    │
│   └──────────────────┘  └──────────────────┘   ステージ        │
│                                                                  │
│   ┌──────────────────┐                                          │
│   │FRHIAmplification │   メッシュシェーダー                     │
│   │     Shader       │   パイプライン用                          │
│   └──────────────────┘                                          │
│                                                                  │
│   ┌──────────────────┐                                          │
│   │ FRHIComputeShader│   コンピュート                            │
│   └──────────────────┘   パイプライン                            │
│                                                                  │
│   ┌──────────────────┐                                          │
│   │FRHIRayTracingShader│ レイトレーシング                        │
│   └──────────────────┘   (オプショナル)                          │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 1.2 シェーダークラスの構造

各シェーダークラスは以下の基本構造を持ちます：

```
┌─────────────────────────────────────────────────────────────────┐
│                    シェーダークラス構成                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│   ┌────────────────────────────────────────────────────────┐    │
│   │                   FRHIShaderBase                        │    │
│   │  ├── 参照カウント                                       │    │
│   │  ├── シェーダー周波数 (SF_Vertex, SF_Pixel, etc.)       │    │
│   │  └── デバッグ名                                          │    │
│   └────────────────────────────────────────────────────────┘    │
│                          ▲                                       │
│                          │                                       │
│   ┌────────────────────────────────────────────────────────┐    │
│   │                  FD3D12ShaderData                       │    │
│   │  ├── Code (バイトコード配列)                             │    │
│   │  ├── ResourceCounts (リソース使用情報)                  │    │
│   │  ├── ShaderBindingLayoutHash                            │    │
│   │  ├── VendorExtensions (ベンダー拡張)                    │    │
│   │  └── Features (シェーダー機能フラグ)                    │    │
│   └────────────────────────────────────────────────────────┘    │
│                          ▲                                       │
│                          │                                       │
│   ┌────────────────────────────────────────────────────────┐    │
│   │              FD3D12VertexShader など                    │    │
│   │  ├── プラットフォーム固有のシェーダーオブジェクト        │    │
│   │  └── ルートシグネチャ参照 (コンピュート/レイトレ)        │    │
│   └────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 1.3 実装すべき項目

#### シェーダーデータの保持

```
┌─────────────────────────────────────────────────────────────────┐
│                  シェーダーデータ構成                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  バイトコード:                                                    │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ [ヘッダー] [128bitチェックサム] [DXIL/SPIRV] [メタデータ] │    │
│  └─────────────────────────────────────────────────────────┘    │
│      │                                                          │
│      ▼                                                          │
│  ハッシュ計算:                                                    │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ D3D12: バイトコード内のチェックサムを直接使用            │    │
│  │ Vulkan: SPIRV-Reflect等でリフレクション                  │    │
│  │ Metal: 事前コンパイル済みライブラリ                      │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  リソースカウント (FShaderCodePackedResourceCounts):             │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ ├── NumSamplers (サンプラー数)                           │    │
│  │ ├── NumSRVs (シェーダーリソースビュー数)                 │    │
│  │ ├── NumCBs (コンスタントバッファ数)                      │    │
│  │ ├── NumUAVs (アンオーダードアクセスビュー数)             │    │
│  │ └── UsageFlags (使用機能フラグ)                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

#### シェーダー作成フロー

```
┌─────────────────────────────────────────────────────────────────┐
│                 シェーダー作成フロー                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  1. RHI関数呼び出し                                              │
│     CreateVertexShader(Code)                                     │
│              │                                                   │
│              ▼                                                   │
│  2. バイトコード解析                                             │
│     ┌──────────────────────────────┐                            │
│     │ ├── ヘッダー検証              │                            │
│     │ ├── リソースカウント抽出      │                            │
│     │ ├── バインディング情報抽出    │                            │
│     │ └── ベンダー拡張抽出          │                            │
│     └──────────────────────────────┘                            │
│              │                                                   │
│              ▼                                                   │
│  3. プラットフォームオブジェクト作成                             │
│     ┌──────────────────────────────┐                            │
│     │ D3D12: バイトコード保持のみ   │  ← PSO作成時に使用         │
│     │ Vulkan: VkShaderModule作成    │                            │
│     │ Metal: MTLFunction作成        │                            │
│     └──────────────────────────────┘                            │
│              │                                                   │
│              ▼                                                   │
│  4. RHIシェーダーオブジェクト返却                                │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 2. パイプラインステート実装

### 2.1 パイプラインステートの種類

```
┌─────────────────────────────────────────────────────────────────┐
│               パイプラインステートの種類                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │              Graphics Pipeline State                      │   │
│  │  ┌────────────────────────────────────────────────────┐  │   │
│  │  │                                                     │  │   │
│  │  │   Input Assembly ─── Vertex Shader ─── Geometry     │  │   │
│  │  │         │                                   │       │  │   │
│  │  │         ▼                                   ▼       │  │   │
│  │  │   Rasterizer ──────────────────── Pixel Shader     │  │   │
│  │  │         │                                   │       │  │   │
│  │  │         ▼                                   ▼       │  │   │
│  │  │   Depth/Stencil ─────────────── Output Merger      │  │   │
│  │  │                                                     │  │   │
│  │  └────────────────────────────────────────────────────┘  │   │
│  └──────────────────────────────────────────────────────────┘   │
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │           Mesh Shader Pipeline State                      │   │
│  │  ┌────────────────────────────────────────────────────┐  │   │
│  │  │   Amplification ─── Mesh Shader ─── Pixel Shader   │  │   │
│  │  │       Shader            │               │           │  │   │
│  │  │                         ▼               ▼           │  │   │
│  │  │                    Rasterizer ─── Output Merger    │  │   │
│  │  └────────────────────────────────────────────────────┘  │   │
│  └──────────────────────────────────────────────────────────┘   │
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │              Compute Pipeline State                       │   │
│  │  ┌────────────────────────────────────────────────────┐  │   │
│  │  │   Root Signature ─── Compute Shader ─── Dispatch   │  │   │
│  │  └────────────────────────────────────────────────────┘  │   │
│  └──────────────────────────────────────────────────────────┘   │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 グラフィックスPSOの構成要素

```
┌─────────────────────────────────────────────────────────────────┐
│          Graphics PSO Descriptor 構成要素                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ シェーダーバイトコード                                    │    │
│  │  ├── VS (頂点シェーダー)                                 │    │
│  │  ├── PS (ピクセルシェーダー)                             │    │
│  │  ├── GS (ジオメトリシェーダー) [オプション]              │    │
│  │  ├── MS (メッシュシェーダー) [代替]                      │    │
│  │  └── AS (アンプリフィケーションシェーダー) [代替]        │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ ブレンドステート                                          │    │
│  │  ├── AlphaToCoverageEnable                               │    │
│  │  ├── IndependentBlendEnable                              │    │
│  │  └── RenderTarget[8]                                     │    │
│  │       ├── BlendEnable                                    │    │
│  │       ├── SrcBlend / DestBlend                           │    │
│  │       ├── BlendOp                                        │    │
│  │       ├── SrcBlendAlpha / DestBlendAlpha                 │    │
│  │       ├── BlendOpAlpha                                   │    │
│  │       └── RenderTargetWriteMask                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ ラスタライザステート                                      │    │
│  │  ├── FillMode (Solid/Wireframe)                          │    │
│  │  ├── CullMode (None/Front/Back)                          │    │
│  │  ├── FrontCounterClockwise                               │    │
│  │  ├── DepthBias / DepthBiasClamp / SlopeScaledDepthBias   │    │
│  │  ├── DepthClipEnable                                     │    │
│  │  ├── MultisampleEnable                                   │    │
│  │  └── ConservativeRaster                                  │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ 深度/ステンシルステート                                   │    │
│  │  ├── DepthEnable                                         │    │
│  │  ├── DepthWriteMask                                      │    │
│  │  ├── DepthFunc                                           │    │
│  │  ├── StencilEnable                                       │    │
│  │  ├── StencilReadMask / StencilWriteMask                  │    │
│  │  ├── FrontFace (StencilFunc, StencilOps)                 │    │
│  │  └── BackFace (StencilFunc, StencilOps)                  │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ 入力レイアウト                                            │    │
│  │  └── InputElementDesc[]                                  │    │
│  │       ├── SemanticName                                   │    │
│  │       ├── SemanticIndex                                  │    │
│  │       ├── Format                                         │    │
│  │       ├── InputSlot                                      │    │
│  │       ├── AlignedByteOffset                              │    │
│  │       └── InputSlotClass / InstanceDataStepRate          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ レンダーターゲットフォーマット                            │    │
│  │  ├── RTFormats[8] (各RTのピクセルフォーマット)           │    │
│  │  ├── DSVFormat (深度/ステンシルフォーマット)             │    │
│  │  ├── SampleDesc (マルチサンプリング設定)                 │    │
│  │  └── NodeMask (マルチGPU用)                              │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 2.3 PSO作成フロー

```
┌─────────────────────────────────────────────────────────────────┐
│                  PSO 作成フロー                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ 1. FGraphicsPipelineStateInitializer受信                  │   │
│  │    (ブレンド、ラスタライザ、深度等の設定を含む)           │   │
│  └──────────────────────────────────────────────────────────┘   │
│                          │                                       │
│                          ▼                                       │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ 2. 高レベルキャッシュ検索                                  │   │
│  │    Initializer → FD3D12GraphicsPipelineState*             │   │
│  │    (見つかれば即座に返却)                                 │   │
│  └──────────────────────────────────────────────────────────┘   │
│                          │ キャッシュミス                        │
│                          ▼                                       │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ 3. 低レベルDescriptor構築                                  │   │
│  │    ├── シェーダーバイトコード設定                         │   │
│  │    ├── ブレンドステート変換                               │   │
│  │    ├── ラスタライザステート変換                           │   │
│  │    ├── 深度/ステンシルステート変換                        │   │
│  │    ├── 入力レイアウト構築                                 │   │
│  │    └── RT/DSVフォーマット設定                             │   │
│  └──────────────────────────────────────────────────────────┘   │
│                          │                                       │
│                          ▼                                       │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ 4. 低レベルキャッシュ検索                                  │   │
│  │    LowLevelDesc → FD3D12PipelineState*                    │   │
│  └──────────────────────────────────────────────────────────┘   │
│                          │ キャッシュミス                        │
│                          ▼                                       │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ 5. ディスクキャッシュ検索                                  │   │
│  │    PSO Hashで事前コンパイル済みPSOを検索                  │   │
│  └──────────────────────────────────────────────────────────┘   │
│                          │ キャッシュミス                        │
│                          ▼                                       │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ 6. PSO作成 (同期 or 非同期)                                │   │
│  │    ┌──────────────────┐  ┌───────────────────────────┐   │   │
│  │    │ 同期作成          │  │ 非同期作成                 │   │   │
│  │    │ (ブロッキング)     │  │ (ワーカースレッドで作成)   │   │   │
│  │    │ CreatePSO()       │  │ CreateAsync() + 待機      │   │   │
│  │    └──────────────────┘  └───────────────────────────┘   │   │
│  └──────────────────────────────────────────────────────────┘   │
│                          │                                       │
│                          ▼                                       │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ 7. キャッシュに追加して返却                                │   │
│  └──────────────────────────────────────────────────────────┘   │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 2.4 PSOキャッシュシステム

```
┌─────────────────────────────────────────────────────────────────┐
│                  PSO キャッシュ階層                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  レベル1: 高レベルキャッシュ (ランタイム)                        │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ Key: FGraphicsPipelineStateInitializer                   │    │
│  │ Value: FD3D12GraphicsPipelineState*                      │    │
│  │                                                          │    │
│  │ 特徴:                                                    │    │
│  │ - エンジン固有の構造体をキーとして使用                    │    │
│  │ - 最速のルックアップ                                     │    │
│  │ - シェーダー参照を保持                                   │    │
│  └─────────────────────────────────────────────────────────┘    │
│                          │                                       │
│                          ▼                                       │
│  レベル2: 低レベルキャッシュ (ランタイム)                        │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ Key: FD3D12LowLevelGraphicsPipelineStateDesc             │    │
│  │      (シェーダーハッシュ + ステート設定)                  │    │
│  │ Value: FD3D12PipelineState*                              │    │
│  │                                                          │    │
│  │ 特徴:                                                    │    │
│  │ - プラットフォームネイティブな記述子                      │    │
│  │ - ID3D12PipelineStateを直接保持                          │    │
│  │ - 同一シェーダー・同一設定のPSOを共有可能                 │    │
│  └─────────────────────────────────────────────────────────┘    │
│                          │                                       │
│                          ▼                                       │
│  レベル3: ディスクキャッシュ (永続)                              │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ Key: PSO ハッシュ (64bit または 128bit)                   │    │
│  │ Value: シリアライズされたPSOブロブ                       │    │
│  │                                                          │    │
│  │ 特徴:                                                    │    │
│  │ - ゲーム起動時にプリロード可能                           │    │
│  │ - ドライバーレベルのコンパイル結果を保存                  │    │
│  │ - ドライバーバージョン変更で無効化                        │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 3. ルートシグネチャ / バインディングレイアウト

### 3.1 ルートシグネチャの概念

```
┌─────────────────────────────────────────────────────────────────┐
│              ルートシグネチャの概念                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ルートシグネチャは、シェーダーがアクセスするリソースの           │
│  "署名"または"契約"を定義します                                  │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                Root Signature Layout                     │    │
│  │  (最大64 DWORD = 256 bytes)                              │    │
│  ├─────────────────────────────────────────────────────────┤    │
│  │                                                          │    │
│  │  Slot 0: [Descriptor Table] ─── SRV用デスクリプタテーブル│    │
│  │  Slot 1: [Descriptor Table] ─── CBV用デスクリプタテーブル│    │
│  │  Slot 2: [Descriptor Table] ─── Sampler用テーブル        │    │
│  │  Slot 3: [Root CBV] ─────────── 直接バインドCBV         │    │
│  │  Slot 4: [Root Constants] ──── インライン定数           │    │
│  │  Slot 5: [Descriptor Table] ─── UAV用テーブル            │    │
│  │                                                          │    │
│  │  各スロットのコスト:                                      │    │
│  │  - Descriptor Table: 1 DWORD                             │    │
│  │  - Root Descriptor (CBV/SRV/UAV): 2 DWORD                │    │
│  │  - Root Constants: 1 DWORD per 32-bit constant           │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 ルートパラメータの種類

```
┌─────────────────────────────────────────────────────────────────┐
│              ルートパラメータの種類                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  1. Descriptor Table (デスクリプタテーブル)                      │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  Root Signature                        Descriptor Heap   │    │
│  │  ┌────────────┐                       ┌────────────────┐ │    │
│  │  │ Table Ptr ─┼───────────────────────▶ [CBV0]         │ │    │
│  │  └────────────┘                       │ [CBV1]         │ │    │
│  │  (1 DWORD)                            │ [CBV2]         │ │    │
│  │                                        │ ...            │ │    │
│  │  利点: 多数のリソースを効率的にバインド                   │    │
│  │  欠点: デスクリプタヒープへの間接参照                     │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  2. Root Descriptor (ルートデスクリプタ)                         │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  Root Signature                                          │    │
│  │  ┌────────────────────────┐                              │    │
│  │  │ GPU Virtual Address   ├───▶ バッファリソース直接      │    │
│  │  └────────────────────────┘                              │    │
│  │  (2 DWORD)                                               │    │
│  │                                                          │    │
│  │  利点: 最速アクセス、ヒープ不要                          │    │
│  │  欠点: CBV/SRV/UAVのみ、テクスチャ不可                   │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  3. Root Constants (ルート定数)                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  Root Signature                                          │    │
│  │  ┌────────────────────────────────────┐                  │    │
│  │  │ [Const0] [Const1] [Const2] ...    │                  │    │
│  │  └────────────────────────────────────┘                  │    │
│  │  (N DWORD、定数ごとに1 DWORD)                            │    │
│  │                                                          │    │
│  │  利点: 超高速、バッファ不要                              │    │
│  │  欠点: 容量制限、小さな定数のみ                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 3.3 シェーダーステージとビジビリティ

```
┌─────────────────────────────────────────────────────────────────┐
│           シェーダービジビリティマッピング                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │          Parameter Visibility Settings                    │   │
│  ├──────────────────────────────────────────────────────────┤   │
│  │                                                           │   │
│  │  D3D12_SHADER_VISIBILITY_ALL                              │   │
│  │    └── すべてのステージからアクセス可能                   │   │
│  │                                                           │   │
│  │  D3D12_SHADER_VISIBILITY_VERTEX                           │   │
│  │    └── 頂点シェーダーのみ                                 │   │
│  │                                                           │   │
│  │  D3D12_SHADER_VISIBILITY_PIXEL                            │   │
│  │    └── ピクセルシェーダーのみ                             │   │
│  │                                                           │   │
│  │  D3D12_SHADER_VISIBILITY_GEOMETRY                         │   │
│  │    └── ジオメトリシェーダーのみ                           │   │
│  │                                                           │   │
│  │  D3D12_SHADER_VISIBILITY_MESH                             │   │
│  │    └── メッシュシェーダーのみ                             │   │
│  │                                                           │   │
│  │  D3D12_SHADER_VISIBILITY_AMPLIFICATION                    │   │
│  │    └── アンプリフィケーションシェーダーのみ               │   │
│  │                                                           │   │
│  └──────────────────────────────────────────────────────────┘   │
│                                                                  │
│  UE5での実装:                                                    │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  ERootParameterKeys (バインドスロットマップ):             │   │
│  │  ├── PS_SRVs, PS_CBVs, PS_RootCBVs, PS_Samplers          │   │
│  │  ├── VS_SRVs, VS_CBVs, VS_RootCBVs, VS_Samplers, VS_UAVs │   │
│  │  ├── GS_SRVs, GS_CBVs, GS_RootCBVs, GS_Samplers          │   │
│  │  ├── MS_SRVs, MS_CBVs, MS_RootCBVs, MS_Samplers          │   │
│  │  ├── AS_SRVs, AS_CBVs, AS_RootCBVs, AS_Samplers          │   │
│  │  └── ALL_SRVs, ALL_CBVs, ALL_RootCBVs, ALL_Samplers...   │   │
│  └──────────────────────────────────────────────────────────┘   │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 4. 同期/フェンス実装

### 4.1 GPU同期の基本概念

```
┌─────────────────────────────────────────────────────────────────┐
│               GPU同期の基本概念                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  同期が必要なシナリオ:                                           │
│                                                                  │
│  1. CPU-GPU同期                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  CPU                             GPU                     │    │
│  │  ┌────┐                         ┌────┐                  │    │
│  │  │ 書込 │ ──────────────────────▶ │ 読取 │                 │    │
│  │  └────┘                         └────┘                  │    │
│  │    │                               │                     │    │
│  │    │ CPUはGPUがデータを                                  │    │
│  │    │ 読み終わるまで待つ必要がある                         │    │
│  │    ▼                               ▼                     │    │
│  │  ┌────┐                         ┌────┐                  │    │
│  │  │ 待機 │ ◀── フェンス完了 ─────── │ シグナル │            │    │
│  │  └────┘                         └────┘                  │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  2. GPU-GPU同期 (キュー間)                                       │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  Graphics Queue              Compute Queue               │    │
│  │  ┌────────────┐             ┌────────────┐              │    │
│  │  │ レンダリング │             │ ポストプロセス │            │    │
│  │  │ Pass 1     │             │ 計算        │              │    │
│  │  └────────────┘             └────────────┘              │    │
│  │       │                           │                      │    │
│  │       │ Signal ──────────▶ Wait   │                      │    │
│  │       ▼                           ▼                      │    │
│  │  ┌────────────┐             ┌────────────┐              │    │
│  │  │ Wait       │ ◀──────── Signal │                       │    │
│  │  │ レンダリング │             └────────────┘              │    │
│  │  │ Pass 2     │                                          │    │
│  │  └────────────┘                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  3. リソース遷移同期                                             │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  [描画ターゲット] ──────▶ [シェーダーリソース]             │    │
│  │                                                          │    │
│  │  バリアが必要:                                            │    │
│  │  - レイアウト遷移                                        │    │
│  │  - キャッシュフラッシュ                                   │    │
│  │  - 可視性確保                                            │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 4.2 フェンスの実装

```
┌─────────────────────────────────────────────────────────────────┐
│                  フェンス実装詳細                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  フェンスの動作原理:                                             │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  時間軸 ───────────────────────────────────────────▶     │    │
│  │                                                          │    │
│  │  GPU:  [Cmd1] [Cmd2] [Signal(5)] [Cmd3] [Cmd4]           │    │
│  │                  │                                       │    │
│  │                  ▼                                       │    │
│  │  Fence:    1 → 2 → 3 → 4 → 5 (GPUが更新)                 │    │
│  │                          ▲                               │    │
│  │                          │                               │    │
│  │  CPU:            Wait(5) ┘ (値が5以上になるまで待機)     │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  FD3D12ManualFence 構造:                                         │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  class FD3D12ManualFence                                 │    │
│  │  ├── TMap<FD3D12Queue*, ID3D12Fence*> Fences             │    │
│  │  │   (各キューに対応するフェンス)                         │    │
│  │  │                                                       │    │
│  │  ├── NextFenceValueTOP                                   │    │
│  │  │   (次にシグナルする値 - フレーム開始時)                │    │
│  │  │                                                       │    │
│  │  ├── NextFenceValueBOP                                   │    │
│  │  │   (次にシグナルする値 - フレーム終了時)                │    │
│  │  │                                                       │    │
│  │  └── CompletedFenceValue                                 │    │
│  │      (GPUが完了したフェンス値のキャッシュ)               │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  主要な操作:                                                     │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  Signal (GPUからシグナル):                               │    │
│  │  ┌─────────────────────────────────────────────────┐    │    │
│  │  │ CommandQueue->Signal(Fence, FenceValue)          │    │    │
│  │  │ // GPUがこの点に達したらFence値を更新            │    │    │
│  │  └─────────────────────────────────────────────────┘    │    │
│  │                                                          │    │
│  │  Wait (CPUで待機):                                       │    │
│  │  ┌─────────────────────────────────────────────────┐    │    │
│  │  │ if (Fence->GetCompletedValue() < FenceValue)     │    │    │
│  │  │ {                                                │    │    │
│  │  │   Fence->SetEventOnCompletion(FenceValue, Event) │    │    │
│  │  │   WaitForSingleObject(Event, INFINITE)           │    │    │
│  │  │ }                                                │    │    │
│  │  └─────────────────────────────────────────────────┘    │    │
│  │                                                          │    │
│  │  Wait (GPUで待機):                                       │    │
│  │  ┌─────────────────────────────────────────────────┐    │    │
│  │  │ CommandQueue->Wait(Fence, FenceValue)            │    │    │
│  │  │ // このキューは別キューのフェンス値を待つ        │    │    │
│  │  └─────────────────────────────────────────────────┘    │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 4.3 同期ポイント (Sync Points)

```
┌─────────────────────────────────────────────────────────────────┐
│               同期ポイントシステム                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  フレーム同期の例:                                               │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  フレーム N                フレーム N+1                   │    │
│  │  ┌──────────────┐          ┌──────────────┐             │    │
│  │  │ CPU:          │          │ CPU:          │             │    │
│  │  │ コマンド記録   │          │ コマンド記録   │             │    │
│  │  └──────────────┘          └──────────────┘             │    │
│  │         │                           │                     │    │
│  │         │ ExecuteCommandLists       │                     │    │
│  │         ▼                           ▼                     │    │
│  │  ┌──────────────┐          ┌──────────────┐             │    │
│  │  │ GPU:          │          │ GPU:          │             │    │
│  │  │ コマンド実行   │          │ コマンド実行   │             │    │
│  │  └──────────────┘          └──────────────┘             │    │
│  │         │                           │                     │    │
│  │         │ Signal(N)                 │ Signal(N+1)        │    │
│  │         ▼                           ▼                     │    │
│  │  ┌──────────────┐          ┌──────────────┐             │    │
│  │  │ Present      │──────────│ Present      │             │    │
│  │  └──────────────┘          └──────────────┘             │    │
│  │                                                          │    │
│  │  フレームペーシング:                                      │    │
│  │  - MAX_FRAMES_IN_FLIGHT (通常2-3)                        │    │
│  │  - CPU が N+3 を開始する前に N の完了を待機               │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  リソースライフタイム管理:                                       │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  1. リソース使用 (フレーム N)                             │    │
│  │     CommandList->Draw(Resource)                          │    │
│  │                                                          │    │
│  │  2. フェンスシグナル                                      │    │
│  │     Queue->Signal(Fence, N)                              │    │
│  │                                                          │    │
│  │  3. 遅延削除キューに追加                                  │    │
│  │     DeferredDeleteQueue.Add({Resource, FenceValue: N})   │    │
│  │                                                          │    │
│  │  4. 後のフレームでクリーンアップ                          │    │
│  │     for (item : DeferredDeleteQueue)                     │    │
│  │       if (Fence->GetCompletedValue() >= item.FenceValue) │    │
│  │         delete item.Resource                             │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 5. デスクリプタ管理

### 5.1 デスクリプタヒープの種類

```
┌─────────────────────────────────────────────────────────────────┐
│               デスクリプタヒープの種類                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  D3D12でのデスクリプタヒープ種類:                                │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  1. CBV/SRV/UAV Heap                                     │    │
│  │     ┌───────────────────────────────────────────────┐   │    │
│  │     │ GPU Visible (シェーダーからアクセス可能)        │   │    │
│  │     │ - 最大 1,000,000+ デスクリプタ                 │   │    │
│  │     │ - 1ヒープのみバインド可能                      │   │    │
│  │     └───────────────────────────────────────────────┘   │    │
│  │     ┌───────────────────────────────────────────────┐   │    │
│  │     │ CPU Only (ステージング/コピー用)               │   │    │
│  │     │ - 複数ヒープ可能                               │   │    │
│  │     │ - GPUからは見えない                            │   │    │
│  │     └───────────────────────────────────────────────┘   │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  2. Sampler Heap                                         │    │
│  │     ┌───────────────────────────────────────────────┐   │    │
│  │     │ GPU Visible                                    │   │    │
│  │     │ - 最大 2048 デスクリプタ                       │   │    │
│  │     │ - 1ヒープのみバインド可能                      │   │    │
│  │     │ - サンプラーステートを定義                      │   │    │
│  │     └───────────────────────────────────────────────┘   │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  3. RTV Heap (Render Target View)                        │    │
│  │     ┌───────────────────────────────────────────────┐   │    │
│  │     │ CPU Only                                       │   │    │
│  │     │ - レンダーターゲット用                          │   │    │
│  │     │ - OMSetRenderTargetsで使用                     │   │    │
│  │     └───────────────────────────────────────────────┘   │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  4. DSV Heap (Depth Stencil View)                        │    │
│  │     ┌───────────────────────────────────────────────┐   │    │
│  │     │ CPU Only                                       │   │    │
│  │     │ - 深度/ステンシルバッファ用                     │   │    │
│  │     │ - OMSetRenderTargetsで使用                     │   │    │
│  │     └───────────────────────────────────────────────┘   │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 5.2 デスクリプタ管理アーキテクチャ

```
┌─────────────────────────────────────────────────────────────────┐
│            デスクリプタ管理アーキテクチャ                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │           FD3D12DescriptorHeapManager                    │    │
│  │  (デバイスレベルのデスクリプタヒープ統括管理)             │    │
│  ├─────────────────────────────────────────────────────────┤    │
│  │                                                          │    │
│  │  ┌─────────────────────────────────────────────────┐    │    │
│  │  │ GlobalHeaps (グローバルヒープ)                   │    │    │
│  │  │ ├── CBV/SRV/UAV グローバルヒープ                 │    │    │
│  │  │ └── Sampler グローバルヒープ                     │    │    │
│  │  └─────────────────────────────────────────────────┘    │    │
│  │                          │                               │    │
│  │                          ▼                               │    │
│  │  ┌─────────────────────────────────────────────────┐    │    │
│  │  │ FD3D12DescriptorManager (サブアロケーター)       │    │    │
│  │  │ ├── 空きスロット管理                             │    │    │
│  │  │ ├── アロケーション/解放                          │    │    │
│  │  │ └── フラグメンテーション対策                     │    │    │
│  │  └─────────────────────────────────────────────────┘    │    │
│  │                                                          │    │
│  │  ┌─────────────────────────────────────────────────┐    │    │
│  │  │ PooledHeaps (プールされたヒープ)                 │    │    │
│  │  │ - 再利用可能なヒープのキャッシュ                  │    │    │
│  │  │ - サイズ/タイプごとにプール                      │    │    │
│  │  └─────────────────────────────────────────────────┘    │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  オンラインデスクリプタ管理:                                     │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │       FD3D12OnlineDescriptorManager                      │    │
│  │  (フレームごとのGPU可視ヒープ管理)                       │    │
│  ├─────────────────────────────────────────────────────────┤    │
│  │                                                          │    │
│  │  パイプラインごとのヒープ:                                │    │
│  │  ┌──────────────────┐  ┌──────────────────┐            │    │
│  │  │ Graphics Heap    │  │ Compute Heap     │            │    │
│  │  └──────────────────┘  └──────────────────┘            │    │
│  │                                                          │    │
│  │  ブロック割り当て:                                        │    │
│  │  ┌─────────────────────────────────────────────────┐    │    │
│  │  │ [Block 0] [Block 1] [Block 2] ... [Block N]      │    │    │
│  │  │    │                                              │    │    │
│  │  │    └─ BaseSlot + Size + SizeUsed                  │    │    │
│  │  └─────────────────────────────────────────────────┘    │    │
│  │                                                          │    │
│  │  フロー:                                                 │    │
│  │  1. AllocateHeapBlock() - 使用可能なブロックを取得       │    │
│  │  2. 描画コマンドでデスクリプタを埋める                    │    │
│  │  3. フレーム終了時にRecycle()で返却                      │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  オフラインデスクリプタ管理:                                     │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │       FD3D12OfflineDescriptorManager                     │    │
│  │  (CPU専用デスクリプタのステージング)                      │    │
│  ├─────────────────────────────────────────────────────────┤    │
│  │                                                          │    │
│  │  用途:                                                   │    │
│  │  - リソース作成時にデスクリプタを事前作成                 │    │
│  │  - RTV/DSV用 (GPU不可視)                                 │    │
│  │  - 描画時にオンラインヒープへコピー                       │    │
│  │                                                          │    │
│  │  構造:                                                   │    │
│  │  ┌─────────────────────────────────────────────────┐    │    │
│  │  │ Heaps[] - 小さなヒープの配列                     │    │    │
│  │  │   └─ 各ヒープにFreeListを保持                   │    │    │
│  │  │                                                  │    │    │
│  │  │ AllocateHeapSlot() - 空きスロットを割り当て      │    │    │
│  │  │ FreeHeapSlot() - スロットを解放                  │    │    │
│  │  └─────────────────────────────────────────────────┘    │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 5.3 バインドレスレンダリング (Bindless)

```
┌─────────────────────────────────────────────────────────────────┐
│              バインドレスレンダリング                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  従来のバインディング vs バインドレス:                           │
│                                                                  │
│  従来:                                                           │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  描画コール1:                                            │    │
│  │  SetShaderResourceView(slot0, texture1)                  │    │
│  │  SetShaderResourceView(slot1, texture2)                  │    │
│  │  Draw()                                                  │    │
│  │                                                          │    │
│  │  描画コール2:                                            │    │
│  │  SetShaderResourceView(slot0, texture3)  ← 再バインド   │    │
│  │  SetShaderResourceView(slot1, texture4)  ← 再バインド   │    │
│  │  Draw()                                                  │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  バインドレス:                                                   │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  初期化時:                                               │    │
│  │  ┌─────────────────────────────────────────────────┐    │    │
│  │  │ Global Descriptor Heap                           │    │    │
│  │  │ [tex0] [tex1] [tex2] [tex3] [tex4] [tex5] ...   │    │    │
│  │  │   0      1      2      3      4      5           │    │    │
│  │  └─────────────────────────────────────────────────┘    │    │
│  │                                                          │    │
│  │  描画時:                                                 │    │
│  │  // ヒープは一度だけセット                               │    │
│  │  SetDescriptorHeaps(1, &globalHeap)                      │    │
│  │                                                          │    │
│  │  // シェーダーでインデックスを使用                        │    │
│  │  Draw() // シェーダー内: textures[materialIndex]         │    │
│  │  Draw() // シェーダー内: textures[materialIndex]         │    │
│  │  Draw() // バインディング変更なし!                       │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  FD3D12BindlessDescriptorManager:                                │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  機能:                                                   │    │
│  │  ├── 巨大なグローバルデスクリプタヒープを管理            │    │
│  │  ├── リソース登録時に永続的なインデックスを割り当て       │    │
│  │  ├── シェーダーからはインデックスでアクセス              │    │
│  │  └── 動的リソースの更新をサポート                        │    │
│  │                                                          │    │
│  │  利点:                                                   │    │
│  │  ├── CPU/GPUバインディングオーバーヘッド削減             │    │
│  │  ├── 描画コール間のステート変更最小化                    │    │
│  │  └── GPU駆動レンダリングとの親和性                       │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 6. メモリアロケーション詳細

### 6.1 メモリアロケータの種類

```
┌─────────────────────────────────────────────────────────────────┐
│              メモリアロケータの種類                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  1. Buddy Allocator (バディアロケータ)                   │    │
│  │                                                          │    │
│  │  原理:                                                   │    │
│  │  ┌─────────────────────────────────────────────────┐    │    │
│  │  │ 256KB                                            │    │    │
│  │  │ [          全体ブロック                          ]│    │    │
│  │  │                    │                              │    │    │
│  │  │              分割 ─┴─                            │    │    │
│  │  │ [   128KB   ][   128KB   ]                       │    │    │
│  │  │       │                                           │    │    │
│  │  │ 分割 ─┴─                                          │    │    │
│  │  │ [64KB][64KB][   128KB   ]                        │    │    │
│  │  │                                                   │    │    │
│  │  │ 解放時: 隣接するバディと結合                       │    │    │
│  │  └─────────────────────────────────────────────────┘    │    │
│  │                                                          │    │
│  │  特性:                                                   │    │
│  │  ├── O(log N) のアロケーション/解放                      │    │
│  │  ├── 2のべき乗サイズに丸められる (内部断片化)            │    │
│  │  └── 外部断片化は最小限                                  │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  2. Pool Allocator (プールアロケータ)                    │    │
│  │                                                          │    │
│  │  原理:                                                   │    │
│  │  ┌─────────────────────────────────────────────────┐    │    │
│  │  │ サイズクラスごとにプール                          │    │    │
│  │  │                                                   │    │    │
│  │  │ 64KB Pool:   [■][□][□][■][□][■]                │    │    │
│  │  │ 256KB Pool:  [□][■][□][■]                       │    │    │
│  │  │ 1MB Pool:    [□][■]                              │    │    │
│  │  │                                                   │    │    │
│  │  │ ■ = 使用中, □ = 空き                            │    │    │
│  │  └─────────────────────────────────────────────────┘    │    │
│  │                                                          │    │
│  │  特性:                                                   │    │
│  │  ├── O(1) のアロケーション/解放                          │    │
│  │  ├── サイズクラスに合わない場合は無駄が発生              │    │
│  │  └── 同サイズの連続アロケーションに最適                  │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  3. Bucket Allocator (バケットアロケータ)                │    │
│  │                                                          │    │
│  │  原理:                                                   │    │
│  │  ┌─────────────────────────────────────────────────┐    │    │
│  │  │ Bucket 0 (64B-128B):   [リソース群]              │    │    │
│  │  │ Bucket 1 (128B-256B):  [リソース群]              │    │    │
│  │  │ Bucket 2 (256B-512B):  [リソース群]              │    │    │
│  │  │ ...                                               │    │    │
│  │  │ Bucket N (大):          [個別リソース]            │    │    │
│  │  └─────────────────────────────────────────────────┘    │    │
│  │                                                          │    │
│  │  特性:                                                   │    │
│  │  ├── サイズ範囲ごとにバケットを分類                      │    │
│  │  ├── 小さなアロケーションを効率的に管理                  │    │
│  │  └── 大きなアロケーションは個別ヒープ                    │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  4. SegList Allocator (セグメントリストアロケータ)       │    │
│  │                                                          │    │
│  │  原理:                                                   │    │
│  │  ┌─────────────────────────────────────────────────┐    │    │
│  │  │ ブロックサイズごとにセグメントリストを維持        │    │    │
│  │  │                                                   │    │    │
│  │  │ 64KB Segments:                                    │    │    │
│  │  │ Heap0: [□][■][□][□]                             │    │    │
│  │  │ Heap1: [■][□][■][□]                             │    │    │
│  │  │                                                   │    │    │
│  │  │ 256KB Segments:                                   │    │    │
│  │  │ Heap0: [□][■]                                    │    │    │
│  │  │                                                   │    │    │
│  │  │ ヒープは必要に応じて作成/削除                     │    │    │
│  │  └─────────────────────────────────────────────────┘    │    │
│  │                                                          │    │
│  │  特性:                                                   │    │
│  │  ├── テクスチャアロケーション用に最適化                  │    │
│  │  ├── 同サイズのリソースを効率的にプール                  │    │
│  │  └── メモリ使用量に応じてヒープを動的管理                │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 6.2 リソースアロケーション戦略

```
┌─────────────────────────────────────────────────────────────────┐
│            リソースアロケーション戦略                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  D3D12でのアロケーション方法:                                    │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  1. Committed Resource (コミットリソース)                │    │
│  │                                                          │    │
│  │  ┌───────────────────┐                                  │    │
│  │  │ ID3D12Resource    │ ← 暗黙のヒープを持つ              │    │
│  │  │ [リソース本体]     │                                  │    │
│  │  │ [暗黙のヒープ]     │                                  │    │
│  │  └───────────────────┘                                  │    │
│  │                                                          │    │
│  │  用途:                                                   │    │
│  │  - 大きなリソース                                        │    │
│  │  - プール管理に適さないリソース                          │    │
│  │  - シンプルなケース                                      │    │
│  │                                                          │    │
│  │  API: CreateCommittedResource()                          │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  2. Placed Resource (配置リソース)                       │    │
│  │                                                          │    │
│  │  ┌───────────────────────────────────────────────────┐  │    │
│  │  │ ID3D12Heap (明示的ヒープ)                          │  │    │
│  │  │ ┌──────────┐ ┌──────────┐ ┌──────────┐           │  │    │
│  │  │ │Resource A│ │Resource B│ │Resource C│           │  │    │
│  │  │ └──────────┘ └──────────┘ └──────────┘           │  │    │
│  │  └───────────────────────────────────────────────────┘  │    │
│  │                                                          │    │
│  │  用途:                                                   │    │
│  │  - メモリプーリング                                      │    │
│  │  - サブアロケーション                                    │    │
│  │  - メモリエイリアシング                                  │    │
│  │                                                          │    │
│  │  API: CreateHeap() + CreatePlacedResource()              │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  3. Reserved Resource (予約リソース / タイルリソース)    │    │
│  │                                                          │    │
│  │  ┌───────────────────────────────────────────────────┐  │    │
│  │  │ Virtual Address Space                              │  │    │
│  │  │ ┌────┐ ┌────┐ ┌────┐ ┌────┐ ┌────┐ ┌────┐       │  │    │
│  │  │ │Tile│ │Tile│ │NULL│ │Tile│ │NULL│ │Tile│       │  │    │
│  │  │ │ ↓  │ │ ↓  │ │    │ │ ↓  │ │    │ │ ↓  │       │  │    │
│  │  │ └────┘ └────┘ └────┘ └────┘ └────┘ └────┘       │  │    │
│  │  │   │      │             │             │           │  │    │
│  │  │   ▼      ▼             ▼             ▼           │  │    │
│  │  │ [物理メモリ]                                      │  │    │
│  │  └───────────────────────────────────────────────────┘  │    │
│  │                                                          │    │
│  │  用途:                                                   │    │
│  │  - バーチャルテクスチャ                                  │    │
│  │  - スパースリソース                                      │    │
│  │  - ストリーミング                                        │    │
│  │                                                          │    │
│  │  API: CreateReservedResource() + UpdateTileMappings()    │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 6.3 ヒープタイプとメモリ特性

```
┌─────────────────────────────────────────────────────────────────┐
│              ヒープタイプとメモリ特性                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  D3D12_HEAP_TYPE_DEFAULT                                 │    │
│  │                                                          │    │
│  │  ┌───────────────────────────────────────────────────┐  │    │
│  │  │ GPU                     CPU                        │  │    │
│  │  │ ┌──────────┐           ┌──────────┐               │  │    │
│  │  │ │ 高速読書  │           │ アクセス不可│              │  │    │
│  │  │ └──────────┘           └──────────┘               │  │    │
│  │  └───────────────────────────────────────────────────┘  │    │
│  │                                                          │    │
│  │  用途: レンダーターゲット、テクスチャ、UAV              │    │
│  │  特性: GPU最適化VRAM                                    │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  D3D12_HEAP_TYPE_UPLOAD                                  │    │
│  │                                                          │    │
│  │  ┌───────────────────────────────────────────────────┐  │    │
│  │  │ GPU                     CPU                        │  │    │
│  │  │ ┌──────────┐           ┌──────────┐               │  │    │
│  │  │ │ 読み取り  │ ◀──────── │ 書き込み  │               │  │    │
│  │  │ └──────────┘           └──────────┘               │  │    │
│  │  └───────────────────────────────────────────────────┘  │    │
│  │                                                          │    │
│  │  用途: 頂点/インデックスバッファのステージング           │    │
│  │       コンスタントバッファ、テクスチャアップロード       │    │
│  │  特性: Write-Combined、CPUからマップ可能                 │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  D3D12_HEAP_TYPE_READBACK                                │    │
│  │                                                          │    │
│  │  ┌───────────────────────────────────────────────────┐  │    │
│  │  │ GPU                     CPU                        │  │    │
│  │  │ ┌──────────┐           ┌──────────┐               │  │    │
│  │  │ │ 書き込み  │ ────────▶ │ 読み取り  │               │  │    │
│  │  │ └──────────┘           └──────────┘               │  │    │
│  │  └───────────────────────────────────────────────────┘  │    │
│  │                                                          │    │
│  │  用途: GPUからのデータ読み戻し                           │    │
│  │       スクリーンショット、オクルージョンクエリ結果       │    │
│  │  特性: CPU読み取り最適化                                 │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  D3D12_HEAP_TYPE_CUSTOM (カスタムヒープ)                 │    │
│  │                                                          │    │
│  │  D3D12_CPU_PAGE_PROPERTY:                                │    │
│  │  ├── NOT_AVAILABLE (CPUアクセス不可)                    │    │
│  │  ├── WRITE_COMBINE (書き込み結合)                        │    │
│  │  └── WRITE_BACK (キャッシュ可能)                         │    │
│  │                                                          │    │
│  │  D3D12_MEMORY_POOL:                                      │    │
│  │  ├── L0 (システムメモリ)                                 │    │
│  │  └── L1 (ビデオメモリ)                                   │    │
│  │                                                          │    │
│  │  用途: 高度なメモリ管理が必要な場合                      │    │
│  │       UMA/NUMAアーキテクチャの最適化                     │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 次のパートの内容

Part 4 では以下を解説します：

- レイトレーシングパイプライン
- ワークグラフ
- マルチGPU対応
- フレーム管理とリソースライフサイクル
- プラットフォーム間の違い (Vulkan/Metal対応)
