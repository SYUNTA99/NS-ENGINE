# RHI 実装ガイド Part 4: 高度な機能とプラットフォーム対応

このドキュメントでは、RHI実装における高度な機能を解説します：

- レイトレーシングパイプライン
- ワークグラフ
- マルチGPU対応
- フレーム管理とリソースライフサイクル
- プラットフォーム間の差異

---

## 1. レイトレーシングパイプライン

### 1.1 レイトレーシングの基本構造

```
┌─────────────────────────────────────────────────────────────────┐
│              レイトレーシング基本構造                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │              Ray Tracing Pipeline                         │   │
│  │                                                           │   │
│  │   ┌─────────────┐                                        │   │
│  │   │ Ray Gen     │ ← レイ生成シェーダー                    │   │
│  │   │ Shader      │   (カメラからレイを発射)                │   │
│  │   └─────────────┘                                        │   │
│  │         │                                                 │   │
│  │         │ TraceRay()                                      │   │
│  │         ▼                                                 │   │
│  │   ┌─────────────────────────────────────────────────┐    │   │
│  │   │        Acceleration Structure                    │    │   │
│  │   │   ┌─────────────────────────────────────────┐   │    │   │
│  │   │   │ TLAS (Top-Level AS)                      │   │    │   │
│  │   │   │  ├── Instance 0 → BLAS A                 │   │    │   │
│  │   │   │  ├── Instance 1 → BLAS B                 │   │    │   │
│  │   │   │  └── Instance N → BLAS C                 │   │    │   │
│  │   │   └─────────────────────────────────────────┘   │    │   │
│  │   │                    │                             │    │   │
│  │   │   ┌─────────────────────────────────────────┐   │    │   │
│  │   │   │ BLAS (Bottom-Level AS)                   │   │    │   │
│  │   │   │  └── Geometry (Triangles/AABBs)          │   │    │   │
│  │   │   └─────────────────────────────────────────┘   │    │   │
│  │   └─────────────────────────────────────────────────┘    │   │
│  │         │                                                 │   │
│  │   ┌─────┴─────┐                                          │   │
│  │   │ Hit?      │                                          │   │
│  │   └─────┬─────┘                                          │   │
│  │    Yes ─┤                                                 │   │
│  │         │                                                 │   │
│  │   ┌─────┴─────┐  ┌─────────────┐  ┌─────────────┐       │   │
│  │   │ Any Hit   │  │ Closest Hit │  │ Miss        │       │   │
│  │   │ Shader    │  │ Shader      │  │ Shader      │       │   │
│  │   └───────────┘  └─────────────┘  └─────────────┘       │   │
│  │                                                           │   │
│  └──────────────────────────────────────────────────────────┘   │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 1.2 アクセラレーション構造の階層

```
┌─────────────────────────────────────────────────────────────────┐
│           アクセラレーション構造の階層                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  TLAS (Top-Level Acceleration Structure)                         │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  インスタンスごとの情報:                                  │    │
│  │  ┌─────────────────────────────────────────────────┐    │    │
│  │  │ Instance Desc:                                   │    │    │
│  │  │  ├── Transform (3x4 行列)                        │    │    │
│  │  │  ├── InstanceID (シェーダーで参照)               │    │    │
│  │  │  ├── InstanceMask (可視性フィルタ)               │    │    │
│  │  │  ├── InstanceContributionToHitGroupIndex        │    │    │
│  │  │  ├── Flags (カリング等)                          │    │    │
│  │  │  └── AccelerationStructure (BLASへのポインタ)    │    │    │
│  │  └─────────────────────────────────────────────────┘    │    │
│  │                                                          │    │
│  │  ビルドオプション:                                        │    │
│  │  - PREFER_FAST_TRACE: レイトレース高速化優先             │    │
│  │  - PREFER_FAST_BUILD: ビルド高速化優先                   │    │
│  │  - ALLOW_UPDATE: 更新可能 (動的シーン用)                 │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  BLAS (Bottom-Level Acceleration Structure)                      │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  ジオメトリタイプ:                                        │    │
│  │                                                          │    │
│  │  1. 三角形ジオメトリ                                      │    │
│  │  ┌─────────────────────────────────────────────────┐    │    │
│  │  │ D3D12_RAYTRACING_GEOMETRY_DESC:                  │    │    │
│  │  │  ├── Type = TRIANGLES                            │    │    │
│  │  │  ├── Flags (OPAQUE, NO_DUPLICATE_ANYHIT等)      │    │    │
│  │  │  └── Triangles:                                  │    │    │
│  │  │       ├── Transform3x4 (オプション)              │    │    │
│  │  │       ├── IndexFormat + IndexBuffer              │    │    │
│  │  │       ├── VertexFormat + VertexBuffer            │    │    │
│  │  │       └── VertexCount / IndexCount               │    │    │
│  │  └─────────────────────────────────────────────────┘    │    │
│  │                                                          │    │
│  │  2. プロシージャルジオメトリ (AABB)                       │    │
│  │  ┌─────────────────────────────────────────────────┐    │    │
│  │  │ D3D12_RAYTRACING_GEOMETRY_DESC:                  │    │    │
│  │  │  ├── Type = PROCEDURAL_PRIMITIVE_AABBS           │    │    │
│  │  │  └── AABBs:                                      │    │    │
│  │  │       ├── AABBCount                              │    │    │
│  │  │       └── AABBs (D3D12_RAYTRACING_AABB配列)      │    │    │
│  │  └─────────────────────────────────────────────────┘    │    │
│  │                                                          │    │
│  │  コンパクション:                                          │    │
│  │  ┌─────────────────────────────────────────────────┐    │    │
│  │  │ ビルド後に実際のサイズを取得し、                  │    │    │
│  │  │ より小さなバッファにコピーしてメモリ節約          │    │    │
│  │  │                                                   │    │    │
│  │  │ PostBuildInfo → CompactedSize → CopyAS           │    │    │
│  │  └─────────────────────────────────────────────────┘    │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 1.3 レイトレーシングパイプラインステート

```
┌─────────────────────────────────────────────────────────────────┐
│         レイトレーシングパイプラインステート                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  FD3D12RayTracingPipelineState 構造:                             │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  シェーダーライブラリ:                                    │    │
│  │  ├── RayGenShaders[]    (レイ生成シェーダー群)           │    │
│  │  ├── MissShaders[]      (ミスシェーダー群)               │    │
│  │  ├── HitGroupShaders[]  (ヒットグループ群)               │    │
│  │  └── CallableShaders[]  (呼び出し可能シェーダー群)       │    │
│  │                                                          │    │
│  │  StateObject (ID3D12StateObject):                        │    │
│  │  ├── すべてのシェーダーを含むコンパイル済みパイプライン  │    │
│  │  └── シェーダー識別子 (32バイト) をエクスポート          │    │
│  │                                                          │    │
│  │  GlobalRootSignature:                                    │    │
│  │  └── 全シェーダーで共有されるリソースバインディング      │    │
│  │                                                          │    │
│  │  MaxLocalRootSignatureSize:                              │    │
│  │  └── ヒットグループごとの最大ローカルルート署名サイズ    │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  シェーダー識別子 (FD3D12ShaderIdentifier):                      │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  struct FD3D12ShaderIdentifier {                         │    │
│  │      uint64 Data[4];  // 32バイト = 256ビット            │    │
│  │  };                                                      │    │
│  │                                                          │    │
│  │  用途:                                                   │    │
│  │  - SBT (Shader Binding Table) のレコードに格納           │    │
│  │  - GPUがどのシェーダーを実行するかを特定                  │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 1.4 シェーダーバインディングテーブル (SBT)

```
┌─────────────────────────────────────────────────────────────────┐
│           シェーダーバインディングテーブル (SBT)                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  SBT構造:                                                        │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  ┌─────────────────────────────────────────────────┐    │    │
│  │  │ Ray Generation Shader Records                    │    │    │
│  │  │ ┌───────────────────────────────────────────┐   │    │    │
│  │  │ │ [Shader ID] [Local Root Args] (パディング) │   │    │    │
│  │  │ └───────────────────────────────────────────┘   │    │    │
│  │  └─────────────────────────────────────────────────┘    │    │
│  │                                                          │    │
│  │  ┌─────────────────────────────────────────────────┐    │    │
│  │  │ Miss Shader Records                              │    │    │
│  │  │ ┌───────────────────────────────────────────┐   │    │    │
│  │  │ │ Miss 0: [Shader ID] [Local Args]           │   │    │    │
│  │  │ │ Miss 1: [Shader ID] [Local Args]           │   │    │    │
│  │  │ │ ...                                        │   │    │    │
│  │  │ └───────────────────────────────────────────┘   │    │    │
│  │  └─────────────────────────────────────────────────┘    │    │
│  │                                                          │    │
│  │  ┌─────────────────────────────────────────────────┐    │    │
│  │  │ Hit Group Records                                │    │    │
│  │  │ ┌───────────────────────────────────────────┐   │    │    │
│  │  │ │ Instance 0, Geo 0, Ray 0: [ID] [Args]      │   │    │    │
│  │  │ │ Instance 0, Geo 0, Ray 1: [ID] [Args]      │   │    │    │
│  │  │ │ Instance 0, Geo 1, Ray 0: [ID] [Args]      │   │    │    │
│  │  │ │ ...                                        │   │    │    │
│  │  │ └───────────────────────────────────────────┘   │    │    │
│  │  └─────────────────────────────────────────────────┘    │    │
│  │                                                          │    │
│  │  ┌─────────────────────────────────────────────────┐    │    │
│  │  │ Callable Shader Records (オプション)             │    │    │
│  │  │ ┌───────────────────────────────────────────┐   │    │    │
│  │  │ │ Callable 0: [Shader ID] [Local Args]       │   │    │    │
│  │  │ │ ...                                        │   │    │    │
│  │  │ └───────────────────────────────────────────┘   │    │    │
│  │  └─────────────────────────────────────────────────┘    │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  ヒットグループインデックス計算:                                 │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  HitGroupIndex =                                         │    │
│  │      InstanceContributionToHitGroupIndex                 │    │
│  │    + (GeometryIndex * NumRayTypes)                       │    │
│  │    + RayContributionToHitGroupIndex                      │    │
│  │                                                          │    │
│  │  RecordAddress = HitGroupTableStart                      │    │
│  │                + (HitGroupIndex * HitGroupRecordSize)    │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 1.5 レイトレーシング実装の要点

```
┌─────────────────────────────────────────────────────────────────┐
│           レイトレーシング実装の要点                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  1. アクセラレーション構造の管理                                 │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  FD3D12RayTracingGeometry (BLAS):                        │    │
│  │  ├── AccelerationStructureBuffers[MAX_NUM_GPUS]         │    │
│  │  │   (GPUごとのASバッファ)                               │    │
│  │  │                                                       │    │
│  │  ├── GeometryDescs[]                                     │    │
│  │  │   (ビルド用のジオメトリ記述子)                         │    │
│  │  │                                                       │    │
│  │  ├── HitGroupSystemParameters[MAX_NUM_GPUS][]            │    │
│  │  │   (セグメントごとのヒットグループパラメータ)           │    │
│  │  │                                                       │    │
│  │  └── ダーティフラグ、コンパクションリクエスト管理        │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  2. シーン管理                                                   │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  FD3D12RayTracingScene (TLAS):                           │    │
│  │  ├── AccelerationStructureBuffers[MAX_NUM_GPUS]         │    │
│  │  │                                                       │    │
│  │  ├── ReferencedGeometries[]                              │    │
│  │  │   (参照しているBLASの配列)                            │    │
│  │  │                                                       │    │
│  │  ├── ResourcesToMakeResident[]                           │    │
│  │  │   (レジデンシー確保が必要なリソース)                  │    │
│  │  │                                                       │    │
│  │  └── NumInstances, bBuilt                                │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  3. コンパクション処理                                           │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  FD3D12RayTracingCompactionRequestHandler:               │    │
│  │                                                          │    │
│  │  フロー:                                                 │    │
│  │  ┌─────────────────────────────────────────────────┐    │    │
│  │  │ 1. BLASビルド (ALLOW_COMPACTIONフラグ付き)       │    │    │
│  │  │        │                                         │    │    │
│  │  │        ▼                                         │    │    │
│  │  │ 2. PostBuildInfo取得 (コンパクト後サイズ)        │    │    │
│  │  │        │                                         │    │    │
│  │  │        ▼                                         │    │    │
│  │  │ 3. GPUから結果読み戻し (Readbackバッファ)        │    │    │
│  │  │        │                                         │    │    │
│  │  │        ▼                                         │    │    │
│  │  │ 4. 新しいコンパクトバッファ確保                  │    │    │
│  │  │        │                                         │    │    │
│  │  │        ▼                                         │    │    │
│  │  │ 5. CopyRaytracingAccelerationStructure           │    │    │
│  │  │        │                                         │    │    │
│  │  │        ▼                                         │    │    │
│  │  │ 6. 古いバッファ解放                              │    │    │
│  │  └─────────────────────────────────────────────────┘    │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 2. ワークグラフ

### 2.1 ワークグラフの概要

```
┌─────────────────────────────────────────────────────────────────┐
│               ワークグラフの概要                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ワークグラフは、GPU上で動的にワークを生成・実行する仕組み       │
│                                                                  │
│  従来のモデル:                                                   │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  CPU ────▶ Dispatch(X, Y, Z) ────▶ GPU実行               │    │
│  │        │                                                 │    │
│  │        │  ワーク量はCPUが事前に決定                      │    │
│  │        │                                                 │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  ワークグラフモデル:                                             │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  CPU ────▶ DispatchGraph(初期ワーク) ────▶ GPU           │    │
│  │                                               │           │    │
│  │                                        ┌──────┴──────┐   │    │
│  │                                        │ Node A      │   │    │
│  │                                        │ (シェーダー) │   │    │
│  │                                        └──────┬──────┘   │    │
│  │                                        出力レコード       │    │
│  │                                    ┌─────┴─────┐         │    │
│  │                              ┌─────┴─────┐ ┌───┴───┐     │    │
│  │                              │ Node B    │ │ Node C │     │    │
│  │                              │ (シェーダー) │ │(シェーダー)│     │    │
│  │                              └───────────┘ └───────┘     │    │
│  │                                                          │    │
│  │  GPUがワークを動的に生成                                  │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 ワークグラフパイプラインステート

```
┌─────────────────────────────────────────────────────────────────┐
│          ワークグラフパイプラインステート                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  FD3D12WorkGraphPipelineState 構造:                              │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  RootSignature:                                          │    │
│  │  └── グラフ全体で共有されるリソースバインディング        │    │
│  │                                                          │    │
│  │  StateObject (ID3D12StateObject):                        │    │
│  │  └── コンパイル済みのワークグラフ定義                    │    │
│  │                                                          │    │
│  │  ProgramIdentifier:                                      │    │
│  │  └── グラフを識別するID (DispatchGraph時に指定)          │    │
│  │                                                          │    │
│  │  BackingMemoryAddressRange:                              │    │
│  │  └── GPUが使用する作業メモリの範囲                       │    │
│  │                                                          │    │
│  │  NodeCountPerName:                                       │    │
│  │  └── ノード名とノード数のマッピング                      │    │
│  │                                                          │    │
│  │  RootArgOffsets[] / RootArgStrideInBytes:                │    │
│  │  └── ノードごとのルートアーギュメントオフセット          │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  使用例:                                                         │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  1. LODカリング                                          │    │
│  │     ┌────────────┐                                      │    │
│  │     │ Culling    │                                      │    │
│  │     │ Node       │                                      │    │
│  │     └──────┬─────┘                                      │    │
│  │            │ 可視オブジェクトのみ出力                    │    │
│  │            ▼                                             │    │
│  │     ┌────────────┐                                      │    │
│  │     │ Draw Node  │                                      │    │
│  │     └────────────┘                                      │    │
│  │                                                          │    │
│  │  2. プロシージャル生成                                    │    │
│  │     ┌────────────┐                                      │    │
│  │     │ Generator  │                                      │    │
│  │     │ Node       │                                      │    │
│  │     └──────┬─────┘                                      │    │
│  │            │ 生成されたプリミティブを出力                │    │
│  │            ▼                                             │    │
│  │     ┌────────────┐                                      │    │
│  │     │ Process    │                                      │    │
│  │     │ Node       │                                      │    │
│  │     └────────────┘                                      │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 3. マルチGPU対応

### 3.1 マルチGPUアーキテクチャ

```
┌─────────────────────────────────────────────────────────────────┐
│              マルチGPUアーキテクチャ                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │                    FD3D12Adapter                          │   │
│  │                  (物理GPUまたはLDA)                        │   │
│  ├──────────────────────────────────────────────────────────┤   │
│  │                                                           │   │
│  │   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐      │   │
│  │   │ Device 0    │  │ Device 1    │  │ Device N    │      │   │
│  │   │ (GPU Node 0)│  │ (GPU Node 1)│  │ (GPU Node N)│      │   │
│  │   └─────────────┘  └─────────────┘  └─────────────┘      │   │
│  │         │                │                 │              │   │
│  │         │                │                 │              │   │
│  │   ┌─────┴────────────────┴─────────────────┴─────┐       │   │
│  │   │           Cross-Node Resources                │       │   │
│  │   │  (GPUノード間で共有または転送が必要なリソース)│       │   │
│  │   └──────────────────────────────────────────────┘       │   │
│  │                                                           │   │
│  └──────────────────────────────────────────────────────────┘   │
│                                                                  │
│  MAX_NUM_GPUS:                                                   │
│  - コンパイル時定数 (通常4または8)                               │
│  - 配列サイズの決定に使用                                        │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 GPU マスクとリソース配置

```
┌─────────────────────────────────────────────────────────────────┐
│             GPU マスクとリソース配置                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  FRHIGPUMask:                                                    │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  ビットマスクでGPUを指定:                                 │    │
│  │                                                          │    │
│  │  GPU 0 のみ:        0b0001                               │    │
│  │  GPU 1 のみ:        0b0010                               │    │
│  │  GPU 0 と 1:        0b0011                               │    │
│  │  全GPU (4つ):       0b1111                               │    │
│  │                                                          │    │
│  │  操作:                                                   │    │
│  │  - GetFirstIndex()    最初のセットビットのインデックス   │    │
│  │  - GetNumActive()     セットされたビットの数             │    │
│  │  - Contains(Index)    指定インデックスが含まれるか       │    │
│  │  - Intersect(Mask)    マスクの論理積                     │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  リソース作成のGPUマスク:                                        │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  CreationNode (作成ノード):                              │    │
│  │  └── リソースが物理的に存在するGPU                       │    │
│  │                                                          │    │
│  │  VisibilityMask (可視性マスク):                          │    │
│  │  └── リソースにアクセス可能なGPU群                       │    │
│  │                                                          │    │
│  │  例:                                                     │    │
│  │  ┌─────────────────────────────────────────────────┐    │    │
│  │  │ Creation: GPU 0                                  │    │    │
│  │  │ Visibility: GPU 0, 1, 2                          │    │    │
│  │  │                                                   │    │    │
│  │  │  GPU 0: 直接アクセス (ローカル)                   │    │    │
│  │  │  GPU 1: PCIe経由アクセス                          │    │    │
│  │  │  GPU 2: PCIe経由アクセス                          │    │    │
│  │  └─────────────────────────────────────────────────┘    │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 3.3 AFR (Alternate Frame Rendering)

```
┌─────────────────────────────────────────────────────────────────┐
│             AFR (Alternate Frame Rendering)                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  基本概念:                                                       │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  時間 ────────────────────────────────────────────▶      │    │
│  │                                                          │    │
│  │  GPU 0: [Frame 0] [       ] [Frame 2] [       ]          │    │
│  │  GPU 1: [       ] [Frame 1] [       ] [Frame 3]          │    │
│  │                                                          │    │
│  │  各GPUが交互にフレームをレンダリング                      │    │
│  │  → フレームレート向上                                    │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  課題と対策:                                                     │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  1. 時間的依存性                                         │    │
│  │     ┌─────────────────────────────────────────────┐     │    │
│  │     │ モーションベクターの転送が必要               │     │    │
│  │     │ TAA、モーションブラー等に影響               │     │    │
│  │     └─────────────────────────────────────────────┘     │    │
│  │                                                          │    │
│  │  2. リソースの複製                                        │    │
│  │     ┌─────────────────────────────────────────────┐     │    │
│  │     │ 各GPUに同じテクスチャを配置                  │     │    │
│  │     │ メモリ使用量が増加                          │     │    │
│  │     └─────────────────────────────────────────────┘     │    │
│  │                                                          │    │
│  │  3. GPU間転送                                             │    │
│  │     ┌─────────────────────────────────────────────┐     │    │
│  │     │ 前フレームの結果を次のGPUへ転送             │     │    │
│  │     │ PCIeバンド幅がボトルネックになりうる        │     │    │
│  │     └─────────────────────────────────────────────┘     │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 4. フレーム管理とリソースライフサイクル

### 4.1 フレームの流れ

```
┌─────────────────────────────────────────────────────────────────┐
│                フレームの流れ                                     │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                    Frame N                               │    │
│  │                                                          │    │
│  │  1. BeginFrame                                           │    │
│  │     ├── フェンス値の進行                                 │    │
│  │     ├── 遅延削除リソースのクリーンアップ                 │    │
│  │     └── フレームリソースの準備                           │    │
│  │                │                                         │    │
│  │                ▼                                         │    │
│  │  2. コマンド記録フェーズ                                  │    │
│  │     ├── GetContext() でコマンドコンテキスト取得          │    │
│  │     ├── 各種描画/コンピュートコマンドを記録              │    │
│  │     └── リソース遷移/バリア                              │    │
│  │                │                                         │    │
│  │                ▼                                         │    │
│  │  3. コマンド実行                                          │    │
│  │     ├── ExecuteCommandLists()                            │    │
│  │     └── コマンドリストをキューに送信                     │    │
│  │                │                                         │    │
│  │                ▼                                         │    │
│  │  4. Present                                               │    │
│  │     ├── スワップチェーンのプレゼント                     │    │
│  │     └── フェンスシグナル                                 │    │
│  │                │                                         │    │
│  │                ▼                                         │    │
│  │  5. EndFrame                                              │    │
│  │     ├── フレームフェンスの進行                           │    │
│  │     ├── 統計情報の収集                                   │    │
│  │     └── 次フレームの準備                                 │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 4.2 フレームインフライト管理

```
┌─────────────────────────────────────────────────────────────────┐
│            フレームインフライト管理                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  概念:                                                           │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  CPU と GPU の並列実行を最大化するため、                   │    │
│  │  複数フレームを同時に処理                                 │    │
│  │                                                          │    │
│  │  時間 ─────────────────────────────────────────────▶     │    │
│  │                                                          │    │
│  │  CPU: [記録N] [記録N+1] [記録N+2] [待機] [記録N+3]        │    │
│  │                                                          │    │
│  │  GPU:     [実行N] [実行N+1] [実行N+2] [実行N+3]          │    │
│  │                                                          │    │
│  │  インフライト数 = 3 の場合、                              │    │
│  │  CPUはN+2まで先行して記録可能                             │    │
│  │  N+3を記録する前にNの完了を待機                           │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  リソース管理の影響:                                             │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  フレームごとのリソース:                                  │    │
│  │  ├── コマンドアロケーター (フレームごとにリセット)       │    │
│  │  ├── アップロードバッファ (フレームごとに再利用)         │    │
│  │  └── デスクリプタブロック (フレーム終了後に再利用)       │    │
│  │                                                          │    │
│  │  インフライト数分のリソースセットが必要:                  │    │
│  │  ┌─────────────────────────────────────────────────┐    │    │
│  │  │ Frame N:   [Allocator A] [Upload A] [Desc A]    │    │    │
│  │  │ Frame N+1: [Allocator B] [Upload B] [Desc B]    │    │    │
│  │  │ Frame N+2: [Allocator C] [Upload C] [Desc C]    │    │    │
│  │  └─────────────────────────────────────────────────┘    │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 4.3 遅延削除システム

```
┌─────────────────────────────────────────────────────────────────┐
│               遅延削除システム                                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  問題:                                                           │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  CPUで「delete Resource」を呼んでも、                     │    │
│  │  GPUはまだそのリソースを使用中かもしれない                │    │
│  │                                                          │    │
│  │  危険な例:                                               │    │
│  │  CPU: CommandList->Draw(Texture)                         │    │
│  │  CPU: delete Texture  ← GPU実行前に削除！                │    │
│  │  GPU: Draw(???)       ← 無効なリソースアクセス           │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  解決策 - 遅延削除キュー:                                        │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  struct DeferredDeleteEntry {                            │    │
│  │      IUnknown* Resource;                                 │    │
│  │      uint64 FenceValue;  // この値以上になったら安全     │    │
│  │  };                                                      │    │
│  │                                                          │    │
│  │  フロー:                                                 │    │
│  │  ┌─────────────────────────────────────────────────┐    │    │
│  │  │ 1. リソース解放リクエスト                        │    │    │
│  │  │    DeferredDeleteQueue.Add({Resource, CurrentFence})│    │    │
│  │  │                                                   │    │    │
│  │  │ 2. フレーム開始時にクリーンアップ                 │    │    │
│  │  │    for (entry : DeferredDeleteQueue)              │    │    │
│  │  │        if (GPU.CompletedFence >= entry.FenceValue)│    │    │
│  │  │            entry.Resource->Release()              │    │    │
│  │  │            Queue.Remove(entry)                    │    │    │
│  │  └─────────────────────────────────────────────────┘    │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  RetiredBlock 構造体の例:                                        │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  struct RetiredBlock {                                   │    │
│  │      FD3D12Resource* PlacedResource;                     │    │
│  │      uint64 FrameFence;                                  │    │
│  │      FD3D12BuddyAllocatorPrivateData Data;              │    │
│  │      uint32 AllocationSize;  // 統計用                   │    │
│  │  };                                                      │    │
│  │                                                          │    │
│  │  TArray<RetiredBlock> DeferredDeletionQueue;             │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 5. プラットフォーム間の差異

### 5.1 D3D12 vs Vulkan vs Metal

```
┌─────────────────────────────────────────────────────────────────┐
│             プラットフォーム間の差異                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                      D3D12                               │    │
│  ├─────────────────────────────────────────────────────────┤    │
│  │  シェーダー: HLSL → DXIL/DXBC                            │    │
│  │  パイプライン: Pipeline State Object (PSO)              │    │
│  │  デスクリプタ: Descriptor Heap + Tables                  │    │
│  │  同期: ID3D12Fence                                       │    │
│  │  バリア: ID3D12GraphicsCommandList::ResourceBarrier     │    │
│  │  メモリ: ID3D12Heap + Placed/Committed Resources        │    │
│  │  RT: DXR (DirectX Raytracing)                           │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                      Vulkan                              │    │
│  ├─────────────────────────────────────────────────────────┤    │
│  │  シェーダー: GLSL/HLSL → SPIR-V                          │    │
│  │  パイプライン: VkPipeline + VkPipelineLayout            │    │
│  │  デスクリプタ: Descriptor Set + Layout + Pool           │    │
│  │  同期: VkSemaphore (GPU-GPU), VkFence (CPU-GPU)         │    │
│  │  バリア: vkCmdPipelineBarrier + ImageMemoryBarrier      │    │
│  │  メモリ: VkDeviceMemory + VkBuffer/VkImage              │    │
│  │  RT: VK_KHR_ray_tracing_pipeline                        │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                       Metal                              │    │
│  ├─────────────────────────────────────────────────────────┤    │
│  │  シェーダー: Metal Shading Language (MSL)               │    │
│  │  パイプライン: MTLRenderPipelineState/ComputePipeline   │    │
│  │  デスクリプタ: Argument Buffer + Argument Encoder       │    │
│  │  同期: MTLEvent, MTLFence                               │    │
│  │  バリア: memoryBarrier + textureBarrier                 │    │
│  │  メモリ: MTLHeap + MTLBuffer/MTLTexture                 │    │
│  │  RT: Intersection Functions + Acceleration Structure    │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 5.2 主要な概念のマッピング

```
┌─────────────────────────────────────────────────────────────────┐
│              主要な概念のマッピング                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌──────────────┬──────────────┬──────────────┬──────────────┐  │
│  │   UE RHI     │    D3D12     │    Vulkan    │    Metal     │  │
│  ├──────────────┼──────────────┼──────────────┼──────────────┤  │
│  │FDynamicRHI   │ID3D12Device  │VkDevice      │MTLDevice     │  │
│  ├──────────────┼──────────────┼──────────────┼──────────────┤  │
│  │FRHIBuffer    │ID3D12Resource│VkBuffer      │MTLBuffer     │  │
│  ├──────────────┼──────────────┼──────────────┼──────────────┤  │
│  │FRHITexture   │ID3D12Resource│VkImage       │MTLTexture    │  │
│  ├──────────────┼──────────────┼──────────────┼──────────────┤  │
│  │FRHISampler   │D3D12_SAMPLER │VkSampler     │MTLSamplerState│ │
│  │              │_DESC         │              │              │  │
│  ├──────────────┼──────────────┼──────────────┼──────────────┤  │
│  │FRHIShader    │Bytecode      │VkShaderModule│MTLFunction   │  │
│  ├──────────────┼──────────────┼──────────────┼──────────────┤  │
│  │GPSO          │ID3D12Pipeline│VkPipeline    │MTLRender     │  │
│  │              │State         │              │PipelineState │  │
│  ├──────────────┼──────────────┼──────────────┼──────────────┤  │
│  │CommandList   │ID3D12Graphics│VkCommandBuffer│MTLCommand   │  │
│  │              │CommandList   │              │Buffer        │  │
│  ├──────────────┼──────────────┼──────────────┼──────────────┤  │
│  │Queue         │ID3D12Command │VkQueue       │MTLCommand    │  │
│  │              │Queue         │              │Queue         │  │
│  ├──────────────┼──────────────┼──────────────┼──────────────┤  │
│  │Fence         │ID3D12Fence   │VkFence/      │MTLFence/     │  │
│  │              │              │Semaphore     │Event         │  │
│  └──────────────┴──────────────┴──────────────┴──────────────┘  │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 5.3 バリア/遷移の違い

```
┌─────────────────────────────────────────────────────────────────┐
│              バリア/遷移の違い                                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  D3D12:                                                          │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  D3D12_RESOURCE_BARRIER barrier = {};                    │    │
│  │  barrier.Type = D3D12_RESOURCE_BARRIER_TYPE_TRANSITION;  │    │
│  │  barrier.Transition.pResource = resource;                │    │
│  │  barrier.Transition.StateBefore = RENDER_TARGET;         │    │
│  │  barrier.Transition.StateAfter = SHADER_RESOURCE;        │    │
│  │  barrier.Transition.Subresource = ALL_SUBRESOURCES;      │    │
│  │                                                          │    │
│  │  commandList->ResourceBarrier(1, &barrier);              │    │
│  │                                                          │    │
│  │  ステート: 単一の「状態」で管理                          │    │
│  │  例: RENDER_TARGET, SHADER_RESOURCE, COPY_DEST等        │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  Vulkan:                                                         │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  VkImageMemoryBarrier barrier = {};                      │    │
│  │  barrier.srcAccessMask = VK_ACCESS_COLOR_ATTACHMENT_WRITE│    │
│  │  barrier.dstAccessMask = VK_ACCESS_SHADER_READ;          │    │
│  │  barrier.oldLayout = VK_IMAGE_LAYOUT_COLOR_ATTACHMENT;   │    │
│  │  barrier.newLayout = VK_IMAGE_LAYOUT_SHADER_READ_ONLY;   │    │
│  │  barrier.srcQueueFamilyIndex = graphicsFamily;           │    │
│  │  barrier.dstQueueFamilyIndex = graphicsFamily;           │    │
│  │                                                          │    │
│  │  vkCmdPipelineBarrier(cmd,                               │    │
│  │      VK_PIPELINE_STAGE_COLOR_ATTACHMENT_OUTPUT_BIT,      │    │
│  │      VK_PIPELINE_STAGE_FRAGMENT_SHADER_BIT,              │    │
│  │      0, 0, nullptr, 0, nullptr, 1, &barrier);            │    │
│  │                                                          │    │
│  │  3つの側面:                                               │    │
│  │  - AccessMask: メモリアクセスの種類                       │    │
│  │  - Layout: イメージレイアウト                             │    │
│  │  - Pipeline Stage: 同期するパイプラインステージ          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  Metal:                                                          │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  // 明示的なバリアはなく、                               │    │
│  │  // エンコーダー境界で自動的に同期                       │    │
│  │                                                          │    │
│  │  [renderEncoder endEncoding];                            │    │
│  │  // ここで自動バリア                                     │    │
│  │  [computeEncoder setTexture:texture atIndex:0];          │    │
│  │                                                          │    │
│  │  // 明示的に必要な場合:                                   │    │
│  │  [encoder memoryBarrierWithScope:MTLBarrierScopeTextures │    │
│  │                     afterStages:MTLRenderStageFragment   │    │
│  │                    beforeStages:MTLRenderStageVertex];   │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## まとめ

新しいRHIバックエンドを実装する際は、以下の優先順位で進めることを推奨します：

```
┌─────────────────────────────────────────────────────────────────┐
│                実装の推奨順序                                     │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  フェーズ1: 基盤 (必須)                                          │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ □ モジュール設定 (Build.cs)                              │    │
│  │ □ FDynamicRHI基本実装                                    │    │
│  │ □ デバイス/アダプター初期化                              │    │
│  │ □ キュー管理                                             │    │
│  │ □ 基本的なフェンス/同期                                  │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  フェーズ2: リソース (必須)                                      │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ □ バッファ作成/管理                                      │    │
│  │ □ テクスチャ作成/管理                                    │    │
│  │ □ ビュー (SRV/UAV/RTV/DSV)                               │    │
│  │ □ サンプラー                                             │    │
│  │ □ メモリアロケーター (基本)                              │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  フェーズ3: パイプライン (必須)                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ □ シェーダーコンパイル/ロード                            │    │
│  │ □ ルートシグネチャ/バインディングレイアウト              │    │
│  │ □ グラフィックスPSO                                      │    │
│  │ □ コンピュートPSO                                        │    │
│  │ □ PSOキャッシュ                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  フェーズ4: コマンド実行 (必須)                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ □ コマンドコンテキスト/リスト                            │    │
│  │ □ 描画コマンド                                           │    │
│  │ □ コンピュートディスパッチ                               │    │
│  │ □ リソース遷移/バリア                                    │    │
│  │ □ コピーコマンド                                         │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  フェーズ5: デスクリプタ管理 (必須)                              │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ □ オフラインデスクリプタ管理                             │    │
│  │ □ オンラインデスクリプタ管理                             │    │
│  │ □ デスクリプタテーブル更新                               │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  フェーズ6: 最適化 (推奨)                                        │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ □ 高度なメモリアロケーター                               │    │
│  │ □ バインドレスレンダリング                               │    │
│  │ □ 非同期コンピュート                                     │    │
│  │ □ 非同期コピー                                           │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  フェーズ7: 高度な機能 (オプション)                              │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ □ レイトレーシング                                       │    │
│  │ □ メッシュシェーダー                                     │    │
│  │ □ ワークグラフ                                           │    │
│  │ □ マルチGPU                                              │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

各パートの参照:
- Part 1: モジュール設定、FDynamicRHI、アダプター、デバイス、キュー
- Part 2: コマンドコンテキスト、バッファ、テクスチャ、ビュー
- Part 3: シェーダー、PSO、ルートシグネチャ、同期、デスクリプタ、メモリ
- Part 4: レイトレーシング、ワークグラフ、マルチGPU、フレーム管理
