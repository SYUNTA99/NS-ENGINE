# RHI 実装ガイド Part 5: 描画フロー、スワップチェーン、デバッグ

このドキュメントでは、実際の描画フローに関わる詳細を解説します：

- スワップチェーンとPresent
- レンダーパス
- 描画コマンドの詳細
- コピーコマンド
- 状態バインディング
- クエリシステム
- デバッグ/プロファイリング

---

## 1. スワップチェーンとPresent

### 1.1 スワップチェーンの基本概念

```
┌─────────────────────────────────────────────────────────────────┐
│              スワップチェーンの基本概念                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  スワップチェーン: ディスプレイに表示するバックバッファの管理     │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │              ┌─────────────────────────┐                │    │
│  │              │     ディスプレイ         │                │    │
│  │              │   (Front Buffer表示中)   │                │    │
│  │              └───────────▲─────────────┘                │    │
│  │                          │ Present                       │    │
│  │  ┌──────────────────────────────────────────────────┐   │    │
│  │  │              Swap Chain                           │   │    │
│  │  │  ┌────────┐  ┌────────┐  ┌────────┐             │   │    │
│  │  │  │Buffer 0│  │Buffer 1│  │Buffer 2│  (トリプル)  │   │    │
│  │  │  │(Front) │  │(Back)  │  │(Back)  │  バッファ   │   │    │
│  │  │  └────────┘  └────────┘  └────────┘             │   │    │
│  │  │       ▲          │           │                   │   │    │
│  │  │       │          │           │                   │   │    │
│  │  │       └──────────┴───────────┘                   │   │    │
│  │  │              ローテーション                       │   │    │
│  │  └──────────────────────────────────────────────────┘   │    │
│  │                                                          │    │
│  │  GPU が描画 ──▶ Back Buffer                              │    │
│  │  Present   ──▶ Front/Back を交換                         │    │
│  │  表示      ──▶ Front Buffer をディスプレイへ             │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 1.2 スワップチェーン作成パラメータ

```
┌─────────────────────────────────────────────────────────────────┐
│            スワップチェーン作成パラメータ                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  必須パラメータ                                          │    │
│  ├─────────────────────────────────────────────────────────┤    │
│  │                                                          │    │
│  │  Width / Height:                                         │    │
│  │  └── バックバッファの解像度                              │    │
│  │                                                          │    │
│  │  Format:                                                 │    │
│  │  └── ピクセルフォーマット                                │    │
│  │      ├── DXGI_FORMAT_R8G8B8A8_UNORM (SDR)               │    │
│  │      ├── DXGI_FORMAT_R10G10B10A2_UNORM (HDR)            │    │
│  │      └── DXGI_FORMAT_R16G16B16A16_FLOAT (HDR/Wide)      │    │
│  │                                                          │    │
│  │  BufferCount:                                            │    │
│  │  └── バックバッファ数                                    │    │
│  │      ├── 2: ダブルバッファ                               │    │
│  │      └── 3: トリプルバッファ (推奨)                      │    │
│  │                                                          │    │
│  │  WindowHandle (HWND / NSWindow / etc.):                  │    │
│  │  └── 表示先ウィンドウ                                    │    │
│  │                                                          │    │
│  │  SwapEffect:                                             │    │
│  │  └── スワップの方式                                      │    │
│  │      ├── FLIP_SEQUENTIAL: フリップ (順次)               │    │
│  │      ├── FLIP_DISCARD: フリップ (破棄)                  │    │
│  │      └── DISCARD: Blit破棄 (レガシー)                   │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  オプショナルパラメータ                                   │    │
│  ├─────────────────────────────────────────────────────────┤    │
│  │                                                          │    │
│  │  VSync:                                                  │    │
│  │  └── 垂直同期                                            │    │
│  │      ├── SyncInterval = 0: VSync OFF (ティアリング可)   │    │
│  │      ├── SyncInterval = 1: VSync ON (60fps上限等)       │    │
│  │      └── ALLOW_TEARING: 可変リフレッシュレート対応       │    │
│  │                                                          │    │
│  │  HDR:                                                    │    │
│  │  └── HDRサポート                                         │    │
│  │      ├── ColorSpace (sRGB / HDR10 / scRGB)              │    │
│  │      └── MaxLuminance / MinLuminance                    │    │
│  │                                                          │    │
│  │  Fullscreen:                                             │    │
│  │  └── フルスクリーン排他モード                            │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 1.3 Present フロー

```
┌─────────────────────────────────────────────────────────────────┐
│                    Present フロー                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  Frame N の描画                                          │    │
│  │                                                          │    │
│  │  1. GetCurrentBackBufferIndex()                          │    │
│  │     └── 現在描画すべきバックバッファのインデックス取得   │    │
│  │                                                          │    │
│  │  2. バックバッファをRender Targetに設定                   │    │
│  │     ┌─────────────────────────────────────────────┐     │    │
│  │     │ Barrier: PRESENT → RENDER_TARGET            │     │    │
│  │     │ SetRenderTargets(BackBuffer[Index])         │     │    │
│  │     └─────────────────────────────────────────────┘     │    │
│  │                                                          │    │
│  │  3. 描画コマンド実行                                      │    │
│  │     ┌─────────────────────────────────────────────┐     │    │
│  │     │ Clear, Draw, Dispatch, etc.                 │     │    │
│  │     └─────────────────────────────────────────────┘     │    │
│  │                                                          │    │
│  │  4. バックバッファをPresent可能状態に                     │    │
│  │     ┌─────────────────────────────────────────────┐     │    │
│  │     │ Barrier: RENDER_TARGET → PRESENT            │     │    │
│  │     └─────────────────────────────────────────────┘     │    │
│  │                                                          │    │
│  │  5. ExecuteCommandLists()                                │    │
│  │     └── GPUにコマンド送信                                │    │
│  │                                                          │    │
│  │  6. Present()                                            │    │
│  │     ┌─────────────────────────────────────────────┐     │    │
│  │     │ SwapChain->Present(SyncInterval, Flags)     │     │    │
│  │     │                                              │     │    │
│  │     │ SyncInterval:                               │     │    │
│  │     │   0 = 即座にフリップ (VSync OFF)            │     │    │
│  │     │   1 = 次のVBlankでフリップ                  │     │    │
│  │     │                                              │     │    │
│  │     │ Flags:                                      │     │    │
│  │     │   ALLOW_TEARING = ティアリング許可          │     │    │
│  │     └─────────────────────────────────────────────┘     │    │
│  │                                                          │    │
│  │  7. Signal(FrameFence, FrameNumber)                      │    │
│  │     └── フレーム完了をマーク                             │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  バックバッファローテーション:                                   │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  Frame 0: BackBuffer[0] に描画 → Present → Index++      │    │
│  │  Frame 1: BackBuffer[1] に描画 → Present → Index++      │    │
│  │  Frame 2: BackBuffer[2] に描画 → Present → Index = 0    │    │
│  │  Frame 3: BackBuffer[0] に描画 → ...                    │    │
│  │                                                          │    │
│  │  ※ Frame 3 を開始する前に Frame 0 の完了を待機          │    │
│  │    (フェンスで同期)                                      │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 1.4 リサイズ処理

```
┌─────────────────────────────────────────────────────────────────┐
│                    リサイズ処理                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ウィンドウサイズ変更時のフロー:                                 │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  1. GPU完了を待機                                         │    │
│  │     ┌─────────────────────────────────────────────┐     │    │
│  │     │ FlushRenderingCommands()                    │     │    │
│  │     │ すべてのインフライトフレームの完了を待つ     │     │    │
│  │     └─────────────────────────────────────────────┘     │    │
│  │                                                          │    │
│  │  2. バックバッファ参照を解放                              │    │
│  │     ┌─────────────────────────────────────────────┐     │    │
│  │     │ BackBufferRTV[i].Release()                  │     │    │
│  │     │ BackBufferResource[i].Release()             │     │    │
│  │     │                                              │     │    │
│  │     │ ※ 参照カウントを0にしないとリサイズ失敗    │     │    │
│  │     └─────────────────────────────────────────────┘     │    │
│  │                                                          │    │
│  │  3. バッファリサイズ                                      │    │
│  │     ┌─────────────────────────────────────────────┐     │    │
│  │     │ SwapChain->ResizeBuffers(                   │     │    │
│  │     │     BufferCount,                            │     │    │
│  │     │     NewWidth,                               │     │    │
│  │     │     NewHeight,                              │     │    │
│  │     │     Format,                                 │     │    │
│  │     │     Flags                                   │     │    │
│  │     │ )                                           │     │    │
│  │     └─────────────────────────────────────────────┘     │    │
│  │                                                          │    │
│  │  4. 新しいバックバッファを取得                            │    │
│  │     ┌─────────────────────────────────────────────┐     │    │
│  │     │ for (i = 0; i < BufferCount; i++)           │     │    │
│  │     │     SwapChain->GetBuffer(i, &BackBuffer[i]) │     │    │
│  │     │     CreateRTV(BackBuffer[i], &RTV[i])       │     │    │
│  │     └─────────────────────────────────────────────┘     │    │
│  │                                                          │    │
│  │  5. ビューポート/シザー更新                               │    │
│  │     ┌─────────────────────────────────────────────┐     │    │
│  │     │ Viewport = {0, 0, NewWidth, NewHeight, ...} │     │    │
│  │     │ ScissorRect = {0, 0, NewWidth, NewHeight}   │     │    │
│  │     └─────────────────────────────────────────────┘     │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 2. レンダーパス

### 2.1 レンダーパスの概念

```
┌─────────────────────────────────────────────────────────────────┐
│                レンダーパスの概念                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  レンダーパス: 一連の描画操作をカプセル化した単位                │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  ┌─────────────────────────────────────────────────┐    │    │
│  │  │               Render Pass                        │    │    │
│  │  ├─────────────────────────────────────────────────┤    │    │
│  │  │                                                  │    │    │
│  │  │  アタッチメント (入出力):                        │    │    │
│  │  │  ┌────────────────────────────────────────┐    │    │    │
│  │  │  │ Color Attachment 0: RGBA8             │    │    │    │
│  │  │  │   LoadOp: Clear, StoreOp: Store       │    │    │    │
│  │  │  │                                        │    │    │    │
│  │  │  │ Color Attachment 1: RGBA16F           │    │    │    │
│  │  │  │   LoadOp: Load, StoreOp: Store        │    │    │    │
│  │  │  │                                        │    │    │    │
│  │  │  │ Depth Attachment: D32F                │    │    │    │
│  │  │  │   LoadOp: Clear, StoreOp: DontCare    │    │    │    │
│  │  │  └────────────────────────────────────────┘    │    │    │
│  │  │                                                  │    │    │
│  │  │  サブパス:                                       │    │    │
│  │  │  ┌────────────────────────────────────────┐    │    │    │
│  │  │  │ Subpass 0: ジオメトリパス              │    │    │    │
│  │  │  │   Input: なし                          │    │    │    │
│  │  │  │   Output: Color0, Color1, Depth       │    │    │    │
│  │  │  │                                        │    │    │    │
│  │  │  │ Subpass 1: ライティングパス            │    │    │    │
│  │  │  │   Input: Color0, Color1, Depth        │    │    │    │
│  │  │  │   Output: Color0                       │    │    │    │
│  │  │  └────────────────────────────────────────┘    │    │    │
│  │  │                                                  │    │    │
│  │  └─────────────────────────────────────────────────┘    │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  API別の扱い:                                                    │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  D3D12:                                                  │    │
│  │  └── レンダーパスは「オプション」                        │    │
│  │      - BeginRenderPass() / EndRenderPass() (Optional)   │    │
│  │      - または OMSetRenderTargets() で直接設定            │    │
│  │      - タイルベースGPUでのみ最適化効果                   │    │
│  │                                                          │    │
│  │  Vulkan:                                                 │    │
│  │  └── レンダーパスは「必須」                              │    │
│  │      - VkRenderPass オブジェクトを事前定義               │    │
│  │      - vkCmdBeginRenderPass() / vkCmdEndRenderPass()    │    │
│  │      - パス外での描画コマンドは不可                      │    │
│  │                                                          │    │
│  │  Metal:                                                  │    │
│  │  └── レンダーパスは「エンコーダー単位」                  │    │
│  │      - MTLRenderCommandEncoder = 1つのパス              │    │
│  │      - MTLRenderPassDescriptor でロード/ストア設定       │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 Load/Store操作

```
┌─────────────────────────────────────────────────────────────────┐
│                  Load/Store 操作                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ロード操作 (パス開始時):                                        │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  Load (読み込み):                                        │    │
│  │  ┌───────────────────────────────────────────────────┐  │    │
│  │  │ パス開始前の内容を保持                             │  │    │
│  │  │ → 前のパスの結果を使用する場合                     │  │    │
│  │  │                                                    │  │    │
│  │  │ タイルベースGPU: メインメモリ → タイルメモリ      │  │    │
│  │  │ 即時モードGPU: 操作なし                            │  │    │
│  │  └───────────────────────────────────────────────────┘  │    │
│  │                                                          │    │
│  │  Clear (クリア):                                         │    │
│  │  ┌───────────────────────────────────────────────────┐  │    │
│  │  │ 指定した値でクリア                                 │  │    │
│  │  │ → 新しいパスで内容を完全に上書きする場合           │  │    │
│  │  │                                                    │  │    │
│  │  │ タイルベースGPU: タイルメモリをクリア (高速)      │  │    │
│  │  │ 即時モードGPU: クリアコマンド発行                  │  │    │
│  │  └───────────────────────────────────────────────────┘  │    │
│  │                                                          │    │
│  │  DontCare (不定):                                        │    │
│  │  ┌───────────────────────────────────────────────────┐  │    │
│  │  │ 内容は不定で構わない                               │  │    │
│  │  │ → 完全に上書きするが、クリア値は不要な場合        │  │    │
│  │  │                                                    │  │    │
│  │  │ タイルベースGPU: ロード不要 (最速)                │  │    │
│  │  └───────────────────────────────────────────────────┘  │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  ストア操作 (パス終了時):                                        │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  Store (書き込み):                                       │    │
│  │  ┌───────────────────────────────────────────────────┐  │    │
│  │  │ 結果をメモリに書き戻す                             │  │    │
│  │  │ → 後続のパスやシェーダーで参照する場合            │  │    │
│  │  │                                                    │  │    │
│  │  │ タイルベースGPU: タイルメモリ → メインメモリ      │  │    │
│  │  └───────────────────────────────────────────────────┘  │    │
│  │                                                          │    │
│  │  DontCare (破棄):                                        │    │
│  │  ┌───────────────────────────────────────────────────┐  │    │
│  │  │ 結果は不要、破棄して良い                           │  │    │
│  │  │ → 深度バッファ等、後で使わない場合                │  │    │
│  │  │                                                    │  │    │
│  │  │ タイルベースGPU: ストア不要 (高速)                │  │    │
│  │  └───────────────────────────────────────────────────┘  │    │
│  │                                                          │    │
│  │  Resolve (MSAA解決):                                     │    │
│  │  ┌───────────────────────────────────────────────────┐  │    │
│  │  │ MSAAサンプルを解決して書き戻す                     │  │    │
│  │  │ → アンチエイリアシング処理                        │  │    │
│  │  └───────────────────────────────────────────────────┘  │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  最適な設定例:                                                   │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  カラーバッファ (後で使用):                              │    │
│  │    Load: Clear or DontCare                               │    │
│  │    Store: Store                                          │    │
│  │                                                          │    │
│  │  深度バッファ (このパスのみ):                            │    │
│  │    Load: Clear                                           │    │
│  │    Store: DontCare  ← メモリ帯域節約                    │    │
│  │                                                          │    │
│  │  深度バッファ (シャドウマップ等):                        │    │
│  │    Load: Clear                                           │    │
│  │    Store: Store  ← 後でサンプリングするため             │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 3. 描画コマンドの詳細

### 3.1 描画コマンドの種類

```
┌─────────────────────────────────────────────────────────────────┐
│                描画コマンドの種類                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  1. DrawPrimitive (非インデックス描画)                   │    │
│  │                                                          │    │
│  │  パラメータ:                                             │    │
│  │  ├── VertexCount: 描画する頂点数                        │    │
│  │  ├── StartVertexLocation: 開始頂点インデックス          │    │
│  │  └── InstanceCount: インスタンス数 (オプション)         │    │
│  │                                                          │    │
│  │  頂点バッファ:                                           │    │
│  │  ┌───────────────────────────────────────────────────┐  │    │
│  │  │ [V0] [V1] [V2] [V3] [V4] [V5] ...                 │  │    │
│  │  │  ↑                                                │  │    │
│  │  │  StartVertexLocation                              │  │    │
│  │  │  ├─────────────────────┤                          │  │    │
│  │  │        VertexCount                                │  │    │
│  │  └───────────────────────────────────────────────────┘  │    │
│  │                                                          │    │
│  │  用途: シンプルな形状、プロシージャル生成ジオメトリ      │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  2. DrawIndexedPrimitive (インデックス描画)              │    │
│  │                                                          │    │
│  │  パラメータ:                                             │    │
│  │  ├── IndexCount: 描画するインデックス数                 │    │
│  │  ├── StartIndexLocation: 開始インデックス               │    │
│  │  ├── BaseVertexLocation: 頂点オフセット                 │    │
│  │  └── InstanceCount: インスタンス数 (オプション)         │    │
│  │                                                          │    │
│  │  インデックスバッファ:        頂点バッファ:             │    │
│  │  ┌─────────────────────┐    ┌─────────────────────┐    │    │
│  │  │ [0] [1] [2] [2] [1] │    │ [V0] [V1] [V2] [V3] │    │    │
│  │  │ [3] ...             │    │ [V4] [V5] ...       │    │    │
│  │  │  ↑                  │    │  ↑                  │    │    │
│  │  │  StartIndex         │    │  BaseVertex         │    │    │
│  │  └─────────────────────┘    └─────────────────────┘    │    │
│  │                                                          │    │
│  │  実際の頂点アドレス = VertexBuffer[Index + BaseVertex]   │    │
│  │                                                          │    │
│  │  用途: メッシュ描画 (最も一般的)                        │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  3. DrawPrimitiveInstanced (インスタンス描画)            │    │
│  │                                                          │    │
│  │  追加パラメータ:                                         │    │
│  │  ├── InstanceCount: インスタンス数                      │    │
│  │  └── StartInstanceLocation: 開始インスタンスID          │    │
│  │                                                          │    │
│  │  インスタンスデータ:                                     │    │
│  │  ┌───────────────────────────────────────────────────┐  │    │
│  │  │ Instance 0: [Transform0] [Color0]                 │  │    │
│  │  │ Instance 1: [Transform1] [Color1]                 │  │    │
│  │  │ Instance 2: [Transform2] [Color2]                 │  │    │
│  │  │ ...                                               │  │    │
│  │  └───────────────────────────────────────────────────┘  │    │
│  │                                                          │    │
│  │  シェーダー内で SV_InstanceID を使用してアクセス        │    │
│  │                                                          │    │
│  │  用途: 草、パーティクル、群衆描画                        │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 Indirect 描画

```
┌─────────────────────────────────────────────────────────────────┐
│                   Indirect 描画                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  概念: GPUがパラメータを決定する描画                             │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  従来:                                                   │    │
│  │  CPU → [DrawCall Parameters] → GPU                       │    │
│  │                                                          │    │
│  │  Indirect:                                               │    │
│  │  GPU (Compute) → [Indirect Buffer] → GPU (Graphics)      │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  DrawIndexedIndirect 引数バッファ構造:                           │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  struct DrawIndexedIndirectCommand {                     │    │
│  │      uint IndexCountPerInstance;    // 4 bytes          │    │
│  │      uint InstanceCount;            // 4 bytes          │    │
│  │      uint StartIndexLocation;       // 4 bytes          │    │
│  │      int  BaseVertexLocation;       // 4 bytes          │    │
│  │      uint StartInstanceLocation;    // 4 bytes          │    │
│  │  };  // 合計 20 bytes                                   │    │
│  │                                                          │    │
│  │  Indirect Buffer:                                        │    │
│  │  ┌─────────────────────────────────────────────────┐    │    │
│  │  │ [Cmd 0] [Cmd 1] [Cmd 2] [Cmd 3] ...             │    │    │
│  │  │  20B     20B     20B     20B                     │    │    │
│  │  └─────────────────────────────────────────────────┘    │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  ExecuteIndirect (D3D12) / Multi-Draw Indirect:                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  複数のIndirectコマンドを一度に実行:                     │    │
│  │                                                          │    │
│  │  ┌───────────────────────────────────────────────────┐  │    │
│  │  │ Count Buffer:                                     │  │    │
│  │  │   [N] ← 実行するコマンド数 (GPUが決定可能)        │  │    │
│  │  │                                                   │  │    │
│  │  │ Command Buffer:                                   │  │    │
│  │  │   [Cmd 0] [Cmd 1] ... [Cmd N-1]                  │  │    │
│  │  │                                                   │  │    │
│  │  │ ExecuteIndirect(CommandSignature,                 │  │    │
│  │  │                 MaxCommandCount,                  │  │    │
│  │  │                 CommandBuffer,                    │  │    │
│  │  │                 CountBuffer)                      │  │    │
│  │  └───────────────────────────────────────────────────┘  │    │
│  │                                                          │    │
│  │  用途:                                                   │    │
│  │  - GPU駆動レンダリング                                  │    │
│  │  - オクルージョンカリング結果に基づく描画               │    │
│  │  - LOD選択をGPUで実行                                   │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 3.3 メッシュシェーダー描画

```
┌─────────────────────────────────────────────────────────────────┐
│               メッシュシェーダー描画                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  従来 vs メッシュシェーダー:                                     │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  従来のパイプライン:                                     │    │
│  │  Input Assembler → Vertex → [Hull → Tess → Domain]      │    │
│  │                  → Geometry → Rasterizer → Pixel        │    │
│  │                                                          │    │
│  │  メッシュシェーダーパイプライン:                          │    │
│  │  [Amplification] → Mesh Shader → Rasterizer → Pixel     │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  DispatchMesh コマンド:                                          │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  パラメータ:                                             │    │
│  │  ├── ThreadGroupCountX                                  │    │
│  │  ├── ThreadGroupCountY                                  │    │
│  │  └── ThreadGroupCountZ                                  │    │
│  │                                                          │    │
│  │  各スレッドグループが:                                   │    │
│  │  - 最大256頂点を出力                                     │    │
│  │  - 最大256プリミティブを出力                             │    │
│  │                                                          │    │
│  │  Amplification Shader (オプション):                      │    │
│  │  ┌───────────────────────────────────────────────────┐  │    │
│  │  │ 入力: スレッドグループ                            │  │    │
│  │  │ 処理: カリング、LOD選択                           │  │    │
│  │  │ 出力: DispatchMesh(count, payload)               │  │    │
│  │  │       → Mesh Shaderを動的に起動                  │  │    │
│  │  └───────────────────────────────────────────────────┘  │    │
│  │                                                          │    │
│  │  Mesh Shader:                                            │    │
│  │  ┌───────────────────────────────────────────────────┐  │    │
│  │  │ 入力: スレッドグループ + ペイロード               │  │    │
│  │  │ 処理: 頂点生成、プリミティブ組み立て              │  │    │
│  │  │ 出力: SetMeshOutputCounts(vertCount, primCount)   │  │    │
│  │  │       vertices[i] = ...                           │  │    │
│  │  │       primitives[i].indices = ...                 │  │    │
│  │  └───────────────────────────────────────────────────┘  │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 4. コピーコマンド

### 4.1 バッファコピー

```
┌─────────────────────────────────────────────────────────────────┐
│                   バッファコピー                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  CopyBufferRegion (バッファ→バッファ)                    │    │
│  │                                                          │    │
│  │  Source Buffer:                                          │    │
│  │  ┌─────────────────────────────────────────────────┐    │    │
│  │  │ [    ] [DATA] [DATA] [DATA] [    ] [    ]       │    │    │
│  │  │         ↑                                       │    │    │
│  │  │         SrcOffset                               │    │    │
│  │  │         ├──────────────────┤                    │    │    │
│  │  │               NumBytes                          │    │    │
│  │  └─────────────────────────────────────────────────┘    │    │
│  │                    │                                     │    │
│  │                    │ CopyBufferRegion                    │    │
│  │                    ▼                                     │    │
│  │  Dest Buffer:                                            │    │
│  │  ┌─────────────────────────────────────────────────┐    │    │
│  │  │ [    ] [    ] [DATA] [DATA] [DATA] [    ]       │    │    │
│  │  │               ↑                                 │    │    │
│  │  │               DstOffset                         │    │    │
│  │  └─────────────────────────────────────────────────┘    │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  Upload (CPU→GPU)                                        │    │
│  │                                                          │    │
│  │  フロー:                                                 │    │
│  │  ┌───────────────────────────────────────────────────┐  │    │
│  │  │ 1. Upload Heap にバッファ確保 (MAP可能)           │  │    │
│  │  │                                                   │  │    │
│  │  │ 2. CPU で MAP → データ書き込み → UNMAP           │  │    │
│  │  │    void* ptr;                                     │  │    │
│  │  │    uploadBuffer->Map(0, nullptr, &ptr);          │  │    │
│  │  │    memcpy(ptr, srcData, size);                   │  │    │
│  │  │    uploadBuffer->Unmap(0, nullptr);              │  │    │
│  │  │                                                   │  │    │
│  │  │ 3. GPU で Upload → Default ヒープにコピー         │  │    │
│  │  │    CopyBufferRegion(defaultBuf, uploadBuf, ...)  │  │    │
│  │  └───────────────────────────────────────────────────┘  │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  Readback (GPU→CPU)                                      │    │
│  │                                                          │    │
│  │  フロー:                                                 │    │
│  │  ┌───────────────────────────────────────────────────┐  │    │
│  │  │ 1. Default → Readback ヒープにコピー              │  │    │
│  │  │    CopyBufferRegion(readbackBuf, defaultBuf, ...) │  │    │
│  │  │                                                   │  │    │
│  │  │ 2. GPU完了を待機 (フェンス)                       │  │    │
│  │  │    fence->SetEventOnCompletion(value, event);     │  │    │
│  │  │    WaitForSingleObject(event, INFINITE);          │  │    │
│  │  │                                                   │  │    │
│  │  │ 3. CPU で MAP → データ読み取り                    │  │    │
│  │  │    void* ptr;                                     │  │    │
│  │  │    D3D12_RANGE readRange = {0, size};            │  │    │
│  │  │    readbackBuffer->Map(0, &readRange, &ptr);      │  │    │
│  │  │    memcpy(dstData, ptr, size);                    │  │    │
│  │  │    readbackBuffer->Unmap(0, nullptr);             │  │    │
│  │  └───────────────────────────────────────────────────┘  │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 4.2 テクスチャコピー

```
┌─────────────────────────────────────────────────────────────────┐
│                  テクスチャコピー                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  CopyTextureRegion (テクスチャ→テクスチャ)              │    │
│  │                                                          │    │
│  │  パラメータ:                                             │    │
│  │  ├── SrcTexture, SrcSubresource                         │    │
│  │  ├── SrcBox {Left, Top, Front, Right, Bottom, Back}     │    │
│  │  ├── DstTexture, DstSubresource                         │    │
│  │  └── DstX, DstY, DstZ (コピー先オフセット)              │    │
│  │                                                          │    │
│  │  Source:                  Destination:                   │    │
│  │  ┌─────────────┐         ┌─────────────┐               │    │
│  │  │ ┌───┐       │         │       ┌───┐ │               │    │
│  │  │ │SRC│       │  ──▶    │       │DST│ │               │    │
│  │  │ └───┘       │         │       └───┘ │               │    │
│  │  └─────────────┘         └─────────────┘               │    │
│  │                                                          │    │
│  │  注意: フォーマット互換性が必要                          │    │
│  │        (同一フォーマット or 同一ブロックサイズ)          │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  CopyTextureRegion (バッファ→テクスチャ: Upload)        │    │
│  │                                                          │    │
│  │  Upload Buffer (Linear Layout):                          │    │
│  │  ┌─────────────────────────────────────────────────┐    │    │
│  │  │ [Row 0                                         ] │    │    │
│  │  │ [Padding...                                    ] │    │    │
│  │  │ [Row 1                                         ] │    │    │
│  │  │ [Padding...                                    ] │    │    │
│  │  │ ...                                              │    │    │
│  │  └─────────────────────────────────────────────────┘    │    │
│  │       │                                                  │    │
│  │       │ RowPitch: 各行のバイトサイズ (アライメント含む)  │    │
│  │       │ SlicePitch: 各スライスのバイトサイズ (3D時)     │    │
│  │       ▼                                                  │    │
│  │  Texture (Optimal Layout):                               │    │
│  │  ┌─────────────────┐                                    │    │
│  │  │ [Tiled/Swizzled]│                                    │    │
│  │  │ [GPU最適化配置] │                                    │    │
│  │  └─────────────────┘                                    │    │
│  │                                                          │    │
│  │  D3D12での指定:                                          │    │
│  │  ┌───────────────────────────────────────────────────┐  │    │
│  │  │ D3D12_PLACED_SUBRESOURCE_FOOTPRINT footprint;     │  │    │
│  │  │ device->GetCopyableFootprints(&desc,              │  │    │
│  │  │     subresource, 1, 0,                            │  │    │
│  │  │     &footprint, nullptr, nullptr, nullptr);       │  │    │
│  │  │                                                   │  │    │
│  │  │ // footprint.Footprint.RowPitch にアライメント済み│  │    │
│  │  │ // 行ピッチが含まれる (256バイト境界等)           │  │    │
│  │  └───────────────────────────────────────────────────┘  │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  ResolveSubresource (MSAA解決)                           │    │
│  │                                                          │    │
│  │  MSAA Texture:           Non-MSAA Texture:              │    │
│  │  ┌─────────────────┐     ┌─────────────────┐            │    │
│  │  │ 4x MSAA         │     │ 1x (Resolved)   │            │    │
│  │  │ [s0 s1]         │     │                 │            │    │
│  │  │ [s2 s3] per px  │ ──▶ │ [avg] per px    │            │    │
│  │  └─────────────────┘     └─────────────────┘            │    │
│  │                                                          │    │
│  │  用途:                                                   │    │
│  │  - レンダリング後のアンチエイリアシング解決              │    │
│  │  - MSAA RTをサンプリング可能にする                       │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 5. 状態バインディング

### 5.1 頂点/インデックスバッファバインディング

```
┌─────────────────────────────────────────────────────────────────┐
│           頂点/インデックスバッファバインディング                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  頂点バッファ設定                                        │    │
│  │                                                          │    │
│  │  Input Layout (PSO作成時に定義):                         │    │
│  │  ┌───────────────────────────────────────────────────┐  │    │
│  │  │ Element 0: POSITION, Float3, Slot 0, Offset 0    │  │    │
│  │  │ Element 1: NORMAL,   Float3, Slot 0, Offset 12   │  │    │
│  │  │ Element 2: TEXCOORD, Float2, Slot 0, Offset 24   │  │    │
│  │  │ Element 3: COLOR,    Float4, Slot 1, Offset 0    │  │    │
│  │  └───────────────────────────────────────────────────┘  │    │
│  │                                                          │    │
│  │  頂点バッファビュー:                                     │    │
│  │  ┌───────────────────────────────────────────────────┐  │    │
│  │  │ Slot 0: VertexBufferView                         │  │    │
│  │  │   BufferLocation = buffer0->GetGPUVirtualAddress()│  │    │
│  │  │   SizeInBytes = vertexCount * stride0            │  │    │
│  │  │   StrideInBytes = 32 (Position+Normal+UV)        │  │    │
│  │  │                                                   │  │    │
│  │  │ Slot 1: VertexBufferView                         │  │    │
│  │  │   BufferLocation = buffer1->GetGPUVirtualAddress()│  │    │
│  │  │   SizeInBytes = vertexCount * stride1            │  │    │
│  │  │   StrideInBytes = 16 (Color)                     │  │    │
│  │  └───────────────────────────────────────────────────┘  │    │
│  │                                                          │    │
│  │  コマンド:                                               │    │
│  │  IASetVertexBuffers(StartSlot, NumViews, &Views)        │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  インデックスバッファ設定                                │    │
│  │                                                          │    │
│  │  インデックスバッファビュー:                             │    │
│  │  ┌───────────────────────────────────────────────────┐  │    │
│  │  │ IndexBufferView                                   │  │    │
│  │  │   BufferLocation = indexBuffer->GetGPUVirtualAddress()│ │    │
│  │  │   SizeInBytes = indexCount * indexSize           │  │    │
│  │  │   Format = DXGI_FORMAT_R16_UINT  (16-bit)        │  │    │
│  │  │         or DXGI_FORMAT_R32_UINT  (32-bit)        │  │    │
│  │  └───────────────────────────────────────────────────┘  │    │
│  │                                                          │    │
│  │  コマンド:                                               │    │
│  │  IASetIndexBuffer(&View)                                │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  プリミティブトポロジー設定                              │    │
│  │                                                          │    │
│  │  トポロジー種類:                                         │    │
│  │  ┌───────────────────────────────────────────────────┐  │    │
│  │  │ TRIANGLELIST:    [0,1,2] [3,4,5] ...             │  │    │
│  │  │ TRIANGLESTRIP:   [0,1,2] [1,2,3] [2,3,4] ...     │  │    │
│  │  │ LINELIST:        [0,1] [2,3] ...                 │  │    │
│  │  │ LINESTRIP:       [0,1] [1,2] [2,3] ...           │  │    │
│  │  │ POINTLIST:       [0] [1] [2] ...                 │  │    │
│  │  │ PATCHLIST_N:     テッセレーション用               │  │    │
│  │  └───────────────────────────────────────────────────┘  │    │
│  │                                                          │    │
│  │  コマンド:                                               │    │
│  │  IASetPrimitiveTopology(D3D_PRIMITIVE_TOPOLOGY_...)     │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 5.2 定数バッファ/シェーダーリソースバインディング

```
┌─────────────────────────────────────────────────────────────────┐
│        定数バッファ/シェーダーリソースバインディング              │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  定数バッファ (Constant Buffer / Uniform Buffer)        │    │
│  │                                                          │    │
│  │  方法1: ルートCBV (直接GPU仮想アドレス)                  │    │
│  │  ┌───────────────────────────────────────────────────┐  │    │
│  │  │ SetGraphicsRootConstantBufferView(                │  │    │
│  │  │     RootParameterIndex,                           │  │    │
│  │  │     buffer->GetGPUVirtualAddress() + offset       │  │    │
│  │  │ );                                                │  │    │
│  │  │                                                   │  │    │
│  │  │ 利点: 最速アクセス                               │  │    │
│  │  │ 制限: 64KB以下のバッファのみ                     │  │    │
│  │  └───────────────────────────────────────────────────┘  │    │
│  │                                                          │    │
│  │  方法2: デスクリプタテーブル                             │    │
│  │  ┌───────────────────────────────────────────────────┐  │    │
│  │  │ 1. CBV デスクリプタ作成                           │  │    │
│  │  │    D3D12_CONSTANT_BUFFER_VIEW_DESC desc = {       │  │    │
│  │  │        .BufferLocation = gpuAddr,                │  │    │
│  │  │        .SizeInBytes = alignedSize  // 256B境界   │  │    │
│  │  │    };                                             │  │    │
│  │  │    device->CreateConstantBufferView(&desc, handle);│  │    │
│  │  │                                                   │  │    │
│  │  │ 2. テーブルをルートに設定                        │  │    │
│  │  │    SetGraphicsRootDescriptorTable(                │  │    │
│  │  │        RootParameterIndex,                        │  │    │
│  │  │        gpuDescriptorHandle                        │  │    │
│  │  │    );                                             │  │    │
│  │  └───────────────────────────────────────────────────┘  │    │
│  │                                                          │    │
│  │  方法3: ルート定数 (小さなデータ用)                     │    │
│  │  ┌───────────────────────────────────────────────────┐  │    │
│  │  │ SetGraphicsRoot32BitConstants(                    │  │    │
│  │  │     RootParameterIndex,                           │  │    │
│  │  │     Num32BitValuesToSet,                          │  │    │
│  │  │     pSrcData,                                     │  │    │
│  │  │     DestOffsetIn32BitValues                       │  │    │
│  │  │ );                                                │  │    │
│  │  │                                                   │  │    │
│  │  │ 利点: バッファ不要、超高速                       │  │    │
│  │  │ 制限: 小さなデータのみ (数十バイト)              │  │    │
│  │  └───────────────────────────────────────────────────┘  │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  シェーダーリソースビュー (SRV) / UAV バインディング    │    │
│  │                                                          │    │
│  │  デスクリプタテーブル方式:                               │    │
│  │  ┌───────────────────────────────────────────────────┐  │    │
│  │  │ Descriptor Heap (GPU Visible):                    │  │    │
│  │  │ ┌─────────────────────────────────────────────┐  │  │    │
│  │  │ │[SRV0][SRV1][SRV2][UAV0][CBV0][CBV1]...     │  │  │    │
│  │  │ └─────────────────────────────────────────────┘  │  │    │
│  │  │                                                   │  │    │
│  │  │ SetDescriptorHeaps(1, &srvUavCbvHeap);           │  │    │
│  │  │                                                   │  │    │
│  │  │ SetGraphicsRootDescriptorTable(                   │  │    │
│  │  │     SRVTableIndex,                                │  │    │
│  │  │     srvTableStartHandle  // [SRV0]へのGPUハンドル │  │    │
│  │  │ );                                                │  │    │
│  │  │                                                   │  │    │
│  │  │ SetGraphicsRootDescriptorTable(                   │  │    │
│  │  │     UAVTableIndex,                                │  │    │
│  │  │     uavTableStartHandle  // [UAV0]へのGPUハンドル │  │    │
│  │  │ );                                                │  │    │
│  │  └───────────────────────────────────────────────────┘  │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 5.3 サンプラーとレンダーターゲット

```
┌─────────────────────────────────────────────────────────────────┐
│           サンプラーとレンダーターゲット                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  サンプラー設定                                          │    │
│  │                                                          │    │
│  │  サンプラー記述子:                                       │    │
│  │  ┌───────────────────────────────────────────────────┐  │    │
│  │  │ D3D12_SAMPLER_DESC desc = {                       │  │    │
│  │  │     .Filter = D3D12_FILTER_MIN_MAG_MIP_LINEAR,   │  │    │
│  │  │     .AddressU = D3D12_TEXTURE_ADDRESS_MODE_WRAP, │  │    │
│  │  │     .AddressV = D3D12_TEXTURE_ADDRESS_MODE_WRAP, │  │    │
│  │  │     .AddressW = D3D12_TEXTURE_ADDRESS_MODE_WRAP, │  │    │
│  │  │     .MipLODBias = 0.0f,                          │  │    │
│  │  │     .MaxAnisotropy = 16,                         │  │    │
│  │  │     .ComparisonFunc = D3D12_COMPARISON_FUNC_NEVER,│  │    │
│  │  │     .BorderColor = {0,0,0,0},                    │  │    │
│  │  │     .MinLOD = 0.0f,                              │  │    │
│  │  │     .MaxLOD = D3D12_FLOAT32_MAX                  │  │    │
│  │  │ };                                                │  │    │
│  │  └───────────────────────────────────────────────────┘  │    │
│  │                                                          │    │
│  │  フィルターモード:                                       │    │
│  │  ├── POINT: 最近傍 (ブロック状)                         │    │
│  │  ├── LINEAR: バイリニア (滑らか)                         │    │
│  │  ├── ANISOTROPIC: 異方性 (高品質)                        │    │
│  │  └── COMPARISON: 深度比較 (シャドウマップ用)             │    │
│  │                                                          │    │
│  │  アドレスモード:                                         │    │
│  │  ├── WRAP: 繰り返し                                      │    │
│  │  ├── MIRROR: 鏡像繰り返し                                │    │
│  │  ├── CLAMP: 端をクランプ                                 │    │
│  │  └── BORDER: 境界色                                      │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  レンダーターゲット設定                                  │    │
│  │                                                          │    │
│  │  OMSetRenderTargets:                                     │    │
│  │  ┌───────────────────────────────────────────────────┐  │    │
│  │  │ D3D12_CPU_DESCRIPTOR_HANDLE rtvHandles[] = {      │  │    │
│  │  │     rtv0.GetCPUHandle(),  // Color0              │  │    │
│  │  │     rtv1.GetCPUHandle(),  // Color1 (GBuffer)    │  │    │
│  │  │     rtv2.GetCPUHandle()   // Color2 (GBuffer)    │  │    │
│  │  │ };                                                │  │    │
│  │  │                                                   │  │    │
│  │  │ D3D12_CPU_DESCRIPTOR_HANDLE dsvHandle =          │  │    │
│  │  │     dsv.GetCPUHandle();                          │  │    │
│  │  │                                                   │  │    │
│  │  │ commandList->OMSetRenderTargets(                  │  │    │
│  │  │     3,                    // NumRenderTargets    │  │    │
│  │  │     rtvHandles,           // RTVs               │  │    │
│  │  │     FALSE,                // RTsSingleHandle    │  │    │
│  │  │     &dsvHandle            // DSV                │  │    │
│  │  │ );                                                │  │    │
│  │  └───────────────────────────────────────────────────┘  │    │
│  │                                                          │    │
│  │  クリア操作:                                             │    │
│  │  ┌───────────────────────────────────────────────────┐  │    │
│  │  │ float clearColor[4] = {0.0f, 0.0f, 0.0f, 1.0f};  │  │    │
│  │  │ commandList->ClearRenderTargetView(               │  │    │
│  │  │     rtvHandle, clearColor, 0, nullptr);          │  │    │
│  │  │                                                   │  │    │
│  │  │ commandList->ClearDepthStencilView(               │  │    │
│  │  │     dsvHandle,                                    │  │    │
│  │  │     D3D12_CLEAR_FLAG_DEPTH | D3D12_CLEAR_FLAG_STENCIL,│  │    │
│  │  │     1.0f,  // Depth clear value                  │  │    │
│  │  │     0,     // Stencil clear value                │  │    │
│  │  │     0, nullptr);                                  │  │    │
│  │  └───────────────────────────────────────────────────┘  │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 6. クエリシステム

### 6.1 クエリの種類

```
┌─────────────────────────────────────────────────────────────────┐
│                   クエリの種類                                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  1. Timestamp Query (タイムスタンプ)                     │    │
│  │                                                          │    │
│  │  用途: GPU実行時間の計測                                 │    │
│  │                                                          │    │
│  │  ┌───────────────────────────────────────────────────┐  │    │
│  │  │ // クエリヒープ作成                               │  │    │
│  │  │ D3D12_QUERY_HEAP_DESC desc = {                    │  │    │
│  │  │     .Type = D3D12_QUERY_HEAP_TYPE_TIMESTAMP,     │  │    │
│  │  │     .Count = 2  // Start + End                   │  │    │
│  │  │ };                                                │  │    │
│  │  │ device->CreateQueryHeap(&desc, &queryHeap);       │  │    │
│  │  │                                                   │  │    │
│  │  │ // 計測開始                                       │  │    │
│  │  │ cmdList->EndQuery(queryHeap, D3D12_QUERY_TYPE_TIMESTAMP, 0);│ │    │
│  │  │                                                   │  │    │
│  │  │ // 描画コマンド...                                │  │    │
│  │  │                                                   │  │    │
│  │  │ // 計測終了                                       │  │    │
│  │  │ cmdList->EndQuery(queryHeap, D3D12_QUERY_TYPE_TIMESTAMP, 1);│ │    │
│  │  │                                                   │  │    │
│  │  │ // 結果取得                                       │  │    │
│  │  │ cmdList->ResolveQueryData(queryHeap,              │  │    │
│  │  │     D3D12_QUERY_TYPE_TIMESTAMP, 0, 2,            │  │    │
│  │  │     resultBuffer, 0);                             │  │    │
│  │  │                                                   │  │    │
│  │  │ // CPU側で読み取り                                │  │    │
│  │  │ uint64 timestamps[2];                             │  │    │
│  │  │ // ... Readback ...                              │  │    │
│  │  │ uint64 ticks = timestamps[1] - timestamps[0];    │  │    │
│  │  │ double ms = ticks / (double)timestampFrequency * 1000.0;│  │    │
│  │  └───────────────────────────────────────────────────┘  │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  2. Occlusion Query (オクルージョン)                     │    │
│  │                                                          │    │
│  │  用途: ピクセルが描画されたかの判定                      │    │
│  │                                                          │    │
│  │  ┌───────────────────────────────────────────────────┐  │    │
│  │  │ // クエリタイプ                                   │  │    │
│  │  │ D3D12_QUERY_HEAP_TYPE_OCCLUSION                   │  │    │
│  │  │                                                   │  │    │
│  │  │ // BINARY: 1ピクセルでも描画されたら true         │  │    │
│  │  │ cmdList->BeginQuery(queryHeap,                    │  │    │
│  │  │     D3D12_QUERY_TYPE_BINARY_OCCLUSION, index);   │  │    │
│  │  │                                                   │  │    │
│  │  │ // PRECISE: 描画されたピクセル数をカウント        │  │    │
│  │  │ cmdList->BeginQuery(queryHeap,                    │  │    │
│  │  │     D3D12_QUERY_TYPE_OCCLUSION, index);          │  │    │
│  │  │                                                   │  │    │
│  │  │ // 描画...                                        │  │    │
│  │  │                                                   │  │    │
│  │  │ cmdList->EndQuery(queryHeap, type, index);        │  │    │
│  │  └───────────────────────────────────────────────────┘  │    │
│  │                                                          │    │
│  │  用途例:                                                 │    │
│  │  - オクルージョンカリング (見えないオブジェクトをスキップ)│    │
│  │  - レンズフレア (光源が遮蔽されているか判定)            │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  3. Pipeline Statistics Query (パイプライン統計)        │    │
│  │                                                          │    │
│  │  取得可能な統計:                                         │    │
│  │  ┌───────────────────────────────────────────────────┐  │    │
│  │  │ D3D12_QUERY_DATA_PIPELINE_STATISTICS stats;       │  │    │
│  │  │                                                   │  │    │
│  │  │ stats.IAVertices:     入力頂点数                 │  │    │
│  │  │ stats.IAPrimitives:   入力プリミティブ数         │  │    │
│  │  │ stats.VSInvocations:  VS呼び出し回数             │  │    │
│  │  │ stats.GSInvocations:  GS呼び出し回数             │  │    │
│  │  │ stats.GSPrimitives:   GS出力プリミティブ数       │  │    │
│  │  │ stats.CInvocations:   クリップ後プリミティブ数   │  │    │
│  │  │ stats.CPrimitives:    カリング後プリミティブ数   │  │    │
│  │  │ stats.PSInvocations:  PS呼び出し回数             │  │    │
│  │  │ stats.HSInvocations:  HS呼び出し回数             │  │    │
│  │  │ stats.DSInvocations:  DS呼び出し回数             │  │    │
│  │  │ stats.CSInvocations:  CS呼び出し回数             │  │    │
│  │  └───────────────────────────────────────────────────┘  │    │
│  │                                                          │    │
│  │  用途: パフォーマンス分析、デバッグ                      │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 7. デバッグ/プロファイリング

### 7.1 デバッグマーカー

```
┌─────────────────────────────────────────────────────────────────┐
│                   デバッグマーカー                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  デバッグマーカーは GPU 処理の範囲を名前付けする機能             │
│  PIX、RenderDoc、NSight 等のツールで可視化される                 │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  PIX / D3D12 マーカー                                    │    │
│  │                                                          │    │
│  │  ┌───────────────────────────────────────────────────┐  │    │
│  │  │ // イベント開始                                   │  │    │
│  │  │ PIXBeginEvent(commandList, PIX_COLOR(255,0,0),   │  │    │
│  │  │               L"Shadow Pass");                    │  │    │
│  │  │                                                   │  │    │
│  │  │ // 描画コマンド...                                │  │    │
│  │  │                                                   │  │    │
│  │  │ // ネストしたイベント                             │  │    │
│  │  │ PIXBeginEvent(commandList, PIX_COLOR(0,255,0),   │  │    │
│  │  │               L"Directional Light");              │  │    │
│  │  │ // ...                                            │  │    │
│  │  │ PIXEndEvent(commandList);                         │  │    │
│  │  │                                                   │  │    │
│  │  │ PIXBeginEvent(commandList, PIX_COLOR(0,0,255),   │  │    │
│  │  │               L"Point Lights");                   │  │    │
│  │  │ // ...                                            │  │    │
│  │  │ PIXEndEvent(commandList);                         │  │    │
│  │  │                                                   │  │    │
│  │  │ // イベント終了                                   │  │    │
│  │  │ PIXEndEvent(commandList);                         │  │    │
│  │  └───────────────────────────────────────────────────┘  │    │
│  │                                                          │    │
│  │  可視化結果:                                             │    │
│  │  ┌───────────────────────────────────────────────────┐  │    │
│  │  │ [Shadow Pass                                     ]│  │    │
│  │  │  ├─[Directional Light ]                          │  │    │
│  │  │  └─[Point Lights      ]                          │  │    │
│  │  │ [Main Pass                                       ]│  │    │
│  │  │  ├─[Opaque            ]                          │  │    │
│  │  │  └─[Transparent       ]                          │  │    │
│  │  └───────────────────────────────────────────────────┘  │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  UE5 でのマーカー API                                    │    │
│  │                                                          │    │
│  │  ┌───────────────────────────────────────────────────┐  │    │
│  │  │ // RHI レベル                                     │  │    │
│  │  │ RHICmdList.PushEvent(TEXT("Shadow Pass"),         │  │    │
│  │  │                      FColor::Red);                │  │    │
│  │  │ // ...                                            │  │    │
│  │  │ RHICmdList.PopEvent();                            │  │    │
│  │  │                                                   │  │    │
│  │  │ // または SCOPED マクロ                           │  │    │
│  │  │ SCOPED_DRAW_EVENT(RHICmdList, ShadowPass);        │  │    │
│  │  │ // スコープ終了時に自動 Pop                       │  │    │
│  │  └───────────────────────────────────────────────────┘  │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 7.2 バリデーションレイヤー

```
┌─────────────────────────────────────────────────────────────────┐
│               バリデーションレイヤー                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  D3D12 Debug Layer                                       │    │
│  │                                                          │    │
│  │  有効化:                                                 │    │
│  │  ┌───────────────────────────────────────────────────┐  │    │
│  │  │ #if _DEBUG                                        │  │    │
│  │  │ ID3D12Debug* debugController;                     │  │    │
│  │  │ if (SUCCEEDED(D3D12GetDebugInterface(             │  │    │
│  │  │     IID_PPV_ARGS(&debugController))))             │  │    │
│  │  │ {                                                 │  │    │
│  │  │     debugController->EnableDebugLayer();          │  │    │
│  │  │                                                   │  │    │
│  │  │     // GPU ベースバリデーション (より詳細)        │  │    │
│  │  │     ID3D12Debug1* debugController1;               │  │    │
│  │  │     debugController->QueryInterface(&debugController1);│  │    │
│  │  │     debugController1->SetEnableGPUBasedValidation(true);│  │    │
│  │  │ }                                                 │  │    │
│  │  │ #endif                                            │  │    │
│  │  └───────────────────────────────────────────────────┘  │    │
│  │                                                          │    │
│  │  検出可能なエラー:                                       │    │
│  │  ├── リソースステート不正                               │    │
│  │  ├── デスクリプタの不正アクセス                         │    │
│  │  ├── ルートシグネチャ不一致                             │    │
│  │  ├── バリア不足                                         │    │
│  │  ├── UAVハザード                                        │    │
│  │  └── フェンス同期エラー                                 │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  DRED (Device Removed Extended Data)                     │    │
│  │                                                          │    │
│  │  デバイスロスト時の診断情報を取得:                       │    │
│  │  ┌───────────────────────────────────────────────────┐  │    │
│  │  │ ID3D12DeviceRemovedExtendedDataSettings* dredSettings;│  │    │
│  │  │ device->QueryInterface(&dredSettings);            │  │    │
│  │  │ dredSettings->SetAutoBreadcrumbsEnablement(       │  │    │
│  │  │     D3D12_DRED_ENABLEMENT_FORCED_ON);            │  │    │
│  │  │ dredSettings->SetPageFaultEnablement(             │  │    │
│  │  │     D3D12_DRED_ENABLEMENT_FORCED_ON);            │  │    │
│  │  │                                                   │  │    │
│  │  │ // デバイスロスト発生時                           │  │    │
│  │  │ ID3D12DeviceRemovedExtendedData* dred;            │  │    │
│  │  │ device->QueryInterface(&dred);                    │  │    │
│  │  │ D3D12_DRED_AUTO_BREADCRUMBS_OUTPUT breadcrumbs;   │  │    │
│  │  │ dred->GetAutoBreadcrumbsOutput(&breadcrumbs);     │  │    │
│  │  │ // breadcrumbs から最後に実行されたコマンドを特定 │  │    │
│  │  └───────────────────────────────────────────────────┘  │    │
│  │                                                          │    │
│  │  ブレッドクラム: コマンドの実行履歴を追跡               │    │
│  │  ┌───────────────────────────────────────────────────┐  │    │
│  │  │ [Draw 1] ✓ → [Dispatch] ✓ → [Draw 2] ✗ (ここで停止)│  │    │
│  │  └───────────────────────────────────────────────────┘  │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  リソース命名                                            │    │
│  │                                                          │    │
│  │  デバッグ時にリソースを識別しやすくする:                 │    │
│  │  ┌───────────────────────────────────────────────────┐  │    │
│  │  │ resource->SetName(L"Main Color Buffer");          │  │    │
│  │  │ texture->SetName(L"Character_Albedo_01");         │  │    │
│  │  │ buffer->SetName(L"InstanceData_Frame0");          │  │    │
│  │  │                                                   │  │    │
│  │  │ // PIX、デバッグ出力、メモリ分析で表示される       │  │    │
│  │  └───────────────────────────────────────────────────┘  │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## まとめ: 実装チェックリスト (追加分)

```
┌─────────────────────────────────────────────────────────────────┐
│            実装チェックリスト (Part 5 追加分)                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  スワップチェーン:                                               │
│  ├── □ スワップチェーン作成 (Create)                            │
│  ├── □ バックバッファ取得 (GetBuffer)                           │
│  ├── □ Present                                                  │
│  ├── □ リサイズ (ResizeBuffers)                                 │
│  ├── □ VSync / ティアリング制御                                 │
│  └── □ HDR対応 (オプション)                                     │
│                                                                  │
│  レンダーパス:                                                   │
│  ├── □ BeginRenderPass / EndRenderPass (D3D12オプション)        │
│  ├── □ Load/Store操作の最適化                                   │
│  └── □ サブパス (Vulkan向け)                                    │
│                                                                  │
│  描画コマンド:                                                   │
│  ├── □ DrawPrimitive                                            │
│  ├── □ DrawIndexedPrimitive                                     │
│  ├── □ DrawInstanced / DrawIndexedInstanced                     │
│  ├── □ DrawIndirect / DrawIndexedIndirect                       │
│  ├── □ ExecuteIndirect (Multi-Draw)                             │
│  └── □ DispatchMesh (メッシュシェーダー)                        │
│                                                                  │
│  コピーコマンド:                                                 │
│  ├── □ CopyBufferRegion                                         │
│  ├── □ CopyTextureRegion                                        │
│  ├── □ Upload (CPU→GPU)                                         │
│  ├── □ Readback (GPU→CPU)                                       │
│  └── □ ResolveSubresource (MSAA)                                │
│                                                                  │
│  状態バインディング:                                             │
│  ├── □ IASetVertexBuffers                                       │
│  ├── □ IASetIndexBuffer                                         │
│  ├── □ IASetPrimitiveTopology                                   │
│  ├── □ SetGraphicsRootConstantBufferView                        │
│  ├── □ SetGraphicsRootDescriptorTable                           │
│  ├── □ SetGraphicsRoot32BitConstants                            │
│  ├── □ SetDescriptorHeaps                                       │
│  ├── □ OMSetRenderTargets                                       │
│  ├── □ RSSetViewports                                           │
│  ├── □ RSSetScissorRects                                        │
│  └── □ ClearRenderTargetView / ClearDepthStencilView            │
│                                                                  │
│  クエリ:                                                         │
│  ├── □ Timestamp Query                                          │
│  ├── □ Occlusion Query                                          │
│  ├── □ Pipeline Statistics Query                                │
│  └── □ ResolveQueryData                                         │
│                                                                  │
│  デバッグ:                                                       │
│  ├── □ Debug Layer 有効化                                       │
│  ├── □ PIX / RenderDoc マーカー                                 │
│  ├── □ リソース命名                                             │
│  └── □ DRED (Device Removed Extended Data)                      │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

これで Part 1-5 により、RHI実装に必要なすべての主要コンポーネントを網羅しました。
