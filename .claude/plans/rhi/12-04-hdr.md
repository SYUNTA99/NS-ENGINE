# 12-04: HDRサポート

## 目的

HDR（High Dynamic Range）出力のサポートを定義する。

## 参照ドキュメント

- 12-01-swapchain-desc.md (RHISwapChainDesc)
- 12-02-swapchain-interface.md (IRHISwapChain)
- 15-01-pixel-format-enum.md (HDRフォーマット

## 変更対象ファイル

新規作成:
- `Source/Engine/RHI/Public/RHIHDR.h`

## TODO

### 1. HDRメタデータ

```cpp
#pragma once

#include "RHITypes.h"

namespace NS::RHI
{
    /// HDRメタデータタイプ
    enum class ERHIHDRMetadataType : uint8
    {
        None,

        /// HDR10（ST.2086 + MaxCLL/MaxFALL）。
        HDR10,

        /// HDR10+
        HDR10Plus,

        /// Dolby Vision
        DolbyVision,
    };

    /// 色域
    struct RHI_API RHIColorPrimaries
    {
        /// 赤プライマリ（y座標）
        float redX = 0.0f;
        float redY = 0.0f;

        /// 緑プライマリ
        float greenX = 0.0f;
        float greenY = 0.0f;

        /// 青プライマリ
        float blueX = 0.0f;
        float blueY = 0.0f;

        /// 白色点
        float whiteX = 0.0f;
        float whiteY = 0.0f;

        /// sRGB / Rec.709
        static RHIColorPrimaries Rec709() {
            RHIColorPrimaries p;
            p.redX = 0.64f;   p.redY = 0.33f;
            p.greenX = 0.30f; p.greenY = 0.60f;
            p.blueX = 0.15f;  p.blueY = 0.06f;
            p.whiteX = 0.3127f; p.whiteY = 0.3290f;
            return p;
        }

        /// DCI-P3
        static RHIColorPrimaries DCIP3() {
            RHIColorPrimaries p;
            p.redX = 0.680f;  p.redY = 0.320f;
            p.greenX = 0.265f; p.greenY = 0.690f;
            p.blueX = 0.150f;  p.blueY = 0.060f;
            p.whiteX = 0.3127f; p.whiteY = 0.3290f;
            return p;
        }

        /// Rec.2020
        static RHIColorPrimaries Rec2020() {
            RHIColorPrimaries p;
            p.redX = 0.708f;  p.redY = 0.292f;
            p.greenX = 0.170f; p.greenY = 0.797f;
            p.blueX = 0.131f;  p.blueY = 0.046f;
            p.whiteX = 0.3127f; p.whiteY = 0.3290f;
            return p;
        }
    };

    /// HDRメタデータ
    struct RHI_API RHIHDRMetadata
    {
        /// メタデータタイプ
        ERHIHDRMetadataType type = ERHIHDRMetadataType::None;

        /// 色域
        RHIColorPrimaries colorPrimaries;

        /// 最大マスタリング輝度（nits）。
        float maxMasteringLuminance = 1000.0f;

        /// 最小マスタリング輝度（nits）。
        float minMasteringLuminance = 0.001f;

        /// 最大コンテントライトレベル（nits）。
        float maxContentLightLevel = 1000.0f;

        /// 最大フレーム平均ホワイトレベル（nits）。
        float maxFrameAverageLightLevel = 400.0f;

        /// メタデータのバリデーション
        bool IsValid() const {
            if (type == ERHIHDRMetadataType::None) return true;
            return minMasteringLuminance >= 0.0f
                && maxMasteringLuminance > minMasteringLuminance
                && maxContentLightLevel > 0.0f
                && maxFrameAverageLightLevel > 0.0f
                && maxFrameAverageLightLevel <= maxContentLightLevel;
        }
    };
}
```

- [ ] ERHIHDRMetadataType 列挙型
- [ ] RHIColorPrimaries 構造体
- [ ] RHIHDRMetadata 構造体

### 2. HDR出力情報

```cpp
namespace NS::RHI
{
    /// カラースペース
    enum class ERHIColorSpace : uint8
    {
        /// sRGB
        sRGB,

        /// リニア（RGB色域）
        sRGBLinear,

        /// scRGB（拡張sRGB、HDR）。
        scRGB,

        /// HDR10（ST.2084 + Rec.2020）。
        HDR10_ST2084,

        /// HLG（Hybrid Log-Gamma）。
        HLG,

        /// ACEScg
        ACEScg,

        /// カスタム
        Custom,
    };

    /// HDR出力マ力
    struct RHI_API RHIHDROutputCapabilities
    {
        /// HDR対応か
        bool supportsHDR = false;

        /// サポートされるHDRフォーマット
        bool supportsHDR10 = false;
        bool supportsDolbyVision = false;
        bool supportsHLG = false;

        /// サポートされるカラースペース
        bool supportsScRGB = false;
        bool supportsRec2020 = false;

        /// ディスプレイ能力
        float minLuminance = 0.0f;      // nits
        float maxLuminance = 0.0f;      // nits
        float maxFullFrameLuminance = 0.0f;  // nits

        /// ビット深度
        uint32 bitsPerColor = 8;

        /// 推奨カラースペース
        ERHIColorSpace recommendedColorSpace = ERHIColorSpace::sRGB;

        /// 推奨フォーマット
        ERHIPixelFormat recommendedFormat = ERHIPixelFormat::R8G8B8A8_UNORM;
    };

    /// HDR出力情報取得（RHIAdapterに追加）。
    class IRHIAdapter
    {
    public:
        /// HDR出力マ力取得
        virtual bool GetHDROutputCapabilities(
            uint32 outputIndex,
            RHIHDROutputCapabilities& outCapabilities) const = 0;

        /// HDR有効化チェック
        bool SupportsHDR(uint32 outputIndex) const {
            RHIHDROutputCapabilities caps;
            return GetHDROutputCapabilities(outputIndex, caps) && caps.supportsHDR;
        }
    };
}
```

- [ ] ERHIColorSpace 列挙型
- [ ] RHIHDROutputCapabilities 構造体
- [ ] GetHDROutputCapabilities

### 3. スワップチェーンHDR設定

```cpp
namespace NS::RHI
{
    /// HDR設定（RHISwapChainに追加）。
    class IRHISwapChain
    {
    public:
        /// カラースペース設定
        virtual bool SetColorSpace(ERHIColorSpace colorSpace) = 0;

        /// 現在のカラースペース取得
        virtual ERHIColorSpace GetColorSpace() const = 0;

        /// HDRメタデータ設定
        virtual bool SetHDRMetadata(const RHIHDRMetadata& metadata) = 0;

        /// HDRメタデータ取得
        virtual bool GetHDRMetadata(RHIHDRMetadata& outMetadata) const = 0;

        /// HDR有効/無効切り替え
        virtual bool SetHDREnabled(bool enabled) = 0;

        /// HDR自動切り替え設定
        /// システム設定に応じてHDR/SDR自動切り替え
        virtual void SetHDRAutoSwitch(bool enabled) = 0;
    };
}
```

- [ ] SetColorSpace
- [ ] SetHDRMetadata
- [ ] SetHDREnabled

### 4. HDRトーンマッピングヘルパー

```cpp
namespace NS::RHI
{
    /// トーンマッピングモード
    enum class ERHIToneMappingMode : uint8
    {
        None,           // トーンマッピングなし
        Reinhard,       // Reinhard
        ACES,           // ACES Filmic
        AgX,            // AgX
        Uncharted2,     // Uncharted 2
        Custom,         // カスタム
    };

    /// HDRトーンマッピング設定
    struct RHI_API RHIToneMappingSettings
    {
        ERHIToneMappingMode mode = ERHIToneMappingMode::ACES;

        /// 露出補正
        float exposure = 1.0f;

        /// ホワイトポイント（nits）。
        float whitePoint = 1000.0f;

        /// ペーパーホワイト（SDR=1.0のときの輝度、nits）。
        float paperWhite = 200.0f;

        /// コントラスチ
        float contrast = 1.0f;

        /// 彩度
        float saturation = 1.0f;
    };

    /// HDR→SDR変換ヘルパー
    class RHI_API RHIHDRHelper
    {
    public:
        /// リニア→ST.2084（PQ（変換
        static float LinearToPQ(float linear);

        /// ST.2084→リニア変換
        static float PQToLinear(float pq);

        /// リニア→HLG変換
        static float LinearToHLG(float linear);

        /// HLG→リニア変換
        static float HLGToLinear(float hlg);

        /// sRGB→リニア変換
        static float sRGBToLinear(float srgb);

        /// リニア→sRGB変換
        static float LinearTosRGB(float linear);

        /// 最適なHDRフォーマット選択
        static ERHIPixelFormat SelectOptimalHDRFormat(
            const RHIHDROutputCapabilities& capabilities);

        /// 最適なカラースペース選択
        static ERHIColorSpace SelectOptimalColorSpace(
            const RHIHDROutputCapabilities& capabilities);
    };
}
```

- [ ] ERHIToneMappingMode 列挙型
- [ ] RHIToneMappingSettings 構造体
- [ ] RHIHDRHelper クラス

### 5. 自動輝度調整

```cpp
namespace NS::RHI
{
    /// 自動輝度調整（Auto HDR（設定
    struct RHI_API RHIAutoHDRSettings
    {
        /// 有効化
        bool enabled = false;

        /// SDRコンテンツの最大輝度ブースト
        float maxBoost = 2.0f;

        /// 輝度拡張の強度
        float intensity = 1.0f;

        /// ハイライト拡張の閾値
        float highlightThreshold = 0.8f;

        /// シャドウ保持の強度
        float shadowRetention = 0.5f;
    };

    /// 自動輝度調整（RHISwapChainに追加）。
    class IRHISwapChain
    {
    public:
        /// AAuto HDR設定
        virtual void SetAutoHDRSettings(const RHIAutoHDRSettings& settings) = 0;

        /// AAuto HDR設定取得
        virtual RHIAutoHDRSettings GetAutoHDRSettings() const = 0;

        /// AAuto HDRがサポートされているか
        virtual bool SupportsAutoHDR() const = 0;
    };
}
```

- [ ] RHIAutoHDRSettings 構造体
- [ ] SetAutoHDRSettings

## 検証方法

- [ ] HDR有効化無効化
- [ ] カラースペース設定
- [ ] メタデータ設定
- [ ] ディスプレイ能力検出
