# Unreal Engine 5.7 プラットフォーム抽象化レイヤー (HAL) 完全解説

## 第5部：スレッディング・クラッシュ処理・ネットワーク・文字列処理

---

## 目次

1. [スレッディング詳細 (PlatformAffinity)](#1-スレッディング詳細-platformaffinity)
2. [スレッドローカルストレージ (PlatformTLS)](#2-スレッドローカルストレージ-platformtls)
3. [クラッシュ処理 (PlatformCrashContext)](#3-クラッシュ処理-platformcrashcontext)
4. [スタックウォーク (PlatformStackWalk)](#4-スタックウォーク-platformstackwalk)
5. [ネットワーク/ソケット実装](#5-ネットワークソケット実装)
6. [文字列処理 (PlatformString)](#6-文字列処理-platformstring)
7. [スレッディングプリミティブ詳細](#7-スレッディングプリミティブ詳細)

---

## 1. スレッディング詳細 (PlatformAffinity)

### コンポーネント概要

```
┌─────────────────────────────────────────────────────────────────────────┐
│                   スレッディングシステム概要                             │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【役割】                                                                │
│   ・スレッドの優先度制御                                                 │
│   ・CPUコアへのアフィニティ設定                                          │
│   ・スレッドグループ管理                                                 │
│   ・プラットフォーム固有のスレッド最適化                                  │
│                                                                         │
│  【関連クラス】                                                          │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  PlatformAffinity ──────────── CPUアフィニティ管理              │ │
│  │  │                                                                │ │
│  │  │  GetMainGameMask()    ─── ゲームスレッド用CPUマスク           │ │
│  │  │  GetRenderingThreadMask() ─ レンダリングスレッド用マスク      │ │
│  │  │  GetRHIThreadMask()   ─── RHIスレッド用マスク                │ │
│  │  │  GetTaskGraphThreadMask() ─ タスクグラフ用マスク              │ │
│  │  │  GetPoolThreadMask()  ─── スレッドプール用マスク              │ │
│  │  │  GetNoAffinityMask()  ─── 制限なしマスク                     │ │
│  │  │                                                                │ │
│  │  PlatformProcess ───────────── スレッド操作                     │ │
│  │  │                                                                │ │
│  │  │  SetThreadAffinityMask() ─ アフィニティ設定                  │ │
│  │  │  SetThreadPriority()   ─── 優先度設定                        │ │
│  │  │  SetRealTimeMode()     ─── リアルタイムモード                 │ │
│  │  │                                                                │ │
│  │  RunnableThread ────────────── スレッドラッパー                 │ │
│  │  │                                                                │ │
│  │  │  Create() ─────────────── スレッド作成                       │ │
│  │  │  SetThreadPriority()   ─── 優先度変更                        │ │
│  │  │  SetThreadAffinityMask() ─ アフィニティ変更                  │ │
│  │  │                                                                │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### スレッド優先度システム

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      スレッド優先度レベル                                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【EThreadPriority 列挙型】                                              │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  優先度レベル（高→低）                                             │ │
│  │                                                                   │ │
│  │  ┌─────────────────────────────────────────────────────────────┐ │ │
│  │  │                                                             │ │ │
│  │  │  TPri_TimeCritical ──────── 最高優先度                      │ │ │
│  │  │  │                         オーディオ処理等                  │ │ │
│  │  │  │                         CPU独占の可能性あり               │ │ │
│  │  │  │                                                         │ │ │
│  │  │  TPri_Highest ───────────── 非常に高い                      │ │ │
│  │  │  │                         重要なリアルタイム処理            │ │ │
│  │  │  │                                                         │ │ │
│  │  │  TPri_AboveNormal ───────── 標準より高い                    │ │ │
│  │  │  │                         ゲームスレッド                    │ │ │
│  │  │  │                                                         │ │ │
│  │  │  TPri_Normal ────────────── 標準（デフォルト）              │ │ │
│  │  │  │                         一般的なワーカースレッド          │ │ │
│  │  │  │                                                         │ │ │
│  │  │  TPri_BelowNormal ───────── 標準より低い                    │ │ │
│  │  │  │                         バックグラウンドタスク            │ │ │
│  │  │  │                                                         │ │ │
│  │  │  TPri_Lowest ────────────── 最低優先度                      │ │ │
│  │  │  │                         アイドル時のみ実行               │ │ │
│  │  │  │                         ガベージコレクション等            │ │ │
│  │  │  │                                                         │ │ │
│  │  │  TPri_SlightlyBelowNormal ─ 標準のわずか下                  │ │ │
│  │  │                             スレッドプールのデフォルト       │ │ │
│  │  │                                                             │ │ │
│  │  └─────────────────────────────────────────────────────────────┘ │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【プラットフォーム別マッピング】                                        │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │              │   Windows              │  Unix (pthread)           │ │
│  │  ────────────┼────────────────────────┼─────────────────────────  │ │
│  │  TimeCritical│  THREAD_PRIORITY_      │  sched_param              │ │
│  │              │  TIME_CRITICAL (15)    │  max_priority             │ │
│  │  ────────────┼────────────────────────┼─────────────────────────  │ │
│  │  Highest     │  THREAD_PRIORITY_      │  sched_param              │ │
│  │              │  HIGHEST (2)           │  high                     │ │
│  │  ────────────┼────────────────────────┼─────────────────────────  │ │
│  │  AboveNormal │  THREAD_PRIORITY_      │  sched_param              │ │
│  │              │  ABOVE_NORMAL (1)      │  above_normal             │ │
│  │  ────────────┼────────────────────────┼─────────────────────────  │ │
│  │  Normal      │  THREAD_PRIORITY_      │  sched_param              │ │
│  │              │  NORMAL (0)            │  default                  │ │
│  │  ────────────┼────────────────────────┼─────────────────────────  │ │
│  │  BelowNormal │  THREAD_PRIORITY_      │  sched_param              │ │
│  │              │  BELOW_NORMAL (-1)     │  below_normal             │ │
│  │  ────────────┼────────────────────────┼─────────────────────────  │ │
│  │  Lowest      │  THREAD_PRIORITY_      │  sched_param              │ │
│  │              │  LOWEST (-2)           │  min_priority             │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### CPUアフィニティマスク

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      CPUアフィニティシステム                             │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【概念】                                                                │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  アフィニティマスク = スレッドが実行可能なCPUコアのビットマスク    │ │
│  │                                                                   │ │
│  │  8コアCPUの例:                                                    │ │
│  │  ┌─────────────────────────────────────────────────────────────┐ │ │
│  │  │                                                             │ │ │
│  │  │  ビット位置:    7    6    5    4    3    2    1    0       │ │ │
│  │  │  コア番号:    Core7 Core6 Core5 Core4 Core3 Core2 Core1 Core0│ │ │
│  │  │                                                             │ │ │
│  │  │  0xFF (11111111) = 全コアで実行可能                         │ │ │
│  │  │  0x0F (00001111) = Core0-3のみ                              │ │ │
│  │  │  0xF0 (11110000) = Core4-7のみ                              │ │ │
│  │  │  0x01 (00000001) = Core0のみ                                │ │ │
│  │  │                                                             │ │ │
│  │  └─────────────────────────────────────────────────────────────┘ │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【UE標準アフィニティグループ】                                          │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  ┌─────────────────────────────────────────────────────────────┐ │ │
│  │  │                   8コアシステムの例                          │ │ │
│  │  │                                                             │ │ │
│  │  │    Core 0    Core 1    Core 2    Core 3                     │ │ │
│  │  │   ┌──────┐  ┌──────┐  ┌──────┐  ┌──────┐                   │ │ │
│  │  │   │ Game │  │Render│  │ RHI  │  │Audio │                   │ │ │
│  │  │   │Thread│  │Thread│  │Thread│  │Thread│                   │ │ │
│  │  │   └──────┘  └──────┘  └──────┘  └──────┘                   │ │ │
│  │  │                                                             │ │ │
│  │  │    Core 4    Core 5    Core 6    Core 7                     │ │ │
│  │  │   ┌──────┐  ┌──────┐  ┌──────┐  ┌──────┐                   │ │ │
│  │  │   │TaskGr│  │TaskGr│  │TaskGr│  │TaskGr│                   │ │ │
│  │  │   │Worker│  │Worker│  │Worker│  │Worker│                   │ │ │
│  │  │   └──────┘  └──────┘  └──────┘  └──────┘                   │ │ │
│  │  │                                                             │ │ │
│  │  └─────────────────────────────────────────────────────────────┘ │ │
│  │                                                                   │ │
│  │  グループ名              │  典型的なマスク  │ 用途               │ │
│  │  ────────────────────────┼─────────────────┼─────────────────── │ │
│  │  MainGameMask            │  0x01           │ ゲームスレッド     │ │
│  │  RenderingThreadMask     │  0x02           │ レンダリング       │ │
│  │  RHIThreadMask           │  0x04           │ RHI処理            │ │
│  │  AudioThreadMask         │  0x08           │ オーディオ         │ │
│  │  TaskGraphThreadMask     │  0xF0           │ タスクグラフ       │ │
│  │  PoolThreadMask          │  0xF0           │ スレッドプール     │ │
│  │  NoAffinityMask          │  0xFF           │ 制限なし           │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【プラットフォーム別実装】                                              │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  Windows:                                                         │ │
│  │   ・SetThreadAffinityMask() API使用                              │ │
│  │   ・プロセッサグループ対応（64コア超）                            │ │
│  │   ・NUMA対応                                                      │ │
│  │                                                                   │ │
│  │  Mac:                                                             │ │
│  │   ・thread_policy_set() 使用                                     │ │
│  │   ・THREAD_AFFINITY_POLICY                                       │ │
│  │   ・Apple Silicon では制限あり（効率コア/性能コア区別）           │ │
│  │                                                                   │ │
│  │  Linux:                                                           │ │
│  │   ・pthread_setaffinity_np() 使用                                │ │
│  │   ・cpu_set_t でマスク指定                                       │ │
│  │   ・sched_setaffinity() も使用可能                               │ │
│  │                                                                   │ │
│  │  Android:                                                         │ │
│  │   ・sched_setaffinity() 使用                                     │ │
│  │   ・big.LITTLE アーキテクチャ対応                                │ │
│  │   ・高性能コアと省電力コアの振り分け                              │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### big.LITTLE / 性能・効率コア対応

```
┌─────────────────────────────────────────────────────────────────────────┐
│                ヘテロジニアスCPU対応（big.LITTLE等）                     │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【概念】                                                                │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  現代のCPUは性能重視コアと効率重視コアを混在させている            │ │
│  │                                                                   │ │
│  │  ┌─────────────────────────────────────────────────────────────┐ │ │
│  │  │                                                             │ │ │
│  │  │       性能コア (P-Core / big)    効率コア (E-Core / LITTLE) │ │ │
│  │  │       ┌─────┬─────┬─────┬─────┐ ┌─────┬─────┬─────┬─────┐   │ │ │
│  │  │       │  0  │  1  │  2  │  3  │ │  4  │  5  │  6  │  7  │   │ │ │
│  │  │       └─────┴─────┴─────┴─────┘ └─────┴─────┴─────┴─────┘   │ │ │
│  │  │                                                             │ │ │
│  │  │       高クロック・高消費電力      低クロック・低消費電力     │ │ │
│  │  │       レイテンシ重視タスク向け    スループット/省電力向け    │ │ │
│  │  │                                                             │ │ │
│  │  └─────────────────────────────────────────────────────────────┘ │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【UEでの対応】                                                          │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  PlatformMisc::GetCPUInfo() で取得可能な情報:                    │ │
│  │                                                                   │ │
│  │   ・NumCoresIncludingHyperthreads ─── 論理コア総数              │ │
│  │   ・NumPhysicalCores ─────────────── 物理コア数                 │ │
│  │   ・NumPerformanceCores ──────────── 性能コア数                 │ │
│  │   ・NumEfficiencyCores ───────────── 効率コア数                 │ │
│  │                                                                   │ │
│  │  タスク振り分け戦略:                                              │ │
│  │                                                                   │ │
│  │  ┌─────────────────────────────────────────────────────────────┐ │ │
│  │  │                                                             │ │ │
│  │  │  【性能コアに配置すべきタスク】                              │ │ │
│  │  │   ・ゲームスレッド（メインループ）                          │ │ │
│  │  │   ・レンダリングスレッド                                    │ │ │
│  │  │   ・RHIスレッド                                             │ │ │
│  │  │   ・オーディオスレッド                                      │ │ │
│  │  │   ・レイテンシ敏感な処理                                    │ │ │
│  │  │                                                             │ │ │
│  │  │  【効率コアに配置すべきタスク】                              │ │ │
│  │  │   ・バックグラウンドロード                                  │ │ │
│  │  │   ・非同期コンパイル                                        │ │ │
│  │  │   ・ガベージコレクション                                    │ │ │
│  │  │   ・ログ出力                                                │ │ │
│  │  │   ・統計収集                                                │ │ │
│  │  │                                                             │ │ │
│  │  └─────────────────────────────────────────────────────────────┘ │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【Apple Silicon 対応】                                                  │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  M1/M2/M3 などの Apple Silicon では:                             │ │
│  │                                                                   │ │
│  │   ・QoS (Quality of Service) クラスで制御                       │ │
│  │   ・直接的なアフィニティ設定は不可                               │ │
│  │                                                                   │ │
│  │  QoSクラス:                                                       │ │
│  │   ・QOS_CLASS_USER_INTERACTIVE ─── 性能コア優先                 │ │
│  │   ・QOS_CLASS_USER_INITIATED ───── 性能コア                     │ │
│  │   ・QOS_CLASS_DEFAULT ───────────── バランス                    │ │
│  │   ・QOS_CLASS_UTILITY ───────────── 効率コア                    │ │
│  │   ・QOS_CLASS_BACKGROUND ────────── 効率コア優先                │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 2. スレッドローカルストレージ (PlatformTLS)

### TLSシステム概要

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    TLS（Thread Local Storage）システム                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【概念】                                                                │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  TLS = 各スレッドに固有のデータ領域                               │ │
│  │                                                                   │ │
│  │  ┌─────────────────────────────────────────────────────────────┐ │ │
│  │  │                                                             │ │ │
│  │  │   スレッドA              スレッドB              スレッドC    │ │ │
│  │  │   ┌──────────────┐      ┌──────────────┐      ┌──────────┐  │ │ │
│  │  │   │ スタック      │      │ スタック      │      │スタック  │  │ │ │
│  │  │   ├──────────────┤      ├──────────────┤      ├──────────┤  │ │ │
│  │  │   │ TLS スロット  │      │ TLS スロット  │      │TLSスロット│  │ │ │
│  │  │   │ ┌──────────┐ │      │ ┌──────────┐ │      │┌────────┐│  │ │ │
│  │  │   │ │Slot0: 100│ │      │ │Slot0: 200│ │      ││Slot0:  ││  │ │ │
│  │  │   │ │Slot1: ptr│ │      │ │Slot1: ptr│ │      ││  300   ││  │ │ │
│  │  │   │ │Slot2: ...│ │      │ │Slot2: ...│ │      ││Slot1:..││  │ │ │
│  │  │   │ └──────────┘ │      │ └──────────┘ │      │└────────┘│  │ │ │
│  │  │   └──────────────┘      └──────────────┘      └──────────┘  │ │ │
│  │  │                                                             │ │ │
│  │  │   同じスロット番号でも、スレッドごとに異なる値を持つ          │ │ │
│  │  │                                                             │ │ │
│  │  └─────────────────────────────────────────────────────────────┘ │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【PlatformTLS インターフェース】                                       │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  AllocTlsSlot() ─────────── 新しいTLSスロットを割り当て           │ │
│  │  │                          戻り値: スロットインデックス          │ │
│  │  │                          失敗時: 0xFFFFFFFF                   │ │
│  │  │                                                                │ │
│  │  FreeTlsSlot(SlotIndex) ─── TLSスロットを解放                    │ │
│  │  │                                                                │ │
│  │  SetTlsValue(SlotIndex, Value) ── 現在スレッドのTLS値を設定      │ │
│  │  │                                                                │ │
│  │  GetTlsValue(SlotIndex) ─── 現在スレッドのTLS値を取得            │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### プラットフォーム別TLS実装

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     プラットフォーム別TLS実装                            │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【Windows】                                                             │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  使用API:                                                         │ │
│  │   ・TlsAlloc()   ────────── スロット割り当て                     │ │
│  │   ・TlsFree()    ────────── スロット解放                         │ │
│  │   ・TlsSetValue() ───────── 値設定                               │ │
│  │   ・TlsGetValue() ───────── 値取得                               │ │
│  │                                                                   │ │
│  │  制限:                                                            │ │
│  │   ・最大1088スロット（Windows 10以降）                            │ │
│  │   ・旧バージョンでは64スロット + 拡張領域                        │ │
│  │                                                                   │ │
│  │  高速アクセス:                                                    │ │
│  │   ・__declspec(thread) による静的TLS                             │ │
│  │   ・コンパイル時に確定するため高速                                │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【Unix/Mac/Linux】                                                      │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  使用API:                                                         │ │
│  │   ・pthread_key_create() ─── キー作成（スロット割り当て）        │ │
│  │   ・pthread_key_delete() ─── キー削除                            │ │
│  │   ・pthread_setspecific() ── 値設定                              │ │
│  │   ・pthread_getspecific() ── 値取得                              │ │
│  │                                                                   │ │
│  │  制限:                                                            │ │
│  │   ・PTHREAD_KEYS_MAX（最低128、通常1024）                        │ │
│  │                                                                   │ │
│  │  デストラクタ機能:                                                │ │
│  │   ・pthread_key_create() でデストラクタ関数を指定可能             │ │
│  │   ・スレッド終了時に自動呼び出し                                  │ │
│  │                                                                   │ │
│  │  高速アクセス:                                                    │ │
│  │   ・__thread キーワードによる静的TLS                             │ │
│  │   ・C++11: thread_local キーワード                               │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【UEでの使用例】                                                        │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  主な用途:                                                        │ │
│  │                                                                   │ │
│  │   ・現在スレッドのRunnableThread*ポインタ保存                   │ │
│  │   ・スレッド名保存                                                │ │
│  │   ・スレッドID保存                                                │ │
│  │   ・アロケータのスレッドキャッシュ                                │ │
│  │   ・統計収集用カウンタ                                            │ │
│  │   ・エラーハンドリング用コンテキスト                              │ │
│  │                                                                   │ │
│  │  重要なTLSスロット:                                               │ │
│  │                                                                   │ │
│  │   ・GIsRenderingThread ───── レンダリングスレッドフラグ          │ │
│  │   ・GIsGameThreadTLS ─────── ゲームスレッドフラグ                │ │
│  │   ・GRHIThreadId ─────────── RHIスレッドID                       │ │
│  │   ・GThreadContext ───────── スレッドコンテキスト                │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 3. クラッシュ処理 (PlatformCrashContext)

### クラッシュ処理システム概要

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      クラッシュ処理システム概要                          │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【クラッシュ発生からレポートまでの流れ】                                │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  ┌─────────────────────────────────────────────────────────────┐ │ │
│  │  │  1. クラッシュ発生                                           │ │ │
│  │  │     ・Access Violation（不正メモリアクセス）                 │ │ │
│  │  │     ・Stack Overflow（スタックオーバーフロー）               │ │ │
│  │  │     ・Assertion Failure（アサート失敗）                      │ │ │
│  │  │     ・未処理例外                                             │ │ │
│  │  └─────────────────────────────────────────────────────────────┘ │ │
│  │                              │                                    │ │
│  │                              ▼                                    │ │
│  │  ┌─────────────────────────────────────────────────────────────┐ │ │
│  │  │  2. 例外ハンドラが制御を取得                                 │ │ │
│  │  │     ・Windows: SetUnhandledExceptionFilter                   │ │ │
│  │  │     ・Mac/iOS: NSSetUncaughtExceptionHandler + signal        │ │ │
│  │  │     ・Linux: sigaction (SIGSEGV, SIGABRT等)                  │ │ │
│  │  └─────────────────────────────────────────────────────────────┘ │ │
│  │                              │                                    │ │
│  │                              ▼                                    │ │
│  │  ┌─────────────────────────────────────────────────────────────┐ │ │
│  │  │  3. PlatformCrashContext 作成                               │ │ │
│  │  │     ・レジスタ状態保存                                       │ │ │
│  │  │     ・スタックポインタ保存                                   │ │ │
│  │  │     ・クラッシュアドレス記録                                 │ │ │
│  │  └─────────────────────────────────────────────────────────────┘ │ │
│  │                              │                                    │ │
│  │                              ▼                                    │ │
│  │  ┌─────────────────────────────────────────────────────────────┐ │ │
│  │  │  4. スタックトレース取得                                     │ │ │
│  │  │     ・PlatformStackWalk::CaptureStackBackTrace              │ │ │
│  │  │     ・シンボル情報解決                                       │ │ │
│  │  └─────────────────────────────────────────────────────────────┘ │ │
│  │                              │                                    │ │
│  │                              ▼                                    │ │
│  │  ┌─────────────────────────────────────────────────────────────┐ │ │
│  │  │  5. ダンプファイル生成                                       │ │ │
│  │  │     ・Windows: ミニダンプ (.dmp)                             │ │ │
│  │  │     ・Mac: Apple Crash Report                                │ │ │
│  │  │     ・Linux: コアダンプ                                      │ │ │
│  │  └─────────────────────────────────────────────────────────────┘ │ │
│  │                              │                                    │ │
│  │                              ▼                                    │ │
│  │  ┌─────────────────────────────────────────────────────────────┐ │ │
│  │  │  6. クラッシュレポート作成                                   │ │ │
│  │  │     ・XMLまたはJSON形式                                      │ │ │
│  │  │     ・エンジンバージョン、プラットフォーム情報              │ │ │
│  │  │     ・ログファイル添付                                       │ │ │
│  │  └─────────────────────────────────────────────────────────────┘ │ │
│  │                              │                                    │ │
│  │                              ▼                                    │ │
│  │  ┌─────────────────────────────────────────────────────────────┐ │ │
│  │  │  7. クラッシュレポーターダイアログ表示                       │ │ │
│  │  │     ・CrashReportClient 起動                                 │ │ │
│  │  │     ・ユーザーに送信許可を求める                             │ │ │
│  │  │     ・Epic Games サーバーに送信（許可時）                    │ │ │
│  │  └─────────────────────────────────────────────────────────────┘ │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### PlatformCrashContext 構造

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    PlatformCrashContext 構造                           │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【保存される情報】                                                      │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  【基本情報】                                                      │ │
│  │   ・CrashType ─────────────── クラッシュ種別                     │ │
│  │   ・ErrorMessage ──────────── エラーメッセージ                   │ │
│  │   ・NumMinidumpFramesToIgnore ─ 無視するフレーム数              │ │
│  │                                                                   │ │
│  │  【コンテキスト情報】                                              │ │
│  │   ・ThreadId ──────────────── クラッシュしたスレッドID           │ │
│  │   ・ThreadName ────────────── スレッド名                         │ │
│  │   ・CallStack ─────────────── コールスタック配列                 │ │
│  │                                                                   │ │
│  │  【環境情報】                                                      │ │
│  │   ・CommandLine ───────────── コマンドライン引数                 │ │
│  │   ・BaseDir ───────────────── ベースディレクトリ                 │ │
│  │   ・EngineVersion ─────────── エンジンバージョン                 │ │
│  │   ・SourceContext ─────────── ソースコンテキスト                 │ │
│  │                                                                   │ │
│  │  【メモリ情報】                                                    │ │
│  │   ・MemoryStats ───────────── メモリ使用統計                     │ │
│  │   ・bAllowToBeContacted ───── 連絡許可フラグ                    │ │
│  │   ・UserDescription ───────── ユーザーの説明文                   │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【クラッシュ種別】                                                      │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  ECrashContextType 列挙型:                                        │ │
│  │                                                                   │ │
│  │   ・Crash ─────────────── 一般的なクラッシュ                     │ │
│  │   ・Assert ────────────── アサート失敗                           │ │
│  │   ・Ensure ────────────── Ensure失敗（継続可能）                 │ │
│  │   ・Stall ─────────────── ハング/フリーズ                       │ │
│  │   ・GPUCrash ──────────── GPUクラッシュ                         │ │
│  │   ・Hang ──────────────── 応答なし                              │ │
│  │   ・OutOfMemory ───────── メモリ不足                            │ │
│  │   ・AbnormalShutdown ──── 異常終了                              │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### プラットフォーム別クラッシュハンドリング

```
┌─────────────────────────────────────────────────────────────────────────┐
│                プラットフォーム別クラッシュハンドリング                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【Windows】                                                             │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  例外捕捉:                                                        │ │
│  │   ・SetUnhandledExceptionFilter() ─── グローバル例外フィルタ     │ │
│  │   ・__try / __except ─────────────── SEH（構造化例外処理）      │ │
│  │   ・AddVectoredExceptionHandler() ── ベクトル例外ハンドラ       │ │
│  │                                                                   │ │
│  │  ダンプ生成:                                                      │ │
│  │   ・MiniDumpWriteDump() ──────────── ミニダンプ作成             │ │
│  │   ・MINIDUMP_TYPE フラグで詳細度制御                             │ │
│  │     - MiniDumpNormal ─────────── 最小                           │ │
│  │     - MiniDumpWithDataSegs ──── データセグメント含む            │ │
│  │     - MiniDumpWithFullMemory ── 全メモリ（大容量）              │ │
│  │                                                                   │ │
│  │  シンボル解決:                                                    │ │
│  │   ・DbgHelp.dll 使用                                             │ │
│  │   ・SymInitialize(), SymFromAddr()                               │ │
│  │   ・PDBファイルが必要                                            │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【Mac/iOS】                                                             │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  例外捕捉:                                                        │ │
│  │   ・NSSetUncaughtExceptionHandler() ── Objective-C例外          │ │
│  │   ・signal() / sigaction() ────────── UNIXシグナル              │ │
│  │   ・Mach例外ハンドリング                                         │ │
│  │                                                                   │ │
│  │  クラッシュレポート:                                              │ │
│  │   ・PLCrashReporter ライブラリ使用                               │ │
│  │   ・Apple Crash Report 形式                                      │ │
│  │   ・.crash ファイル生成                                          │ │
│  │                                                                   │ │
│  │  シンボル解決:                                                    │ │
│  │   ・dSYM ファイルが必要                                          │ │
│  │   ・atos コマンドで解決可能                                      │ │
│  │   ・Symbolication                                                │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【Linux】                                                               │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  例外捕捉:                                                        │ │
│  │   ・sigaction() で以下のシグナルを捕捉:                          │ │
│  │     - SIGSEGV ─── セグメンテーション違反                        │ │
│  │     - SIGBUS ──── バスエラー                                    │ │
│  │     - SIGFPE ──── 浮動小数点例外                                │ │
│  │     - SIGABRT ─── abort()                                       │ │
│  │     - SIGILL ──── 不正命令                                      │ │
│  │                                                                   │ │
│  │  コアダンプ:                                                      │ │
│  │   ・/proc/sys/kernel/core_pattern で制御                        │ │
│  │   ・ulimit -c unlimited で有効化                                 │ │
│  │                                                                   │ │
│  │  シンボル解決:                                                    │ │
│  │   ・libbacktrace または libunwind 使用                           │ │
│  │   ・デバッグシンボル（-g）が必要                                 │ │
│  │   ・addr2line コマンドでも解決可能                               │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【Android】                                                             │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  例外捕捉:                                                        │ │
│  │   ・sigaction() ─── Linuxと同様                                 │ │
│  │   ・Java例外は JNI 経由で捕捉                                    │ │
│  │                                                                   │ │
│  │  クラッシュレポート:                                              │ │
│  │   ・Breakpad または Crashpad 統合                                │ │
│  │   ・Google Play Console への自動送信                            │ │
│  │   ・Tombstone ファイル                                           │ │
│  │                                                                   │ │
│  │  シンボル解決:                                                    │ │
│  │   ・NDKの ndk-stack ツール                                       │ │
│  │   ・非ストリップ .so ファイルが必要                              │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 4. スタックウォーク (PlatformStackWalk)

### スタックウォーク機能

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     PlatformStackWalk 機能一覧                         │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【主要関数】                                                            │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  【スタックトレース取得】                                          │ │
│  │                                                                   │ │
│  │  CaptureStackBackTrace(BackTrace, MaxDepth, Context)             │ │
│  │  │                                                                │ │
│  │  │  BackTrace ─── 戻りアドレス配列（出力）                       │ │
│  │  │  MaxDepth ──── 最大取得深度                                   │ │
│  │  │  Context ───── オプションのコンテキスト                       │ │
│  │  │  戻り値 ────── 取得したフレーム数                             │ │
│  │  │                                                                │ │
│  │  ─────────────────────────────────────────────────────────────── │ │
│  │                                                                   │ │
│  │  【シンボル初期化】                                                │ │
│  │                                                                   │ │
│  │  InitStackWalking() ─────────── シンボルハンドラ初期化           │ │
│  │  InitStackWalkingForProcess() ── 特定プロセス用初期化            │ │
│  │                                                                   │ │
│  │  ─────────────────────────────────────────────────────────────── │ │
│  │                                                                   │ │
│  │  【アドレス→シンボル変換】                                        │ │
│  │                                                                   │ │
│  │  ProgramCounterToSymbolInfo(ProgramCounter, SymbolInfo)          │ │
│  │  │                                                                │ │
│  │  │  入力: プログラムカウンタ（アドレス）                         │ │
│  │  │  出力: シンボル情報構造体                                     │ │
│  │  │                                                                │ │
│  │  │  取得できる情報:                                              │ │
│  │  │   ・FunctionName ─── 関数名                                  │ │
│  │  │   ・ModuleName ───── モジュール名（DLL名等）                 │ │
│  │  │   ・Filename ─────── ソースファイル名                        │ │
│  │  │   ・LineNumber ───── 行番号                                  │ │
│  │  │   ・SymbolDisplacement ── オフセット                         │ │
│  │  │                                                                │ │
│  │  ─────────────────────────────────────────────────────────────── │ │
│  │                                                                   │ │
│  │  【便利関数】                                                      │ │
│  │                                                                   │ │
│  │  StackWalkAndDump(HumanReadableString, BufferSize, Context)      │ │
│  │  │                                                                │ │
│  │  │  スタックトレースを人間可読形式で出力                         │ │
│  │  │                                                                │ │
│  │  SymbolInfoToHumanReadableString(SymbolInfo, OutString)          │ │
│  │  │                                                                │ │
│  │  │  シンボル情報を文字列化                                       │ │
│  │  │  例: "MyFunction() [MyModule.dll:123]"                       │ │
│  │  │                                                                │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### スタック構造とウォーキング

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    スタック構造とウォーキング原理                         │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【x64 スタックフレーム構造】                                            │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  高アドレス                                                       │ │
│  │  ┌─────────────────────────────────────────────────────────────┐ │ │
│  │  │                        ...                                  │ │ │
│  │  ├─────────────────────────────────────────────────────────────┤ │ │
│  │  │  呼び出し元の戻りアドレス                                    │ │ │
│  │  ├─────────────────────────────────────────────────────────────┤ │ │
│  │  │  保存されたRBP（フレームポインタ）        ◄── 前のRBP       │ │ │
│  │  ├─────────────────────────────────────────────────────────────┤ │ │
│  │  │  ローカル変数領域                                           │ │ │
│  │  │  ...                                                        │ │ │
│  │  ├─────────────────────────────────────────────────────────────┤ │ │
│  │  │  パラメータ領域（シャドウスペース）                          │ │ │
│  │  ├─────────────────────────────────────────────────────────────┤◄─ RSP│
│  │  │                        ...                                  │ │ │
│  │  └─────────────────────────────────────────────────────────────┘ │ │
│  │  低アドレス                                                       │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【ウォーキングの流れ】                                                  │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  1. 現在のRBP（フレームポインタ）を取得                           │ │
│  │     │                                                             │ │
│  │     ▼                                                             │ │
│  │  2. RBP+8 の位置から戻りアドレスを取得                           │ │
│  │     │                                                             │ │
│  │     ▼                                                             │ │
│  │  3. 戻りアドレスを記録                                           │ │
│  │     │                                                             │ │
│  │     ▼                                                             │ │
│  │  4. RBP の位置から前のフレームのRBPを取得                        │ │
│  │     │                                                             │ │
│  │     ▼                                                             │ │
│  │  5. 新しいRBPで 2-4 を繰り返し                                   │ │
│  │     │                                                             │ │
│  │     ▼                                                             │ │
│  │  6. RBP が無効（NULL、スタック外）になったら終了                  │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【注意点】                                                              │ │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  ・フレームポインタ省略最適化（-fomit-frame-pointer）時は       │ │
│  │    上記方式でウォークできない                                    │ │
│  │                                                                   │ │
│  │  ・x64 Windows/Linux では .pdata/.eh_frame を使用した           │ │
│  │    アンワインド情報ベースのウォーキングが必要                    │ │
│  │                                                                   │ │
│  │  ・インライン関数は別途デバッグ情報が必要                        │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### プラットフォーム別スタックウォーク

```
┌─────────────────────────────────────────────────────────────────────────┐
│                  プラットフォーム別スタックウォーク実装                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【Windows】                                                             │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  スタック取得:                                                    │ │
│  │   ・RtlCaptureStackBackTrace() ──── 高速、推奨                  │ │
│  │   ・StackWalk64() ────────────────── 詳細情報取得可能           │ │
│  │   ・RtlVirtualUnwind() ───────────── 最も正確                   │ │
│  │                                                                   │ │
│  │  シンボル解決 (DbgHelp.dll):                                      │ │
│  │   ・SymInitialize() ──────────── 初期化                         │ │
│  │   ・SymFromAddr() ────────────── アドレス→シンボル名            │ │
│  │   ・SymGetLineFromAddr64() ──── アドレス→ファイル/行番号       │ │
│  │   ・SymGetModuleBase64() ─────── モジュールベースアドレス       │ │
│  │                                                                   │ │
│  │  シンボル検索パス:                                                │ │
│  │   ・_NT_SYMBOL_PATH 環境変数                                     │ │
│  │   ・Microsoft シンボルサーバー                                   │ │
│  │   ・ローカルPDBパス                                              │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【Mac/iOS】                                                             │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  スタック取得:                                                    │ │
│  │   ・backtrace() ────────────────── 標準ライブラリ関数           │ │
│  │   ・_Unwind_Backtrace() ────────── libunwind使用                │ │
│  │                                                                   │ │
│  │  シンボル解決:                                                    │ │
│  │   ・dladdr() ──────────────────── 基本情報                      │ │
│  │   ・backtrace_symbols() ────────── シンボル文字列               │ │
│  │   ・atos ツール ────────────────── 外部コマンド                 │ │
│  │                                                                   │ │
│  │  dSYM バンドル:                                                   │ │
│  │   ・DWARF デバッグ情報を含む                                     │ │
│  │   ・dsymutil で生成                                              │ │
│  │   ・UUID でバイナリとマッチング                                  │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【Linux】                                                               │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  スタック取得:                                                    │ │
│  │   ・backtrace() ─────────────────── glibc提供                   │ │
│  │   ・libunwind ───────────────────── より堅牢                    │ │
│  │   ・_Unwind_Backtrace() ─────────── GCC組み込み                 │ │
│  │                                                                   │ │
│  │  シンボル解決:                                                    │ │
│  │   ・dladdr() ────────────────────── 基本                        │ │
│  │   ・libbacktrace ────────────────── DWARF解析                   │ │
│  │   ・addr2line ───────────────────── 外部ツール                  │ │
│  │                                                                   │ │
│  │  デバッグ情報:                                                    │ │
│  │   ・DWARF フォーマット (.debug_*)                                │ │
│  │   ・分離デバッグシンボル (.debug ファイル)                       │ │
│  │   ・debuginfod サーバー                                          │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【ARM64 での注意点】                                                    │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  ・リンクレジスタ (LR/x30) に戻りアドレスが格納される             │ │
│  │  ・フレームポインタ (FP/x29) が必要                              │ │
│  │  ・Pointer Authentication (PAC) でアドレスが署名される場合あり   │ │
│  │   → xpaci 命令で署名除去が必要                                  │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 5. ネットワーク/ソケット実装

### ソケットサブシステム概要

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      ソケットサブシステム概要                            │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【レイヤー構造】                                                        │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  アプリケーションコード                                           │ │
│  │         │                                                         │ │
│  │         ▼                                                         │ │
│  │  ┌─────────────────────────────────────────────────────────────┐ │ │
│  │  │                    ISocketSubsystem                         │ │ │
│  │  │        ソケットサブシステムインターフェース                   │ │ │
│  │  │   ・CreateSocket()                                          │ │ │
│  │  │   ・GetHostByName()                                         │ │ │
│  │  │   ・GetAddressInfo()                                        │ │ │
│  │  └─────────────────────────────────────────────────────────────┘ │ │
│  │         │                                                         │ │
│  │         ▼                                                         │ │
│  │  ┌─────────────────────────────────────────────────────────────┐ │ │
│  │  │                       Socket                               │ │ │
│  │  │              ソケットラッパークラス                          │ │ │
│  │  │   ・Connect() / Bind() / Listen() / Accept()                │ │ │
│  │  │   ・Send() / Recv()                                         │ │ │
│  │  │   ・SetNonBlocking()                                        │ │ │
│  │  └─────────────────────────────────────────────────────────────┘ │ │
│  │         │                                                         │ │
│  │         ▼                                                         │ │
│  │  ┌─────────────────────────────────────────────────────────────┐ │ │
│  │  │               プラットフォーム固有実装                        │ │ │
│  │  │                                                             │ │ │
│  │  │   Windows: SocketSubsystemWindows (Winsock2)               │ │ │
│  │  │   Unix:    SocketSubsystemUnix (BSD Sockets)               │ │ │
│  │  │                                                             │ │ │
│  │  └─────────────────────────────────────────────────────────────┘ │ │
│  │         │                                                         │ │
│  │         ▼                                                         │ │
│  │  ┌─────────────────────────────────────────────────────────────┐ │ │
│  │  │                    OS ソケットAPI                            │ │ │
│  │  └─────────────────────────────────────────────────────────────┘ │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### BSDソケット機能フラグ

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      BSDソケット機能フラグ詳細                          │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【PLATFORM_HAS_BSD_SOCKETS 関連フラグ】                                │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  フラグ名                              │ Win │ Mac │ Linux │ And │ │
│  │  ──────────────────────────────────────┼─────┼─────┼───────┼─────│ │
│  │  PLATFORM_HAS_BSD_SOCKETS              │  ●  │  ●  │   ●   │  ●  │ │
│  │  PLATFORM_HAS_BSD_IPV6_SOCKETS         │  ●  │  ●  │   ●   │  ●  │ │
│  │                                                                   │ │
│  │  【機能サブフラグ】                                                │ │
│  │  FEATURE_WINSOCKETS ───────────────────│  ●  │  ○  │   ○   │  ○  │ │
│  │    Winsock2 API使用                                               │ │
│  │                                                                   │ │
│  │  FEATURE_IOCTL ────────────────────────│  ○  │  ●  │   ●   │  ●  │ │
│  │    ioctl() による制御                                             │ │
│  │                                                                   │ │
│  │  FEATURE_POLL ─────────────────────────│  ○  │  ●  │   ●   │  ●  │ │
│  │    poll() システムコール                                          │ │
│  │                                                                   │ │
│  │  FEATURE_SELECT ───────────────────────│  ●  │  ●  │   ●   │  ●  │ │
│  │    select() システムコール                                        │ │
│  │                                                                   │ │
│  │  FEATURE_MSG_DONTWAIT ─────────────────│  ○  │  ●  │   ●   │  ●  │ │
│  │    非ブロッキングsend/recvフラグ                                  │ │
│  │                                                                   │ │
│  │  FEATURE_RECVMMSG ─────────────────────│  ○  │  ○  │   ●   │  ○  │ │
│  │    recvmmsg() 複数メッセージ受信                                  │ │
│  │                                                                   │ │
│  │  FEATURE_TIMESTAMP ────────────────────│  ○  │  ●  │   ●   │  ●  │ │
│  │    パケットタイムスタンプ                                         │ │
│  │                                                                   │ │
│  │  FEATURE_CLOSE_ON_EXEC ────────────────│  ○  │  ●  │   ●   │  ●  │ │
│  │    SOCK_CLOEXEC フラグ                                            │ │
│  │                                                                   │ │
│  │  FEATURE_NODELAY ──────────────────────│  ●  │  ●  │   ●   │  ●  │ │
│  │    TCP_NODELAY オプション                                         │ │
│  │                                                                   │ │
│  │  ● = サポート  ○ = 非サポート                                      │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### プラットフォーム別ソケット実装

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    プラットフォーム別ソケット実装                        │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【Windows (Winsock2)】                                                  │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  初期化:                                                          │ │
│  │   ・WSAStartup() ─── 必須の初期化                                │ │
│  │   ・WSACleanup() ─── 終了処理                                    │ │
│  │                                                                   │ │
│  │  ソケット作成:                                                    │ │
│  │   ・socket() / WSASocket()                                       │ │
│  │   ・closesocket() ─── close()ではない点に注意                   │ │
│  │                                                                   │ │
│  │  非ブロッキング設定:                                              │ │
│  │   ・ioctlsocket(sock, FIONBIO, &mode)                           │ │
│  │                                                                   │ │
│  │  エラー取得:                                                      │ │
│  │   ・WSAGetLastError() ─── errno ではない                        │ │
│  │                                                                   │ │
│  │  I/O多重化:                                                       │ │
│  │   ・select() ─────────── 最大 FD_SETSIZE (通常64)              │ │
│  │   ・WSAPoll() ────────── poll()相当（Vista以降）               │ │
│  │   ・WSAEventSelect() ── イベントベース                          │ │
│  │   ・IOCP ─────────────── 高性能非同期I/O                       │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【Unix/Mac/Linux (BSD Sockets)】                                        │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  初期化:                                                          │ │
│  │   ・不要（グローバル初期化なし）                                  │ │
│  │                                                                   │ │
│  │  ソケット作成:                                                    │ │
│  │   ・socket()                                                      │ │
│  │   ・close() ─── 通常のファイルディスクリプタクローズ             │ │
│  │                                                                   │ │
│  │  非ブロッキング設定:                                              │ │
│  │   ・fcntl(sock, F_SETFL, O_NONBLOCK)                             │ │
│  │   ・SOCK_NONBLOCK フラグ（Linux 2.6.27+）                        │ │
│  │                                                                   │ │
│  │  エラー取得:                                                      │ │
│  │   ・errno グローバル変数                                         │ │
│  │                                                                   │ │
│  │  I/O多重化:                                                       │ │
│  │   ・select() ────── ポータブルだが FD_SETSIZE 制限              │ │
│  │   ・poll() ─────── 制限なし、推奨                               │ │
│  │   ・epoll (Linux) ─ 高性能、エッジトリガー対応                   │ │
│  │   ・kqueue (Mac) ── BSD系高性能I/O                              │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【差異の抽象化】                                                        │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  UE統一API          │  Windows              │  Unix               │ │
│  │  ───────────────────┼───────────────────────┼───────────────────  │ │
│  │  Socket::Close()   │  closesocket()        │  close()            │ │
│  │  GetLastError()     │  WSAGetLastError()    │  errno              │ │
│  │  SetNonBlocking()   │  ioctlsocket()        │  fcntl()            │ │
│  │  HasPendingData()   │  ioctlsocket(FIONREAD)│  ioctl(FIONREAD)    │ │
│  │                                                                   │ │
│  │  エラーコードの変換:                                              │ │
│  │   ・WSAEWOULDBLOCK → EWOULDBLOCK                                │ │
│  │   ・WSAECONNRESET  → ECONNRESET                                 │ │
│  │   ・WSAEINPROGRESS → EINPROGRESS                                │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 6. 文字列処理 (PlatformString)

### PlatformString 機能

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      PlatformString 機能一覧                           │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【役割】                                                                │
│   ・プラットフォーム最適化された文字列操作                               │
│   ・SIMD命令を活用した高速処理                                           │
│   ・文字エンコーディング変換                                             │
│                                                                         │
│  【主要関数】                                                            │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  【メモリ操作（SIMD最適化）】                                      │ │
│  │                                                                   │ │
│  │  Memcpy(Dest, Src, Size) ────────── メモリコピー                 │ │
│  │  │                                                                │ │
│  │  │  最適化:                                                      │ │
│  │  │   ・小サイズ: 直接コピー                                     │ │
│  │  │   ・中サイズ: REP MOVSB / memcpy                             │ │
│  │  │   ・大サイズ: SSE/AVX ストリーミング                         │ │
│  │  │   ・非整列: 整列境界まで通常コピー後、SIMD                   │ │
│  │  │                                                                │ │
│  │  Memmove(Dest, Src, Size) ───────── 重複許容コピー               │ │
│  │  │                                                                │ │
│  │  │  領域重複時:                                                  │ │
│  │  │   ・前方重複 → 後ろから前へコピー                            │ │
│  │  │   ・後方重複 → 前から後ろへコピー                            │ │
│  │  │                                                                │ │
│  │  Memset(Dest, Char, Size) ───────── メモリ充填                   │ │
│  │  │                                                                │ │
│  │  │  最適化:                                                      │ │
│  │  │   ・SSE: _mm_set1_epi8 + ストア                              │ │
│  │  │   ・AVX: _mm256_set1_epi8 + ストア                           │ │
│  │  │                                                                │ │
│  │  Memzero(Dest, Size) ────────────── ゼロ充填                     │ │
│  │  │                                                                │ │
│  │  │  Memset(Dest, 0, Size) と等価だが最適化される場合あり         │ │
│  │  │                                                                │ │
│  │  Memcmp(A, B, Size) ─────────────── メモリ比較                   │ │
│  │  │                                                                │ │
│  │  │  最適化:                                                      │ │
│  │  │   ・SSE: _mm_cmpeq_epi8 + _mm_movemask_epi8                  │ │
│  │  │   ・早期終了: 差異発見で即リターン                           │ │
│  │  │                                                                │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【文字列操作】                                                          │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  Strlen(String) ─────────────────── 文字列長取得                 │ │
│  │  │                                                                │ │
│  │  │  最適化:                                                      │ │
│  │  │   ・SSE: ヌル文字をSIMDで検索                                │ │
│  │  │   ・16/32バイト単位で並列検索                                │ │
│  │  │                                                                │ │
│  │  Strcmp(A, B) ───────────────────── 文字列比較                   │ │
│  │  Stricmp(A, B) ──────────────────── 大小無視比較                 │ │
│  │  Strncmp(A, B, N) ───────────────── N文字比較                    │ │
│  │  Strnicmp(A, B, N) ──────────────── N文字大小無視比較            │ │
│  │                                                                   │ │
│  │  Strcpy(Dest, Src) ──────────────── 文字列コピー                 │ │
│  │  Strncpy(Dest, Src, N) ──────────── N文字コピー                  │ │
│  │  Strcat(Dest, Src) ──────────────── 文字列連結                   │ │
│  │                                                                   │ │
│  │  Strchr(Str, Char) ──────────────── 文字検索                     │ │
│  │  Strrchr(Str, Char) ─────────────── 末尾から文字検索             │ │
│  │  Strstr(Str, SubStr) ────────────── 部分文字列検索               │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### SIMD最適化詳細

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       SIMD最適化の詳細                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【Memcpy最適化フロー】                                                  │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │   Size の判定                                                     │ │
│  │      │                                                            │ │
│  │      ├── Size < 16 ────────────────────────────────────────────┐ │ │
│  │      │                                                         │ │ │
│  │      │   単純コピー（バイト/ワード単位）                        │ │ │
│  │      │                                                         │ │ │
│  │      ├── 16 <= Size < 64 ──────────────────────────────────────┤ │ │
│  │      │                                                         │ │ │
│  │      │   SSE (128bit) レジスタ使用                              │ │ │
│  │      │   _mm_loadu_si128 / _mm_storeu_si128                    │ │ │
│  │      │                                                         │ │ │
│  │      ├── 64 <= Size < 256 ─────────────────────────────────────┤ │ │
│  │      │                                                         │ │ │
│  │      │   AVX (256bit) レジスタ使用                              │ │ │
│  │      │   _mm256_loadu_si256 / _mm256_storeu_si256              │ │ │
│  │      │                                                         │ │ │
│  │      └── Size >= 256 ──────────────────────────────────────────┘ │ │
│  │                                                                   │ │
│  │          ストリーミングストア使用                                 │ │
│  │          _mm256_stream_si256（キャッシュバイパス）               │ │
│  │          プリフェッチ: _mm_prefetch                              │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【ARM64 (NEON) での最適化】                                             │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  NEON命令を使用:                                                  │ │
│  │   ・vld1q_u8 / vst1q_u8 ─── 128bit ロード/ストア                │ │
│  │   ・ldp / stp ────────────── ペアロード/ストア                  │ │
│  │                                                                   │ │
│  │  Apple Silicon 特有:                                              │ │
│  │   ・memcpy は高度に最適化済み                                    │ │
│  │   ・手動最適化が逆効果になる場合あり                              │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【キャッシュ考慮】                                                      │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  大サイズコピー時の戦略:                                          │ │
│  │                                                                   │ │
│  │  ┌─────────────────────────────────────────────────────────────┐ │ │
│  │  │                                                             │ │ │
│  │  │  通常ストア（キャッシュ経由）                                │ │ │
│  │  │   ・小〜中サイズ                                            │ │ │
│  │  │   ・読み取りされるデータ                                    │ │ │
│  │  │                                                             │ │ │
│  │  │  ストリーミングストア（キャッシュバイパス）                  │ │ │
│  │  │   ・大サイズ（L3キャッシュ超）                              │ │ │
│  │  │   ・書き込み専用データ                                      │ │ │
│  │  │   ・WC（Write Combining）メモリ                             │ │ │
│  │  │                                                             │ │ │
│  │  │  プリフェッチ                                                │ │ │
│  │  │   ・読み取り先を事前にキャッシュにロード                     │ │ │
│  │  │   ・_mm_prefetch(addr, _MM_HINT_T0)                         │ │ │
│  │  │                                                             │ │ │
│  │  └─────────────────────────────────────────────────────────────┘ │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 文字エンコーディング変換

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      文字エンコーディング変換                            │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【UEの文字型とエンコーディング】                                        │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  型               │ サイズ   │ エンコーディング                   │ │
│  │  ─────────────────┼──────────┼─────────────────────────────────   │ │
│  │  ANSICHAR         │ 1 byte   │ ASCII / ロケール依存              │ │
│  │  UTF8CHAR         │ 1 byte   │ UTF-8 (可変長)                    │ │
│  │  WIDECHAR         │ 2 bytes  │ UTF-16                            │ │
│  │  UTF32CHAR        │ 4 bytes  │ UTF-32                            │ │
│  │  TCHAR            │ 2 bytes* │ UTF-16 (デフォルト)               │ │
│  │                                                                   │ │
│  │  * USE_UTF8_TCHARS 有効時は UTF8CHAR (1 byte)                    │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【変換関数】                                                            │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  PlatformString 変換関数:                                        │ │
│  │                                                                   │ │
│  │   ・Convert(Dest, DestLen, Src, SrcLen)                          │ │
│  │     テンプレート化された汎用変換                                  │ │
│  │                                                                   │ │
│  │  UTF8ToTCHAR / TCHARToUTF8:                                    │ │
│  │   ・UTF-8 ⇔ TCHAR 変換ヘルパー                                  │ │
│  │                                                                   │ │
│  │  String変換:                                                     │ │
│  │   ・String → UTF8: TCHAR_TO_UTF8(String)                       │ │
│  │   ・UTF8 → String: UTF8_TO_TCHAR(Utf8String)                   │ │
│  │   ・String → ANSI: TCHAR_TO_ANSI(String)                       │ │
│  │   ・ANSI → String: ANSI_TO_TCHAR(AnsiString)                   │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【プラットフォーム別の違い】                                            │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  Windows:                                                         │ │
│  │   ・wchar_t = 2 bytes (UTF-16)                                   │ │
│  │   ・Win32 API は UTF-16 (W関数)                                  │ │
│  │   ・コードページ変換: MultiByteToWideChar / WideCharToMultiByte  │ │
│  │                                                                   │ │
│  │  Unix/Mac/Linux:                                                  │ │
│  │   ・wchar_t = 4 bytes (UTF-32)                                   │ │
│  │   ・WIDECHAR は char16_t で明示的に2バイト                       │ │
│  │   ・iconv() でエンコーディング変換                               │ │
│  │   ・setlocale() でロケール設定                                   │ │
│  │                                                                   │ │
│  │  注意点:                                                          │ │
│  │   ・サロゲートペア (UTF-16)：U+10000以上の文字は2ユニット必要    │ │
│  │   ・結合文字：1つの表示文字が複数コードポイントで構成される場合  │ │
│  │   ・正規化：同じ文字に複数の表現がある（NFC/NFD）                │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 7. スレッディングプリミティブ詳細

### Event 実装詳細

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        Event 実装詳細                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【Event クラス内部構造】                                                │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  class Event {                                                   │ │
│  │      static TAtomic<uint32> EventUniqueId; // グローバルIDカウンタ│ │
│  │      uint32 EventId;                        // 一意のイベントID   │ │
│  │      TAtomic<uint32> EventStartCycles;      // 待機開始サイクル   │ │
│  │  };                                                              │ │
│  │                                                                   │ │
│  │  ※ EventId は生成時に EventUniqueId++ で割り当て                 │ │
│  │  ※ 統計収集中のみ EventStartCycles が使用される                  │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【EEventMode 列挙型】                                                   │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  enum class EEventMode {                                         │ │
│  │      AutoReset,    // シグナル後に自動リセット（1スレッドのみ）   │ │
│  │      ManualReset   // 明示的にReset()を呼ぶまでシグナル状態維持   │ │
│  │  };                                                              │ │
│  │                                                                   │ │
│  │  【使い分け】                                                     │ │
│  │   AutoReset:  Producer-Consumer パターン、1対1通知              │ │
│  │   ManualReset: ブロードキャスト、複数スレッドへの一斉通知        │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【統計トラッキング機能】                                                │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  WaitForStats():                                                 │ │
│  │   └─ STAT_EventWaitWithId にパケット送信                        │ │
│  │   └─ PacketEventIdAndCycles = (EventId << 32) | 0               │ │
│  │   └─ EventStartCycles = Cycles() で待機開始時刻記録             │ │
│  │                                                                   │ │
│  │  TriggerForStats():                                              │ │
│  │   └─ STAT_EventTriggerWithId にパケット送信                     │ │
│  │   └─ DeltaCycles = EndCycles - EventStartCycles                 │ │
│  │   └─ PacketEventIdAndCycles = (EventId << 32) | DeltaCycles     │ │
│  │                                                                   │ │
│  │  ResetForStats():                                                │ │
│  │   └─ EventStartCycles = 0 にリセット                            │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### EventRef / SharedEventRef

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    EventRef / SharedEventRef                            │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【EventRef クラス】                                                     │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  RAII スタイルのプールド Event                                    │ │
│  │                                                                   │ │
│  │  class EventRef final {                                          │ │
│  │      Event* Event;                                               │ │
│  │                                                                   │ │
│  │      explicit EventRef(EEventMode Mode = EEventMode::AutoReset); │ │
│  │      ~EventRef();  // 自動的にプールに返却                       │ │
│  │                                                                   │ │
│  │      // コピー・ムーブ禁止                                        │ │
│  │      EventRef(const EventRef&) = delete;                         │ │
│  │      EventRef(EventRef&&) = delete;                              │ │
│  │  };                                                              │ │
│  │                                                                   │ │
│  │  ※ TEventPool<EEventMode> からイベントを取得                    │ │
│  │  ※ デストラクタでプールに返却（再利用）                          │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【SharedEventRef クラス】                                               │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  参照カウント付きの共有イベント                                   │ │
│  │                                                                   │ │
│  │  class SharedEventRef final {                                    │ │
│  │      TSharedPtr<Event> Ptr;                                      │ │
│  │                                                                   │ │
│  │      explicit SharedEventRef(EEventMode Mode);                   │ │
│  │  };                                                              │ │
│  │                                                                   │ │
│  │  ※ 複数の所有者間でイベントを共有可能                            │ │
│  │  ※ 最後の参照が破棄されるとプールに返却                          │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【TEventPool テンプレート】                                             │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  template<EEventMode PoolType>                                   │ │
│  │  class TEventPool {                                              │ │
│  │      TLockFreePointerListUnordered<Event> Pool;                  │ │
│  │                                                                   │ │
│  │      Event* GetEventFromPool();    // プールからイベント取得     │ │
│  │      void ReturnToPool(Event*);    // プールに返却               │ │
│  │      Event* GetRawEvent();         // 内部用生イベント取得       │ │
│  │      void ReturnRawEvent(Event*);  // 内部用生イベント返却       │ │
│  │      void EmptyPool();             // プールをクリア             │ │
│  │  };                                                              │ │
│  │                                                                   │ │
│  │  ※ TLazySingleton でシングルトン管理                            │ │
│  │  ※ AutoReset/ManualReset それぞれ別プール                       │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### PThreadEvent 実装

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      PThreadEvent 実装                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【PThreadEvent クラス】                                                 │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  PThreads ベースの Event 実装（Unix/Mac/Linux/Android）          │ │
│  │                                                                   │ │
│  │  class PThreadEvent : public Event {                             │ │
│  │      bool bInitialized;                                          │ │
│  │      bool bIsManualReset;                                        │ │
│  │      volatile TriggerType Triggered;                             │ │
│  │      volatile int32 WaitingThreads;                              │ │
│  │      pthread_mutex_t Mutex;                                      │ │
│  │      pthread_cond_t Condition;                                   │ │
│  │  };                                                              │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【TriggerType 列挙型】                                                  │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  typedef enum {                                                  │ │
│  │      TRIGGERED_NONE,   // トリガーされていない                   │ │
│  │      TRIGGERED_ONE,    // 1スレッドのみ起床（AutoReset用）       │ │
│  │      TRIGGERED_ALL     // 全スレッド起床（ManualReset用）        │ │
│  │  } TriggerType;                                                  │ │
│  │                                                                   │ │
│  │  【状態遷移】                                                     │ │
│  │                                                                   │ │
│  │  TRIGGERED_NONE ──Trigger()──> TRIGGERED_ONE (AutoReset)        │ │
│  │                                TRIGGERED_ALL (ManualReset)       │ │
│  │                                                                   │ │
│  │  TRIGGERED_ONE ──Wait()成功──> TRIGGERED_NONE                   │ │
│  │  TRIGGERED_ALL ──Reset()──> TRIGGERED_NONE                      │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【デストラクタの安全性機構】                                            │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  ~PThreadEvent() の安全な破棄手順:                               │ │
│  │                                                                   │ │
│  │  1. bIsManualReset = true に設定                                 │ │
│  │  2. Trigger() で全待機スレッドを起床                             │ │
│  │  3. bInitialized = false に設定（以降のアクセスを禁止）          │ │
│  │  4. WaitingThreads が 0 になるまでスピン待機                     │ │
│  │  5. pthread_cond_destroy() で条件変数を破棄                      │ │
│  │  6. pthread_mutex_destroy() でミューテックスを破棄               │ │
│  │                                                                   │ │
│  │  ※ 不適切な呼び出しコードに対しても安全に対応                    │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### TLS 自動クリーンアップ

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      TLS 自動クリーンアップ                             │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【定数】                                                                │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  InvalidTlsSlot = 0xFFFFFFFF  // 無効なTLSスロット値             │ │
│  │                                                                   │ │
│  │  IsValidTlsSlot(Slot):                                           │ │
│  │   └─ return Slot != InvalidTlsSlot;                             │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【TlsAutoCleanup クラス】                                               │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  スレッド終了時の自動クリーンアップをサポートする基底クラス       │ │
│  │                                                                   │ │
│  │  class TlsAutoCleanup {                                          │ │
│  │  public:                                                         │ │
│  │      virtual ~TlsAutoCleanup() {}                                │ │
│  │      void Register();  // 自動クリーンアップに登録               │ │
│  │  };                                                              │ │
│  │                                                                   │ │
│  │  ※ Register() を呼び出すと RunnableThread に登録される          │ │
│  │  ※ スレッド終了時に自動的に delete される                        │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【TTlsAutoCleanupValue テンプレート】                                   │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  template<class T>                                               │ │
│  │  class TTlsAutoCleanupValue : public TlsAutoCleanup {            │ │
│  │      T Value;                                                    │ │
│  │  public:                                                         │ │
│  │      TTlsAutoCleanupValue(const T& InValue);                     │ │
│  │      T Get() const;                                              │ │
│  │      void Set(const T& InValue);                                 │ │
│  │      void Set(T&& InValue);                                      │ │
│  │  };                                                              │ │
│  │                                                                   │ │
│  │  ※ 任意の型をTLSに格納し自動クリーンアップ対応にする            │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【TThreadSingleton テンプレート】                                       │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  スレッドごとのシングルトンパターン実装                           │ │
│  │                                                                   │ │
│  │  template<class T, ESPMode SPMode = ESPMode::Fast>               │ │
│  │  class TThreadSingleton : public TlsAutoCleanup {                │ │
│  │  public:                                                         │ │
│  │      static uint32& GetTlsSlot();  // TLSスロット取得            │ │
│  │      static T& Get();              // インスタンス取得           │ │
│  │      static T* TryGet();           // 存在時のみ取得             │ │
│  │  };                                                              │ │
│  │                                                                   │ │
│  │  使用例:                                                          │ │
│  │   class MyThreadData : public TThreadSingleton<MyThreadData> {}; │ │
│  │   MyThreadData::Get().DoSomething();  // スレッドごとに自動生成  │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【ThreadSingletonInitializer】                                         │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  class ThreadSingletonInitializer {                              │ │
│  │      static TlsAutoCleanup* Get(                                 │ │
│  │          TFunctionRef<TlsAutoCleanup*()> CreateInstance,         │ │
│  │          uint32& TlsSlot);                                       │ │
│  │      static TlsAutoCleanup* TryGet(uint32& TlsSlot);             │ │
│  │      static TlsAutoCleanup* Inject(                              │ │
│  │          TlsAutoCleanup* Instance, uint32& TlsSlot);             │ │
│  │  };                                                              │ │
│  │                                                                   │ │
│  │  ※ 遅延初期化とTLSスロット管理を一元化                          │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### ThreadHeartBeat システム

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    ThreadHeartBeat システム                             │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【概要】                                                                │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  スレッドのハング検出・監視システム                               │ │
│  │                                                                   │ │
│  │  ・各スレッドがハートビートを送信                                 │ │
│  │  ・一定時間ハートビートがないとハング判定                         │ │
│  │  ・クラッシュレポートやデバッグに活用                             │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【EConstants 列挙型】                                                   │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  enum EConstants {                                                │ │
│  │      InvalidThreadId = (uint32)-1,  // 無効なスレッドID          │ │
│  │      PresentThreadId = (uint32)-2   // フレーム提示追跡用ID      │ │
│  │  };                                                               │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【HeartBeatInfo 構造体】                                                │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  struct HeartBeatInfo {                                          │ │
│  │      double LastHeartBeatTime;   // 最後のハートビート時刻       │ │
│  │      double LastHangTime;        // 最後のハング検出時刻         │ │
│  │      int32 SuspendedCount;       // サスペンドカウンタ           │ │
│  │      double HangDuration;        // ハング判定タイムアウト       │ │
│  │      double LastStuckTime;       // 最後のスタック検出時刻       │ │
│  │      double StuckDuration;       // スタック継続時間             │ │
│  │      FName HeartBeatName;        // オプション名                 │ │
│  │                                                                   │ │
│  │      void Suspend();             // ハートビート監視を一時停止   │ │
│  │      void Resume(double Time);   // ハートビート監視を再開       │ │
│  │  };                                                               │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【ThreadHeartBeatClock】                                                │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  サスペンド/レジューム対応の独自クロック                          │ │
│  │                                                                   │ │
│  │  class ThreadHeartBeatClock {                                    │ │
│  │      uint64 CurrentCycles;       // 累積サイクル数               │ │
│  │      uint64 LastRealTickCycles;  // 前回のリアルサイクル         │ │
│  │      const uint64 MaxTimeStepCycles;  // 最大タイムステップ      │ │
│  │                                                                   │ │
│  │      void Tick();                // クロック更新                 │ │
│  │      double Seconds();           // 経過秒数取得                 │ │
│  │  };                                                               │ │
│  │                                                                   │ │
│  │  ※ タイトルがサスペンド中はこのスレッドも停止                    │ │
│  │  ※ レジューム時にデルタがクランプされ、長いヒッチと誤判定しない  │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【ThreadHeartBeat 主要メソッド】                                        │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  static ThreadHeartBeat& Get();       // シングルトン取得        │ │
│  │  static ThreadHeartBeat* GetNoInit(); // 初期化なし取得          │ │
│  │                                                                   │ │
│  │  void Start();                    // 監視開始                    │ │
│  │  void HeartBeat();                // ハートビート送信            │ │
│  │  void KillHeartBeat();            // 監視終了                    │ │
│  │                                                                   │ │
│  │  void PresentFrame();             // フレーム提示通知            │ │
│  │  uint32 CheckHeartBeat(double&);  // ハング確認                  │ │
│  │                                                                   │ │
│  │  void SuspendHeartBeat(bool All); // 監視一時停止                │ │
│  │  void ResumeHeartBeat(bool All);  // 監視再開                    │ │
│  │                                                                   │ │
│  │  void MonitorFunctionStart();     // 関数監視開始                │ │
│  │  void MonitorFunctionEnd();       // 関数監視終了                │ │
│  │                                                                   │ │
│  │  void MonitorCheckpointStart(FName, double);  // CP監視開始      │ │
│  │  void MonitorCheckpointEnd(FName);            // CP監視終了      │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【デリゲート】                                                          │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  FOnThreadStuck& GetOnThreadStuck();     // スタック時コールバック│ │
│  │  FOnThreadUnstuck& GetOnThreadUnstuck(); // 回復時コールバック   │ │
│  │  FOnHangDelegate& GetOnHangDelegate();   // ハング時コールバック │ │
│  │                                                                   │ │
│  │  使用例:                                                          │ │
│  │   ThreadHeartBeat::Get().GetOnThreadStuck().BindStatic(          │ │
│  │       &GenericCrashContext::OnThreadStuck);                      │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### スコープヘルパークラス

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    スコープヘルパークラス                               │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【SlowHeartBeatScope】                                                  │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  ハートビート監視を一時停止するRAIIスコープ                       │ │
│  │                                                                   │ │
│  │  struct SlowHeartBeatScope {                                     │ │
│  │      SlowHeartBeatScope(bool bAllThreads = false);               │ │
│  │      ~SlowHeartBeatScope();                                      │ │
│  │  };                                                              │ │
│  │                                                                   │ │
│  │  使用例:                                                          │ │
│  │   {                                                              │ │
│  │       SlowHeartBeatScope Scope;  // 監視一時停止                 │ │
│  │       // 長時間処理...                                           │ │
│  │   }  // スコープ終了で監視再開                                   │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【FunctionHeartBeatScope】                                              │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  関数が時間内に完了するか監視するスコープ                         │ │
│  │                                                                   │ │
│  │  struct FunctionHeartBeatScope {                                 │ │
│  │      FunctionHeartBeatScope();                                   │ │
│  │      ~FunctionHeartBeatScope();                                  │ │
│  │  };                                                              │ │
│  │                                                                   │ │
│  │  使用例:                                                          │ │
│  │   void ImportantFunction() {                                     │ │
│  │       FunctionHeartBeatScope Scope;  // 関数監視開始             │ │
│  │       // 処理...                                                 │ │
│  │   }  // 正常完了を通知                                           │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【DisableHitchDetectorScope】                                           │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  ヒッチ検出を一時停止するスコープ                                 │ │
│  │                                                                   │ │
│  │  struct DisableHitchDetectorScope {                              │ │
│  │      DisableHitchDetectorScope();                                │ │
│  │      ~DisableHitchDetectorScope();                               │ │
│  │  };                                                              │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### GameThreadHitchHeartBeat

```
┌─────────────────────────────────────────────────────────────────────────┐
│                  GameThreadHitchHeartBeat                               │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【概要】                                                                │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  ゲームスレッドのヒッチ（長時間フレーム）検出システム             │ │
│  │                                                                   │ │
│  │  #if PLATFORM_UNIX                                               │ │
│  │      typedef UnixSignalGameHitchHeartBeat GameThreadHitchHeartBeat;│ │
│  │  #else                                                           │ │
│  │      typedef GameThreadHitchHeartBeatThreaded GameThreadHitchHeartBeat;│ │
│  │  #endif                                                          │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【定数】                                                                │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  // スタックトレース関連                                          │ │
│  │  #if WALK_STACK_ON_HITCH_DETECTED                                │ │
│  │  #if LOOKUP_SYMBOLS_IN_HITCH_STACK_WALK                          │ │
│  │      static constexpr SIZE_T StackTraceSize = 65535;             │ │
│  │  #else                                                           │ │
│  │      static constexpr uint32 MaxStackDepth = 128;                │ │
│  │  #endif                                                          │ │
│  │  #endif                                                          │ │
│  │                                                                   │ │
│  │  // ThreadManager のスタックサイズ                                │ │
│  │  static constexpr uint32 ProgramCountersMaxStackSize = 100;      │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【主要メソッド】                                                        │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  static GameThreadHitchHeartBeat& Get();                         │ │
│  │  static GameThreadHitchHeartBeat* GetNoInit();                   │ │
│  │                                                                   │ │
│  │  void InitSettings();              // 設定の初期化               │ │
│  │  void FrameStart(bool bSkip);      // フレーム開始を登録         │ │
│  │  double GetFrameStartTime();       // フレーム開始時刻を取得     │ │
│  │  double GetCurrentTime();          // 現在時刻を取得             │ │
│  │                                                                   │ │
│  │  void SuspendHeartBeat();          // ヒッチ検出を一時停止       │ │
│  │  void ResumeHeartBeat();           // ヒッチ検出を再開           │ │
│  │  bool IsStartedSuspended();        // 開始時からサスペンドか     │ │
│  │                                                                   │ │
│  │  // Unix専用                                                      │ │
│  │  void Restart();                   // 再起動                     │ │
│  │  void PostFork();                  // fork後処理                 │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 実装チェックリスト（追加分）

```
┌─────────────────────────────────────────────────────────────────────────┐
│                   追加コンポーネント実装チェックリスト                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【スレッディング】                                                      │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  □ NewPlatformAffinity                                          │ │
│  │    □ GetMainGameMask()                                           │ │
│  │    □ GetRenderingThreadMask()                                    │ │
│  │    □ GetRHIThreadMask()                                          │ │
│  │    □ GetTaskGraphThreadMask()                                    │ │
│  │    □ GetPoolThreadMask()                                         │ │
│  │    □ GetNoAffinityMask()                                         │ │
│  │                                                                   │ │
│  │  □ スレッド優先度マッピング                                       │ │
│  │    □ EThreadPriority → OS優先度値の変換                         │ │
│  │                                                                   │ │
│  │  □ typedef NewPlatformAffinity PlatformAffinity                │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【TLS】                                                                 │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  □ NewPlatformTLS                                               │ │
│  │    □ AllocTlsSlot()                                              │ │
│  │    □ FreeTlsSlot()                                               │ │
│  │    □ SetTlsValue()                                               │ │
│  │    □ GetTlsValue()                                               │ │
│  │    □ GetCurrentThreadId()                                        │ │
│  │                                                                   │ │
│  │  □ typedef NewPlatformTLS PlatformTLS                          │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【クラッシュ処理】                                                      │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  □ NewPlatformCrashContext                                      │ │
│  │    □ SetCrashInfo()                                              │ │
│  │    □ GetCallStack()                                              │ │
│  │    □ CaptureContext()                                            │ │
│  │                                                                   │ │
│  │  □ 例外ハンドラ登録                                               │ │
│  │    □ OS固有のシグナル/例外ハンドラ設定                           │ │
│  │                                                                   │ │
│  │  □ ダンプ生成機能                                                 │ │
│  │    □ OS固有のダンプファイル生成                                  │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【スタックウォーク】                                                    │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  □ NewPlatformStackWalk                                         │ │
│  │    □ InitStackWalking()                                          │ │
│  │    □ CaptureStackBackTrace()                                     │ │
│  │    □ ProgramCounterToSymbolInfo()                                │ │
│  │    □ SymbolInfoToHumanReadableString()                           │ │
│  │    □ StackWalkAndDump()                                          │ │
│  │                                                                   │ │
│  │  □ シンボル解決ライブラリ統合                                     │ │
│  │    □ デバッグシンボルロード                                      │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【ソケット】                                                            │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  □ SocketSubsystemNewPlatform                                   │ │
│  │    □ CreateSocket()                                              │ │
│  │    □ DestroySocket()                                             │ │
│  │    □ GetHostByName()                                             │ │
│  │    □ GetAddressInfo()                                            │ │
│  │    □ GetLocalHostAddr()                                          │ │
│  │                                                                   │ │
│  │  □ SocketNewPlatform                                            │ │
│  │    □ Bind() / Connect() / Listen() / Accept()                    │ │
│  │    □ Send() / SendTo() / Recv() / RecvFrom()                     │ │
│  │    □ SetNonBlocking() / SetBroadcast()                           │ │
│  │    □ GetConnectionState()                                        │ │
│  │                                                                   │ │
│  │  □ PLATFORM_HAS_BSD_SOCKETS フラグ設定                           │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【文字列処理】                                                          │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  □ NewPlatformString（オプション、最適化）                       │ │
│  │    □ Memcpy() ─── SIMD最適化版                                  │ │
│  │    □ Memmove()                                                   │ │
│  │    □ Memset()                                                    │ │
│  │    □ Memcmp()                                                    │ │
│  │    □ Strlen()                                                    │ │
│  │                                                                   │ │
│  │  □ 文字エンコーディングサポート                                   │ │
│  │    □ UTF-8 ⇔ UTF-16 変換                                        │ │
│  │    □ ロケール設定                                                │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 前のパートへのリンク

- [第1部：アーキテクチャと設計思想](Platform_Abstraction_Layer_Part1.md)
- [第2部：プリプロセッサシステムと型システム](Platform_Abstraction_Layer_Part2.md)
- [第3部：HALコンポーネント詳細](Platform_Abstraction_Layer_Part3.md)
- [第4部：ビルドシステムと新規プラットフォーム追加](Platform_Abstraction_Layer_Part4.md)

---

*このドキュメントはUnreal Engine 5.7のソースコードに基づいています。*
