# Unreal Engine 5.7 プラットフォーム抽象化レイヤー (HAL) 完全解説

## 第3部：HALコンポーネント詳細

---

## 目次

1. [メモリ管理 (PlatformMemory)](#1-メモリ管理-platformmemory)
2. [プロセス管理 (PlatformProcess)](#2-プロセス管理-platformprocess)
3. [ファイルI/O (PlatformFile)](#3-ファイルio-platformfile)
4. [アトミック操作 (PlatformAtomics)](#4-アトミック操作-platformatomics)
5. [時間管理 (PlatformTime)](#5-時間管理-platformtime)
6. [ファイルI/O 実装詳細](#6-ファイルio-実装詳細)
7. [プロセス管理 実装詳細](#7-プロセス管理-実装詳細)
8. [アトミック操作 実装詳細](#8-アトミック操作-実装詳細)
9. [時間管理 実装詳細](#9-時間管理-実装詳細)

---

## 1. メモリ管理 (PlatformMemory)

### コンポーネント概要

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    PlatformMemory コンポーネント                         │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【役割】                                                                │
│   ・物理/仮想メモリの管理                                                │
│   ・メモリアロケータの選択と初期化                                       │
│   ・メモリ統計情報の取得                                                 │
│   ・ページ保護とアクセス制御                                             │
│   ・共有メモリ領域の管理                                                 │
│                                                                         │
│  【主要クラス】                                                          │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  GenericPlatformMemory ──────── 基底クラス（汎用実装）            │ │
│  │         │                                                         │ │
│  │         ├── WindowsPlatformMemory ─ VirtualAlloc/VirtualFree     │ │
│  │         ├── MacPlatformMemory ───── mmap/malloc_zone              │ │
│  │         ├── UnixPlatformMemory ──── mmap/munmap (POSIX)          │ │
│  │         └── AndroidPlatformMemory ─ Android固有最適化            │ │
│  │                                                                   │ │
│  │  PlatformMemory ─────────────── 最終エイリアス（ユーザー使用）    │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### メモリ階層とアロケータ

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      メモリ割り当て階層                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【アプリケーションレベル】                                              │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  new / delete / Memory::Malloc / Memory::Free                  │ │
│  │                           │                                       │ │
│  │                           ▼                                       │ │
│  │                    ┌───────────┐                                  │ │
│  │                    │  Malloc  │ ← メモリアロケータ               │ │
│  │                    │ インターフェース                              │ │
│  │                    └─────┬─────┘                                  │ │
│  │                          │                                        │ │
│  └──────────────────────────┼────────────────────────────────────────┘ │
│                             │                                          │
│  【アロケータレベル】        ▼                                          │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐               │ │
│  │  │ MallocBinned│  │MallocBinned│  │MallocBinned│               │ │
│  │  │     2       │  │     3       │  │    GPU      │               │ │
│  │  └──────┬──────┘  └──────┬──────┘  └─────────────┘               │ │
│  │         │                │                                        │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐               │ │
│  │  │ MallocTBB  │  │MallocMimalloc  │ MallocJemalloc│            │ │
│  │  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘               │ │
│  │         │                │                │                       │ │
│  │  ┌─────────────────────────────────────────────────────────────┐ │ │
│  │  │                       MallocAnsi                           │ │ │
│  │  │                    （フォールバック）                         │ │ │
│  │  └────────────────────────────┬────────────────────────────────┘ │ │
│  │                               │                                   │ │
│  └───────────────────────────────┼───────────────────────────────────┘ │
│                                  │                                     │
│  【OSレベル】                     ▼                                     │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  PlatformMemory::BinnedAllocFromOS()                            │ │
│  │  PlatformMemory::BinnedFreeToOS()                               │ │
│  │                           │                                       │ │
│  │  ┌────────────────────────┼────────────────────────┐             │ │
│  │  │                        │                        │             │ │
│  │  ▼                        ▼                        ▼             │ │
│  │ [Windows]              [Mac/iOS]               [Linux]           │ │
│  │ VirtualAlloc           mmap                    mmap              │ │
│  │ VirtualFree            munmap                  munmap            │ │
│  │                        vm_allocate                               │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### アロケータ選択フロー

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      アロケータ選択プロセス                              │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  PlatformMemory::BaseAllocator() が呼ばれると：                         │
│                                                                         │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  1. コマンドライン引数をチェック                                   │ │
│  │     │                                                             │ │
│  │     ├── -ansimalloc    → MallocAnsi                             │ │
│  │     ├── -stompmalloc   → MallocStomp（デバッグ用）               │ │
│  │     ├── -tbbmalloc     → MallocTBB                              │ │
│  │     ├── -jemalloc      → MallocJemalloc                         │ │
│  │     ├── -mimalloc      → MallocMimalloc                         │ │
│  │     ├── -binnedmalloc  → MallocBinned                           │ │
│  │     ├── -binnedmalloc2 → MallocBinned2                          │ │
│  │     └── -binnedmalloc3 → MallocBinned3                          │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                              │                                          │
│                              ▼ 指定なしの場合                           │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  2. プラットフォームのデフォルトを選択                             │ │
│  │                                                                   │ │
│  │  【Windows】                                                       │ │
│  │   ├── 64bit + mimalloc有効 → MallocMimalloc                     │ │
│  │   ├── 64bit              → MallocBinned3                        │ │
│  │   └── 32bit              → MallocBinned2                        │ │
│  │                                                                   │ │
│  │  【Mac】                                                           │ │
│  │   └── MallocMimalloc または MallocBinned2                       │ │
│  │                                                                   │ │
│  │  【Linux】                                                         │ │
│  │   ├── jemalloc有効       → MallocJemalloc                       │ │
│  │   ├── mimalloc有効       → MallocMimalloc                       │ │
│  │   └── デフォルト         → MallocBinned2                        │ │
│  │                                                                   │ │
│  │  【iOS/Android】                                                   │ │
│  │   └── MallocBinned2                                             │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### メモリ統計情報

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      メモリ統計構造体                                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【PlatformMemoryConstants】（起動時に確定、変化しない）                │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  TotalPhysical ───────────── 物理メモリ総量（バイト）             │ │
│  │  │                           例: 17179869184 (16GB)              │ │
│  │  │                                                                │ │
│  │  TotalVirtual ────────────── 仮想メモリ総量（バイト）             │ │
│  │  │                           例: 140737488355328 (128TB)         │ │
│  │  │                                                                │ │
│  │  PageSize ────────────────── ページサイズ                        │ │
│  │  │                           Windows/Linux: 4096                 │ │
│  │  │                           Mac: 16384 (Apple Silicon)          │ │
│  │  │                                                                │ │
│  │  OsAllocationGranularity ─── OS割り当て粒度                      │ │
│  │  │                           Windows: 65536 (64KB)               │ │
│  │  │                           Unix: = PageSize                    │ │
│  │  │                                                                │ │
│  │  BinnedPageSize ──────────── Binnedアロケータ用ページサイズ       │ │
│  │  │                           通常: 65536以上                      │ │
│  │  │                                                                │ │
│  │  AddressLimit ────────────── 有効アドレス範囲上限                 │ │
│  │  │                           64bit: 0x100000000 以上             │ │
│  │  │                                                                │ │
│  │  TotalPhysicalGB ─────────── 物理RAM概算（GB単位）               │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【PlatformMemoryStats】（実行時に変動）                                │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  AvailablePhysical ───────── 利用可能物理メモリ                   │ │
│  │  AvailableVirtual ────────── 利用可能仮想メモリ                   │ │
│  │  UsedPhysical ────────────── プロセス使用物理メモリ               │ │
│  │  PeakUsedPhysical ────────── ピーク使用物理メモリ                 │ │
│  │  UsedVirtual ─────────────── プロセス使用仮想メモリ               │ │
│  │  PeakUsedVirtual ─────────── ピーク使用仮想メモリ                 │ │
│  │                                                                   │ │
│  │  【メモリプレッシャー状態】                                        │ │
│  │   ・Unknown  ─── 不明                                             │ │
│  │   ・Nominal  ─── 正常                                             │ │
│  │   ・Warning  ─── 警告（メモリ逼迫）                                │ │
│  │   ・Critical ─── 危険（OOMリスク高）                              │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 仮想メモリブロック

```
┌─────────────────────────────────────────────────────────────────────────┐
│                   PlatformVirtualMemoryBlock                            │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【概念】                                                                │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  仮想アドレス空間の予約（Reserve）と                               │ │
│  │  物理メモリのコミット（Commit）を分離管理                          │ │
│  │                                                                   │ │
│  │  ┌─────────────────────────────────────────────────────────────┐ │ │
│  │  │                                                             │ │ │
│  │  │     AllocateVirtual(1GB)                                    │ │ │
│  │  │     ┌─────────────────────────────────────────────────────┐ │ │ │
│  │  │     │ 予約済み（Reserved）- 物理メモリなし                 │ │ │ │
│  │  │     │ アドレス空間のみ確保                                 │ │ │ │
│  │  │     │                                                     │ │ │ │
│  │  │     │  0x00000000                                         │ │ │ │
│  │  │     │  ┌───────────────────────────────────────────────┐ │ │ │ │
│  │  │     │  │                                               │ │ │ │ │
│  │  │     │  │     未コミット領域（アクセス不可）             │ │ │ │ │
│  │  │     │  │                                               │ │ │ │ │
│  │  │     │  └───────────────────────────────────────────────┘ │ │ │ │
│  │  │     │  0x40000000 (1GB)                                   │ │ │ │
│  │  │     └─────────────────────────────────────────────────────┘ │ │ │
│  │  │                                                             │ │ │
│  │  └─────────────────────────────────────────────────────────────┘ │ │
│  │                           │                                       │ │
│  │                           ▼ Commit(0, 64KB)                       │ │
│  │  ┌─────────────────────────────────────────────────────────────┐ │ │
│  │  │                                                             │ │ │
│  │  │  0x00000000                                                 │ │ │
│  │  │  ┌───────────────────┐                                     │ │ │
│  │  │  │ コミット済み       │ ← 物理メモリ割り当て                │ │ │
│  │  │  │ (64KB)            │   読み書き可能                       │ │ │
│  │  │  └───────────────────┘                                     │ │ │
│  │  │  0x00010000                                                 │ │ │
│  │  │  ┌───────────────────────────────────────────────────────┐ │ │ │
│  │  │  │                                                       │ │ │ │
│  │  │  │     未コミット（アクセス不可）                        │ │ │ │
│  │  │  │                                                       │ │ │ │
│  │  │  └───────────────────────────────────────────────────────┘ │ │ │
│  │  │  0x40000000                                                 │ │ │
│  │  │                                                             │ │ │
│  │  └─────────────────────────────────────────────────────────────┘ │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【主要操作】                                                            │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  AllocateVirtual(Size) ─── 仮想アドレス空間を予約                 │ │
│  │                            物理メモリは割り当てない                │ │
│  │                                                                   │ │
│  │  Commit(Offset, Size) ──── 指定範囲に物理メモリをコミット         │ │
│  │                            読み書きアクセス可能になる              │ │
│  │                                                                   │ │
│  │  Decommit(Offset, Size) ── 指定範囲の物理メモリを解放             │ │
│  │                            仮想アドレスは維持                      │ │
│  │                                                                   │ │
│  │  FreeVirtual() ─────────── 仮想アドレス空間を完全解放             │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【プラットフォーム別実装】                                              │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  Windows:                                                         │ │
│  │   ・VirtualAlloc(MEM_RESERVE) → 予約                             │ │
│  │   ・VirtualAlloc(MEM_COMMIT) → コミット                          │ │
│  │   ・VirtualFree(MEM_DECOMMIT) → デコミット                       │ │
│  │   ・VirtualFree(MEM_RELEASE) → 解放                              │ │
│  │                                                                   │ │
│  │  Unix/Mac/Linux:                                                  │ │
│  │   ・mmap(PROT_NONE) → 予約                                       │ │
│  │   ・mprotect(PROT_READ|PROT_WRITE) → コミット                    │ │
│  │   ・madvise(MADV_DONTNEED) → デコミット                          │ │
│  │   ・munmap() → 解放                                              │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 2. プロセス管理 (PlatformProcess)

### コンポーネント概要

```
┌─────────────────────────────────────────────────────────────────────────┐
│                   PlatformProcess コンポーネント                         │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【役割】                                                                │
│   ・子プロセスの生成と管理                                               │
│   ・プロセス間通信（パイプ）                                             │
│   ・DLL/共有ライブラリのロード                                           │
│   ・現在プロセスの情報取得                                               │
│   ・スリープ/イールド制御                                                │
│   ・スレッドアフィニティ/優先度設定                                       │
│                                                                         │
│  【主要機能グループ】                                                    │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  プロセス制御                    プロセス間通信                    │ │
│  │  ┌─────────────────┐           ┌─────────────────┐               │ │
│  │  │ CreateProc      │           │ CreatePipe      │               │ │
│  │  │ OpenProcess     │           │ ReadPipe        │               │ │
│  │  │ CloseProc       │           │ WritePipe       │               │ │
│  │  │ IsProcRunning   │           │ ClosePipe       │               │ │
│  │  │ WaitForProc     │           └─────────────────┘               │ │
│  │  │ TerminateProc   │                                             │ │
│  │  │ GetProcReturnCode│                                            │ │
│  │  └─────────────────┘                                             │ │
│  │                                                                   │ │
│  │  DLL管理                         実行制御                         │ │
│  │  ┌─────────────────┐           ┌─────────────────┐               │ │
│  │  │ GetDllHandle    │           │ Sleep           │               │ │
│  │  │ FreeDllHandle   │           │ SleepNoStats    │               │ │
│  │  │ GetDllExport    │           │ SleepInfinite   │               │ │
│  │  └─────────────────┘           │ YieldThread     │               │ │
│  │                                └─────────────────┘               │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### プロセス生成フロー

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      プロセス生成と通信フロー                            │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【Step 1】パイプ作成                                                    │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  CreatePipe(ReadPipe, WritePipe)                                 │ │
│  │                                                                   │ │
│  │    親プロセス                      子プロセス                     │ │
│  │  ┌────────────┐                 ┌────────────┐                   │ │
│  │  │            │                 │            │                   │ │
│  │  │  WritePipe ├────────────────►│ stdin      │                   │ │
│  │  │            │     パイプ       │            │                   │ │
│  │  │  ReadPipe  │◄────────────────┤ stdout     │                   │ │
│  │  │            │                 │            │                   │ │
│  │  └────────────┘                 └────────────┘                   │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                              │                                          │
│                              ▼                                          │
│  【Step 2】プロセス生成                                                  │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  CreateProc(                                                      │ │
│  │      URL,              // 実行ファイルパス                        │ │
│  │      Params,           // コマンドライン引数                      │ │
│  │      bLaunchDetached,  // デタッチ実行                           │ │
│  │      bLaunchHidden,    // ウィンドウ非表示                        │ │
│  │      ...,                                                         │ │
│  │      PipeWriteChild,   // 子のstdin                              │ │
│  │      PipeReadChild     // 子のstdout                             │ │
│  │  )                                                                │ │
│  │                                                                   │ │
│  │  【プラットフォーム別実装】                                        │ │
│  │   ・Windows: CreateProcess()                                     │ │
│  │   ・Unix: fork() + exec()                                        │ │
│  │   ・Mac: NSTask または fork()/exec()                             │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                              │                                          │
│                              ▼                                          │
│  【Step 3】通信と監視                                                    │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  ループ処理:                                                      │ │
│  │                                                                   │ │
│  │   while (IsProcRunning(ProcHandle))                              │ │
│  │   {                                                               │ │
│  │       Output = ReadPipe(ReadPipe);  // 子の出力を読み取り         │ │
│  │       // 必要に応じて WritePipe で入力を送信                      │ │
│  │   }                                                               │ │
│  │                                                                   │ │
│  │   GetProcReturnCode(ProcHandle, &ReturnCode);  // 終了コード取得  │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                              │                                          │
│                              ▼                                          │
│  【Step 4】クリーンアップ                                                │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  ClosePipe(ReadPipe, WritePipe);                                 │ │
│  │  CloseProc(ProcHandle);                                          │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### DLLロードシステム

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      DLL/共有ライブラリ管理                              │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【ロードフロー】                                                        │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  1. GetDllHandle("MyLibrary") ─── DLLをロード                    │ │
│  │     │                                                             │ │
│  │     │  Windows: LoadLibraryW()                                   │ │
│  │     │  Unix/Mac: dlopen()                                        │ │
│  │     │                                                             │ │
│  │     ▼                                                             │ │
│  │  2. GetDllExport(Handle, "FunctionName") ─ 関数アドレス取得       │ │
│  │     │                                                             │ │
│  │     │  Windows: GetProcAddress()                                 │ │
│  │     │  Unix/Mac: dlsym()                                         │ │
│  │     │                                                             │ │
│  │     ▼                                                             │ │
│  │  3. 関数ポインタを使用して呼び出し                                │ │
│  │     │                                                             │ │
│  │     ▼                                                             │ │
│  │  4. FreeDllHandle(Handle) ─── DLLをアンロード                    │ │
│  │                                                                   │ │
│  │     Windows: FreeLibrary()                                       │ │
│  │     Unix/Mac: dlclose()                                          │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【検索パス】                                                            │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  GetModulesDirectory() が返すパス:                                │ │
│  │                                                                   │ │
│  │   ・エディタ: Engine/Binaries/{Platform}/                        │ │
│  │   ・パッケージゲーム: {GameDir}/Binaries/{Platform}/              │ │
│  │                                                                   │ │
│  │  PushDllDirectory() / PopDllDirectory()                          │ │
│  │   → 一時的に検索パスを追加/削除                                   │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【遅延ロード】                                                          │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  Windows のみ: PublicDelayLoadDLLs                               │ │
│  │                                                                   │ │
│  │  Build.cs で指定:                                                 │ │
│  │   PublicDelayLoadDLLs.Add("DBGHELP.DLL");                        │ │
│  │                                                                   │ │
│  │  効果:                                                            │ │
│  │   ・起動時にロードせず、初回使用時にロード                        │ │
│  │   ・DLLが見つからなくても起動は成功                               │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 3. ファイルI/O (PlatformFile)

### コンポーネント概要

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    PlatformFile コンポーネント                           │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【階層構造】                                                            │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  ゲームコード                                                     │ │
│  │      │                                                            │ │
│  │      ▼                                                            │ │
│  │  IFileManager ─────────────── 高レベルファイルマネージャ          │ │
│  │      │                        ・パス解決                          │ │
│  │      │                        ・ワイルドカード検索                 │ │
│  │      ▼                                                            │ │
│  │  IPlatformFile チェーン ───── ファイルシステム抽象化              │ │
│  │      │                                                            │ │
│  │      │  ┌───────────────────────────────────────────────────┐    │ │
│  │      │  │ [オプション] LogWrapper                           │    │ │
│  │      │  │              ↓                                    │    │ │
│  │      │  │ [オプション] CachedWrapper                        │    │ │
│  │      │  │              ↓                                    │    │ │
│  │      │  │ [オプション] PakFile                              │    │ │
│  │      │  │              ↓                                    │    │ │
│  │      │  │ [必須] PhysicalPlatformFile                       │    │ │
│  │      │  └───────────────────────────────────────────────────┘    │ │
│  │      │                                                            │ │
│  │      ▼                                                            │ │
│  │  OS ファイルシステム                                               │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### ファイルハンドル操作

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      IFileHandle インターフェース                        │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【主要操作】                                                            │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  【位置操作】                                                      │ │
│  │   Tell()              ─── 現在位置を取得                          │ │
│  │   Seek(Position)      ─── 先頭からの位置に移動                    │ │
│  │   SeekFromEnd(Offset) ─── 末尾からの相対位置に移動                │ │
│  │   Size()              ─── ファイルサイズを取得                    │ │
│  │                                                                   │ │
│  │  【読み書き】                                                      │ │
│  │   Read(Buffer, BytesToRead)   ─── データを読み取り                │ │
│  │   Write(Buffer, BytesToWrite) ─── データを書き込み                │ │
│  │   Flush(bFullFlush)           ─── バッファをフラッシュ            │ │
│  │   Truncate(NewSize)           ─── ファイルを切り詰め              │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【典型的な使用パターン】                                                │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  読み取り:                                                        │ │
│  │  ┌─────────────────────────────────────────────────────────────┐ │ │
│  │  │                                                             │ │ │
│  │  │  IPlatformFile& PlatformFile = PlatformFileManager::Get()  │ │ │
│  │  │                                       .GetPlatformFile();   │ │ │
│  │  │                                                             │ │ │
│  │  │  IFileHandle* Handle = PlatformFile.OpenRead(Path);         │ │ │
│  │  │  if (Handle)                                                │ │ │
│  │  │  {                                                          │ │ │
│  │  │      int64 FileSize = Handle->Size();                       │ │ │
│  │  │      Buffer.SetNum(FileSize);                               │ │ │
│  │  │      Handle->Read(Buffer.GetData(), FileSize);              │ │ │
│  │  │      delete Handle;                                         │ │ │
│  │  │  }                                                          │ │ │
│  │  │                                                             │ │ │
│  │  └─────────────────────────────────────────────────────────────┘ │ │
│  │                                                                   │ │
│  │  書き込み:                                                        │ │
│  │  ┌─────────────────────────────────────────────────────────────┐ │ │
│  │  │                                                             │ │ │
│  │  │  IFileHandle* Handle = PlatformFile.OpenWrite(Path);        │ │ │
│  │  │  if (Handle)                                                │ │ │
│  │  │  {                                                          │ │ │
│  │  │      Handle->Write(Data.GetData(), Data.Num());             │ │ │
│  │  │      Handle->Flush();                                       │ │ │
│  │  │      delete Handle;                                         │ │ │
│  │  │  }                                                          │ │ │
│  │  │                                                             │ │ │
│  │  └─────────────────────────────────────────────────────────────┘ │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### プラットフォーム別実装

```
┌─────────────────────────────────────────────────────────────────────────┐
│                   プラットフォーム別ファイルI/O                          │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【Windows】                                                             │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  使用API:                                                         │ │
│  │   ・CreateFileW() ────────── ファイルオープン                     │ │
│  │   ・ReadFile() / WriteFile() ─ 読み書き                          │ │
│  │   ・SetFilePointerEx() ────── シーク                             │ │
│  │   ・GetFileSizeEx() ───────── サイズ取得                         │ │
│  │   ・FlushFileBuffers() ────── フラッシュ                         │ │
│  │   ・CloseHandle() ─────────── クローズ                           │ │
│  │                                                                   │ │
│  │  特徴:                                                            │ │
│  │   ・非同期I/O (OVERLAPPED) サポート                               │ │
│  │   ・メモリマップドファイル対応                                     │ │
│  │   ・UNCパス対応 (\\server\share\...)                              │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【Unix/Mac/Linux】                                                      │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  使用API:                                                         │ │
│  │   ・open() ─────────────────── ファイルオープン                   │ │
│  │   ・read() / write() ───────── 読み書き                          │ │
│  │   ・lseek() ────────────────── シーク                            │ │
│  │   ・fstat() ────────────────── サイズ取得                        │ │
│  │   ・fsync() / fdatasync() ──── フラッシュ                        │ │
│  │   ・close() ────────────────── クローズ                          │ │
│  │                                                                   │ │
│  │  特徴:                                                            │ │
│  │   ・POSIXセマンティクス                                           │ │
│  │   ・シンボリックリンク対応                                        │ │
│  │   ・パーミッション管理                                            │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【パス変換】                                                            │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  Windows:  C:\Users\Name\Documents\file.txt                      │ │
│  │  Unix:     /home/name/documents/file.txt                         │ │
│  │                                                                   │ │
│  │  UEの内部パス: ../../../Content/file.uasset                       │ │
│  │                                                                   │ │
│  │  Paths::ConvertRelativePathToFull() で絶対パスに変換             │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 4. アトミック操作 (PlatformAtomics)

### アトミック操作一覧

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     PlatformAtomics 操作一覧                           │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【インクリメント/デクリメント】                                         │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  InterlockedIncrement(Value*) ──── *Value += 1、新しい値を返す    │ │
│  │  InterlockedDecrement(Value*) ──── *Value -= 1、新しい値を返す    │ │
│  │                                                                   │ │
│  │  サポート型: int32, int64                                         │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【加算】                                                                │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  InterlockedAdd(Value*, Amount) ── *Value += Amount、古い値を返す │ │
│  │                                                                   │ │
│  │  サポート型: int32, int64                                         │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【交換（Swap）】                                                        │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  InterlockedExchange(Dest*, Exchange)                             │ │
│  │   ── *Dest = Exchange、古い値を返す                               │ │
│  │                                                                   │ │
│  │  InterlockedExchangePtr(Dest**, Exchange*)                        │ │
│  │   ── ポインタ版                                                   │ │
│  │                                                                   │ │
│  │  サポート型: int32, int64, void*                                  │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【比較交換（CAS: Compare And Swap）】                                   │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  InterlockedCompareExchange(Dest*, Exchange, Comparand)           │ │
│  │   ── if (*Dest == Comparand) *Dest = Exchange                    │ │
│  │   ── 古い値を返す（成功判定に使用）                                │ │
│  │                                                                   │ │
│  │  InterlockedCompareExchangePointer(Dest**, Exchange*, Comparand*) │ │
│  │   ── ポインタ版                                                   │ │
│  │                                                                   │ │
│  │  InterlockedCompareExchange128(Dest*, Exchange, Comparand*)       │ │
│  │   ── 128ビット版（PLATFORM_HAS_128BIT_ATOMICS時のみ）             │ │
│  │   ── ABA問題対策に有用                                            │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【ビット操作】                                                          │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  InterlockedAnd(Value*, Mask) ─── *Value &= Mask、古い値を返す    │ │
│  │  InterlockedOr(Value*, Mask) ──── *Value |= Mask、古い値を返す    │ │
│  │  InterlockedXor(Value*, Mask) ─── *Value ^= Mask、古い値を返す    │ │
│  │                                                                   │ │
│  │  サポート型: int32, int64                                         │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【メモリバリア】                                                        │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  MemoryBarrier() ─────────────── フルメモリフェンス               │ │
│  │                                                                   │ │
│  │  Windows: _mm_sfence() / MemoryBarrier()                         │ │
│  │  Clang:   __sync_synchronize()                                   │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### プラットフォーム別実装

```
┌─────────────────────────────────────────────────────────────────────────┐
│                  プラットフォーム別アトミック実装                        │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【Windows (MSVC)】                                                      │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  Interlocked関数群を使用:                                         │ │
│  │                                                                   │ │
│  │  ┌───────────────────────────────────────────────────────────┐   │ │
│  │  │  UE関数                    │  Windows Intrinsic            │   │ │
│  │  ├───────────────────────────┼────────────────────────────────┤   │ │
│  │  │  InterlockedIncrement     │  _InterlockedIncrement         │   │ │
│  │  │  InterlockedDecrement     │  _InterlockedDecrement         │   │ │
│  │  │  InterlockedAdd           │  _InterlockedExchangeAdd       │   │ │
│  │  │  InterlockedExchange      │  _InterlockedExchange          │   │ │
│  │  │  InterlockedCompareExchange │ _InterlockedCompareExchange   │   │ │
│  │  │  InterlockedAnd           │  _InterlockedAnd               │   │ │
│  │  │  InterlockedOr            │  _InterlockedOr                │   │ │
│  │  └───────────────────────────┴────────────────────────────────┘   │ │
│  │                                                                   │ │
│  │  64ビット版は _InterlockedXxx64 を使用                            │ │
│  │  128ビット版は _InterlockedCompareExchange128 (Win8以降)          │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【Clang/GCC (Unix系)】                                                  │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  コンパイラビルトインを使用:                                       │ │
│  │                                                                   │ │
│  │  ┌───────────────────────────────────────────────────────────┐   │ │
│  │  │  UE関数                    │  Compiler Builtin             │   │ │
│  │  ├───────────────────────────┼────────────────────────────────┤   │ │
│  │  │  InterlockedIncrement     │  __sync_add_and_fetch(..., 1)  │   │ │
│  │  │  InterlockedDecrement     │  __sync_sub_and_fetch(..., 1)  │   │ │
│  │  │  InterlockedAdd           │  __sync_fetch_and_add          │   │ │
│  │  │  InterlockedExchange      │  __sync_lock_test_and_set      │   │ │
│  │  │  InterlockedCompareExchange │ __sync_val_compare_and_swap   │   │ │
│  │  │  InterlockedAnd           │  __sync_fetch_and_and          │   │ │
│  │  │  InterlockedOr            │  __sync_fetch_and_or           │   │ │
│  │  └───────────────────────────┴────────────────────────────────┘   │ │
│  │                                                                   │ │
│  │  C++11対応版: std::atomic も使用可能                              │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 5. 時間管理 (PlatformTime)

### 時間関数一覧

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       PlatformTime 関数一覧                             │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【高精度時間】                                                          │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  Seconds() ─────────────────── 起動からの経過秒数（double）       │ │
│  │  │                             高精度タイマー使用                  │ │
│  │  │                             ゲームループ計測等に使用            │ │
│  │  │                                                                │ │
│  │  Cycles64() ────────────────── CPUサイクルカウンタ（64bit）       │ │
│  │  │                             最高精度だがプラットフォーム依存    │ │
│  │  │                                                                │ │
│  │  Cycles() ──────────────────── CPUサイクルカウンタ（32bit）       │ │
│  │                                 オーバーフロー注意                  │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【サイクル変換】                                                        │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  GetSecondsPerCycle64() ────── 1サイクルあたりの秒数               │ │
│  │  GetSecondsPerCycle() ──────── 同上（32bit版）                    │ │
│  │  ToSeconds(Cycles) ─────────── サイクルを秒に変換                 │ │
│  │  ToMilliseconds(Cycles) ────── サイクルをミリ秒に変換              │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【システム時刻】                                                        │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  SystemTime() ──────────────── ローカルシステム時刻               │ │
│  │  │                             (Year, Month, Day, Hour, ...)      │ │
│  │  │                                                                │ │
│  │  UtcTime() ─────────────────── UTC時刻                           │ │
│  │                                                                   │ │
│  │  Now() ─────────────────────── 現在のローカルDateTime            │ │
│  │  UtcNow() ──────────────────── 現在のUTC DateTime                │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【CPU時間】                                                             │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  GetCPUTime() ──────────────── CPU使用率情報を取得                │ │
│  │  UpdateCPUTime() ───────────── CPU時間統計を更新                  │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### プラットフォーム別実装

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    プラットフォーム別時間実装                            │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【高精度タイマー】                                                      │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  Windows:                                                         │ │
│  │   ・QueryPerformanceCounter() ──── Seconds()用                   │ │
│  │   ・QueryPerformanceFrequency() ── 周波数取得                    │ │
│  │   ・__rdtsc() ──────────────────── Cycles64()用（TSCレジスタ）   │ │
│  │                                                                   │ │
│  │  Mac:                                                             │ │
│  │   ・mach_absolute_time() ────────── 高精度タイマー               │ │
│  │   ・mach_timebase_info() ────────── ナノ秒変換係数取得           │ │
│  │                                                                   │ │
│  │  Linux:                                                           │ │
│  │   ・clock_gettime(CLOCK_MONOTONIC) ── Seconds()用               │ │
│  │   ・__rdtsc() (x86) / CNTVCT (ARM) ── Cycles64()用              │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【精度比較】                                                            │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  方法               │ 精度          │ オーバーヘッド │ 用途        │ │
│  │  ───────────────────┼───────────────┼───────────────┼───────────  │ │
│  │  Cycles64()         │ ナノ秒未満    │ 極小          │ 精密計測    │ │
│  │  Seconds()          │ マイクロ秒    │ 小            │ 通常計測    │ │
│  │  UtcNow()           │ ミリ秒        │ 中            │ ログ等      │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【注意点】                                                              │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  ・Cycles() は32bitでオーバーフローしやすい                        │ │
│  │   → 長時間計測には Cycles64() を使用                              │ │
│  │                                                                   │ │
│  │  ・マルチコア環境ではTSCがコア間で同期していない場合がある          │ │
│  │   → スレッド移動時に不整合が発生する可能性                         │ │
│  │                                                                   │ │
│  │  ・仮想マシン上ではタイマー精度が低下する場合がある                 │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 6. ファイルI/O 実装詳細

### キャッシュシステム

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    ファイルキャッシュ実装                               │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【定数】                                                                │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  BufferCacheSize = 64 * 1024   // 64KB（最適なパフォーマンス）    │ │
│  │  BufferSizeMask = ~((uint64)BufferCacheSize - 1)  // アライメント  │ │
│  │  CacheCount = 2                 // デュアルバッファ               │ │
│  │                                                                   │ │
│  │  PLATFORM_FILE_READER_BUFFER_SIZE = 1024  // 読み取りバッファ     │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【CachedFileHandle クラス構造】                                         │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  class CachedFileHandle {                                        │ │
│  │      uint8 BufferCache[CacheCount][BufferCacheSize];  // 128KB   │ │
│  │      int64 CacheStart[CacheCount];   // 各キャッシュの開始位置    │ │
│  │      int64 CacheEnd[CacheCount];     // 各キャッシュの終了位置    │ │
│  │      int32 CurrentCache;             // 現在のキャッシュインデックス│ │
│  │      int64 FilePos;                  // 要求されたファイル位置    │ │
│  │      int64 TellPos;                  // 実際のファイル位置        │ │
│  │  };                                                              │ │
│  │                                                                   │ │
│  │  【動作】                                                         │ │
│  │   ・読み取り時にキャッシュをチェック                              │ │
│  │   ・キャッシュミス時にBufferCacheSizeずつ読み込み                 │ │
│  │   ・読み取りサイズ > BufferCacheSize の場合はキャッシュをバイパス │ │
│  │   ・デュアルバッファで先読みとヒット率を最適化                    │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 非同期ファイルI/O

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     非同期ファイルI/O                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【EAsyncIOPriorityAndFlags 列挙型】                                     │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  // プライオリティマスクとフラグ                                   │ │
│  │  AIOP_PRIORITY_MASK      = 0x000000ff  // 優先度ビット            │ │
│  │  AIOP_FLAG_PRECACHE      = 0x00000100  // プリキャッシュフラグ    │ │
│  │  AIOP_FLAG_DONTCACHE     = 0x00000200  // キャッシュ無効化        │ │
│  │  AIOP_FLAG_HW_TARGET_MEMORY = 0x00000400  // ハードウェアメモリ   │ │
│  │                                                                   │ │
│  │  // 優先度レベル（低→高）                                         │ │
│  │  AIOP_MIN           = 0              // 最低                      │ │
│  │  AIOP_Low           = 1              // 低                        │ │
│  │  AIOP_BelowNormal   = 2              // 標準以下                  │ │
│  │  AIOP_Normal        = 3              // 標準                      │ │
│  │  AIOP_High          = 4              // 高                        │ │
│  │  AIOP_CriticalPath  = 5              // クリティカルパス          │ │
│  │  AIOP_MAX           = AIOP_CriticalPath                          │ │
│  │  AIOP_NUM                            // 優先度数                  │ │
│  │                                                                   │ │
│  │  AIOP_Precache = AIOP_MIN | AIOP_FLAG_PRECACHE  // レガシー       │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【IAsyncReadRequest 内部構造】                                          │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  // スレッドセーフフラグ（TSANアトミック）                        │ │
│  │  TSAN_ATOMIC(bool) bDataIsReady;              // データ準備完了   │ │
│  │  TSAN_ATOMIC(bool) bCompleteAndCallbackCalled; // 完了+コールバック│ │
│  │  TSAN_ATOMIC(bool) bCompleteSync;             // 同期完了         │ │
│  │  TSAN_ATOMIC(bool) bCanceled;                 // キャンセル済み   │ │
│  │                                                                   │ │
│  │  // リクエストタイプによる共用体                                   │ │
│  │  union {                                                          │ │
│  │      PTRINT Size;     // サイズリクエスト用                       │ │
│  │      uint8* Memory;   // メモリリクエスト用                       │ │
│  │  };                                                               │ │
│  │                                                                   │ │
│  │  AsyncFileCallBack Callback;  // 完了時コールバック               │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【プラットフォームファイルフラグ】                                      │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  enum class EPlatformFileRead {                                  │ │
│  │      None = 0x0,                                                 │ │
│  │      AllowWrite = 0x01   // 書き込み許可                         │ │
│  │  };                                                              │ │
│  │                                                                   │ │
│  │  enum class EPlatformFileWrite {                                 │ │
│  │      None = 0x0,                                                 │ │
│  │      AllowRead = 0x01    // 読み取り許可                         │ │
│  │  };                                                              │ │
│  │                                                                   │ │
│  │  enum class ESymlinkResult {                                     │ │
│  │      Unimplemented = -1, // 未実装                               │ │
│  │      NonSymlink = 0,     // シンボリックリンクではない           │ │
│  │      Symlink = 1         // シンボリックリンク                   │ │
│  │  };                                                              │ │
│  │                                                                   │ │
│  │  enum class EDirectoryVisitorFlags {                             │ │
│  │      None = 0x0,                                                 │ │
│  │      ThreadSafe = 0x01   // スレッドセーフ                       │ │
│  │  };                                                              │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### ディスク使用率追跡

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    ディスク使用率追跡                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【有効化】 TRACK_DISK_UTILIZATION = 1                                  │
│                                                                         │
│  【DiskUtilizationTracker クラス】                                       │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  struct UtilizationStats {                                       │ │
│  │      uint64 TotalReads;        // 総読み取り回数                 │ │
│  │      uint64 TotalSeeks;        // 総シーク回数                   │ │
│  │      uint64 TotalBytesRead;    // 総読み取りバイト数             │ │
│  │      uint64 TotalSeekDistance; // 総シーク距離                   │ │
│  │      double TotalIOTime;       // 総I/O時間                      │ │
│  │      double TotalIdleTime;     // 総アイドル時間                 │ │
│  │                                                                   │ │
│  │      // スループット計算メソッド                                  │ │
│  │      double GetOverallThrougputBS();   // 全体B/s                │ │
│  │      double GetOverallThroughputMBS(); // 全体MB/s               │ │
│  │      double GetReadThrougputBS();      // 読み取りB/s            │ │
│  │      double GetReadThroughputMBS();    // 読み取りMB/s           │ │
│  │      double GetTotalIdleTimeInSeconds();                         │ │
│  │      double GetTotalIOTimeInSeconds();                           │ │
│  │      double GetPercentTimeIdle();      // アイドル率%            │ │
│  │  };                                                              │ │
│  │                                                                   │ │
│  │  UtilizationStats LongTermStats;   // 累積統計                   │ │
│  │  UtilizationStats ShortTermStats;  // 短期統計                   │ │
│  │  uint64 IdleStartCycle;            // アイドル開始サイクル       │ │
│  │  uint64 ReadStartCycle;            // 読み取り開始サイクル       │ │
│  │  uint64 InFlightBytes;             // 処理中バイト数             │ │
│  │  int32 InFlightReads;              // 処理中読み取り数           │ │
│  │  ThreadSafeBool bResetShortTermStats;  // リセットフラグ         │ │
│  │                                                                   │ │
│  │  int32 GetOutstandingRequests();   // 未処理リクエスト数         │ │
│  │  void ResetShortTermStats();       // 短期統計リセット           │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【ScopedDiskUtilizationTracker】                                        │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  RAII スタイルのディスク使用率追跡                                │ │
│  │                                                                   │ │
│  │  {                                                               │ │
│  │      ScopedDiskUtilizationTracker Tracker(BytesToRead);          │ │
│  │      // ディスク読み取り処理                                      │ │
│  │  }  // 自動的に統計を更新                                        │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 7. プロセス管理 実装詳細

### プロセス優先度

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    プロセス優先度詳細                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【PriorityModifier 定数】                                               │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  範囲: -2 ～ +2                                                   │ │
│  │                                                                   │ │
│  │  -2  ─────── Idle (アイドル優先度)                               │ │
│  │  -1  ─────── Low (低優先度)                                      │ │
│  │   0  ─────── Normal (標準、デフォルト)                           │ │
│  │  +1  ─────── High (高優先度)                                     │ │
│  │  +2  ─────── Higher (より高い優先度)                             │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【ProcHandle テンプレート構造】                                         │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  template<typename T, T InvalidHandleValue>                      │ │
│  │  struct TProcHandle {                                            │ │
│  │      T Handle;                                                   │ │
│  │                                                                   │ │
│  │      bool IsValid() const {                                      │ │
│  │          return Handle != InvalidHandleValue;                    │ │
│  │      }                                                           │ │
│  │      void Reset() { Handle = InvalidHandleValue; }               │ │
│  │      T Get() const { return Handle; }                            │ │
│  │  };                                                              │ │
│  │                                                                   │ │
│  │  // Windows: ProcHandle = TProcHandle<Windows::HANDLE, nullptr>  │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【Windows プロセス管理メソッド】                                        │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  SetProcessAffinity(NumCores, bPhysicalCoresOnly)                │ │
│  │   └─ プロセスのCPUアフィニティを設定                             │ │
│  │                                                                   │ │
│  │  IsProcessAffinitySet()                                          │ │
│  │   └─ アフィニティが設定されているか確認                          │ │
│  │                                                                   │ │
│  │  SetProcPriority(ProcHandle, PriorityModifier)                   │ │
│  │   └─ プロセス優先度を変更                                        │ │
│  │                                                                   │ │
│  │  GetPerFrameProcessorUsage(ProcessId, &ProcessFraction, &Idle)   │ │
│  │   └─ フレームごとのCPU使用率を取得                               │ │
│  │                                                                   │ │
│  │  TerminateProcTreeWithPredicate(Handle, Predicate)               │ │
│  │   └─ 条件に基づいてプロセスツリーを終了                          │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### パイプ実装

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        パイプ実装                                       │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【UE::HAL 名前空間のパイプクラス】                                      │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  namespace UE::HAL {                                             │ │
│  │                                                                   │ │
│  │      struct Pipe {                                               │ │
│  │          ReadHandle ReadHandle;                                  │ │
│  │          WriteHandle WriteHandle;                                │ │
│  │          // ムーブセマンティクス対応                              │ │
│  │          // nullptr比較対応                                       │ │
│  │      };                                                          │ │
│  │                                                                   │ │
│  │      struct InputPipe : Pipe {                                   │ │
│  │          String Read();               // 読み取り                │ │
│  │          operator WriteHandle()&;     // 書き込みハンドル変換    │ │
│  │      };                                                          │ │
│  │                                                                   │ │
│  │      struct OutputPipe : Pipe {                                  │ │
│  │          bool Write(const String& Message);  // 書き込み         │ │
│  │          operator ReadHandle()&;      // 読み取りハンドル変換    │ │
│  │      };                                                          │ │
│  │                                                                   │ │
│  │  }                                                               │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【ProcessStartInfo 構造体】                                             │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  struct ProcessStartInfo {                                       │ │
│  │      const TCHAR* Uri;                        // 実行ファイル    │ │
│  │      const TCHAR* Arguments = "";             // 引数            │ │
│  │      const TCHAR* WorkingDirectory = nullptr; // 作業ディレクトリ│ │
│  │      int32 PriorityModifier = 0;              // 優先度 (-2～+2) │ │
│  │      bool bDetached = false;                  // デタッチ        │ │
│  │      bool bHidden = false;                    // 非表示          │ │
│  │      bool bInheritHandles = false;            // ハンドル継承    │ │
│  │      ReadHandle StdIn;                        // 標準入力        │ │
│  │      WriteHandle StdOut;                      // 標準出力        │ │
│  │      WriteHandle StdErr = StdOut;             // 標準エラー      │ │
│  │  };                                                              │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【プロセスリソース制限】                                                │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  namespace EProcessResource {                                    │ │
│  │      enum Type {                                                 │ │
│  │          VirtualMemory   // 最大アドレス可能メモリ               │ │
│  │      };                                                          │ │
│  │  };                                                              │ │
│  │                                                                   │ │
│  │  // セマフォ名の最大長                                            │ │
│  │  GenericPlatformProcess::Semaphore::MaxSemaphoreName = 128       │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 8. アトミック操作 実装詳細

### EMemoryOrder 列挙型

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    メモリオーダリング詳細                               │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【EMemoryOrder 列挙型】                                                 │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  enum class EMemoryOrder {                                       │ │
│  │      Relaxed,                // 順序保証なし（最速）             │ │
│  │      SequentiallyConsistent, // 全操作で完全順序保証             │ │
│  │      Count                                                       │ │
│  │  };                                                              │ │
│  │                                                                   │ │
│  │  【使い分け】                                                     │ │
│  │   Relaxed:                                                       │ │
│  │    ・カウンタのインクリメント/デクリメント                       │ │
│  │    ・他の操作との順序が重要でない場合                            │ │
│  │    ・最もパフォーマンスが高い                                    │ │
│  │                                                                   │ │
│  │   SequentiallyConsistent:                                        │ │
│  │    ・ロックの実装                                                │ │
│  │    ・複数のアトミック操作間の順序が重要な場合                    │ │
│  │    ・全スレッドで同じ順序が見える必要がある場合                  │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### TAtomic テンプレート

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      TAtomic テンプレート                               │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【TAtomic テンプレート】 ※ 非推奨、std::atomic<T> を推奨              │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  template<typename T>                                            │ │
│  │  class TAtomic {                                                 │ │
│  │      static_assert(TIsTrivial<T>::Value);  // trivial型のみ      │ │
│  │                                                                   │ │
│  │      // 内部では std::atomic<T> を使用                           │ │
│  │      std::atomic<T> Element;                                     │ │
│  │                                                                   │ │
│  │      T Load(EMemoryOrder Order = EMemoryOrder::SequentiallyConsistent);│ │
│  │      void Store(T Value, EMemoryOrder Order = ...);              │ │
│  │      T Exchange(T Value);                                        │ │
│  │      bool CompareExchange(T& Expected, T Desired);               │ │
│  │  };                                                              │ │
│  │                                                                   │ │
│  │  サポートサイズ: 1, 2, 4, 8 バイトのみ                           │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【PlatformAtomics API】                                                 │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  // インクリメント/デクリメント（戻り値は新しい値）               │ │
│  │  InterlockedIncrement(volatile int8/16/32/64*)                   │ │
│  │  InterlockedDecrement(volatile int8/16/32/64*)                   │ │
│  │                                                                   │ │
│  │  // 加算（戻り値は古い値）                                        │ │
│  │  InterlockedAdd(volatile int8/16/32/64*, int8/16/32/64 Amount)   │ │
│  │                                                                   │ │
│  │  // 交換（戻り値は古い値）                                        │ │
│  │  InterlockedExchange(volatile int8/16/32/64*, int8/16/32/64)     │ │
│  │                                                                   │ │
│  │  // CAS（戻り値は古い値、成功なら Expected == 戻り値）           │ │
│  │  InterlockedCompareExchange(volatile T*, T Exchange, T Comparand)│ │
│  │                                                                   │ │
│  │  // ビット演算                                                    │ │
│  │  InterlockedAnd(volatile int8/16/32/64*, int8/16/32/64)          │ │
│  │  InterlockedOr(volatile int8/16/32/64*, int8/16/32/64)           │ │
│  │  InterlockedXor(volatile int8/16/32/64*, int8/16/32/64)          │ │
│  │                                                                   │ │
│  │  // アトミック読み取り                                            │ │
│  │  AtomicRead(volatile const T*)                                   │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【128ビットアトミック】 PLATFORM_HAS_128BIT_ATOMICS = 1               │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  InterlockedCompareExchange128(                                  │ │
│  │      volatile Int128* Dest,                                      │ │
│  │      const Int128& Exchange,                                     │ │
│  │      Int128* Comparand                                           │ │
│  │  );                                                              │ │
│  │                                                                   │ │
│  │  AtomicRead128(                                                  │ │
│  │      const volatile Int128* Src,                                 │ │
│  │      Int128* OutResult                                           │ │
│  │  );                                                              │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【Windows 固有実装】                                                    │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  // インリンシック使用                                            │ │
│  │  _InterlockedIncrement     (32-bit)                              │ │
│  │  _InterlockedIncrement16   (16-bit)                              │ │
│  │  _InterlockedIncrement64   (64-bit)                              │ │
│  │                                                                   │ │
│  │  // 32-bitビルドでの64-bitフォールバック                         │ │
│  │  → CASループで _InterlockedCompareExchange64 を使用              │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 9. 時間管理 実装詳細

### PlatformTime 内部構造

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    時間管理 実装詳細                                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【GenericPlatformTime 静的メンバ】                                      │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  static double SecondsPerCycle;      // 32-bit用変換係数          │ │
│  │  static double SecondsPerCycle64;    // 64-bit用変換係数          │ │
│  │  static double LastIntervalCPUTimeInSeconds;  // CPU時間          │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【サイクルカウンタ】                                                    │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  uint32 Cycles()                                                 │ │
│  │   └─ 32-bit サイクルカウンタ（オーバーフロー注意）               │ │
│  │                                                                   │ │
│  │  uint64 Cycles64()                                               │ │
│  │   └─ 64-bit サイクルカウンタ（推奨）                             │ │
│  │   └─ 実行中にオーバーフローしない                                │ │
│  │                                                                   │ │
│  │  【プラットフォーム実装】                                         │ │
│  │   Windows: __rdtsc() 直接使用                                    │ │
│  │   Mac:     mach_absolute_time()                                  │ │
│  │   Linux:   __rdtsc() (x86) / CNTVCT (ARM)                        │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【時間変換メソッド】                                                    │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  // サイクル → 時間                                               │ │
│  │  float ToMilliseconds(uint32 Cycles)                             │ │
│  │   └─ return Cycles * GetSecondsPerCycle() * 1000.0f              │ │
│  │                                                                   │ │
│  │  double ToMilliseconds64(uint64 Cycles)                          │ │
│  │   └─ return Cycles * GetSecondsPerCycle64() * 1000.0             │ │
│  │                                                                   │ │
│  │  // 時間 → サイクル                                               │ │
│  │  uint64 SecondsToCycles64(double Seconds)                        │ │
│  │   └─ return Seconds / GetSecondsPerCycle64()                     │ │
│  │                                                                   │ │
│  │  // 変換係数取得                                                  │ │
│  │  double GetSecondsPerCycle()                                     │ │
│  │  double GetSecondsPerCycle64()                                   │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【CPU使用率追跡】                                                       │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  struct CPUTime {                                                │ │
│  │      float CPUTimePct;          // CPU使用率 %                   │ │
│  │      float CPUTimePctRelative;  // 単一コア相対使用率            │ │
│  │  };                                                              │ │
│  │                                                                   │ │
│  │  // Unix系プラットフォーム詳細                                    │ │
│  │  namespace UE::Profiling {                                       │ │
│  │      struct CPUStatTime {                                        │ │
│  │          uint64_t TotalTime, UserTime, NiceTime, SystemTime;     │ │
│  │          uint64_t SoftIRQTime, IRQTime, IdleTime, IOWaitTime;    │ │
│  │      };                                                          │ │
│  │                                                                   │ │
│  │      struct CPUState {                                           │ │
│  │          static constexpr int32 MaxSupportedCores = 128;         │ │
│  │          int32 CoreCount, ActivatedCoreCount;                    │ │
│  │          CPUStatTime CurrentUsage[128], PreviousUsage[128];      │ │
│  │          int32 Status[128];                                      │ │
│  │          double Utilization[128], IdleTime[128];                 │ │
│  │          double AverageUtilization, AverageIdleTime;             │ │
│  │      };                                                          │ │
│  │  }                                                               │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【初期化】                                                              │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  double InitTiming()                                             │ │
│  │   └─ SecondsPerCycle / SecondsPerCycle64 を設定                  │ │
│  │   └─ main() 前に自動的に呼び出される                             │ │
│  │   └─ 戻り値: SecondsPerCycle                                     │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 次のパート

[第4部：ビルドシステムと新規プラットフォーム追加](Platform_Abstraction_Layer_Part4.md) に続く

---

*このドキュメントはUnreal Engine 5.7のソースコードに基づいています。*
