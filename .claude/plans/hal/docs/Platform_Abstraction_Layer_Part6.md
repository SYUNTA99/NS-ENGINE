# Unreal Engine 5.7 プラットフォーム抽象化レイヤー (HAL) 完全解説

## 第6部：メモリアロケータ詳細ガイド

---

## 目次

1. [アロケータアーキテクチャ概要](#1-アロケータアーキテクチャ概要)
2. [標準アロケータ](#2-標準アロケータ)
3. [サードパーティアロケータ](#3-サードパーティアロケータ)
4. [デバッグ/診断アロケータ](#4-デバッグ診断アロケータ)
5. [プロキシアロケータ](#5-プロキシアロケータ)
6. [仮想メモリアロケータ](#6-仮想メモリアロケータ)
7. [GenericPlatformMemory プラットフォームメモリ基盤](#7-fgenericplatformmemory-プラットフォームメモリ基盤)
8. [アロケータ選択ガイド](#8-アロケータ選択ガイド)

---

## 1. アロケータアーキテクチャ概要

### アロケータ階層構造

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    メモリアロケータ階層構造                              │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【アプリケーション層】                                                  │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │  new / delete / Memory::Malloc / Memory::Free                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                              │                                          │
│                              ▼                                          │
│  【統一API層】                                                           │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │  Memory (HAL/UnrealMemory.h)                                     │ │
│  │   ├─ Malloc() / Realloc() / Free()                                │ │
│  │   ├─ MallocZeroed() / QuantizeSize()                              │ │
│  │   └─ SystemMalloc() / SystemFree()                                │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                              │                                          │
│                              ▼                                          │
│  【アロケータインターフェース層】                                        │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │  Malloc (HAL/MemoryBase.h)                                       │ │
│  │   ├─ Malloc() / TryMalloc()                                       │ │
│  │   ├─ Realloc() / TryRealloc()                                     │ │
│  │   ├─ Free()                                                       │ │
│  │   ├─ GetAllocationSize()                                          │ │
│  │   ├─ ValidateHeap()                                               │ │
│  │   └─ SetupTLSCachesOnCurrentThread()                              │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                              │                                          │
│          ┌───────────────────┼───────────────────┐                      │
│          ▼                   ▼                   ▼                      │
│  ┌─────────────┐     ┌─────────────┐     ┌─────────────┐               │
│  │  標準       │     │サードパーティ│     │  デバッグ   │               │
│  │アロケータ   │     │アロケータ   │     │アロケータ   │               │
│  ├─────────────┤     ├─────────────┤     ├─────────────┤               │
│  │ Binned     │     │ TBB        │     │ Stomp      │               │
│  │ Binned2    │     │ Jemalloc   │     │ Poison     │               │
│  │ Binned3    │     │ Mimalloc   │     │ LeakDetect │               │
│  │ Ansi       │     │ Libpas     │     │ ...        │               │
│  └─────────────┘     └─────────────┘     └─────────────┘               │
│                              │                                          │
│                              ▼                                          │
│  【OS層】                                                                │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │  PlatformMemory::BinnedAllocFromOS() / BinnedFreeToOS()          │ │
│  │   ├─ Windows: VirtualAlloc / VirtualFree                          │ │
│  │   ├─ Unix: mmap / munmap                                          │ │
│  │   └─ Mac: vm_allocate / vm_deallocate                             │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### Malloc 基底インターフェース

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      Malloc インターフェース                            │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  class Malloc : public UseSystemMallocForNew                          │
│  {                                                                      │
│  public:                                                                │
│      // 基本操作                                                        │
│      virtual void* Malloc(SIZE_T Count, uint32 Alignment) = 0;         │
│      virtual void* TryMalloc(SIZE_T Count, uint32 Alignment);          │
│      virtual void* Realloc(void* Ptr, SIZE_T NewCount, uint32 Align);  │
│      virtual void* TryRealloc(void* Ptr, SIZE_T NewCount, uint32 Align);│
│      virtual void Free(void* Ptr) = 0;                                 │
│                                                                         │
│      // ゼロ初期化版                                                    │
│      virtual void* MallocZeroed(SIZE_T Count, uint32 Alignment);       │
│      virtual void* TryMallocZeroed(SIZE_T Count, uint32 Alignment);    │
│                                                                         │
│      // サイズ最適化                                                    │
│      virtual SIZE_T QuantizeSize(SIZE_T Count, uint32 Alignment);      │
│      virtual bool GetAllocationSize(void* Ptr, SIZE_T& OutSize);       │
│                                                                         │
│      // ヒープ管理                                                      │
│      virtual bool ValidateHeap();                                      │
│      virtual void Trim(bool bTrimThreadCaches);                        │
│                                                                         │
│      // TLSキャッシュ管理                                               │
│      virtual void SetupTLSCachesOnCurrentThread();                     │
│      virtual void MarkTLSCachesAsUsedOnCurrentThread();                │
│      virtual void MarkTLSCachesAsUnusedOnCurrentThread();              │
│      virtual void ClearAndDisableTLSCachesOnCurrentThread();           │
│                                                                         │
│      // 統計情報                                                        │
│      virtual void UpdateStats();                                       │
│      virtual void GetAllocatorStats(GenericMemoryStats& Stats);       │
│      virtual void DumpAllocatorStats(OutputDevice& Ar);               │
│                                                                         │
│      // 識別                                                            │
│      virtual const TCHAR* GetDescriptiveName() = 0;                    │
│      virtual bool IsInternallyThreadSafe() const;                      │
│  };                                                                     │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### Memory API (UnrealMemory.h)

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           Memory API                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【概要】                                                                │
│   ・Malloc のラッパー + 低レベルメモリトラッキング                     │
│   ・AutoRTFM サポート                                                   │
│   ・GMalloc への推奨アクセス方法                                        │
│                                                                         │
│  【ファイル】HAL/UnrealMemory.h, HAL/MemoryBase.h                       │
│                                                                         │
│  【アライメント定数 (MemoryBase.h)】                                     │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │  DEFAULT_ALIGNMENT = 0                                          │   │
│  │   → デフォルト指定時はエンジンルール適用                       │   │
│  │   → 16バイト以上: 16バイトアライメント                         │   │
│  │   → 16バイト未満: 8バイトアライメント                          │   │
│  │                                                                 │   │
│  │  MIN_ALIGNMENT = 8                                              │   │
│  │   → 最小アライメント                                           │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  【AllocationHints enum】                                                │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │  enum AllocationHints                                           │   │
│  │  {                                                              │   │
│  │      None      = -1,  // ヒントなし                             │   │
│  │      Default   = 0,   // デフォルト                             │   │
│  │      Temporary = 1,   // 一時的な割り当て                       │   │
│  │      SmallPool = 2,   // スモールプール用                       │   │
│  │      Max       = 3                                              │   │
│  │  };                                                             │   │
│  │                                                                 │   │
│  │  アロケータがヒントに基づいて割り当て戦略を変更可能            │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  【主要API】                                                             │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │  メモリ割り当て:                                                │   │
│  │   static void* Malloc(SIZE_T Count, uint32 Alignment);          │   │
│  │   static void* Realloc(void* Original, SIZE_T Count, uint32 Align);│  │
│  │   static void Free(void* Original);                             │   │
│  │   static SIZE_T GetAllocSize(void* Original);                   │   │
│  │   static void* MallocZeroed(SIZE_T Count, uint32 Alignment);    │   │
│  │   static SIZE_T QuantizeSize(SIZE_T Count, uint32 Alignment);   │   │
│  │                                                                 │   │
│  │  システムアロケータ (GMalloc バイパス):                         │   │
│  │   static void* SystemMalloc(SIZE_T Size);                       │   │
│  │   static void SystemFree(void* Ptr);                            │   │
│  │                                                                 │   │
│  │  TLSキャッシュ管理:                                             │   │
│  │   static void Trim(bool bTrimThreadCaches);                     │   │
│  │   static void SetupTLSCachesOnCurrentThread();                  │   │
│  │   static void ClearAndDisableTLSCachesOnCurrentThread();        │   │
│  │   static void MarkTLSCachesAsUsedOnCurrentThread();             │   │
│  │   static void MarkTLSCachesAsUnusedOnCurrentThread();           │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  【デバッグ/テスト機能】                                                 │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │  static void TestMemory();                                      │   │
│  │   → ランダムヒープ割り当てでヒープ整合性テスト                 │   │
│  │                                                                 │   │
│  │  static void EnablePurgatoryTests();                            │   │
│  │   → -purgatorymallocproxy で有効化                             │   │
│  │   → 古いポインタへの書き込み検出                               │   │
│  │                                                                 │   │
│  │  static void EnablePoisonTests();                               │   │
│  │   → -poisonmallocproxy で有効化                                │   │
│  │                                                                 │   │
│  │  static void ExplicitInit(Malloc& Allocator);                  │   │
│  │   → 遅延初期化無効時の明示的初期化                             │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  【グローバル変数】                                                      │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │  UE::Private::GMalloc (推奨)                                    │   │
│  │   → TSAN_ATOMIC(Malloc*) 型                                   │   │
│  │                                                                 │   │
│  │  ::GMalloc (非推奨、UE5.6以降警告)                              │   │
│  │   → Memory::Malloc 使用を推奨                                 │   │
│  │                                                                 │   │
│  │  GFixedMallocLocationPtr                                        │   │
│  │   → PLATFORM_USES_FIXED_GMalloc_CLASS 使用時のポインタ         │   │
│  │                                                                 │   │
│  │  Malloc::MaxSingleAlloc (非Shipping)                           │   │
│  │   → デバッグ用最大単一割り当て制限                             │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  【コンパイルフラグ】                                                    │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │  UE_USE_VERYLARGEPAGEALLOCATOR = 0 (デフォルト)                 │   │
│  │   → 大ページアロケータ有効化                                   │   │
│  │                                                                 │   │
│  │  UE_ALLOW_OSMEMORYLOCKFREE = 0 (デフォルト)                     │   │
│  │   → OSメモリロックフリー操作許可                               │   │
│  │                                                                 │   │
│  │  MALLOC_GT_HOOKS = STATS ? 1 : 0                                │   │
│  │   → ゲームスレッドフック有効化                                 │   │
│  │                                                                 │   │
│  │  TIME_MALLOC = 0 (デフォルト)                                   │   │
│  │   → malloc時間計測有効化                                       │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### ScopedMallocTimer (TIME_MALLOC)

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       ScopedMallocTimer                                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【概要】                                                                │
│   ・malloc操作の時間計測スコープクラス                                  │
│   ・TIME_MALLOC=1 で有効化                                             │
│                                                                         │
│  【ファイル】HAL/UnrealMemory.h                                         │
│                                                                         │
│  【有効時の構造】                                                        │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │  static uint64 GTotalCycles[4];  // 累積サイクル                │   │
│  │  static uint64 GTotalCount[4];   // 呼び出し回数                │   │
│  │  static uint64 GTotalMisses[4];  // キャッシュミス回数          │   │
│  │                                                                 │   │
│  │  インデックス: 操作タイプ別 (0-3)                               │   │
│  │                                                                 │   │
│  │  Index=1 かつ 65536回ごとに Spew() で統計出力                  │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 2. 標準アロケータ

### Binned系共通定数 (MallocBinnedCommon.h)

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     MallocBinnedCommon 共通定数                         │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【概要】                                                                │
│   ・MallocBinned/Binned2/Binned3で共有される定数                       │
│   ・スモールプール設定とアライメント定義                                │
│                                                                         │
│  【ファイル】HAL/MallocBinnedCommon.h                                   │
│                                                                         │
│  【スモールプール定数】                                                  │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │  #define UE_MBC_MAX_LISTED_SMALL_POOL_SIZE  28672               │   │
│  │   → スモールプールテーブルに列挙される最大サイズ (28KB)        │   │
│  │                                                                 │   │
│  │  #define UE_MBC_NUM_LISTED_SMALL_POOLS      52                  │   │
│  │   → スモールプールの総数                                       │   │
│  │                                                                 │   │
│  │  スモールプールサイズ例:                                        │   │
│  │   16, 32, 48, 64, 80, 96, 112, 128, 160, 192, 224, 256,        │   │
│  │   288, 320, 384, 448, 512, 576, 640, 704, 768, 896, 1024,      │   │
│  │   1168, 1360, 1632, 2048, 2336, 2720, 3264, 4096, 4672,        │   │
│  │   5456, 6544, 8192, 9360, 10912, 13104, 16384, 21840, 28672    │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  【バンドルサイズ】                                                      │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │  #define UE_DEFAULT_GMallocBinnedBundleSize  65536              │   │
│  │   → プールバンドルの標準サイズ (64KB)                         │   │
│  │   → 一度にOSから取得するメモリ単位                            │   │
│  │                                                                 │   │
│  │  バンドル内でスモールブロックを分割・管理                      │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  【アライメント定数】                                                    │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │  #define UE_MBC_MIN_SMALL_POOL_ALIGNMENT    8                   │   │
│  │   → スモールプールの最小アライメント                          │   │
│  │                                                                 │   │
│  │  #define UE_MBC_STANDARD_ALIGNMENT          16                  │   │
│  │   → 標準アライメント（16バイト以上の割り当て用）              │   │
│  │                                                                 │   │
│  │  アライメント選択ロジック:                                      │   │
│  │   Size >= 16 → 16バイトアライメント                           │   │
│  │   Size <  16 → 8バイトアライメント                            │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  【プールサイズ計算】                                                    │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │  要求サイズ → 最適プールサイズの決定:                          │   │
│  │                                                                 │   │
│  │  GetPoolIndex(Size):                                           │   │
│  │   ・SmallPoolTable[N] を検索                                   │   │
│  │   ・Size以上の最小プールサイズを返す                           │   │
│  │   ・バイナリサーチで O(log N) 検索                             │   │
│  │                                                                 │   │
│  │  例: 要求100バイト → 112バイトプール使用                       │   │
│  │      要求1000バイト → 1024バイトプール使用                     │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### Binned系ユーティリティ (MallocBinnedCommonUtils.h)

```
┌─────────────────────────────────────────────────────────────────────────┐
│                  MallocBinnedCommonUtils ユーティリティ                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【概要】                                                                │
│   ・Binned系アロケータ共通のユーティリティクラス・関数                  │
│   ・TLSキャッシュトリム、グローバルリサイクラー                         │
│                                                                         │
│  【ファイル】HAL/MallocBinnedCommonUtils.h                              │
│                                                                         │
│  【TGlobalRecycler テンプレート】                                        │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │  template<int NumSmallPools>                                    │   │
│  │  struct TGlobalRecycler                                         │   │
│  │  {                                                              │   │
│  │      // バンドルをキャッシュにプッシュ                          │   │
│  │      bool PushBundle(uint32 PoolIndex, BundleNode* Bundle);    │   │
│  │      // キャッシュからバンドルをポップ                          │   │
│  │      BundleNode* PopBundle(uint32 PoolIndex);                  │   │
│  │  };                                                             │   │
│  │                                                                 │   │
│  │  内部構造:                                                      │   │
│  │   ・BundlePointer[NumSmallPools] (キャッシュラインアライン)   │   │
│  │   ・FreeBundles[GMallocBinnedMaxBundlesBeforeRecycle]          │   │
│  │   ・InterlockedCompareExchangePointer でロックフリー操作       │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  【MallocBinnedCommonUtils クラス】                                     │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │  static void TrimThreadFreeBlockLists(Allocator, FreeBlockLists)│   │
│  │   → スレッドローカルフリーリストをトリム                       │   │
│  │                                                                 │   │
│  │  static void FlushCurrentThreadCache(Allocator, bNewEpochOnly)  │   │
│  │   → 現在スレッドのキャッシュをフラッシュ                       │   │
│  │   → GMallocBinnedFlushThreadCacheMaxWaitTime 超過で警告        │   │
│  │                                                                 │   │
│  │  static void Trim(Allocator)                                    │   │
│  │   → MemoryTrimEpoch をインクリメント                          │   │
│  │   → 非デスクトップ: 登録済み全スレッドをトリム                │   │
│  │   → デスクトップ: タスクグラフへブロードキャスト              │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  【プロファイリング】                                                    │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │  #if FRAMEPRO_ENABLED                                           │   │
│  │  class NoAllocScopeCycleCounter                                │   │
│  │   → 割り当てなしでスコーププロファイル                         │   │
│  │                                                                 │   │
│  │  NOALLOC_SCOPE_CYCLE_COUNTER(Stat)                              │   │
│  │   → 割り当てなしスコープカウンターマクロ                       │   │
│  │  #endif                                                         │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### MallocAnsi

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          MallocAnsi                                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【概要】                                                                │
│   ・標準C関数（malloc/free/realloc）をラップ                            │
│   ・最もシンプルなフォールバック実装                                     │
│   ・デバッグや他のアロケータが使用不可な場合に使用                        │
│                                                                         │
│  【ファイル】HAL/MallocAnsi.h                                           │
│                                                                         │
│  【特徴】                                                                │
│   ・プラットフォーム非依存                                               │
│   ・アライメント対応（aligned_alloc または手動パディング）               │
│   ・オーバーヘッド最小                                                   │
│   ・TLSキャッシュなし                                                   │
│                                                                         │
│  【使用シーン】                                                          │
│   ・-ansimalloc コマンドライン引数                                      │
│   ・プラットフォーム固有アロケータの初期化前                             │
│   ・デバッグ時のベースライン比較                                         │
│                                                                         │
│  【実装】                                                                │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  void* MallocAnsi::Malloc(SIZE_T Size, uint32 Alignment)       │   │
│  │  {                                                              │   │
│  │      Alignment = Math::Max(Size >= 16 ? 16u : 8u, Alignment);  │   │
│  │  #if PLATFORM_SUPPORTS_ALIGNED_ALLOC                            │   │
│  │      return aligned_alloc(Alignment, Size);                     │   │
│  │  #else                                                          │   │
│  │      // 手動アライメント処理                                     │   │
│  │      void* Ptr = malloc(Size + Alignment + sizeof(void*));      │   │
│  │      // ... アライメント調整                                     │   │
│  │  #endif                                                         │   │
│  │  }                                                              │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### MallocBinned

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          MallocBinned                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【概要】                                                                │
│   ・ビンベース（サイズクラス別）の高速アロケータ                         │
│   ・UE4時代からの実装                                                   │
│   ・32bitプラットフォーム向け                                           │
│                                                                         │
│  【ファイル】HAL/MallocBinned.h                                         │
│                                                                         │
│  【実装定数】                                                            │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │  POOL_COUNT = 41                                                │   │
│  │   → プールテーブル数                                           │   │
│  │                                                                 │   │
│  │  EXTENDED_PAGE_POOL_ALLOCATION_COUNT = 2                        │   │
│  │   → 拡張ページプール数                                         │   │
│  │                                                                 │   │
│  │  MAX_POOLED_ALLOCATION_SIZE = 32768 + 1 (32KB + 1)              │   │
│  │   → プール割り当ての最大サイズ                                 │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  【ロッキングモード】                                                    │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │  USE_INTERNAL_LOCKS (デフォルト有効)                            │   │
│  │   ├─ USE_COARSE_GRAIN_LOCKS → 粗粒度ロック                    │   │
│  │   └─ USE_FINE_GRAIN_LOCKS  → 細粒度ロック (テーブル単位)      │   │
│  │                                                                 │   │
│  │  USE_LOCKFREE_DELETE                                            │   │
│  │   → TLockFreePointerList による非同期解放                      │   │
│  │                                                                 │   │
│  │  統計カウンター:                                                │   │
│  │   COARSE: 直接インクリメント                                   │   │
│  │   FINE: InterlockedIncrement/Add (アトミック)                  │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  【OSキャッシュ (CACHE_FREED_OS_ALLOCS)】                                │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │  MAX_CACHED_OS_FREES = 64                                       │   │
│  │  MAX_CACHED_OS_FREES_BYTE_LIMIT:                                │   │
│  │   ・64bit: 64MB                                                 │   │
│  │   ・32bit: 16MB                                                 │   │
│  │                                                                 │   │
│  │  解放されたOSページをキャッシュして再利用                       │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  【iOS専用 (USE_OS_SMALL_BLOCK_ALLOC)】                                  │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │  USE_OS_SMALL_BLOCK_ALLOC = PLATFORM_IOS                        │   │
│  │   → Nano Mallocとの統合                                        │   │
│  │                                                                 │   │
│  │  USE_OS_SMALL_BLOCK_GRAB_MEMORY_FROM_OS                         │   │
│  │   → OSから小ブロックメモリを取得                               │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  【PoolTable 統計情報】                                                 │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │  NumActivePools    → 現在アクティブなプール数                  │   │
│  │  MaxActivePools    → 同時アクティブ最大プール数                │   │
│  │  ActiveRequests    → 現在アクティブなリクエスト数              │   │
│  │  MaxActiveRequests → 同時アクティブ最大リクエスト数            │   │
│  │  MinRequest        → 最小リクエストサイズ                      │   │
│  │  MaxRequest        → 最大リクエストサイズ                      │   │
│  │  TotalRequests     → 総リクエスト数                            │   │
│  │  TotalWaste        → 総無駄バイト数                            │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### MallocBinned2

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          MallocBinned2                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【概要】                                                                │
│   ・Binnedの改良版                                                      │
│   ・64bitプラットフォーム向けに最適化                                    │
│   ・モバイル/コンソールのデフォルト                                      │
│                                                                         │
│  【ファイル】HAL/MallocBinned2.h                                        │
│                                                                         │
│  【改良点】                                                              │
│   ・より多くのサイズクラス                                               │
│   ・ロックフリー操作の増加                                               │
│   ・メモリ効率の向上                                                    │
│   ・TLSキャッシュ対応                                                   │
│                                                                         │
│  【設定パラメータ（実装値）】                                            │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │  UE_MB2_LARGE_ALLOC = 65536 (64KB)                              │   │
│  │   → これを超えるとOS直接割り当て                               │   │
│  │                                                                 │   │
│  │  【共通定数 (MallocBinnedCommon.h)】                            │   │
│  │  UE_MBC_MAX_LISTED_SMALL_POOL_SIZE = 28672 (28KB)               │   │
│  │  UE_MBC_NUM_LISTED_SMALL_POOLS = 52                             │   │
│  │  UE_DEFAULT_GMallocBinnedBundleSize = 65536 (64KB)              │   │
│  │  UE_MBC_MIN_SMALL_POOL_ALIGNMENT = 8                            │   │
│  │  UE_MBC_STANDARD_ALIGNMENT = 16                                 │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  【カナリア検証システム】                                                │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │  EBlockCanary - ブロックレベルの状態検証:                       │   │
│  │  ┌───────────────────────────────────────────────────────────┐ │   │
│  │  │  enum class EBlockCanary : uint8                          │ │   │
│  │  │  {                                                        │ │   │
│  │  │      Value    = 0xe3,  // 通常状態                        │ │   │
│  │  │      PreFork  = 0xb7,  // フォーク前状態                  │ │   │
│  │  │      PostFork = 0xca,  // フォーク後状態                  │ │   │
│  │  │  };                                                       │ │   │
│  │  └───────────────────────────────────────────────────────────┘ │   │
│  │                                                                 │   │
│  │  PoolInfo::ECanary - プールレベルの状態検証:                   │   │
│  │  ┌───────────────────────────────────────────────────────────┐ │   │
│  │  │  enum ECanary : uint16                                    │ │   │
│  │  │  {                                                        │ │   │
│  │  │      Value0 = 0x3941,  // 状態パターン0                   │ │   │
│  │  │      Value1 = 0x17ea,  // 状態パターン1                   │ │   │
│  │  │      Value2 = 0xf317,  // 状態パターン2                   │ │   │
│  │  │  };                                                       │ │   │
│  │  └───────────────────────────────────────────────────────────┘ │   │
│  │                                                                 │   │
│  │  カナリア検証でメモリ破損を早期検出                             │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  【フォークサポート (BINNED2_FORK_SUPPORT)】                            │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │  有効条件:                                                      │   │
│  │   ・BINNED2_FORK_SUPPORT = 1 (プラットフォーム依存)            │   │
│  │   ・Unix系OSでfork()対応が必要な場合                           │   │
│  │                                                                 │   │
│  │  フォーク時のメモリ一貫性維持:                                  │   │
│  │   1. PreFork: ブロックカナリアを0xb7に変更                     │   │
│  │   2. fork()実行                                                │   │
│  │   3. PostFork: カナリアを0xcaに変更                            │   │
│  │   4. 子プロセス: 新規割り当てで親のプールを継承しない          │   │
│  │                                                                 │   │
│  │  Copy-on-Write最適化:                                          │   │
│  │   ・フォーク後も親子で読み取り専用ページを共有                 │   │
│  │   ・書き込み時のみページコピーが発生                           │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### MallocBinned3

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          MallocBinned3                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【概要】                                                                │
│   ・最新の仮想メモリベースアロケータ                                     │
│   ・Windows 64bit/Linux 64bit のデフォルト                              │
│   ・PLATFORM_HAS_PlatformVirtualMemoryBlock が必要                     │
│                                                                         │
│  【ファイル】HAL/MallocBinned3.h                                        │
│                                                                         │
│  【アーキテクチャ】                                                      │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │        仮想アドレス空間                                          │   │
│  │  ┌──────────────────────────────────────────────────────────┐   │   │
│  │  │                                                          │   │   │
│  │  │  ┌────────────────────────────────────────────────────┐  │   │   │
│  │  │  │        スモールプールエリア                         │  │   │   │
│  │  │  │  ┌──────┬──────┬──────┬──────┬──────┬──────┐       │  │   │   │
│  │  │  │  │Pool 0│Pool 1│Pool 2│ ... │Pool N│(未使用)│       │  │   │   │
│  │  │  │  │ 16B  │ 32B  │ 48B  │     │      │        │       │  │   │   │
│  │  │  │  └──────┴──────┴──────┴──────┴──────┴──────┘       │  │   │   │
│  │  │  │                                                    │  │   │   │
│  │  │  │  各プールは連続した仮想メモリ領域                   │  │   │   │
│  │  │  │  物理メモリは必要に応じてコミット                   │  │   │   │
│  │  │  └────────────────────────────────────────────────────┘  │   │   │
│  │  │                                                          │   │   │
│  │  │  ┌────────────────────────────────────────────────────┐  │   │   │
│  │  │  │        ラージアロケーション                         │  │   │   │
│  │  │  │  ・OS直接割り当て                                   │  │   │   │
│  │  │  │  ・キャッシュページアロケータ経由（オプション）     │  │   │   │
│  │  │  └────────────────────────────────────────────────────┘  │   │   │
│  │  │                                                          │   │   │
│  │  └──────────────────────────────────────────────────────────┘   │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  【ビット木によるブロック管理】                                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │  各プールは二分木構造でフリーブロックを追跡                      │   │
│  │                                                                 │   │
│  │              [Root: 全体空き状況]                               │   │
│  │                    /    \                                       │   │
│  │           [左半分]        [右半分]                              │   │
│  │            /    \          /    \                               │   │
│  │         [1/4]  [1/4]    [1/4]  [1/4]                           │   │
│  │          ...    ...      ...    ...                             │   │
│  │                                                                 │   │
│  │  O(log N) でフリーブロック検索                                  │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  【カナリア検証 (PoolInfo::ECanary)】                                   │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │  enum class ECanary : uint32                                    │   │
│  │  {                                                              │   │
│  │      Unassigned = 0x39431234,  // 未割り当て状態                │   │
│  │      Assigned   = 0x17ea5678,  // 割り当て済み状態              │   │
│  │  };                                                             │   │
│  │                                                                 │   │
│  │  PoolInfo構造体:                                               │   │
│  │   ├─ Canary: ECanary        (検証用マジック値)                  │   │
│  │   ├─ AllocSize: uint32      (要求バイト数)                      │   │
│  │   ├─ VMSizeDivAlignment     (VM予約サイズ/アライメント)         │   │
│  │   └─ CommitSize: uint32     (OSコミット済みバイト数)            │   │
│  │                                                                 │   │
│  │  CheckCanary()で状態検証 → メモリ破損検出                       │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  【設定オプション（実装値）】                                            │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │  UE_MB3_BASE_PAGE_SIZE = 4096                                   │   │
│  │   → 最小ページサイズ                                           │   │
│  │                                                                 │   │
│  │  UE_MB3_MAX_MEMORY_PER_POOL_SIZE_MB                             │   │
│  │   → プール単位の最大仮想メモリ                                 │   │
│  │   → デフォルト: 1024MB (1GB)                                   │   │
│  │   → iOS: 512MB                                                 │   │
│  │                                                                 │   │
│  │  UE_MB3_MAX_SMALL_POOL_SIZE = 128KB (デフォルト)                │   │
│  │   → スモールプールの最大サイズ                                 │   │
│  │                                                                 │   │
│  │  BINNED3_USE_SEPARATE_VM_PER_POOL                               │   │
│  │   → Windows: 1 (プールごとに独立VM)                            │   │
│  │   → その他: 0 (連続VM領域)                                     │   │
│  │                                                                 │   │
│  │  UE_MB3_USE_CACHED_PAGE_ALLOCATOR_FOR_LARGE_ALLOCS = 0          │   │
│  │   → ラージ割り当てにキャッシュページアロケータを使用            │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### MallocBinnedGPU

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          MallocBinnedGPU                               │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【概要】                                                                │
│   ・GPU向けメモリ割り当て戦略                                           │
│   ・UMA (Unified Memory Architecture) 対応                             │
│   ・コンソール向け最適化                                                │
│                                                                         │
│  【ファイル】HAL/MallocBinnedGPU.h                                      │
│                                                                         │
│  【特徴】                                                                │
│   ・GPUアクセス可能なメモリ領域からの割り当て                           │
│   ・アライメント要件が厳しい (通常64KB以上)                             │
│   ・Write-Combined メモリ対応                                           │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 3. サードパーティアロケータ

### MallocTBB

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           MallocTBB                                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【概要】                                                                │
│   ・Intel Threading Building Blocks (TBB) のscalable_malloc使用        │
│   ・マルチスレッド環境で優れたスケーラビリティ                          │
│                                                                         │
│  【ファイル】HAL/MallocTBB.h                                            │
│                                                                         │
│  【対応プラットフォーム】                                                │
│   ・Windows (PLATFORM_SUPPORTS_TBB)                                    │
│   ・Mac (PLATFORM_SUPPORTS_TBB)                                        │
│                                                                         │
│  【有効化】                                                              │
│   ・コマンドライン: -tbbmalloc                                         │
│   ・TBBライブラリがリンクされている必要あり                             │
│                                                                         │
│  【特徴】                                                                │
│   ・スレッドローカルヒープ                                              │
│   ・ロック競合の最小化                                                  │
│   ・大規模並列処理に最適                                                │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### MallocJemalloc

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         MallocJemalloc                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【概要】                                                                │
│   ・Jason Evans (Facebook) 開発の高性能アロケータ                       │
│   ・FreeBSD標準、Linux/Androidで人気                                   │
│                                                                         │
│  【ファイル】HAL/MallocJemalloc.h                                       │
│                                                                         │
│  【対応プラットフォーム】                                                │
│   ・Linux (PLATFORM_SUPPORTS_JEMALLOC)                                 │
│   ・FreeBSD                                                            │
│                                                                         │
│  【有効化】                                                              │
│   ・コマンドライン: -jemalloc                                          │
│                                                                         │
│  【特徴】                                                                │
│   ・アリーナベースの割り当て                                            │
│   ・フラグメンテーション最小化                                          │
│   ・詳細な統計情報                                                      │
│   ・mallctl API による動的設定                                         │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### MallocMimalloc

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         MallocMimalloc                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【概要】                                                                │
│   ・Microsoft開発のコンパクト汎用アロケータ                             │
│   ・優れたパフォーマンスと低メモリオーバーヘッド                         │
│   ・Windows/Mac/Linuxのデフォルト候補                                   │
│                                                                         │
│  【ファイル】HAL/MallocMimalloc.h                                       │
│                                                                         │
│  【対応プラットフォーム】                                                │
│   ・Windows 64bit (PLATFORM_SUPPORTS_MIMALLOC)                         │
│   ・Mac (PLATFORM_SUPPORTS_MIMALLOC)                                   │
│   ・Linux 64bit (PLATFORM_SUPPORTS_MIMALLOC)                           │
│                                                                         │
│  【有効化】                                                              │
│   ・コマンドライン: -mimalloc                                          │
│   ・多くのプラットフォームでデフォルト                                  │
│                                                                         │
│  【特徴】                                                                │
│   ・フリーリストシャーディング                                          │
│   ・セグメントベース                                                    │
│   ・約2%の空間オーバーヘッド                                            │
│   ・セキュリティ強化オプション                                          │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### MallocLibpas

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          MallocLibpas                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【概要】                                                                │
│   ・WebKitのlibpas (Phil's Awesome malloc System)                      │
│   ・Apple環境向け最適化                                                 │
│                                                                         │
│  【ファイル】HAL/MallocLibpas.h                                         │
│                                                                         │
│  【対応プラットフォーム】                                                │
│   ・Mac (Apple Silicon最適化)                                          │
│   ・iOS                                                                │
│                                                                         │
│  【特徴】                                                                │
│   ・ページヘッダーベース                                                │
│   ・隔離ヒープ                                                          │
│   ・Type-safe allocation                                               │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 4. デバッグ/診断アロケータ

### MallocDebug

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          MallocDebug                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【概要】                                                                │
│   ・デバッグ機能付きアロケータ                                          │
│   ・割り当て追跡、境界チェック等                                        │
│                                                                         │
│  【ファイル】HAL/MallocDebug.h                                          │
│                                                                         │
│  【機能】                                                                │
│   ・割り当て/解放の詳細ログ                                             │
│   ・二重解放検出                                                        │
│   ・未初期化メモリの検出                                                │
│   ・メモリリーク報告                                                    │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### MallocStomp

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          MallocStomp                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【概要】                                                                │
│   ・ページ保護によるバッファオーバーラン/アンダーラン検出               │
│   ・各割り当てをページ境界に配置                                        │
│                                                                         │
│  【ファイル】HAL/MallocStomp.h                                          │
│                                                                         │
│  【有効化条件】                                                          │
│   ・WITH_MALLOC_STOMP が有効 (Core.Build.cs で設定)                    │
│   ・コマンドライン: -stompmalloc                                       │
│                                                                         │
│  【実装詳細】                                                            │
│   ・VirtualAddressBlockSize = 1GB (スレッドごと)                       │
│   ・スレッドローカル仮想アドレス空間を使用                              │
│   ・スレッドセーフ (mmap/VirtualAlloc がスレッドセーフ)                 │
│                                                                         │
│  【動作原理】                                                            │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │  オーバーラン検出モード (デフォルト):                             │   │
│  │  ┌────────────────────────────────┬─────────────────┐           │   │
│  │  │       ユーザーデータ           │   ガードページ   │           │   │
│  │  │       (アクセス可能)            │  (アクセス不可) │           │   │
│  │  └────────────────────────────────┴─────────────────┘           │   │
│  │                                    ↑                            │   │
│  │                         ここを超えるとクラッシュ                 │   │
│  │                                                                 │   │
│  │  アンダーラン検出モード (bUseUnderrunMode=true):                  │   │
│  │  ┌─────────────────┬────────────────────────────────┐           │   │
│  │  │   ガードページ   │       ユーザーデータ           │           │   │
│  │  │  (アクセス不可) │       (アクセス可能)            │           │   │
│  │  └─────────────────┴────────────────────────────────┘           │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### MallocStomp2

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          MallocStomp2                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【概要】                                                                │
│   ・Stompの改良版、より大規模なアドレス空間を確保                       │
│   ・Use-after-free検出の強化                                           │
│                                                                         │
│  【ファイル】HAL/MallocStomp2.h                                         │
│                                                                         │
│  【有効化条件】                                                          │
│   ・WITH_MALLOC_STOMP2 = WITH_EDITOR && PLATFORM_WINDOWS               │
│   ・コマンドライン: -stomp2malloc                                      │
│                                                                         │
│  【実装詳細】                                                            │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │  VirtualAddressSpaceToReserve = 64GB (ブロックあたり)            │   │
│  │  MaxAddressSpaceStompDataBlocks = 4096                          │   │
│  │  TargetAddressSpaceToReserve = 32TB (最大)                      │   │
│  │                                                                 │   │
│  │  センチネル値:                                                   │   │
│  │    64bit: SentinelExpectedValue = 0xdeadbeefdeadbeef            │   │
│  │    32bit: SentinelExpectedValue = 0xdeadbeef                    │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  【特殊機能】                                                            │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │  ScopeDisableMallocStomp2:                                     │   │
│  │   ・スコープ内でStomp2を一時無効化                              │   │
│  │   ・TLSカウンタで制御                                           │   │
│  │   ・追跡不要な割り当てに使用                                    │   │
│  │                                                                 │   │
│  │  MinSize / MaxSize:                                             │   │
│  │   ・追跡する割り当てサイズ範囲を制限可能                        │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  【Use-After-Free検出】                                                  │
│   ・Free時に物理メモリはデコミット (MEM_DECOMMIT)                      │
│   ・仮想アドレスは予約維持 → アクセスでページフォルト                  │
│   ・大量の仮想アドレス空間を使用して検出期間を延長                      │
│                                                                         │
│  【注意】                                                                │
│   ・Windows + Editorビルドのみ                                         │
│   ・大量の仮想アドレス空間を消費                                       │
│   ・パフォーマンス影響大                                               │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### MallocLeakDetection

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       MallocLeakDetection                              │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【概要】                                                                │
│   ・メモリリーク検出専用アロケータ                                      │
│   ・全割り当てを追跡し、未解放メモリを報告                              │
│                                                                         │
│  【ファイル】HAL/MallocLeakDetection.h                                  │
│                                                                         │
│  【有効化】                                                              │
│   ・MALLOC_LEAKDETECTION = 1 (デフォルト: 0)                           │
│                                                                         │
│  【内部構造】                                                            │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │  CallstackTrack:                                               │   │
│  │   ├─ Callstack[32]: uint64  (コールスタック深度32)              │   │
│  │   ├─ FirstFrame/LastFrame   (フレーム範囲)                      │   │
│  │   ├─ Size: uint64           (累積サイズ)                        │   │
│  │   ├─ Count: uint32          (割り当て回数)                      │   │
│  │   ├─ CachedHash             (CityHash64によるハッシュ)          │   │
│  │   └─ BytesPerFrame          (最小二乗法によるリーク率推定)      │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  【レポートオプション (MallocLeakReportOptions)】                       │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │  SizeFilter        → 指定サイズ以上のみ報告                     │   │
│  │  RateFilter        → 指定リーク率以上のみ報告                   │   │
│  │  OnlyNonDeleters   → 解放履歴のない割り当てのみ                 │   │
│  │  FrameStart/End    → フレーム範囲でフィルタ                     │   │
│  │  SortBy            → SortSize/SortRate/SortHash                 │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  【使用方法】                                                            │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │  // レポート出力                                                 │   │
│  │  MallocLeakReportOptions Options;                              │   │
│  │  Options.SizeFilter = 1024;  // 1KB以上                         │   │
│  │  Options.SortBy = ESortOption::SortRate;                        │   │
│  │  MallocLeakDetection::Get().DumpOpenCallstacks(Options);       │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### MallocDoubleFreeFinder

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     MallocDoubleFreeFinder                             │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【概要】                                                                │
│   ・二重解放（Double Free）検出                                        │
│   ・解放済みポインタの再使用検出                                        │
│   ・MallocCallstackHandler を継承                                     │
│                                                                         │
│  【ファイル】HAL/MallocDoubleFreeFinder.h                               │
│                                                                         │
│  【グローバル変数】                                                      │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │  extern MallocDoubleFreeFinder* GMallocDoubleFreeFinder;       │   │
│  │  extern bool GMallocDoubleFreeFinderEnabled;                    │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  【内部構造】                                                            │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │  TrackedAllocationData:                                         │   │
│  │   ├─ Size: SIZE_T              (割り当てサイズ)                │   │
│  │   └─ CallStackIndex: int32     (コールスタックインデックス)    │   │
│  │                                                                 │   │
│  │  TrackedCurrentAllocations                                      │   │
│  │   → TMap<void*, TrackedAllocationData>                         │   │
│  │   → 現在の割り当てを追跡                                       │   │
│  │                                                                 │   │
│  │  TrackedFreeAllocations                                         │   │
│  │   → TMap<void*, TrackedAllocationData>                         │   │
│  │   → 解放済みの割り当てを追跡                                   │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  【特殊機能】                                                            │
│   ・TrackSpecial(void* Ptr): アロケータ外のメモリエラー調査用          │
│   ・アクセス違反ポインタを渡して直近のFreeコールスタックを取得         │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### MallocCallstackHandler

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      MallocCallstackHandler                            │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【概要】                                                                │
│   ・全割り当てのコールスタックを記録                                    │
│   ・メモリ問題のデバッグに使用                                          │
│   ・MallocDoubleFreeFinder, MallocFrameProfiler の基底クラス         │
│                                                                         │
│  【ファイル】HAL/MallocCallstackHandler.h                               │
│                                                                         │
│  【実装定数】                                                            │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │  MaxCallStackDepth = 64                                         │   │
│  │   → 記録するコールスタックの最大深度                           │   │
│  │                                                                 │   │
│  │  CallStackEntriesToSkipCount = 2                                │   │
│  │   → スキップするスタックエントリ数（アロケータ自身）           │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  【内部構造】                                                            │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │  CallStackInfo:                                                │   │
│  │   ├─ Count: uint32             (参照カウント)                  │   │
│  │   └─ FramePointers[64]: uint64 (フレームポインタ配列)         │   │
│  │                                                                 │   │
│  │  CallStackMapKey:                                              │   │
│  │   ├─ CRC: uint32               (Crc::MemCrc32 ハッシュ)       │   │
│  │   └─ CallStack: uint64*        (コールスタックポインタ)        │   │
│  │                                                                 │   │
│  │  CallStackMapKeyToCallStackIndexMap                             │   │
│  │   → TMap<CallStackMapKey, int32>                              │   │
│  │                                                                 │   │
│  │  CallStackInfoArray                                             │   │
│  │   → TArray<CallStackInfo>                                     │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  【TLS無効化機構】                                                       │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │  ScopeDisableMallocCallstackHandler:                           │   │
│  │   → コンストラクタ: IncDisabled() (TLSカウンタ++)              │   │
│  │   → デストラクタ:  DecDisabled() (TLSカウンタ--)              │   │
│  │   → IsDisabled(): TLSカウンタ != 0 で追跡スキップ              │   │
│  │                                                                 │   │
│  │  用途: トラッキングデータ自体のメモリ割り当て時に使用          │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### MallocFrameProfiler

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       MallocFrameProfiler                              │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【概要】                                                                │
│   ・フレーム単位のメモリ割り当てプロファイリング                        │
│   ・ゲームループでの割り当てパターン分析                                │
│   ・MallocCallstackHandler を継承                                     │
│                                                                         │
│  【ファイル】HAL/MallocFrameProfiler.h                                  │
│                                                                         │
│  【グローバル変数】                                                      │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │  extern MallocFrameProfiler* GMallocFrameProfiler;             │   │
│  │  extern bool GMallocFrameProfilerEnabled;                       │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  【内部構造】                                                            │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │  CallStackStats:                                               │   │
│  │   ├─ CallStackIndex: int32     (コールスタックインデックス)    │   │
│  │   ├─ Mallocs: int32            (割り当て回数)                  │   │
│  │   ├─ Frees: int32              (解放回数)                      │   │
│  │   ├─ UsageCount: int32         (使用回数)                      │   │
│  │   ├─ UniqueFrames: int32       (ユニークフレーム数)            │   │
│  │   └─ LastFrameSeen: int32      (最後に見たフレーム)            │   │
│  │                                                                 │   │
│  │  TrackedCurrentAllocations                                      │   │
│  │   → TMap<void*, int32> (ポインタ → インデックス)              │   │
│  │                                                                 │   │
│  │  CallStackStatsArray                                            │   │
│  │   → TArray<CallStackStats>                                    │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  【フレーム統計】                                                        │
│   ・FrameCount: 現在のフレーム番号                                     │
│   ・EntriesToOutput: 出力するエントリ数                                │
│   ・UpdateStats(): フレームごとに呼び出し統計更新                      │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### MallocReplayProxy

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       MallocReplayProxy                                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【概要】                                                                │
│   ・メモリ操作の記録と再生                                              │
│   ・再現性のあるバグ調査に使用                                          │
│   ・軽量なメモリダンプ機構                                              │
│                                                                         │
│  【ファイル】HAL/MallocReplayProxy.h                                    │
│                                                                         │
│  【有効化条件】                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │  #define UE_USE_MALLOC_REPLAY_PROXY                             │   │
│  │      (PLATFORM_UNIX && !UE_BUILD_SHIPPING)                      │   │
│  │                                                                 │   │
│  │  → Linux/Unix の非Shippingビルドでデフォルト有効               │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  【実装定数】                                                            │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │  HistoryCacheSize = 16384                                       │   │
│  │   → メモリ内キャッシュサイズ                                   │   │
│  │   → 超過時にディスクへフラッシュ                               │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  【HistoryEntry 構造体】                                                │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │  struct HistoryEntry                                           │   │
│  │  {                                                              │   │
│  │      const char* Operation;  // 操作種別文字列                  │   │
│  │      void* PointerOut;       // 返却ポインタ                    │   │
│  │      void* PointerIn;        // 入力ポインタ                    │   │
│  │      SIZE_T Size;            // 要求サイズ                      │   │
│  │      uint32 Alignment;       // アライメント                    │   │
│  │  };                                                             │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  【ディスク出力】                                                        │
│   ・OperationNumber: グローバル操作番号（シーケンシャル）              │
│   ・HistoryFile: FILE* でファイル出力                                  │
│   ・DumpHistoryToDisk(): キャッシュ超過時に自動フラッシュ              │
│   ・CloseHistory(): 終了時/任意タイミングでクローズ                    │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### MallocTimer / ScopedVirtualMallocTimer

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    ScopedVirtualMallocTimer                            │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【概要】                                                                │
│   ・仮想メモリ操作の時間計測                                            │
│   ・アロケータのパフォーマンス分析                                      │
│   ・スコープベースの自動計測                                            │
│                                                                         │
│  【ファイル】HAL/MallocTimer.h                                          │
│                                                                         │
│  【有効化】                                                              │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │  #define UE_TIME_VIRTUALMALLOC 0  // デフォルト無効             │   │
│  │                                                                 │   │
│  │  1に設定すると時間計測が有効化                                  │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  【操作種別 (IndexType)】                                                │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │  enum IndexType : int32                                         │   │
│  │  {                                                              │   │
│  │      Reserve,   // 仮想メモリ予約                               │   │
│  │      Commit,    // 物理メモリコミット                           │   │
│  │      Combined,  // 予約+コミット同時                            │   │
│  │      DeCommit,  // 物理メモリデコミット                         │   │
│  │      Free,      // 仮想メモリ解放                               │   │
│  │      Max                                                        │   │
│  │  };                                                             │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  【プラットフォーム種別 (PlatormIndexType)】                             │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │  enum PlatormIndexType : int32                                  │   │
│  │  {                                                              │   │
│  │      OrdinaryCPU,              // 通常CPU用メモリ               │   │
│  │      GPU_WriteCombine,         // GPU書込結合メモリ             │   │
│  │      GPU_Cacheable,            // GPUキャッシュ可能メモリ       │   │
│  │      GPU_WriteCombineRenderTarget, // 4MBページ/128Kアライン   │   │
│  │      PlatormIndexTypeMax                                        │   │
│  │  };                                                             │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  【統計配列】                                                            │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │  static uint64 GTotalCycles[IndexType::Max][PlatormIndexType::Max]│  │
│  │   → 累積サイクル数                                             │   │
│  │                                                                 │   │
│  │  static uint64 GTotalCounts[IndexType::Max][PlatormIndexType::Max]│  │
│  │   → 呼び出し回数                                               │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  【使用例】                                                              │
│   {                                                                    │
│       ScopedVirtualMallocTimer Timer(IndexType::Commit, OrdinaryCPU);│
│       // ... 仮想メモリ操作 ...                                        │
│   } // デストラクタで自動的に時間記録                                   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### MallocLeakDetectionProxy

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    MallocLeakDetectionProxy                            │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【概要】                                                                │
│   ・MallocLeakDetection のプロキシラッパー                            │
│   ・任意のアロケータにリーク検出機能を追加                              │
│                                                                         │
│  【ファイル】HAL/MallocLeakDetectionProxy.h (Private)                   │
│                                                                         │
│  【有効化条件】                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │  #if MALLOC_LEAKDETECTION                                       │   │
│  │   → MALLOC_LEAKDETECTION=1 で有効                              │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  【構造】                                                                │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │  class MallocLeakDetectionProxy : public Malloc               │   │
│  │  {                                                              │   │
│  │      Malloc* UsedMalloc;           // 実際のアロケータ        │   │
│  │      MallocLeakDetection& Verify;  // リーク検出オブジェクト  │   │
│  │  };                                                             │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  【動作】                                                                │
│   Malloc: UsedMalloc->Malloc() → Verify.Malloc()                      │
│   Realloc: UsedMalloc->Realloc() → Verify.Realloc()                   │
│   Free: Verify.Free() → UsedMalloc->Free()                            │
│                                                                         │
│  【取得方法】                                                            │
│   static MallocLeakDetectionProxy& Get();                             │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 5. プロキシアロケータ

### MallocPoisonProxy

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       MallocPoisonProxy                                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【概要】                                                                │
│   ・メモリポイズニング（毒入れ）                                        │
│   ・未初期化メモリ使用/解放後使用の検出                                 │
│                                                                         │
│  【ファイル】HAL/MallocPoisonProxy.h                                    │
│                                                                         │
│  【有効化条件】                                                          │
│   ・UE_USE_MALLOC_FILL_BYTES = 1 (以下の条件で自動有効)                 │
│     - (UE_BUILD_DEBUG || UE_BUILD_DEVELOPMENT)                         │
│     - && !WITH_EDITORONLY_DATA                                         │
│     - && !PLATFORM_USES_FIXED_GMalloc_CLASS                            │
│     - && !USING_ADDRESS_SANITISER                                      │
│                                                                         │
│  【ポイズン値（実装値）】                                                │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │  #define UE_DEBUG_FILL_NEW   0xCD  // 新規割り当て時            │   │
│  │  #define UE_DEBUG_FILL_FREED 0xDD  // 解放時                    │   │
│  │                                                                 │   │
│  │  Malloc時:                                                      │   │
│  │   ・Memset(Result, 0xCD, Size)                                  │   │
│  │   ・未初期化メモリを使用すると 0xCDCDCDCD のような値            │   │
│  │                                                                 │   │
│  │  Free時:                                                        │   │
│  │   ・Memset(Ptr, 0xDD, AllocSize)                                │   │
│  │   ・解放後メモリを使用すると 0xDDDDDDDD のような値              │   │
│  │                                                                 │   │
│  │  Realloc時:                                                     │   │
│  │   ・縮小: 縮小部分を 0xDD で埋める                              │   │
│  │   ・拡大: 拡張部分を 0xCD で埋める                              │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  【デバッガでの識別】                                                    │
│   ・0xCDCDCDCD: 未初期化メモリの使用                                   │
│   ・0xDDDDDDDD: 解放済みメモリの使用 (Use-After-Free)                  │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### MallocThreadSafeProxy

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     MallocThreadSafeProxy                              │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【概要】                                                                │
│   ・スレッドセーフでないアロケータをラップ                              │
│   ・全操作をロックで保護                                                │
│                                                                         │
│  【ファイル】HAL/MallocThreadSafeProxy.h                                │
│                                                                         │
│  【使用シーン】                                                          │
│   ・シングルスレッドアロケータをマルチスレッド環境で使用               │
│   ・デバッグ時の競合検出                                                │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### MallocVerifyProxy

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       MallocVerifyProxy                                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【概要】                                                                │
│   ・全割り当てポインタの検証プロキシ                                    │
│   ・不正なポインタ操作の検出                                            │
│                                                                         │
│  【ファイル】HAL/MallocVerify.h (Private)                               │
│                                                                         │
│  【有効化条件】                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │  #define MALLOC_VERIFY 0  // デフォルト無効                     │   │
│  │                                                                 │   │
│  │  MALLOC_VERIFY=1 でコンパイル時に有効化                        │   │
│  │  本番ビルドでは無効推奨（オーバーヘッド大）                    │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  【動作原理】                                                            │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │  Malloc時:                                                      │   │
│  │   1. 実際のアロケータから割り当て取得                          │   │
│  │   2. ポインタをセット(AllocatedPointers)に追加                 │   │
│  │                                                                 │   │
│  │  Free時:                                                        │   │
│  │   1. ポインタがセット内に存在するか検証                        │   │
│  │   2. 存在しなければ不正な解放として検出                        │   │
│  │   3. セットからポインタを削除                                  │   │
│  │   4. 実際のアロケータでFree                                    │   │
│  │                                                                 │   │
│  │  Realloc時:                                                     │   │
│  │   1. 元ポインタの存在を検証                                    │   │
│  │   2. セットから元ポインタを削除                                │   │
│  │   3. 実際のReallocを実行                                       │   │
│  │   4. 新ポインタをセットに追加                                  │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  【検出可能な問題】                                                      │
│   ・未割り当てポインタの解放                                            │
│   ・二重解放 (Double Free)                                             │
│   ・不正なポインタへのRealloc                                          │
│   ・ワイルドポインタの解放                                              │
│                                                                         │
│  【内部構造】                                                            │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │  class MallocVerifyProxy : public Malloc                      │   │
│  │  {                                                              │   │
│  │      Malloc* UsedMalloc;           // 実際のアロケータ        │   │
│  │      TSet<void*> AllocatedPointers; // 全割り当てポインタ      │   │
│  │      CriticalSection Mutex;        // スレッドセーフ用ロック  │   │
│  │  };                                                             │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  【パフォーマンス影響】                                                  │
│   ・Malloc/Free毎にセット操作 → O(log N) オーバーヘッド               │
│   ・メモリ使用量増加（ポインタ追跡用）                                  │
│   ・ロック競合の可能性                                                  │
│   ・デバッグビルドでのみ使用推奨                                        │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 6. 仮想メモリアロケータ

### VirtualAllocator

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        VirtualAllocator                                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【概要】                                                                │
│   ・汎用仮想メモリアロケータ                                            │
│   ・Binned系アロケータの基盤                                            │
│                                                                         │
│  【ファイル】HAL/VirtualAllocator.h                                     │
│                                                                         │
│  【内部構造（実装値）】                                                  │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │  FreeLink構造体:                                               │   │
│  │  ┌───────────────────────────────────────────────────────────┐ │   │
│  │  │  struct FreeLink                                         │ │   │
│  │  │  {                                                        │ │   │
│  │  │      void* Ptr = nullptr;    // ブロックポインタ          │ │   │
│  │  │      FreeLink* Next = nullptr; // 次のフリーリンク       │ │   │
│  │  │  };                                                       │ │   │
│  │  └───────────────────────────────────────────────────────────┘ │   │
│  │                                                                 │   │
│  │  PerBlockSize構造体:                                           │   │
│  │  ┌───────────────────────────────────────────────────────────┐ │   │
│  │  │  struct PerBlockSize                                     │ │   │
│  │  │  {                                                        │ │   │
│  │  │      int64 AllocBlocksSize = 0;  // 割り当て済みサイズ    │ │   │
│  │  │      int64 FreeBlocksSize = 0;   // フリーサイズ          │ │   │
│  │  │      FreeLink* FirstFree = nullptr; // フリーリスト先頭  │ │   │
│  │  │  };                                                       │ │   │
│  │  └───────────────────────────────────────────────────────────┘ │   │
│  │                                                                 │   │
│  │  ブロックサイズ管理:                                            │   │
│  │   ・Blocks[64] 配列でサイズクラス別に管理                       │   │
│  │   ・CeilLogTwo64 でブロックインデックス計算                     │   │
│  │   ・2のべき乗サイズに切り上げ                                   │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  【RecycledLinks機構】                                                   │
│   ・FreeLink構造体自体のメモリプール                                   │
│   ・bBacksMalloc時: VM空間からコミット                                 │
│   ・それ以外: Memory::Malloc で確保                                   │
│   ・MaximumAlignment サイズで一括確保、分割使用                        │
│                                                                         │
│  【MB3との連携】                                                         │
│   ・巨大ブロック (TotalSize/2以上) は2のべき乗丸めをスキップ           │
│   ・MB3は大量のVMを要求し解放しないため特別処理                        │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### TCachedOSPageAllocator

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    TCachedOSPageAllocator                               │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【概要】                                                                │
│   ・OSページアロケータ + キャッシュ層                                   │
│   ・頻繁なOS呼び出しを削減                                              │
│   ・テンプレートでキャッシュサイズを設定                                │
│                                                                         │
│  【ファイル】HAL/Allocators/CachedOSPageAllocator.h                     │
│                                                                         │
│  【テンプレートパラメータ】                                              │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │  template <uint32 NumCacheBlocks, uint32 CachedByteLimit>       │   │
│  │  struct TCachedOSPageAllocator                                  │   │
│  │                                                                 │   │
│  │  NumCacheBlocks: キャッシュブロック数                           │   │
│  │  CachedByteLimit: キャッシュ合計バイト制限                      │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  【内部構造】                                                            │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │  FreePageBlock:                                                │   │
│  │   ├─ Ptr: void*       (ページポインタ)                         │   │
│  │   └─ ByteSize: SIZE_T (バイトサイズ)                           │   │
│  │                                                                 │   │
│  │  FreedPageBlocks[NumCacheBlocks * 2]                            │   │
│  │   → TimeCriticalスレッド用に2倍確保                            │   │
│  │                                                                 │   │
│  │  CachedTotal: SIZE_T (現在キャッシュ総量)                       │   │
│  │  FreedPageBlocksNum: uint32 (使用中ブロック数)                  │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  【OS割り当て判定】                                                      │
│   IsOSAllocation(Size):                                                │
│    → BinnedPlatformHasMemoryPoolForThisSize(Size)                     │
│    → または Size > CachedByteLimit / 4                                │
│                                                                         │
│  【API】                                                                 │
│   ・Allocate(Size, AllocationHint, Mutex)                              │
│   ・Free(Ptr, Size, Mutex, ThreadIsTimeCritical)                       │
│   ・FreeAll(Mutex)                                                     │
│   ・GetCachedFreeTotal() / GetCachedImmediatelyFreeable()              │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### CachedOSVeryLargePageAllocator

```
┌─────────────────────────────────────────────────────────────────────────┐
│                  CachedOSVeryLargePageAllocator                        │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【概要】                                                                │
│   ・大ページ (2MB) 用キャッシュアロケータ                               │
│   ・TLBミス削減、高スループット向け                                     │
│   ・MallocBinned2/3 のバックエンドとして使用                           │
│                                                                         │
│  【ファイル】HAL/Allocators/CachedOSVeryLargePageAllocator.h            │
│                                                                         │
│  【有効化条件】                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │  #if UE_USE_VERYLARGEPAGEALLOCATOR                              │   │
│  │                                                                 │   │
│  │  extern bool GEnableVeryLargePageAllocator;                     │   │
│  │   → ランタイムで有効/無効切り替え                              │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  【実装定数】                                                            │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │  キャッシュ制限:                                                │   │
│  │   64bit: CACHEDOSVERYLARGEPAGEALLOCATOR_BYTE_LIMIT = 128MB      │   │
│  │   32bit: CACHEDOSVERYLARGEPAGEALLOCATOR_BYTE_LIMIT = 16MB       │   │
│  │                                                                 │   │
│  │  CACHEDOSVERYLARGEPAGEALLOCATOR_MAX_CACHED_OS_FREES = 256       │   │
│  │                                                                 │   │
│  │  仮想メモリ予約:                                                │   │
│  │   UE_VERYLARGEPAGEALLOCATOR_RESERVED_SIZE_IN_GB = 4 (デフォルト)│   │
│  │   AddressSpaceToReserve = 4GB                                   │   │
│  │   AddressSpaceToReserveForSmallPool = 2GB (半分)                │   │
│  │                                                                 │   │
│  │  ページサイズ:                                                  │   │
│  │   UE_VERYLARGEPAGEALLOCATOR_PAGESIZE_KB = 2048 (2MB)            │   │
│  │   SizeOfLargePage = 2MB                                         │   │
│  │   SizeOfSubPage = 64KB                                          │   │
│  │   NumberOfSubPagesPerLargePage = 32 (2MB / 64KB)                │   │
│  │                                                                 │   │
│  │  NumberOfLargePages = 2048 (4GB / 2MB)                          │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  【LargePage 構造体】                                                   │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │  struct LargePage : TIntrusiveLinkedList<LargePage>           │   │
│  │  {                                                              │   │
│  │      uintptr_t FreeSubPages[NumberOfSubPagesPerLargePage];      │   │
│  │      int32 NumberOfFreeSubPages;                                │   │
│  │      uint32 AllocationHint;                                     │   │
│  │      uintptr_t BaseAddress;                                     │   │
│  │  };                                                             │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  【ページリスト管理】                                                    │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │  各AllocationHintごとに4種類のリスト:                           │   │
│  │                                                                 │   │
│  │  FreeLargePagesHead[AllocationHints::Max]                       │   │
│  │   → バッキングストアなし（未コミット）                         │   │
│  │                                                                 │   │
│  │  UsedLargePagesHead[AllocationHints::Max]                       │   │
│  │   → バッキングストアあり、満杯                                 │   │
│  │                                                                 │   │
│  │  UsedLargePagesWithSpaceHead[AllocationHints::Max]              │   │
│  │   → バッキングストアあり、空きあり                             │   │
│  │                                                                 │   │
│  │  EmptyButAvailableLargePagesHead[AllocationHints::Max]          │   │
│  │   → バッキングストアあり、完全に空                             │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  【内部キャッシュ】                                                      │
│   TCachedOSPageAllocator<256, 128MB> CachedOSPageAllocator              │
│    → 大きすぎる割り当てのフォールバック                               │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### PooledVirtualMemoryAllocator

```
┌─────────────────────────────────────────────────────────────────────────┐
│                   PooledVirtualMemoryAllocator                         │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【概要】                                                                │
│   ・MallocBinned2 用のプール化仮想メモリアロケータ                     │
│   ・64KBアライメント保証                                                │
│   ・VMA (Virtual Memory Area) 断片化防止                               │
│                                                                         │
│  【ファイル】HAL/Allocators/PooledVirtualMemoryAllocator.h              │
│                                                                         │
│  【実装定数 (Limits enum)】                                              │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │  NumAllocationSizeClasses = 64                                  │   │
│  │   → サイズクラス数                                             │   │
│  │                                                                 │   │
│  │  MaxAllocationSizeToPool = 64 * 64KB = 4MB                      │   │
│  │   → プール化する最大サイズ                                     │   │
│  │   → これを超えるとOS直接割り当て                               │   │
│  │                                                                 │   │
│  │  MaxOSAllocCacheSize = 64MB                                     │   │
│  │   → OS割り当てキャッシュ上限                                   │   │
│  │                                                                 │   │
│  │  MaxOSAllocsCached = 64                                         │   │
│  │   → キャッシュするOS割り当て数                                 │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  【バケット構造】                                                        │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │  サイズクラス = (Size >> 16) + ((Size & 0xFFFF) ? 1 : 0) - 1    │   │
│  │                                                                 │   │
│  │  例:                                                            │   │
│  │   64KB bucket (class 0):  65536バイト以下                       │   │
│  │   128KB bucket (class 1): 65537〜131072バイト                   │   │
│  │   192KB bucket (class 2): 131073〜196608バイト                  │   │
│  │   ...                                                           │   │
│  │   4MB bucket (class 63):  最大プールサイズ                      │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  【内部管理構造】                                                        │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │  PoolDescriptorBase:                                           │   │
│  │   ├─ Next: PoolDescriptorBase* (リンクリスト)                 │   │
│  │   └─ VMSizeDivVirtualSizeAlignment (VM予約サイズ/アライメント) │   │
│  │                                                                 │   │
│  │  ClassesListHeads[64]                                           │   │
│  │   → 各サイズクラスのプールリストヘッド                         │   │
│  │                                                                 │   │
│  │  ClassesLocks[64]                                               │   │
│  │   → サイズクラス別ロック（並行性向上）                         │   │
│  │                                                                 │   │
│  │  NextPoolSize[64]                                               │   │
│  │   → 次回プール作成時のサイズ（適応的）                         │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  【プール成長戦略】                                                      │
│   DecideOnTheNextPoolSize(SizeClass, bGrowing):                        │
│    ・bGrowing=true: プール枯渇時、次回サイズを増加                     │
│    ・bGrowing=false: プール削除時、次回サイズを縮小                    │
│    ・指数的または段階的にサイズ調整                                    │
│                                                                         │
│  【OS割り当てフォールバック】                                            │
│   TCachedOSPageAllocator<64, 64MB> OsAllocatorCache                    │
│    → MaxAllocationSizeToPool を超える割り当て用                       │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### PageCache

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           PageCache                                     │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【概要】                                                                │
│   ・ページレベルのコミット/デコミット追跡                               │
│   ・メモリ再利用効率の最適化                                            │
│   ・BitTree による高速ビット管理                                        │
│                                                                         │
│  【ファイル】HAL/PageCache.h                                            │
│                                                                         │
│  【PageCache クラス構造】                                                │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │  class PageCache {                                              │   │
│  │      uint64 CommitHits;           // ページ再利用成功回数      │   │
│  │      uint64 CommitMisses;         // 新規コミット必要回数      │   │
│  │      uint32 SweepPage;            // 現在のスイープ位置        │   │
│  │      uint32 CommittedPages;       // コミット済みページ数      │   │
│  │      uint32 DecommittedPages;     // デコミット済みページ数    │   │
│  │      uint32 PendingDecommittedPages; // デコミット保留ページ数│   │
│  │                                                                 │   │
│  │      BitTree CurrentlyCommitted;  // コミット状態追跡          │   │
│  │      BitTree NotPendingDecommit;  // デコミット保留でない      │   │
│  │  };                                                             │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  【ヒット率計算】                                                        │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │  float GetHitRate() {                                          │   │
│  │      return 100.0f * CommitHits /                              │   │
│  │             (CommitHits + CommitMisses + 1);                   │   │
│  │  }                                                             │   │
│  │                                                                 │   │
│  │  size_t GetFreeableMemory()  // 解放可能メモリサイズ           │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### BitTree

```
┌─────────────────────────────────────────────────────────────────────────┐
│                            BitTree                                      │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【概要】                                                                │
│   ・階層的ビットマップ構造                                              │
│   ・高速なビット割り当て/解放                                           │
│   ・PageCache 等で使用                                                  │
│                                                                         │
│  【BitTree クラス API】                                                  │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │  static size_t GetMemoryRequirements(uint32 NumPages)          │   │
│  │   └─ 必要メモリサイズを計算                                    │   │
│  │                                                                 │   │
│  │  uint32 AllocBit()                                             │   │
│  │   └─ 最初の空きビットを割り当てて返す                          │   │
│  │                                                                 │   │
│  │  void AllocBit(uint32 Index)                                   │   │
│  │   └─ 指定インデックスのビットを割り当て                        │   │
│  │                                                                 │   │
│  │  void FreeBit(uint32 Index)                                    │   │
│  │   └─ 指定インデックスのビットを解放                            │   │
│  │                                                                 │   │
│  │  uint32 NextAllocBit(uint32 StartIndex)                        │   │
│  │   └─ StartIndex以降で次の割り当て済みビットを検索              │   │
│  │                                                                 │   │
│  │  bool IsAllocated(uint32 Index)                                │   │
│  │   └─ 指定インデックスが割り当て済みか確認                      │   │
│  │                                                                 │   │
│  │  uint32 CountOnes(uint32 UpTo)                                 │   │
│  │   └─ UpTo までのセットビット数をカウント                       │   │
│  │                                                                 │   │
│  │  uint64 Slow_NextAllocBits(uint32 NumBits, uint64 StartIndex)  │   │
│  │   └─ NumBits個の連続ビットを検索（2のべき乗のみ）             │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### VirtualAllocatorStats

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      VirtualAllocatorStats                              │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【VirtualAllocator 統計構造体】                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │  struct VirtualAllocatorStats {                                │   │
│  │      size_t PageSize;              // ページサイズ             │   │
│  │      size_t MaximumAlignment;      // 最大アライメント         │   │
│  │      size_t VMSpaceTotal;          // VM総容量                 │   │
│  │      size_t VMSpaceConsumed;       // 消費済みVM               │   │
│  │      size_t VMSpaceConsumedPeak;   // 消費ピーク               │   │
│  │      size_t FreeListLinks;         // フリーリストリンク数     │   │
│  │                                                                 │   │
│  │      VirtualAllocatorStatsPerBlockSize BlockStats[64];         │   │
│  │  };                                                             │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  【VirtualAllocator 追加定数・メンバ】                                   │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │  MaximumAlignment             // アライメント保証              │   │
│  │  NextAlloc                    // 線形割り当てポインタ          │   │
│  │  SpaceConsumed                // ピーク消費量追跡              │   │
│  │                                                                 │   │
│  │  【巨大ブロック処理】                                           │   │
│  │   TotalSize の 50% 以上のブロックは:                           │   │
│  │    → 2のべき乗への切り上げをスキップ                          │   │
│  │    → メモリ効率を優先                                         │   │
│  │                                                                 │   │
│  │  【メタデータ遅延コミット】                                     │   │
│  │   PlatformMemory::PlatformVirtualMemoryBlock を使用            │   │
│  │    → メタデータ用メモリを必要時にのみコミット                 │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 7. GenericPlatformMemory プラットフォームメモリ基盤

### 概要

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    GenericPlatformMemory                               │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【概要】                                                                │
│   ・プラットフォーム固有メモリ操作の汎用インターフェース                 │
│   ・OOM（メモリ不足）ハンドリング                                        │
│   ・メモリ統計情報提供                                                   │
│   ・共有メモリ、仮想メモリブロック管理                                   │
│                                                                         │
│  【ファイル】GenericPlatform/GenericPlatformMemory.h                    │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### EMemoryCounterRegion enum

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      メモリカウンタ領域                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  enum EMemoryCounterRegion                                              │
│  {                                                                      │
│      MCR_Invalid,          // 0 - 非メモリ                              │
│      MCR_Physical,         // 1 - メインシステムメモリ                  │
│      MCR_GPU,              // 2 - GPU専用メモリ                         │
│      MCR_GPUSystem,        // 3 - GPU直接アクセス可能システムメモリ     │
│      MCR_TexturePool,      // 4 - 事前確保テクスチャプール              │
│      MCR_StreamingPool,    // 5 - ストリーミング用テクスチャプール容量  │
│      MCR_UsedStreamingPool,// 6 - ストリーミングプール使用量            │
│      MCR_GPUDefragPool,    // 7 - デフラグ可能GPUプール                 │
│      MCR_PhysicalLLM,      // 8 - CPU+GPU含む総物理メモリ（LLM用）      │
│      MCR_MAX               // 9 - 最大値                                │
│  };                                                                     │
│                                                                         │
│  用途: StatManagerが各領域の最大利用可能メモリを追跡                    │
│        配列サイズ = PlatformMemory::MCR_MAX                            │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### EMemoryAllocatorToUse enum

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      使用アロケータ選択                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  enum EMemoryAllocatorToUse                                             │
│  {                                                                      │
│      Ansi,      // デフォルトCアロケータ (malloc/free)                  │
│      Stomp,     // メモリ踏み潰し検出用                                 │
│      TBB,       // Intel Thread Building Blocks malloc                 │
│      Jemalloc,  // Linux/FreeBSD用 jemalloc                            │
│      Binned,    // 旧Binnedアロケータ                                   │
│      Binned2,   // 新Binnedアロケータ                                   │
│      Binned3,   // VMベースBinnedアロケータ（64bit専用）               │
│      Platform,  // プラットフォーム固有カスタムアロケータ               │
│      Mimalloc,  // Microsoft mimalloc                                  │
│      Libpas,    // Apple libpas                                        │
│  };                                                                     │
│                                                                         │
│  静的変数: AllocatorToUse (現在選択されているアロケータ)                │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### EPlatformMemorySizeBucket enum

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       メモリサイズバケット                                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  enum class EPlatformMemorySizeBucket                                   │
│  {                                                                      │
│      Largest,   // テクスチャLODでは未使用                              │
│      Larger,    // テクスチャLODでは未使用                              │
│      Default,   // デフォルト（cook出力の最大サイズ）                   │
│      Smaller,   // より小さいメモリデバイス用                           │
│      Smallest,  // 最小メモリデバイス用                                 │
│      Tiniest,   // 極小メモリデバイス用                                 │
│  };                                                                     │
│                                                                         │
│  用途: プラットフォーム依存のテクスチャLOD設定                          │
│        メモリ容量に基づく品質スケーリング                               │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### EMemcpyCachePolicy enum

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       Memcpyキャッシュポリシー                            │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  enum class EMemcpyCachePolicy : uint8                                  │
│  {                                                                      │
│      StoreCached,    // キャッシュ可視書き込み（デフォルト）            │
│                      // CPUがすぐにアクセスする場合に使用               │
│                                                                         │
│      StoreUncached,  // キャッシュバイパス書き込み                      │
│                      // 大きなコピーで汚染を避ける場合に使用            │
│  };                                                                     │
│                                                                         │
│  用途: ParallelMemcpy() のキャッシュ戦略指定                            │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### GenericPlatformMemoryConstants 構造体

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    プラットフォームメモリ定数                             │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  struct GenericPlatformMemoryConstants                                 │
│  {                                                                      │
│      uint64 TotalPhysical = 0;                                         │
│       → 実物理メモリ量（バイト）                                       │
│       → 32bitコードでも4GB超対応                                       │
│                                                                         │
│      uint64 TotalVirtual = 0;                                          │
│       → 仮想メモリ量（バイト）                                         │
│                                                                         │
│      SIZE_T PageSize = 0;                                              │
│       → 物理ページサイズ（バイト）                                     │
│       → PageProtect()、コミット、プロパティの粒度                      │
│                                                                         │
│      SIZE_T OsAllocationGranularity = 0;                               │
│       → OS割り当て粒度                                                 │
│       → 例: Windows VirtualAlloc = 64KB                                │
│                                                                         │
│      SIZE_T BinnedPageSize = 0;                                        │
│       → Binned2用ページサイズ（64KB以上）                              │
│       → BinnedAllocFromOS()はこのアライメントで返す                    │
│                                                                         │
│      SIZE_T BinnedAllocationGranularity = 0;                           │
│       → Binned割り当て粒度                                             │
│       → 0の場合はBinnedPageSizeを使用                                  │
│                                                                         │
│      uint64 AddressStart = 0;                                          │
│       → 利用可能仮想アドレス空間の開始                                 │
│                                                                         │
│      uint64 AddressLimit = 0xffffffff + 1;                             │
│       → BinnedAllocFromOS()が返すアドレス範囲推定                      │
│       → この範囲内はO(1)ルックアップ、外は遅い                         │
│                                                                         │
│      uint32 TotalPhysicalGB = 1;                                       │
│       → 概算物理RAM（GB単位）                                          │
│       → PCは実値、他プラットフォームは1                                │
│  };                                                                     │
│                                                                         │
│  typedef GenericPlatformMemoryConstants PlatformMemoryConstants;     │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### GenericPlatformMemoryStats 構造体

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     プラットフォームメモリ統計                            │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  struct GenericPlatformMemoryStats : public PlatformMemoryConstants  │
│  {                                                                      │
│      uint64 AvailablePhysical;    // 現在利用可能物理メモリ            │
│      uint64 AvailableVirtual;     // 現在利用可能仮想メモリ            │
│      uint64 UsedPhysical;         // プロセス使用物理メモリ            │
│      uint64 PeakUsedPhysical;     // ピーク物理メモリ使用量            │
│      uint64 UsedVirtual;          // プロセス使用仮想メモリ            │
│      uint64 PeakUsedVirtual;      // ピーク仮想メモリ使用量            │
│  };                                                                     │
│                                                                         │
│  【EMemoryPressureStatus enum】                                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │  enum class EMemoryPressureStatus : uint8                       │   │
│  │  {                                                              │   │
│  │      Unknown,   // 状態不明                                     │   │
│  │      Nominal,   // 正常                                         │   │
│  │      Warning,   // 警告                                         │   │
│  │      Critical,  // クリティカル（OOMリスク高）                  │   │
│  │  };                                                             │   │
│  │                                                                 │   │
│  │  用途: 利用可能メモリ推定に含まれない回収可能メモリや           │   │
│  │        スワップを考慮したメモリ圧力状態                         │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  【PlatformSpecificStat 構造体】                                        │
│   const TCHAR* Name;  // 統計名                                        │
│   uint64 Value;       // 値                                            │
│   → プラットフォーム固有統計をTArray<PlatformSpecificStat>で返却     │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### OOMハンドリング

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      OOM（メモリ不足）ハンドリング                        │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【OOM状態変数】                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │  static bool bIsOOM;                                            │   │
│  │   → OOM発生フラグ                                               │   │
│  │                                                                 │   │
│  │  static uint64 OOMAllocationSize;                               │   │
│  │   → OOMを引き起こした割り当てサイズ（0なら未設定）              │   │
│  │                                                                 │   │
│  │  static uint32 OOMAllocationAlignment;                          │   │
│  │   → OOMを引き起こした割り当てアライメント（0なら未設定）        │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  【バックアップメモリプール】                                             │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │  static void* BackupOOMMemoryPool;                              │   │
│  │   → OOM時に解放する事前割り当てバッファ                         │   │
│  │   → OOMハンドリングとクラッシュレポートに使用                   │   │
│  │                                                                 │   │
│  │  static uint32 BackupOOMMemoryPoolSize;                         │   │
│  │   → バックアッププールのサイズ（バイト）                        │   │
│  │                                                                 │   │
│  │  static uint32 GetBackMemoryPoolSize();                         │   │
│  │   → デフォルト: 0（プール作成なし）                             │   │
│  │   → プラットフォームがオーバーライドして設定                    │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  【OOMハンドラ】                                                          │
│   [[noreturn]] static void OnOutOfMemory(uint64 Size, uint32 Alignment);│
│    → OOM発生時に呼ばれる                                               │
│    → BackupOOMMemoryPoolを解放してクラッシュレポートのメモリを確保     │
│    → リターンしない（致命的エラー）                                    │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### SharedMemoryRegion 共有メモリ

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        共有メモリ領域                                     │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【ESharedMemoryAccess enum】                                            │
│   Read  = (1 << 1)  // 読み取りアクセス                                 │
│   Write = (1 << 2)  // 書き込みアクセス                                 │
│                                                                         │
│  【SharedMemoryRegion 構造体】                                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │  const TCHAR* GetName() const;   // 領域名                      │   │
│  │  void* GetAddress();             // プロセスアドレス空間先頭    │   │
│  │  SIZE_T GetSize() const;         // サイズ（バイト）            │   │
│  │                                                                 │   │
│  │  Limits:                                                        │   │
│  │   MaxSharedMemoryName = 128     // 名前最大長                   │   │
│  │                                                                 │   │
│  │  メンバ:                                                        │   │
│  │   TCHAR Name[128]    // 領域名                                  │   │
│  │   uint32 AccessMode  // アクセスモード                          │   │
│  │   void* Address      // バッファアドレス                        │   │
│  │   SIZE_T Size        // バッファサイズ                          │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  【API】                                                                  │
│   MapNamedSharedMemoryRegion(Name, bCreate, AccessMode, Size)           │
│    → 名前付き共有メモリを作成または開く                                │
│    → 名前にはスラッシュを含めない（クロスプラットフォーム）            │
│                                                                         │
│   UnmapNamedSharedMemoryRegion(MemoryRegion)                            │
│    → 共有メモリをアンマップ                                            │
│    → 失敗してもMemoryRegionは破棄される                                │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### BasicVirtualMemoryBlock クラス

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     基本仮想メモリブロック                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  class BasicVirtualMemoryBlock                                         │
│  {                                                                      │
│  protected:                                                             │
│      void* Ptr;                          // 仮想メモリポインタ          │
│      uint32 VMSizeDivVirtualSizeAlignment; // サイズ/アライメント      │
│                                                                         │
│  public:                                                                │
│      uint32 GetActualSizeInPages() const;                              │
│       → VMSizeDivVirtualSizeAlignment を返す                           │
│                                                                         │
│      void* GetVirtualPointer() const;                                  │
│       → Ptr を返す                                                     │
│  };                                                                     │
│                                                                         │
│  【プラットフォーム実装必須メソッド】                                     │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │  void Commit(size_t InOffset, size_t InSize);                   │   │
│  │   → 指定範囲をコミット（物理メモリ割り当て）                    │   │
│  │                                                                 │   │
│  │  void Decommit(size_t InOffset, size_t InSize);                 │   │
│  │   → 指定範囲をデコミット（物理メモリ解放）                      │   │
│  │                                                                 │   │
│  │  void FreeVirtual();                                            │   │
│  │   → 仮想メモリブロック全体を解放                                │   │
│  │                                                                 │   │
│  │  void CommitByPtr(void* InPtr, size_t InSize);                  │   │
│  │   → ポインタ指定でコミット                                      │   │
│  │                                                                 │   │
│  │  void DecommitByPtr(void* InPtr, size_t InSize);                │   │
│  │   → ポインタ指定でデコミット                                    │   │
│  │                                                                 │   │
│  │  size_t GetActualSize() const;                                  │   │
│  │   → 実サイズ = VMSizeDivVirtualSizeAlignment * Alignment        │   │
│  │                                                                 │   │
│  │  static PlatformVirtualMemoryBlock AllocateVirtual(            │   │
│  │      size_t Size, size_t InAlignment);                          │   │
│  │   → 未コミット仮想メモリを確保                                  │   │
│  │   → SizeはGetVirtualSizeAlignment()にアライン必須               │   │
│  │                                                                 │   │
│  │  static size_t GetCommitAlignment();                            │   │
│  │   → コミット粒度を返す                                          │   │
│  │                                                                 │   │
│  │  static size_t GetVirtualSizeAlignment();                       │   │
│  │   → 仮想メモリサイズアライメントを返す                          │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### Memcpy最適化関数群

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       メモリコピー最適化                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【標準メモリ操作】                                                       │
│   Memmove(Dest, Src, Count)  → オーバーラップ対応コピー                │
│   Memcmp(Buf1, Buf2, Count)  → 比較                                    │
│   Memset(Dest, Char, Count)  → 埋め尽くし                              │
│   Memzero(Dest, Count)       → ゼロ埋め                                │
│   Memcpy(Dest, Src, Count)   → 非オーバーラップコピー                  │
│                                                                         │
│  【最適化Memcpy】                                                         │
│   BigBlockMemcpy(Dest, Src, Count)                                     │
│    → 大ブロック用最適化（デフォルトはmemcpy）                          │
│                                                                         │
│   StreamingMemcpy(Dest, Src, Count)                                    │
│    → L2キャッシュ汚染回避（デフォルトはmemcpy）                        │
│                                                                         │
│   ParallelMemcpy(Dest, Src, Count, Policy)                             │
│    → マルチスレッド対応（デフォルトはmemcpy）                          │
│    → Policyでキャッシュ戦略を指定                                      │
│                                                                         │
│  【Memswap最適化】                                                        │
│   Memswap(Ptr1, Ptr2, Size)                                            │
│    → サイズ別最適化実装                                                │
│    → 0〜8, 16バイト: インライン                                        │
│    → それ以上: MemswapGreaterThan8()                                   │
│                                                                         │
│  【非アライメントアクセス】                                               │
│   template<T> T ReadUnaligned(const void* Ptr);                        │
│   template<T> void WriteUnaligned(void* Ptr, const T& Value);          │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### KernelAddressBit 定数

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     カーネルアドレスビット                                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  static constexpr uint32 KernelAddressBit:                             │
│                                                                         │
│   x86_64 / _M_X64:   63                                                │
│   aarch64 / _M_ARM64: 55                                               │
│                                                                         │
│  用途:                                                                  │
│   ・ユーザーモードアドレスで常にゼロのビット                           │
│   ・ARM PAC、Top-Byte Ignore、Intel LAM/5-Level Pagingでも未使用       │
│   ・ポインタタグ付けやアドレス検証に使用可能                           │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 大規模割り当てチェック

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     大規模割り当てチェック                                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【コンパイル時設定】                                                     │
│   #define UE_CHECK_LARGE_ALLOCATIONS 0  // デフォルト無効              │
│                                                                         │
│  【有効時の変数（UE::Memory::Private名前空間）】                          │
│   bool GEnableLargeAllocationChecks;                                   │
│   int32 GLargeAllocationThreshold;                                     │
│   AutoConsoleVariableRef CVarEnableLargeAllocationChecks;             │
│                                                                         │
│  用途:                                                                  │
│   ・大きすぎる割り当てを検出                                           │
│   ・デバッグビルドでのメモリ使用量調査                                 │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### Memory_Alloca マクロ

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       スタックアロケーション                              │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【マクロ】                                                               │
│   Memory_Alloca(Size)                                                 │
│    → スタックから16バイトアラインでSize確保                            │
│    → Size==0なら0を返す                                                │
│                                                                         │
│   Memory_Alloca_Aligned(Size, Alignment)                              │
│    → 指定アライメント対応版                                            │
│    → Alignment <= 16の場合は16バイトアライン                           │
│    → それ以上は指定アライメント                                        │
│                                                                         │
│  【プラットフォーム依存】                                                 │
│   PLATFORM_USES_MICROSOFT_LIBC_FUNCTIONS:                              │
│    → _alloca を使用                                                    │
│   その他:                                                               │
│    → alloca を使用                                                     │
│                                                                         │
│  注意: 関数ではなくマクロ必須（スタック領域の生存期間のため）           │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 8. アロケータ選択ガイド

### プラットフォーム別デフォルト

```
┌─────────────────────────────────────────────────────────────────────────┐
│                   プラットフォーム別デフォルトアロケータ                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  プラットフォーム        │ デフォルト      │ 代替候補                   │
│  ────────────────────────┼─────────────────┼───────────────────────── │
│  Windows 64bit          │ Mimalloc/Binned3│ TBB, Binned2             │
│  Windows 32bit          │ Binned2         │ Ansi                     │
│  Mac (Apple Silicon)    │ Mimalloc        │ Libpas, Binned2          │
│  Mac (Intel)            │ Mimalloc        │ TBB, Binned2             │
│  Linux 64bit            │ Mimalloc/Binned3│ Jemalloc, Binned2        │
│  iOS                    │ Binned2         │ Libpas                   │
│  Android                │ Binned2         │ Jemalloc                 │
│  コンソール             │ BinnedGPU/Binned2│ プラットフォーム固有     │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### コマンドライン選択

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      コマンドライン引数                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  引数                │ アロケータ        │ 用途                        │
│  ────────────────────┼───────────────────┼──────────────────────────── │
│  -ansimalloc        │ MallocAnsi       │ ベースライン、デバッグ      │
│  -binnedmalloc      │ MallocBinned     │ レガシー                    │
│  -binnedmalloc2     │ MallocBinned2    │ 汎用                        │
│  -binnedmalloc3     │ MallocBinned3    │ 64bitデスクトップ           │
│  -tbbmalloc         │ MallocTBB        │ 高並列ワークロード          │
│  -jemalloc          │ MallocJemalloc   │ Linux最適化                 │
│  -mimalloc          │ MallocMimalloc   │ 汎用高性能                  │
│  -stompmalloc       │ MallocStomp      │ バッファオーバーラン検出    │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 用途別推奨

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        用途別アロケータ推奨                              │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【開発/デバッグ】                                                       │
│   ・メモリバグ調査 → MallocStomp / MallocPoisonProxy                 │
│   ・リーク調査 → MallocLeakDetection                                  │
│   ・パフォーマンス分析 → MallocFrameProfiler                          │
│                                                                         │
│  【本番環境】                                                            │
│   ・デスクトップ → MallocMimalloc / MallocBinned3                    │
│   ・モバイル → MallocBinned2                                          │
│   ・サーバー → MallocJemalloc / MallocTBB                            │
│                                                                         │
│  【特殊要件】                                                            │
│   ・最小オーバーヘッド → MallocAnsi                                   │
│   ・GPU共有メモリ → MallocBinnedGPU                                   │
│   ・高並列 → MallocTBB                                                │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 次のパート

[第7部：Low Level Memory Tracker (LLM) 完全ガイド](Platform_Abstraction_Layer_Part7.md) に続く

---

*このドキュメントはUnreal Engine 5.7のソースコードに基づいています。*
