# Unreal Engine 5.7 プラットフォーム抽象化レイヤー (HAL) 完全解説

## 第2部：プリプロセッサシステムと型システム

---

## 目次

1. [プラットフォームマクロシステム](#1-プラットフォームマクロシステム)
2. [機能フラグマクロ](#2-機能フラグマクロ)
3. [コンパイラマクロ](#3-コンパイラマクロ)
4. [型システム](#4-型システム)
5. [関数呼び出し規約](#5-関数呼び出し規約)

---

## 1. プラットフォームマクロシステム

### マクロ定義のフロー

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    プラットフォームマクロ定義フロー                       │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【Step 1】UBTによるコンパイラフラグ設定                                 │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  Unreal Build Tool (UBT) がターゲットプラットフォームを検出        │ │
│  │  │                                                                │ │
│  │  ├─ Windows向けビルド時：                                         │ │
│  │  │   -DPLATFORM_WINDOWS=1                                        │ │
│  │  │   -DUBT_COMPILED_PLATFORM=Windows                             │ │
│  │  │                                                                │ │
│  │  ├─ Mac向けビルド時：                                             │ │
│  │  │   -DPLATFORM_MAC=1                                            │ │
│  │  │   -DPLATFORM_APPLE=1                                          │ │
│  │  │   -DPLATFORM_UNIX=1                                           │ │
│  │  │   -DUBT_COMPILED_PLATFORM=Mac                                 │ │
│  │  │                                                                │ │
│  │  └─ Linux向けビルド時：                                           │ │
│  │      -DPLATFORM_LINUX=1                                          │ │
│  │      -DPLATFORM_UNIX=1                                           │ │
│  │      -DUBT_COMPILED_PLATFORM=Linux                               │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                              │                                          │
│                              ▼                                          │
│  【Step 2】Platform.h でのデフォルト値設定                               │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  未定義のプラットフォームマクロを全て0に設定                        │ │
│  │                                                                   │ │
│  │  ┌─────────────────────────────────────────────────────────────┐ │ │
│  │  │  #if !defined(PLATFORM_WINDOWS)                             │ │ │
│  │  │      #define PLATFORM_WINDOWS 0                             │ │ │
│  │  │  #endif                                                     │ │ │
│  │  │  #if !defined(PLATFORM_MAC)                                 │ │ │
│  │  │      #define PLATFORM_MAC 0                                 │ │ │
│  │  │  #endif                                                     │ │ │
│  │  │  // ... 他の全プラットフォーム                               │ │ │
│  │  └─────────────────────────────────────────────────────────────┘ │ │
│  │                                                                   │ │
│  │  結果：ターゲットのみ1、他は全て0                                  │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                              │                                          │
│                              ▼                                          │
│  【Step 3】プラットフォーム固有ヘッダのインクルード                       │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  COMPILED_PLATFORM_HEADER(Platform.h) により                      │ │
│  │  プラットフォーム固有の設定をロード                                │ │
│  │                                                                   │ │
│  │  例：Windows の場合                                               │ │
│  │   → Windows/WindowsPlatform.h がインクルードされる                │ │
│  │   → PLATFORM_DESKTOP = 1                                         │ │
│  │   → PLATFORM_LITTLE_ENDIAN = 1                                   │ │
│  │   → その他Windows固有マクロが設定される                           │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                              │                                          │
│                              ▼                                          │
│  【Step 4】必須マクロの検証                                              │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  以下のマクロが未定義の場合、コンパイルエラー                       │ │
│  │                                                                   │ │
│  │  ┌─────────────────────────────────────────────────────────────┐ │ │
│  │  │  #ifndef PLATFORM_DESKTOP                                   │ │ │
│  │  │      #error "PLATFORM_DESKTOP must be defined"              │ │ │
│  │  │  #endif                                                     │ │ │
│  │  │  #ifndef PLATFORM_64BITS                                    │ │ │
│  │  │      #error "PLATFORM_64BITS must be defined"               │ │ │
│  │  │  #endif                                                     │ │ │
│  │  └─────────────────────────────────────────────────────────────┘ │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 各プラットフォームのマクロ設定状態

```
┌─────────────────────────────────────────────────────────────────────────┐
│                プラットフォーム別マクロ設定一覧                          │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  マクロ名                    Win  Mac  Linux  iOS  Android  Switch      │
│  ─────────────────────────────────────────────────────────────────────  │
│                                                                         │
│  【プラットフォーム識別】                                                │
│  PLATFORM_WINDOWS             1    0     0     0      0        0        │
│  PLATFORM_MAC                 0    1     0     0      0        0        │
│  PLATFORM_LINUX               0    0     1     0      0        0        │
│  PLATFORM_IOS                 0    0     0     1      0        0        │
│  PLATFORM_ANDROID             0    0     0     0      1        0        │
│  PLATFORM_SWITCH              0    0     0     0      0        1        │
│                                                                         │
│  【プラットフォームグループ】                                            │
│  PLATFORM_DESKTOP             1    1     1     0      0        0        │
│  PLATFORM_APPLE               0    1     0     1      0        0        │
│  PLATFORM_UNIX                0    1     1     1      1        0        │
│  PLATFORM_MICROSOFT           1    0     0     0      0        0        │
│                                                                         │
│  【アーキテクチャ】                                                      │
│  PLATFORM_64BITS              1    1     1     1      1        1        │
│  PLATFORM_LITTLE_ENDIAN       1    1     1     1      1        1        │
│  PLATFORM_CPU_X86_FAMILY      1   0/1    1     0      0        0        │
│  PLATFORM_CPU_ARM_FAMILY     0/1   1     0     1      1        1        │
│                                                                         │
│  【スレッドモデル】                                                      │
│  PLATFORM_USE_PTHREADS        0    1     1     1      1        ?        │
│                                                                         │
│  【ソケット】                                                            │
│  PLATFORM_HAS_BSD_SOCKETS     1    1     1     1      1        ?        │
│  PLATFORM_HAS_BSD_SOCKET_FEATURE_WINSOCKETS                             │
│                               1    0     0     0      0        0        │
│                                                                         │
│  ※ 0/1 = アーキテクチャにより変動                                       │
│  ※ ?   = プラットフォーム固有の設定                                     │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 2. 機能フラグマクロ

### 機能フラグの分類

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        機能フラグマクロ分類                              │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【メモリ関連】                                                          │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  PLATFORM_SUPPORTS_MIMALLOC ─────── mimalloc使用可能か            │ │
│  │  │                                                                │ │
│  │  ├─ Windows 64bit → 1                                            │ │
│  │  ├─ Mac          → 1                                             │ │
│  │  ├─ Linux 64bit  → 1                                             │ │
│  │  └─ その他       → 0                                             │ │
│  │                                                                   │ │
│  │  PLATFORM_SUPPORTS_TBB ──────────── Intel TBB使用可能か           │ │
│  │  │                                                                │ │
│  │  ├─ Windows → 1                                                  │ │
│  │  ├─ Mac     → 1                                                  │ │
│  │  └─ その他  → 0                                                  │ │
│  │                                                                   │ │
│  │  PLATFORM_SUPPORTS_JEMALLOC ─────── jemalloc使用可能か            │ │
│  │  │                                                                │ │
│  │  └─ Linux/FreeBSD → 1、その他 → 0                                │ │
│  │                                                                   │ │
│  │  PLATFORM_HAS_128BIT_ATOMICS ────── 128ビットアトミック対応        │ │
│  │  │                                                                │ │
│  │  ├─ Windows 64bit (Win8以降) → 1                                 │ │
│  │  └─ その他 → 0                                                   │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【SIMD/ベクトル命令】                                                   │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  PLATFORM_ENABLE_VECTORINTRINSICS ──── ベクトル命令有効           │ │
│  │  │                                                                │ │
│  │  ├─ x86/x64 → 1（SSE使用）                                       │ │
│  │  ├─ ARM64   → 1（NEON使用）                                      │ │
│  │  └─ その他  → 0                                                  │ │
│  │                                                                   │ │
│  │  PLATFORM_ENABLE_VECTORINTRINSICS_NEON ─ NEON命令有効            │ │
│  │  │                                                                │ │
│  │  └─ ARM/ARM64 → 1、x86 → 0                                      │ │
│  │                                                                   │ │
│  │  PLATFORM_ALWAYS_HAS_SSE4_1 ───────── SSE4.1常時利用可能          │ │
│  │  PLATFORM_ALWAYS_HAS_SSE4_2 ───────── SSE4.2常時利用可能          │ │
│  │  │                                                                │ │
│  │  └─ x86/x64 → 1（UE5.2以降必須）                                 │ │
│  │                                                                   │ │
│  │  PLATFORM_MAYBE_HAS_AVX ───────────── AVX使用可能（要ランタイム検出）│
│  │  PLATFORM_ALWAYS_HAS_AVX ──────────── AVX常時利用可能             │ │
│  │  PLATFORM_ALWAYS_HAS_AVX_2 ────────── AVX2常時利用可能            │ │
│  │  PLATFORM_ALWAYS_HAS_FMA3 ─────────── FMA3常時利用可能            │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【レンダリング機能】                                                    │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  PLATFORM_SUPPORTS_GEOMETRY_SHADERS ─ ジオメトリシェーダー対応    │ │
│  │  │                                                                │ │
│  │  └─ ほぼ全プラットフォーム → 1                                   │ │
│  │                                                                   │ │
│  │  PLATFORM_SUPPORTS_MESH_SHADERS ───── メッシュシェーダー対応      │ │
│  │  │                                                                │ │
│  │  ├─ Windows → 1                                                  │ │
│  │  ├─ Mac     → 1（Metal 3対応時）                                 │ │
│  │  ├─ Linux   → 1                                                  │ │
│  │  └─ その他  → 0                                                  │ │
│  │                                                                   │ │
│  │  PLATFORM_SUPPORTS_BINDLESS_RENDERING ─ バインドレスレンダリング  │ │
│  │  │                                                                │ │
│  │  ├─ Windows → 1                                                  │ │
│  │  ├─ Linux   → 1                                                  │ │
│  │  └─ その他  → 0                                                  │ │
│  │                                                                   │ │
│  │  PLATFORM_SUPPORTS_VARIABLE_RATE_SHADING ─ VRS対応               │ │
│  │  │                                                                │ │
│  │  └─ Windows → 1、その他 → 0                                     │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【ソケット/ネットワーク】                                               │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  PLATFORM_HAS_BSD_SOCKETS ─────────── BSDソケット使用可能         │ │
│  │  PLATFORM_HAS_BSD_IPV6_SOCKETS ────── IPv6対応                   │ │
│  │  PLATFORM_HAS_BSD_SOCKET_FEATURE_IOCTL ─ ioctl使用可能           │ │
│  │  PLATFORM_HAS_BSD_SOCKET_FEATURE_POLL ── poll使用可能            │ │
│  │  PLATFORM_HAS_BSD_SOCKET_FEATURE_SELECT ─ select使用可能         │ │
│  │  PLATFORM_HAS_BSD_SOCKET_FEATURE_WINSOCKETS ─ Winsock使用        │ │
│  │  PLATFORM_HAS_BSD_SOCKET_FEATURE_MSG_DONTWAIT ─ 非ブロッキング    │ │
│  │  PLATFORM_HAS_BSD_SOCKET_FEATURE_RECVMMSG ──── recvmmsg使用可能  │ │
│  │  PLATFORM_HAS_BSD_SOCKET_FEATURE_TIMESTAMP ─── タイムスタンプ    │ │
│  │  PLATFORM_HAS_BSD_SOCKET_FEATURE_CLOSE_ON_EXEC ─ CLOEXEC         │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### プラットフォーム別機能対応表

```
┌─────────────────────────────────────────────────────────────────────────┐
│                  主要機能フラグ対応表                                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│                               Win  Mac  Linux  iOS  Android             │
│  ─────────────────────────────────────────────────────────────────────  │
│                                                                         │
│  【メモリ】                                                              │
│  SUPPORTS_MIMALLOC             ●    ●     ●     ○      ○               │
│  SUPPORTS_TBB                  ●    ●     ○     ○      ○               │
│  SUPPORTS_JEMALLOC             ○    ○     ●     ○      ○               │
│  HAS_128BIT_ATOMICS            ●    ○     ○     ○      ○               │
│                                                                         │
│  【SIMD】                                                                │
│  ENABLE_VECTORINTRINSICS       ●    ●     ●     ●      ●               │
│  ALWAYS_HAS_SSE4_2             ●    △     ●     ○      ○               │
│  ENABLE_VECTORINTRINSICS_NEON  △    ●     △     ●      ●               │
│                                                                         │
│  【レンダリング】                                                        │
│  SUPPORTS_GEOMETRY_SHADERS     ●    ●     ●     ●      ●               │
│  SUPPORTS_MESH_SHADERS         ●    ●     ●     ○      ○               │
│  SUPPORTS_BINDLESS_RENDERING   ●    ○     ●     ○      ○               │
│  SUPPORTS_VARIABLE_RATE_SHADING●    ○     ○     ○      ○               │
│                                                                         │
│  【ソケット】                                                            │
│  HAS_BSD_SOCKETS               ●    ●     ●     ●      ●               │
│  HAS_BSD_IPV6_SOCKETS          ●    ●     ●     ●      ●               │
│  FEATURE_WINSOCKETS            ●    ○     ○     ○      ○               │
│  FEATURE_POLL                  ○    ●     ●     ●      ●               │
│  FEATURE_RECVMMSG              ○    ○     ●     ○      ○               │
│                                                                         │
│  【その他】                                                              │
│  SUPPORTS_STACK_SYMBOLS        ●    ●     ●     ●      ●               │
│  SUPPORTS_NAMED_PIPES          ●    ○     ○     ○      ○               │
│  SUPPORTS_BORDERLESS_WINDOW    ●    ●     ●     ○      ○               │
│  CAN_SUPPORT_EDITORONLY_DATA   ●    ●     ●     ○      ○               │
│                                                                         │
│  ● = 対応 (1)                                                           │
│  ○ = 非対応 (0)                                                         │
│  △ = アーキテクチャ依存                                                 │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 3. コンパイラマクロ

### コンパイラ検出

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       コンパイラ検出システム                             │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【コンパイラ識別マクロ】                                                │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  PLATFORM_COMPILER_CLANG ──────── Clangコンパイラ                 │ │
│  │  │                                                                │ │
│  │  │  検出方法: __clang__ が定義されているか                        │ │
│  │  │                                                                │ │
│  │  │  使用プラットフォーム:                                         │ │
│  │  │   ・Mac (Apple Clang)                                         │ │
│  │  │   ・iOS / tvOS / visionOS                                     │ │
│  │  │   ・Linux (通常)                                               │ │
│  │  │   ・Android (NDK Clang)                                       │ │
│  │  │   ・Windows (clang-cl使用時)                                  │ │
│  │  │                                                                │ │
│  │  PLATFORM_COMPILER_MSVC ───────── MSVCコンパイラ                  │ │
│  │  │                                                                │ │
│  │  │  検出方法: _MSC_VER が定義 かつ __clang__ が未定義             │ │
│  │  │                                                                │ │
│  │  │  使用プラットフォーム:                                         │ │
│  │  │   ・Windows (Visual Studio)                                   │ │
│  │  │   ・Xbox                                                      │ │
│  │  │                                                                │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【コンパイラ機能マクロ】                                                │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  PLATFORM_COMPILER_HAS_TCHAR_WMAIN                                │ │
│  │  │                                                                │ │
│  │  │  wmain関数（ワイド文字エントリポイント）サポート               │ │
│  │  │  Windows MSVC → 1、その他 → 0                                 │ │
│  │  │                                                                │ │
│  │  PLATFORM_COMPILER_DISTINGUISHES_INT_AND_LONG                     │ │
│  │  │                                                                │ │
│  │  │  intとlongを異なる型として扱うか                               │ │
│  │  │  Unix系 → 1（LP64）、Windows → 0（LLP64）                     │ │
│  │  │                                                                │ │
│  │  PLATFORM_COMPILER_HAS_GENERATED_COMPARISON_OPERATORS             │ │
│  │  │                                                                │ │
│  │  │  C++20 三方比較演算子の自動生成サポート                        │ │
│  │  │  __cplusplus >= 202002L → 1                                   │ │
│  │  │                                                                │ │
│  │  PLATFORM_COMPILER_SUPPORTS_BUILTIN_BITCAST                       │ │
│  │  │                                                                │ │
│  │  │  __builtin_bit_cast サポート                                  │ │
│  │  │                                                                │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### コンパイラとプラットフォームの関係

```
┌─────────────────────────────────────────────────────────────────────────┐
│               コンパイラ × プラットフォーム マトリクス                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│              ┌───────────────────────────────────────────────────────┐  │
│              │                    コンパイラ                         │  │
│              ├─────────────┬─────────────┬─────────────┬───────────┤  │
│              │    MSVC     │  Clang-CL   │ Apple Clang │ LLVM Clang│  │
│  ┌───────────┼─────────────┼─────────────┼─────────────┼───────────┤  │
│  │           │             │             │             │           │  │
│  │ Windows   │     ●       │     ●       │      -      │     -     │  │
│  │ x64       │  (標準)      │  (オプション)│             │           │  │
│  │           │             │             │             │           │  │
│  ├───────────┼─────────────┼─────────────┼─────────────┼───────────┤  │
│  │           │             │             │             │           │  │
│  │ Windows   │     -       │     ●       │      -      │     -     │  │
│  │ ARM64     │             │  (必須)      │             │           │  │
│  │           │             │             │             │           │  │
│  ├───────────┼─────────────┼─────────────┼─────────────┼───────────┤  │
│  │           │             │             │             │           │  │
│  │ macOS     │     -       │      -      │     ●       │     -     │  │
│  │           │             │             │   (必須)     │           │  │
│  │           │             │             │             │           │  │
│  ├───────────┼─────────────┼─────────────┼─────────────┼───────────┤  │
│  │           │             │             │             │           │  │
│  │ iOS/tvOS  │     -       │      -      │     ●       │     -     │  │
│  │ visionOS  │             │             │   (必須)     │           │  │
│  │           │             │             │             │           │  │
│  ├───────────┼─────────────┼─────────────┼─────────────┼───────────┤  │
│  │           │             │             │             │           │  │
│  │ Linux     │     -       │      -      │      -      │     ●     │  │
│  │           │             │             │             │  (標準)    │  │
│  │           │             │             │             │           │  │
│  ├───────────┼─────────────┼─────────────┼─────────────┼───────────┤  │
│  │           │             │             │             │           │  │
│  │ Android   │     -       │      -      │      -      │     ●     │  │
│  │           │             │             │             │ (NDK Clang)│  │
│  │           │             │             │             │           │  │
│  └───────────┴─────────────┴─────────────┴─────────────┴───────────┘  │
│                                                                         │
│  ● = サポート/使用                                                      │
│  - = 非対応/未使用                                                      │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 4. 型システム

### 型定義階層

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         型定義階層構造                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【第1層】汎用型定義                                                     │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  GenericPlatformTypes                                           │ │
│  │  ─────────────────────────────────────────────────                │ │
│  │                                                                   │ │
│  │  【符号なし整数】                                                  │ │
│  │   uint8  ───── 8ビット符号なし（0〜255）                          │ │
│  │   uint16 ───── 16ビット符号なし（0〜65535）                       │ │
│  │   uint32 ───── 32ビット符号なし（0〜約43億）                      │ │
│  │   uint64 ───── 64ビット符号なし（0〜約1844京）                    │ │
│  │                                                                   │ │
│  │  【符号あり整数】                                                  │ │
│  │   int8   ───── 8ビット符号あり（-128〜127）                       │ │
│  │   int16  ───── 16ビット符号あり（-32768〜32767）                  │ │
│  │   int32  ───── 32ビット符号あり（約-21億〜約21億）                │ │
│  │   int64  ───── 64ビット符号あり（約-922京〜約922京）              │ │
│  │                                                                   │ │
│  │  【文字型】                                                        │ │
│  │   ANSICHAR ─── 8ビット ANSI文字                                  │ │
│  │   WIDECHAR ─── ワイド文字（16または32ビット、プラットフォーム依存）│ │
│  │   UTF8CHAR ─── 8ビット UTF-8文字（char8_t）                      │ │
│  │   CHAR16 ──── 16ビット文字                                       │ │
│  │   UTF32CHAR ── 32ビット UTF-32文字（char32_t）                   │ │
│  │   TCHAR ───── テキスト文字（WIDECHARまたはUTF8CHAR）              │ │
│  │                                                                   │ │
│  │  【ポインタサイズ整数】                                            │ │
│  │   UPTRINT ─── 符号なしポインタサイズ整数                          │ │
│  │   PTRINT ──── 符号ありポインタサイズ整数                          │ │
│  │   SIZE_T ──── サイズ型（UPTRINT同等）                            │ │
│  │   SSIZE_T ─── 符号ありサイズ型（PTRINT同等）                     │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                              │                                          │
│                              ▼                                          │
│  【第2層】プラットフォーム固有型                                         │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  WindowsPlatformTypes (Windows)                                  │ │
│  │  ─────────────────────────────────                                │ │
│  │   ・SIZE_T → unsigned __int64（64bit時）                         │ │
│  │   ・SSIZE_T → __int64（64bit時）                                 │ │
│  │   ・TCHAR → WIDECHAR（デフォルト）またはUTF8CHAR                  │ │
│  │                                                                   │ │
│  │  UnixPlatformTypes (Linux/Mac/iOS/Android)                       │ │
│  │  ─────────────────────────────────                                │ │
│  │   ・WIDECHAR → char16_t（16ビット固定）                          │ │
│  │   ・SIZE_T → __SIZE_TYPE__                                       │ │
│  │   ・TYPE_OF_NULL → decltype(__null)                              │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                              │                                          │
│                              ▼                                          │
│  【第3層】グローバルエクスポート                                         │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  typedef PlatformTypes::uint8  uint8;                           │ │
│  │  typedef PlatformTypes::uint16 uint16;                          │ │
│  │  typedef PlatformTypes::uint32 uint32;                          │ │
│  │  typedef PlatformTypes::uint64 uint64;                          │ │
│  │  // ... 他の型も同様                                              │ │
│  │                                                                   │ │
│  │  → ユーザーコードは単に uint32, TCHAR 等を使用可能                │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 型サイズ比較表

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    型サイズ比較（バイト単位）                            │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│              Windows (LLP64)    Unix系 (LP64)                           │
│              ───────────────    ─────────────                           │
│                                                                         │
│  【基本整数型】                                                          │
│  ┌─────────────┬────────────────┬────────────────┐                      │
│  │ 型          │ Windows        │ Unix系         │                      │
│  ├─────────────┼────────────────┼────────────────┤                      │
│  │ uint8/int8  │      1         │      1         │                      │
│  │ uint16/int16│      2         │      2         │                      │
│  │ uint32/int32│      4         │      4         │                      │
│  │ uint64/int64│      8         │      8         │                      │
│  └─────────────┴────────────────┴────────────────┘                      │
│                                                                         │
│  【ポインタとサイズ型】                                                  │
│  ┌─────────────┬────────────────┬────────────────┐                      │
│  │ 型          │ Windows 64bit  │ Unix 64bit     │                      │
│  ├─────────────┼────────────────┼────────────────┤                      │
│  │ void*       │      8         │      8         │                      │
│  │ SIZE_T      │      8         │      8         │                      │
│  │ PTRINT      │      8         │      8         │                      │
│  │ long        │      4 ←違い   │      8 ←違い   │                      │
│  └─────────────┴────────────────┴────────────────┘                      │
│                                                                         │
│  【文字型】                                                              │
│  ┌─────────────┬────────────────┬────────────────┐                      │
│  │ 型          │ Windows        │ Unix系         │                      │
│  ├─────────────┼────────────────┼────────────────┤                      │
│  │ ANSICHAR    │      1         │      1         │                      │
│  │ UTF8CHAR    │      1         │      1         │                      │
│  │ WIDECHAR    │   2 (wchar_t)  │   2 (char16_t) │                      │
│  │ wchar_t     │      2         │      4 ←違い   │                      │
│  │ TCHAR       │      2         │      2         │                      │
│  └─────────────┴────────────────┴────────────────┘                      │
│                                                                         │
│  【重要な違い】                                                          │
│   ・Windows: wchar_t = 2バイト (UTF-16)                                 │
│   ・Unix系: wchar_t = 4バイト (UTF-32)                                  │
│   ・UEはWIDECHARを統一的に16ビットとして扱う                             │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### TCHAR の挙動

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        TCHAR 文字型システム                              │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【TCHARとは】                                                           │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  TCHAR = "Text Character"                                        │ │
│  │                                                                   │ │
│  │  テキスト処理用の文字型で、ビルド設定により                        │ │
│  │  WIDECHARまたはUTF8CHARのいずれかになる                           │ │
│  │                                                                   │ │
│  │  ┌───────────────────────────────────────────┐                   │ │
│  │  │  TEXT("Hello") マクロ                     │                   │ │
│  │  │                                           │                   │ │
│  │  │  ・TCHAR = WIDECHAR の場合:               │                   │ │
│  │  │    L"Hello" (ワイド文字列) に展開         │                   │ │
│  │  │                                           │                   │ │
│  │  │  ・TCHAR = UTF8CHAR の場合:               │                   │ │
│  │  │    u8"Hello" (UTF-8文字列) に展開         │                   │ │
│  │  └───────────────────────────────────────────┘                   │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【プラットフォーム別デフォルト】                                        │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  プラットフォーム     TCHAR        サイズ     エンコーディング     │ │
│  │  ─────────────────────────────────────────────────────────────── │ │
│  │  Windows             WIDECHAR      2バイト    UTF-16             │ │
│  │  macOS               WIDECHAR      2バイト    UTF-16             │ │
│  │  Linux               WIDECHAR*     2バイト    UTF-16             │ │
│  │  iOS                 WIDECHAR      2バイト    UTF-16             │ │
│  │  Android             WIDECHAR      2バイト    UTF-16             │ │
│  │                                                                   │ │
│  │  * Linux の wchar_t は4バイトだが、WIDECHAR は char16_t で       │ │
│  │    2バイトに統一されている                                        │ │
│  │                                                                   │ │
│  │  【UTF-8モード】                                                   │ │
│  │  USE_UTF8_TCHARS = 1 の場合:                                      │ │
│  │   ・TCHAR = UTF8CHAR (1バイト)                                   │ │
│  │   ・TEXT("...") = u8"..." (UTF-8)                                │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【関連マクロ】                                                          │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  PLATFORM_TCHAR_IS_4_BYTES                                       │ │
│  │  │                                                                │ │
│  │  └─ TCHARが4バイトか（通常は0）                                   │ │
│  │                                                                   │ │
│  │  PLATFORM_TCHAR_IS_UTF8CHAR                                       │ │
│  │  │                                                                │ │
│  │  └─ TCHARがUTF8CHARか（USE_UTF8_TCHARS依存）                     │ │
│  │                                                                   │ │
│  │  PLATFORM_TCHAR_IS_CHAR16                                        │ │
│  │  │                                                                │ │
│  │  └─ WIDECHARがchar16_tか（Unix系で1）                            │ │
│  │                                                                   │ │
│  │  PLATFORM_WCHAR_IS_4_BYTES                                       │ │
│  │  │                                                                │ │
│  │  └─ wchar_tが4バイトか（Unix系で1、Windowsで0）                  │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 5. 関数呼び出し規約

### 呼び出し規約マクロ

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       関数呼び出し規約                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【主要マクロ】                                                          │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  VARARGS ─────────── 可変引数関数                                 │ │
│  │  │                                                                │ │
│  │  │  Windows: __cdecl                                             │ │
│  │  │  Unix系:  (なし - デフォルト)                                  │ │
│  │  │                                                                │ │
│  │  CDECL ───────────── 標準C呼び出し規約                            │ │
│  │  │                                                                │ │
│  │  │  Windows: __cdecl                                             │ │
│  │  │  Unix系:  (なし)                                               │ │
│  │  │                                                                │ │
│  │  STDCALL ─────────── Windows標準呼び出し規約                      │ │
│  │  │                                                                │ │
│  │  │  Windows: __stdcall                                           │ │
│  │  │  Unix系:  (なし)                                               │ │
│  │  │                                                                │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【インライン制御】                                                      │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  FORCEINLINE ─────── 強制インライン                               │ │
│  │  │                                                                │ │
│  │  │  Windows: __forceinline                                       │ │
│  │  │  Clang:   inline __attribute__((always_inline))               │ │
│  │  │  Debug:   inline（デバッグビルドでは緩和）                      │ │
│  │  │                                                                │ │
│  │  FORCENOINLINE ───── 強制非インライン                             │ │
│  │  │                                                                │ │
│  │  │  Windows: __declspec(noinline)                                │ │
│  │  │  Clang:   __attribute__((noinline))                           │ │
│  │  │                                                                │ │
│  │  UE_FORCEINLINE_HINT ─ 条件付き強制インライン                     │ │
│  │  │                                                                │ │
│  │  │  PGO使用時: inline（コンパイラ判断に委ねる）                   │ │
│  │  │  通常時:    FORCEINLINE                                       │ │
│  │  │                                                                │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【その他の属性】                                                        │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  RESTRICT ────────── エイリアス無しヒント                         │ │
│  │  │                                                                │ │
│  │  │  __restrict（ポインタが他と重ならないことを示す）              │ │
│  │  │                                                                │ │
│  │  UE_COLD ─────────── コールドパス指定                             │ │
│  │  │                                                                │ │
│  │  │  MSVC:  __declspec(noinline)                                  │ │
│  │  │  Clang: __attribute__((cold))                                 │ │
│  │  │  使用法: エラーハンドラ等、稀にしか呼ばれない関数に付与        │ │
│  │  │                                                                │ │
│  │  UE_NODISCARD ────── 戻り値無視警告                               │ │
│  │  │                                                                │ │
│  │  │  [[nodiscard]] 属性                                           │ │
│  │  │                                                                │ │
│  │  UE_NO_UNIQUE_ADDRESS ─ 空基底最適化                              │ │
│  │  │                                                                │ │
│  │  │  [[no_unique_address]] または [[msvc::no_unique_address]]     │ │
│  │  │                                                                │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### DLLエクスポート/インポート

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    DLLエクスポート/インポート                            │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【基本マクロ】                                                          │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  DLLEXPORT ───────── シンボルのエクスポート                        │ │
│  │  │                                                                │ │
│  │  │  Windows: __declspec(dllexport)                               │ │
│  │  │  Unix系:  __attribute__((visibility("default")))              │ │
│  │  │                                                                │ │
│  │  DLLIMPORT ───────── シンボルのインポート                          │ │
│  │  │                                                                │ │
│  │  │  Windows: __declspec(dllimport)                               │ │
│  │  │  Unix系:  __attribute__((visibility("default")))              │ │
│  │  │                                                                │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【モジュールAPIマクロ】                                                 │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  各モジュールは XXX_API マクロを定義                              │ │
│  │                                                                   │ │
│  │  例: CORE_API                                                    │ │
│  │                                                                   │ │
│  │  ┌─────────────────────────────────────────────────────────────┐ │ │
│  │  │                                                             │ │ │
│  │  │  モジュールをビルド中（DLL作成側）:                          │ │ │
│  │  │    CORE_API = DLLEXPORT                                     │ │ │
│  │  │                                                             │ │ │
│  │  │  モジュールを使用中（DLL利用側）:                            │ │ │
│  │  │    CORE_API = DLLIMPORT                                     │ │ │
│  │  │                                                             │ │ │
│  │  │  モノリシックビルド:                                         │ │ │
│  │  │    CORE_API = （空）                                        │ │ │
│  │  │                                                             │ │ │
│  │  └─────────────────────────────────────────────────────────────┘ │ │
│  │                                                                   │ │
│  │  使用例:                                                          │ │
│  │   CORE_API void PlatformMemory::Init();                         │ │
│  │   CORE_API Malloc* PlatformMemory::BaseAllocator();            │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 次のパート

[第3部：HALコンポーネント詳細](Platform_Abstraction_Layer_Part3.md) に続く

---

*このドキュメントはUnreal Engine 5.7のソースコードに基づいています。*
