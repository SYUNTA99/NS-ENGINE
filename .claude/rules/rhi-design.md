# RHI（Render Hardware Interface）設計原則

グラフィックスAPI（DirectX 12、Vulkan等）の抽象化レイヤー。

---



---

## 設計原則

 1. 基本設計哲学                                                                                                
  
  - 最小公約数ではなく最大公倍数 - 全プラットフォームの機能を統合
  - ゼロコスト抽象化 - vtable回避、CRTP使用
  - 明示的制御優先 - 暗黙の動作を排除

  2. リソース管理原則

  - 参照カウント - TRefCountPtrによる自動管理
  - 遅延削除 - GPU使用完了まで削除を遅延
  - Transientリソース - メモリエイリアシングによる最適化

  3. コマンドパターン

  - 遅延実行モデル - 記録と実行の分離
  - リニアアロケータ - 高速なコマンドメモリ確保
  - Bypassパターン - 即時実行が必要な場合の対応

  4. スレッディングモデル

  - スレッド分離 - Game/Render/RHIスレッドの明確な分離
  - 並列コマンドリスト - 複数リストの並列記録
  - パイプライン並列性 - Graphics/AsyncComputeの並列実行

  5. 状態管理原則

  - 明示的状態追跡 - 自動遷移を行わない
  - 不変状態の焼き付け - PSOへの状態統合
  - バインドレスモデル - ディスクリプタインデックス参照

  6. 同期プリミティブ

  - フェンス階層 - フレーム/パイプライン/コマンドリスト/メモリバリア
  - バリアバッチング - 複数バリアの統合
  - スプリットバリア - 開始/終了の分離

  7. エラー処理原則

  - フェイルファスト - 早期検出とクラッシュ
  - 検証レイヤー - デバッグ時の詳細検証
  - GPUクラッシュ診断 - Breadcrumbによる原因特定

  8. 拡張性原則

  - プラットフォーム拡張ポイント - RHISupportsExtension
  - 機能フラグ - コンパイル時/実行時の条件分岐

  9. パフォーマンス原則

  - CPUオーバーヘッド最小化 - API呼び出し削減
  - GPUアイドル排除 - パイプライン化
  - メモリ帯域幅最適化 - キャッシュフレンドリーなレイアウト

---

## 禁止事項

| 禁止 | 理由 | 代替 |
|------|------|------|
| Public APIでのD3D12/Vulkan型 | 移植性喪失 | 抽象インターフェース |
| 生ポインタでのリソース所有 | リーク | スマートポインタ、RAII |
| 暗黙の状態変更 | デバッグ困難 | 明示的API |
| 例外 | パフォーマンス | `NS::Result` |
| グローバルデバイス | テスト困難 | 依存性注入 |
