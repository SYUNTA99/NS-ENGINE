# HAL（Hardware Abstraction Layer）設計原則

ハードウェア・OS固有機能の抽象化レイヤー。

---

## 設計原則

抽象化

ハードウェア固有の詳細を隠蔽
統一インターフェースで異なるデバイスを操作
上位層はレジスタやアドレスを意識しない

移植性

プラットフォーム依存コードを局所化
条件分岐よりコンパイル時切り替え
ボード固有設定は設定ファイル/構造体で分離

初期化と構成

宣言的な設定（レジスタ直接操作を避ける）
初期化順序の明確化
依存関係の明示（クロック→ペリフェラル等）

リソースアクセス

排他制御の提供（mutex/セマフォ）
DMAと割り込みの抽象化
メモリマップドI/Oの安全なラップ

エラー処理

統一されたエラーコード体系
タイムアウト処理の標準化
Fail-fast（不正操作は即エラー）

省電力

スリープ/ウェイクの統一API
クロックゲーティング対応
電力状態の明示的管理

テスト容易性

モック差し替え可能な設計
ハードウェア無しでの単体テスト対応
ログ/トレース機構

拡張性

新デバイス追加が既存コードに影響しない
コールバック/フックポイントの提供
バージョニング対応


### 5. Resultベースエラー処理

OS APIのエラーを`NS::Result`に変換。


## 禁止事項

| 禁止 | 理由 | 代替 |
|------|------|------|
| Public APIでのOS固有型 | 移植性喪失 | 抽象インターフェース |
| 生ポインタでのリソース所有 | リーク | RAII、スマートポインタ |
| 例外 | パフォーマンス | `NS::Result` |
| グローバル状態 | テスト困難 | 依存性注入 |
| プリプロセッサでのプラットフォーム分岐（Public） | 可読性低下 | 実装ファイルで分離 |

---

