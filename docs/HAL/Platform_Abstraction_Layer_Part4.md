# Unreal Engine 5.7 プラットフォーム抽象化レイヤー (HAL) 完全解説

## 第4部：ビルドシステムと新規プラットフォーム追加

---

## 目次

1. [ビルドシステム概要](#1-ビルドシステム概要)
2. [モジュールビルドルール](#2-モジュールビルドルール)
3. [プラットフォームグループ](#3-プラットフォームグループ)
4. [新規プラットフォーム追加手順](#4-新規プラットフォーム追加手順)
5. [実装チェックリスト](#5-実装チェックリスト)
6. [ベストプラクティス](#6-ベストプラクティス)

---

## 1. ビルドシステム概要

### UBT（Unreal Build Tool）の役割

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    Unreal Build Tool (UBT) の役割                       │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【ビルドフロー】                                                        │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  ソースコード                                                     │ │
│  │  (.cpp, .h, .Build.cs)                                           │ │
│  │         │                                                         │ │
│  │         ▼                                                         │ │
│  │  ┌─────────────────────────────────────────────────────────────┐ │ │
│  │  │                                                             │ │ │
│  │  │                 Unreal Build Tool (UBT)                     │ │ │
│  │  │                                                             │ │ │
│  │  │  ┌─────────────────────────────────────────────────────┐   │ │ │
│  │  │  │  1. ターゲット解析                                   │   │ │ │
│  │  │  │     ・プラットフォーム検出                           │   │ │ │
│  │  │  │     ・コンフィグレーション決定                        │   │ │ │
│  │  │  │     ・アーキテクチャ特定                             │   │ │ │
│  │  │  └─────────────────────────────────────────────────────┘   │ │ │
│  │  │                         │                                   │ │ │
│  │  │                         ▼                                   │ │ │
│  │  │  ┌─────────────────────────────────────────────────────┐   │ │ │
│  │  │  │  2. モジュール解析                                   │   │ │ │
│  │  │  │     ・Build.cs ファイルの実行                        │   │ │ │
│  │  │  │     ・依存関係グラフ構築                             │   │ │ │
│  │  │  │     ・プラットフォーム固有設定適用                    │   │ │ │
│  │  │  └─────────────────────────────────────────────────────┘   │ │ │
│  │  │                         │                                   │ │ │
│  │  │                         ▼                                   │ │ │
│  │  │  ┌─────────────────────────────────────────────────────┐   │ │ │
│  │  │  │  3. コンパイラ設定生成                               │   │ │ │
│  │  │  │     ・プリプロセッサマクロ定義                        │   │ │ │
│  │  │  │       -DPLATFORM_WINDOWS=1                          │   │ │ │
│  │  │  │       -DUBT_COMPILED_PLATFORM=Windows               │   │ │ │
│  │  │  │     ・インクルードパス設定                           │   │ │ │
│  │  │  │     ・ライブラリリンク設定                           │   │ │ │
│  │  │  └─────────────────────────────────────────────────────┘   │ │ │
│  │  │                         │                                   │ │ │
│  │  │                         ▼                                   │ │ │
│  │  │  ┌─────────────────────────────────────────────────────┐   │ │ │
│  │  │  │  4. コンパイル/リンク実行                            │   │ │ │
│  │  │  │     ・並列ビルド管理                                 │   │ │ │
│  │  │  │     ・インクリメンタルビルド                          │   │ │ │
│  │  │  └─────────────────────────────────────────────────────┘   │ │ │
│  │  │                                                             │ │ │
│  │  └─────────────────────────────────────────────────────────────┘ │ │
│  │         │                                                         │ │
│  │         ▼                                                         │ │
│  │  実行ファイル / DLL                                               │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### プラットフォームマクロの設定タイミング

```
┌─────────────────────────────────────────────────────────────────────────┐
│                  プラットフォームマクロ設定フロー                        │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【UBTによる設定】                                                       │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  コマンドライン例:                                                 │ │
│  │   RunUBT.bat MyGame Win64 Development                            │ │
│  │                 │     │      │                                    │ │
│  │                 │     │      └── Configuration                   │ │
│  │                 │     └── Platform ────────────────────────────┐ │ │
│  │                 └── Project                                    │ │ │
│  │                                                                │ │ │
│  │                                                                │ │ │
│  │                         ▼                                      │ │ │
│  │  ┌─────────────────────────────────────────────────────────┐  │ │ │
│  │  │  UBT がプラットフォームを解析                            │  │ │ │
│  │  │                                                         │  │ │ │
│  │  │  Win64 → Windows 64bit                                  │  │ │ │
│  │  │   ・PLATFORM_WINDOWS = 1                                │  │ │ │
│  │  │   ・PLATFORM_64BITS = 1                                 │  │ │ │
│  │  │   ・PLATFORM_DESKTOP = 1                                │  │ │ │
│  │  │   ・UBT_COMPILED_PLATFORM = Windows                     │  │ │ │
│  │  │                                                         │  │ │ │
│  │  │  Mac → macOS                                            │  │ │ │
│  │  │   ・PLATFORM_MAC = 1                                    │  │ │ │
│  │  │   ・PLATFORM_APPLE = 1                                  │  │ │ │
│  │  │   ・PLATFORM_UNIX = 1                                   │  │ │ │
│  │  │   ・PLATFORM_DESKTOP = 1                                │  │ │ │
│  │  │   ・UBT_COMPILED_PLATFORM = Mac                         │  │ │ │
│  │  │                                                         │  │ │ │
│  │  │  Linux → Linux x64                                      │  │ │ │
│  │  │   ・PLATFORM_LINUX = 1                                  │  │ │ │
│  │  │   ・PLATFORM_UNIX = 1                                   │  │ │ │
│  │  │   ・PLATFORM_DESKTOP = 1                                │  │ │ │
│  │  │   ・UBT_COMPILED_PLATFORM = Linux                       │  │ │ │
│  │  │                                                         │  │ │ │
│  │  └─────────────────────────────────────────────────────────┘  │ │ │
│  │                                                                │ │ │
│  └────────────────────────────────────────────────────────────────┘ │ │
│                                                                       │ │
│  ※ これらのマクロはコンパイラの -D オプションとして渡される             │ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 2. モジュールビルドルール

### Build.cs の構造

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       Build.cs ファイル構造                              │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【基本構造】                                                            │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  ModuleRules クラス継承                                           │ │
│  │  │                                                                │ │
│  │  │  ┌─────────────────────────────────────────────────────────┐ │ │
│  │  │  │  public class Core : ModuleRules                        │ │ │
│  │  │  │  {                                                      │ │ │
│  │  │  │      public Core(ReadOnlyTargetRules Target)            │ │ │
│  │  │  │          : base(Target)                                 │ │ │
│  │  │  │      {                                                  │ │ │
│  │  │  │          // モジュール設定                               │ │ │
│  │  │  │      }                                                  │ │ │
│  │  │  │  }                                                      │ │ │
│  │  │  └─────────────────────────────────────────────────────────┘ │ │
│  │  │                                                                │ │
│  └──┴────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【主要プロパティ】                                                      │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  【依存関係】                                                      │ │
│  │   PublicDependencyModuleNames ──── 公開依存モジュール             │ │
│  │   PrivateDependencyModuleNames ─── 非公開依存モジュール           │ │
│  │   PublicIncludePathModuleNames ─── インクルードパスのみ必要       │ │
│  │   PrivateIncludePathModuleNames ── 同上（Private）                │ │
│  │   DynamicallyLoadedModuleNames ─── 動的ロードモジュール           │ │
│  │                                                                   │ │
│  │  【定義】                                                          │ │
│  │   PublicDefinitions ────────────── 公開プリプロセッサ定義         │ │
│  │   PrivateDefinitions ───────────── 非公開プリプロセッサ定義       │ │
│  │                                                                   │ │
│  │  【インクルードパス】                                              │ │
│  │   PublicIncludePaths ───────────── 公開インクルードパス           │ │
│  │   PrivateIncludePaths ──────────── 非公開インクルードパス         │ │
│  │                                                                   │ │
│  │  【ライブラリ】                                                    │ │
│  │   PublicSystemLibraries ────────── システムライブラリ             │ │
│  │   PublicAdditionalLibraries ────── 追加ライブラリ                 │ │
│  │   PublicFrameworks ─────────────── フレームワーク（Apple）        │ │
│  │   PublicDelayLoadDLLs ──────────── 遅延ロードDLL（Windows）       │ │
│  │                                                                   │ │
│  │  【サードパーティ】                                                │ │
│  │   AddEngineThirdPartyPrivateStaticDependencies ── 静的リンク     │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### プラットフォーム条件分岐

```
┌─────────────────────────────────────────────────────────────────────────┐
│                  Build.cs でのプラットフォーム分岐                       │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【Target.Platform による分岐】                                          │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  個別プラットフォーム判定:                                         │ │
│  │                                                                   │ │
│  │   if (Target.Platform == UnrealTargetPlatform.Win64)             │ │
│  │   {                                                               │ │
│  │       // Windows 64bit 固有設定                                   │ │
│  │   }                                                               │ │
│  │                                                                   │ │
│  │   if (Target.Platform == UnrealTargetPlatform.Mac)               │ │
│  │   {                                                               │ │
│  │       // macOS 固有設定                                           │ │
│  │   }                                                               │ │
│  │                                                                   │ │
│  │   if (Target.Platform == UnrealTargetPlatform.Linux)             │ │
│  │   {                                                               │ │
│  │       // Linux 固有設定                                           │ │
│  │   }                                                               │ │
│  │                                                                   │ │
│  │   if (Target.Platform == UnrealTargetPlatform.IOS)               │ │
│  │   {                                                               │ │
│  │       // iOS 固有設定                                             │ │
│  │   }                                                               │ │
│  │                                                                   │ │
│  │   if (Target.Platform == UnrealTargetPlatform.Android)           │ │
│  │   {                                                               │ │
│  │       // Android 固有設定                                         │ │
│  │   }                                                               │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【プラットフォームグループによる分岐】                                   │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  グループ判定（推奨）:                                             │ │
│  │                                                                   │ │
│  │   if (Target.Platform.IsInGroup(UnrealPlatformGroup.Windows))    │ │
│  │   {                                                               │ │
│  │       // Windows系（Win64, WinArm64等）全体の設定                 │ │
│  │   }                                                               │ │
│  │                                                                   │ │
│  │   if (Target.Platform.IsInGroup(UnrealPlatformGroup.Desktop))    │ │
│  │   {                                                               │ │
│  │       // デスクトップ（Windows, Mac, Linux）共通設定              │ │
│  │   }                                                               │ │
│  │                                                                   │ │
│  │   if (Target.IsInPlatformGroup(UnrealPlatformGroup.Unix))        │ │
│  │   {                                                               │ │
│  │       // Unix系（Mac, Linux, iOS, Android）共通設定               │ │
│  │   }                                                               │ │
│  │                                                                   │ │
│  │   if (Target.IsInPlatformGroup(UnrealPlatformGroup.Apple))       │ │
│  │   {                                                               │ │
│  │       // Apple系（Mac, iOS, tvOS, visionOS）共通設定              │ │
│  │   }                                                               │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### Core.Build.cs の構成例

```
┌─────────────────────────────────────────────────────────────────────────┐
│                  Core.Build.cs プラットフォーム別設定                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  【共通依存関係】                                                  │ │
│  │   ・BuildSettings                                                 │ │
│  │   ・AtomicQueue                                                   │ │
│  │   ・AutoRTFM                                                      │ │
│  │   ・BLAKE3                                                        │ │
│  │   ・OodleDataCompression                                          │ │
│  │   ・xxhash                                                        │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                              │                                          │
│       ┌──────────────────────┼──────────────────────┐                   │
│       ▼                      ▼                      ▼                   │
│  ┌─────────┐            ┌─────────┐            ┌─────────┐             │
│  │ Windows │            │  Mac    │            │ Linux   │             │
│  └────┬────┘            └────┬────┘            └────┬────┘             │
│       │                      │                      │                   │
│       ▼                      ▼                      ▼                   │
│  ┌─────────────────┐   ┌─────────────────┐   ┌─────────────────┐       │
│  │【サードパーティ】 │   │【サードパーティ】 │   │【サードパーティ】 │       │
│  │ ・IntelTBB      │   │ ・IntelTBB      │   │ ・zlib          │       │
│  │ ・zlib          │   │ ・zlib          │   │ ・jemalloc      │       │
│  │ ・IntelVTune    │   │ ・PLCrashReporter│  │                 │       │
│  │                 │   │                 │   │                 │       │
│  │【独自モジュール】│   │【独自モジュール】│   │【独自モジュール】│       │
│  │ ・mimalloc      │   │ ・mimalloc      │   │ ・mimalloc      │       │
│  │ ・libpas        │   │                 │   │                 │       │
│  │                 │   │                 │   │                 │       │
│  │【システム】      │   │【フレームワーク】│   │【システム】      │       │
│  │ ・DBGHELP.DLL   │   │ ・Cocoa         │   │ ・dl            │       │
│  │   (遅延ロード)   │   │ ・Carbon        │   │ ・pthread       │       │
│  │                 │   │ ・IOKit         │   │                 │       │
│  │                 │   │ ・Security      │   │                 │       │
│  │【プロファイラ】  │   │ ・Network       │   │                 │       │
│  │ ・Superluminal  │   │ ・...           │   │                 │       │
│  │ ・VSPerf        │   │                 │   │                 │       │
│  │ ・Concurrency   │   │                 │   │                 │       │
│  │   Visualizer    │   │                 │   │                 │       │
│  └─────────────────┘   └─────────────────┘   └─────────────────┘       │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 3. プラットフォームグループ

### グループ一覧

```
┌─────────────────────────────────────────────────────────────────────────┐
│                   UnrealPlatformGroup 一覧                              │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【主要グループ】                                                        │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  UnrealPlatformGroup.Windows                                      │ │
│  │  │                                                                │ │
│  │  │  含まれるプラットフォーム:                                      │ │
│  │  │   ・Win64                                                      │ │
│  │  │   ・WinArm64                                                   │ │
│  │  │                                                                │ │
│  │  │  用途: Windows API使用、MSVC/Clang-CL対応                      │ │
│  │  │                                                                │ │
│  │  ──────────────────────────────────────────────────────────────── │ │
│  │                                                                   │ │
│  │  UnrealPlatformGroup.Desktop                                      │ │
│  │  │                                                                │ │
│  │  │  含まれるプラットフォーム:                                      │ │
│  │  │   ・Win64, WinArm64                                            │ │
│  │  │   ・Mac                                                        │ │
│  │  │   ・Linux, LinuxArm64                                          │ │
│  │  │                                                                │ │
│  │  │  用途: デスクトップ共通機能、エディタ対応                       │ │
│  │  │                                                                │ │
│  │  ──────────────────────────────────────────────────────────────── │ │
│  │                                                                   │ │
│  │  UnrealPlatformGroup.Apple                                        │ │
│  │  │                                                                │ │
│  │  │  含まれるプラットフォーム:                                      │ │
│  │  │   ・Mac                                                        │ │
│  │  │   ・IOS                                                        │ │
│  │  │   ・TVOS                                                       │ │
│  │  │   ・VisionOS                                                   │ │
│  │  │                                                                │ │
│  │  │  用途: Cocoa/Metal、Objective-C統合                            │ │
│  │  │                                                                │ │
│  │  ──────────────────────────────────────────────────────────────── │ │
│  │                                                                   │ │
│  │  UnrealPlatformGroup.IOS                                          │ │
│  │  │                                                                │ │
│  │  │  含まれるプラットフォーム:                                      │ │
│  │  │   ・IOS                                                        │ │
│  │  │   ・TVOS                                                       │ │
│  │  │   ・VisionOS                                                   │ │
│  │  │                                                                │ │
│  │  │  用途: iOSファミリー共通機能                                    │ │
│  │  │                                                                │ │
│  │  ──────────────────────────────────────────────────────────────── │ │
│  │                                                                   │ │
│  │  UnrealPlatformGroup.Unix                                         │ │
│  │  │                                                                │ │
│  │  │  含まれるプラットフォーム:                                      │ │
│  │  │   ・Mac                                                        │ │
│  │  │   ・Linux, LinuxArm64                                          │ │
│  │  │   ・IOS, TVOS, VisionOS                                        │ │
│  │  │   ・Android                                                    │ │
│  │  │   ・FreeBSD                                                    │ │
│  │  │                                                                │ │
│  │  │  用途: POSIX API、pthread、BSDソケット                         │ │
│  │  │                                                                │ │
│  │  ──────────────────────────────────────────────────────────────── │ │
│  │                                                                   │ │
│  │  UnrealPlatformGroup.Android                                      │ │
│  │  │                                                                │ │
│  │  │  含まれるプラットフォーム:                                      │ │
│  │  │   ・Android (全アーキテクチャ)                                  │ │
│  │  │                                                                │ │
│  │  │  用途: NDK、JNI統合、Vulkan                                    │ │
│  │  │                                                                │ │
│  │  ──────────────────────────────────────────────────────────────── │ │
│  │                                                                   │ │
│  │  UnrealPlatformGroup.Microsoft                                    │ │
│  │  │                                                                │ │
│  │  │  含まれるプラットフォーム:                                      │ │
│  │  │   ・Win64, WinArm64                                            │ │
│  │  │   ・Xbox系                                                     │ │
│  │  │                                                                │ │
│  │  │  用途: DirectX、MSVC固有機能                                   │ │
│  │  │                                                                │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### グループの包含関係

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    プラットフォームグループの包含関係                     │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │                           All                                   │   │
│  │  ┌─────────────────────────────────────────────────────────┐   │   │
│  │  │                                                         │   │   │
│  │  │   Desktop                    Mobile                     │   │   │
│  │  │   ┌───────────────────┐     ┌───────────────────┐       │   │   │
│  │  │   │                   │     │                   │       │   │   │
│  │  │   │  Windows   Unix   │     │  IOS    Android   │       │   │   │
│  │  │   │  ┌─────┐  ┌─────┐│     │  ┌─────┐  ┌─────┐ │       │   │   │
│  │  │   │  │Win64│  │Mac  ││     │  │iOS  │  │Andr │ │       │   │   │
│  │  │   │  │     │  │Linux││     │  │tvOS │  │     │ │       │   │   │
│  │  │   │  └─────┘  └─────┘│     │  │visOS│  └─────┘ │       │   │   │
│  │  │   │                   │     │  └─────┘          │       │   │   │
│  │  │   └───────────────────┘     └───────────────────┘       │   │   │
│  │  │                                                         │   │   │
│  │  └─────────────────────────────────────────────────────────┘   │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│                                                                         │
│  【包含関係の詳細】                                                      │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │   プラットフォーム │ Windows │ Desktop │ Apple │ Unix │ IOS     │ │
│  │   ─────────────────┼─────────┼─────────┼───────┼──────┼─────────│ │
│  │   Win64           │    ●    │    ●    │   -   │  -   │    -    │ │
│  │   Mac             │    -    │    ●    │   ●   │  ●   │    -    │ │
│  │   Linux           │    -    │    ●    │   -   │  ●   │    -    │ │
│  │   iOS             │    -    │    -    │   ●   │  ●   │    ●    │ │
│  │   tvOS            │    -    │    -    │   ●   │  ●   │    ●    │ │
│  │   visionOS        │    -    │    -    │   ●   │  ●   │    ●    │ │
│  │   Android         │    -    │    -    │   -   │  ●   │    -    │ │
│  │                                                                   │ │
│  │   ● = 所属する                                                    │ │
│  │   - = 所属しない                                                  │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 4. 新規プラットフォーム追加手順

### 全体フロー

```
┌─────────────────────────────────────────────────────────────────────────┐
│                   新規プラットフォーム追加フロー                         │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【Phase 1: 基盤構築】                                                   │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  Step 1. プラットフォームディレクトリ作成                          │ │
│  │     │                                                             │ │
│  │     │  Public/NewPlatform/                                       │ │
│  │     │  Private/NewPlatform/                                      │ │
│  │     │                                                             │ │
│  │     ▼                                                             │ │
│  │  Step 2. 基本プラットフォームヘッダ作成                            │ │
│  │     │                                                             │ │
│  │     │  NewPlatformPlatform.h                                     │ │
│  │     │   ・型定義（NewPlatformTypes）                             │ │
│  │     │   ・必須マクロ（PLATFORM_DESKTOP, PLATFORM_64BITS）        │ │
│  │     │   ・機能フラグ設定                                          │ │
│  │     │   ・関数呼び出し規約マクロ                                   │ │
│  │     │                                                             │ │
│  │     ▼                                                             │ │
│  │  Step 3. UBT登録                                                  │ │
│  │                                                                   │ │
│  │     ・UnrealTargetPlatform に追加                                │ │
│  │     ・プラットフォーム検出ロジック追加                             │ │
│  │     ・ツールチェーン設定                                          │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                              │                                          │
│                              ▼                                          │
│  【Phase 2: 必須HAL実装】                                                │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  Step 4. メモリ管理実装                                           │ │
│  │     │                                                             │ │
│  │     │  NewPlatformMemory.h / .cpp                                │ │
│  │     │   ・Init()                                                 │ │
│  │     │   ・BaseAllocator()                                        │ │
│  │     │   ・GetStats() / GetConstants()                            │ │
│  │     │   ・BinnedAllocFromOS() / BinnedFreeToOS()                 │ │
│  │     │                                                             │ │
│  │     ▼                                                             │ │
│  │  Step 5. プロセス管理実装                                         │ │
│  │     │                                                             │ │
│  │     │  NewPlatformProcess.h / .cpp                               │ │
│  │     │   ・CreateProc() / CloseProc()                             │ │
│  │     │   ・GetDllHandle() / FreeDllHandle()                       │ │
│  │     │   ・Sleep() / YieldThread()                                │ │
│  │     │                                                             │ │
│  │     ▼                                                             │ │
│  │  Step 6. ファイルI/O実装                                          │ │
│  │     │                                                             │ │
│  │     │  NewPlatformFile.h / .cpp                                  │ │
│  │     │   ・OpenRead() / OpenWrite()                               │ │
│  │     │   ・FileExists() / DirectoryExists()                       │ │
│  │     │   ・CreateDirectory()                                      │ │
│  │     │                                                             │ │
│  │     ▼                                                             │ │
│  │  Step 7. その他必須コンポーネント                                  │ │
│  │                                                                   │ │
│  │     ・NewPlatformMisc.h / .cpp                                   │ │
│  │     ・NewPlatformTime.h / .cpp                                   │ │
│  │     ・NewPlatformAtomics.h                                       │ │
│  │     ・NewPlatformTLS.h / .cpp                                    │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                              │                                          │
│                              ▼                                          │
│  【Phase 3: ビルド統合】                                                 │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  Step 8. Core.Build.cs 更新                                       │ │
│  │     │                                                             │ │
│  │     │  プラットフォーム固有の依存関係追加                          │ │
│  │     │  サードパーティライブラリ設定                                │ │
│  │     │                                                             │ │
│  │     ▼                                                             │ │
│  │  Step 9. テストビルド                                             │ │
│  │     │                                                             │ │
│  │     │  最小プロジェクトでビルド確認                                │ │
│  │     │  起動確認                                                   │ │
│  │     │                                                             │ │
│  │     ▼                                                             │ │
│  │  Step 10. 追加モジュール対応                                      │ │
│  │                                                                   │ │
│  │     ・RHI対応（別途必要）                                         │ │
│  │     ・オーディオ対応                                              │ │
│  │     ・入力対応                                                    │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 必須ファイル一覧

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      必須ファイル一覧                                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【最小構成】(動作に必須)                                                │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  Public/NewPlatform/                                              │ │
│  │  │                                                                │ │
│  │  ├── NewPlatformPlatform.h ─────────── 基本定義                  │ │
│  │  │   ・NewPlatformTypes 構造体                                  │ │
│  │  │   ・PLATFORM_xxx マクロ                                       │ │
│  │  │   ・FORCEINLINE, DLLEXPORT 等                                 │ │
│  │  │                                                                │ │
│  │  ├── NewPlatformMemory.h ───────────── メモリ管理                │ │
│  │  │   ・NewPlatformMemory クラス                                 │ │
│  │  │   ・PlatformMemoryStats 構造体                               │ │
│  │  │                                                                │ │
│  │  ├── NewPlatformProcess.h ──────────── プロセス管理              │ │
│  │  │   ・NewPlatformProcess クラス                                │ │
│  │  │                                                                │ │
│  │  ├── NewPlatformMisc.h ─────────────── ユーティリティ            │ │
│  │  │   ・NewPlatformMisc クラス                                   │ │
│  │  │                                                                │ │
│  │  ├── NewPlatformFile.h ─────────────── ファイルI/O               │ │
│  │  │   ・NewPlatformFile クラス                                   │ │
│  │  │                                                                │ │
│  │  ├── NewPlatformAtomics.h ──────────── アトミック操作            │ │
│  │  │   ・NewPlatformAtomics クラス                                │ │
│  │  │                                                                │ │
│  │  ├── NewPlatformTime.h ─────────────── 時間管理                  │ │
│  │  │   ・NewPlatformTime クラス                                   │ │
│  │  │                                                                │ │
│  │  ├── NewPlatformTLS.h ──────────────── TLS                       │ │
│  │  │   ・NewPlatformTLS クラス                                    │ │
│  │  │                                                                │ │
│  │  ├── NewPlatformCompilerPreSetup.h ─── コンパイラ前処理          │ │
│  │  └── NewPlatformCompilerSetup.h ────── コンパイラ後処理          │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【実装ファイル】                                                        │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  Private/NewPlatform/                                             │ │
│  │  │                                                                │ │
│  │  ├── NewPlatformMemory.cpp                                       │ │
│  │  ├── NewPlatformProcess.cpp                                      │ │
│  │  ├── NewPlatformMisc.cpp                                         │ │
│  │  ├── NewPlatformFile.cpp                                         │ │
│  │  ├── NewPlatformTime.cpp                                         │ │
│  │  ├── NewPlatformTLS.cpp                                          │ │
│  │  └── NewPlatformStackWalk.cpp（オプション）                       │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【追加推奨】                                                            │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  ・NewPlatformString.h/cpp ──────── 文字列操作（最適化）          │ │
│  │  ・NewPlatformMath.h ────────────── 数学関数（SIMD最適化）        │ │
│  │  ・NewPlatformStackWalk.h/cpp ──── スタックトレース              │ │
│  │  ・NewPlatformCrashContext.h/cpp ─ クラッシュ情報                │ │
│  │  ・NewPlatformOutputDevices.h/cpp ─ ログ出力                     │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 5. 実装チェックリスト

### 必須実装項目

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      必須実装チェックリスト                              │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【基本プラットフォーム定義】                                            │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  □ NewPlatformTypes 構造体定義                                  │ │
│  │    □ SIZE_T / SSIZE_T の定義                                     │ │
│  │    □ WIDECHAR / TCHAR の定義                                     │ │
│  │                                                                   │ │
│  │  □ typedef NewPlatformTypes PlatformTypes                      │ │
│  │                                                                   │ │
│  │  □ 必須マクロ定義                                                │ │
│  │    □ PLATFORM_DESKTOP (0 or 1)                                   │ │
│  │    □ PLATFORM_64BITS (1 必須)                                    │ │
│  │                                                                   │ │
│  │  □ 機能フラグ設定                                                │ │
│  │    □ PLATFORM_LITTLE_ENDIAN                                      │ │
│  │    □ PLATFORM_USE_PTHREADS                                       │ │
│  │    □ PLATFORM_HAS_BSD_SOCKETS                                    │ │
│  │    □ PLATFORM_ENABLE_VECTORINTRINSICS                            │ │
│  │                                                                   │ │
│  │  □ 関数マクロ定義                                                │ │
│  │    □ FORCEINLINE                                                 │ │
│  │    □ FORCENOINLINE                                               │ │
│  │    □ DLLEXPORT / DLLIMPORT                                       │ │
│  │    □ PLATFORM_BREAK()                                            │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【メモリ管理】                                                          │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  □ NewPlatformMemory クラス                                     │ │
│  │    □ Init()                                                      │ │
│  │    □ BaseAllocator()                                             │ │
│  │    □ GetStats()                                                  │ │
│  │    □ GetConstants()                                              │ │
│  │    □ BinnedAllocFromOS()                                         │ │
│  │    □ BinnedFreeToOS()                                            │ │
│  │    □ PageProtect()                                               │ │
│  │                                                                   │ │
│  │  □ PlatformVirtualMemoryBlock クラス                            │ │
│  │    □ AllocateVirtual()                                           │ │
│  │    □ Commit() / Decommit()                                       │ │
│  │    □ FreeVirtual()                                               │ │
│  │                                                                   │ │
│  │  □ typedef NewPlatformMemory PlatformMemory                    │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【プロセス管理】                                                        │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  □ NewPlatformProcess クラス                                    │ │
│  │    □ GetCurrentProcessId()                                       │ │
│  │    □ CreateProc() / CloseProc()                                  │ │
│  │    □ IsProcRunning() / WaitForProc()                             │ │
│  │    □ GetProcReturnCode()                                         │ │
│  │    □ CreatePipe() / ClosePipe()                                  │ │
│  │    □ ReadPipe() / WritePipe()                                    │ │
│  │    □ GetDllHandle() / FreeDllHandle() / GetDllExport()           │ │
│  │    □ Sleep() / SleepNoStats() / YieldThread()                    │ │
│  │    □ ExecutablePath() / ComputerName() / UserName()              │ │
│  │                                                                   │ │
│  │  □ typedef NewPlatformProcess PlatformProcess                  │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【ファイルI/O】                                                         │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  □ NewPlatformFile クラス                                       │ │
│  │    □ FileExists() / DirectoryExists()                            │ │
│  │    □ FileSize()                                                  │ │
│  │    □ DeleteFile() / DeleteDirectory()                            │ │
│  │    □ MoveFile()                                                  │ │
│  │    □ CreateDirectory() / CreateDirectoryTree()                   │ │
│  │    □ OpenRead() / OpenWrite()                                    │ │
│  │    □ IterateDirectory()                                          │ │
│  │                                                                   │ │
│  │  □ NewPlatformFileHandle クラス                                 │ │
│  │    □ Tell() / Seek() / SeekFromEnd()                             │ │
│  │    □ Read() / Write()                                            │ │
│  │    □ Size() / Flush() / Truncate()                               │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【その他必須】                                                          │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  □ NewPlatformAtomics                                           │ │
│  │    □ InterlockedIncrement/Decrement                              │ │
│  │    □ InterlockedExchange                                         │ │
│  │    □ InterlockedCompareExchange                                  │ │
│  │    □ MemoryBarrier                                               │ │
│  │                                                                   │ │
│  │  □ NewPlatformTime                                              │ │
│  │    □ Seconds() / Cycles64()                                      │ │
│  │    □ SystemTime() / UtcTime()                                    │ │
│  │                                                                   │ │
│  │  □ NewPlatformTLS                                               │ │
│  │    □ AllocTlsSlot() / FreeTlsSlot()                              │ │
│  │    □ GetTlsValue() / SetTlsValue()                               │ │
│  │                                                                   │ │
│  │  □ NewPlatformMisc                                              │ │
│  │    □ PlatformInit()                                              │ │
│  │    □ GetEnvironmentVariable()                                    │ │
│  │    □ RequestExit()                                               │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 6. ベストプラクティス

### 推奨パターン

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        ベストプラクティス                               │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【継承の活用】                                                          │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  ○ 良い例: 汎用クラスを継承し、必要な部分のみオーバーライド       │ │
│  │                                                                   │ │
│  │    NewPlatformMemory : public GenericPlatformMemory            │ │
│  │    {                                                              │ │
│  │        // 共通機能は継承                                          │ │
│  │        // Memcpy, Memset, Memmove 等はそのまま使用               │ │
│  │                                                                   │ │
│  │        // プラットフォーム固有部分のみオーバーライド              │ │
│  │        static void Init();                                        │ │
│  │        static void* BinnedAllocFromOS(SIZE_T Size);              │ │
│  │    };                                                             │ │
│  │                                                                   │ │
│  │  × 悪い例: 全て一から実装                                         │ │
│  │                                                                   │ │
│  │    NewPlatformMemory  // 継承なし                                │ │
│  │    {                                                              │ │
│  │        // 全メソッドを自前で実装 → 冗長、バグ混入リスク          │ │
│  │    };                                                             │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【条件分岐の書き方】                                                    │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  ○ 良い例: 機能フラグを使用                                       │ │
│  │                                                                   │ │
│  │    #if PLATFORM_HAS_BSD_SOCKETS                                   │ │
│  │        // ソケット機能を使用                                      │ │
│  │    #endif                                                         │ │
│  │                                                                   │ │
│  │    #if PLATFORM_SUPPORTS_MIMALLOC                                │ │
│  │        // mimalloc使用                                            │ │
│  │    #endif                                                         │ │
│  │                                                                   │ │
│  │  ○ 良い例: プラットフォームグループを使用                         │ │
│  │                                                                   │ │
│  │    #if PLATFORM_UNIX                                              │ │
│  │        // Unix系共通コード                                        │ │
│  │    #endif                                                         │ │
│  │                                                                   │ │
│  │    #if PLATFORM_DESKTOP                                           │ │
│  │        // デスクトップ共通コード                                   │ │
│  │    #endif                                                         │ │
│  │                                                                   │ │
│  │  × 悪い例: 個別プラットフォームの列挙                             │ │
│  │                                                                   │ │
│  │    #if PLATFORM_WINDOWS || PLATFORM_MAC || PLATFORM_LINUX        │ │
│  │        // デスクトップ用コード → 新プラットフォーム追加時に漏れ   │ │
│  │    #endif                                                         │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【PlatformXxx の使用】                                                 │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  ○ 良い例: 抽象化された Platform を使用                          │ │
│  │                                                                   │ │
│  │    void* Ptr = PlatformMemory::BinnedAllocFromOS(Size);         │ │
│  │    PlatformProcess::Sleep(1.0f);                                │ │
│  │    double Time = PlatformTime::Seconds();                       │ │
│  │                                                                   │ │
│  │  × 悪い例: OS APIを直接呼び出し                                   │ │
│  │                                                                   │ │
│  │    #ifdef _WIN32                                                  │ │
│  │        VirtualAlloc(...);  // 移植性なし                          │ │
│  │    #else                                                          │ │
│  │        mmap(...);          // 移植性なし                          │ │
│  │    #endif                                                         │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【型安全性】                                                            │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  ○ 良い例: UE定義型を使用                                         │ │
│  │                                                                   │ │
│  │    int32 Count;                                                   │ │
│  │    uint64 Size;                                                   │ │
│  │    SIZE_T AllocationSize;                                         │ │
│  │    TCHAR Buffer[256];                                             │ │
│  │                                                                   │ │
│  │  × 悪い例: プラットフォーム固有型を使用                           │ │
│  │                                                                   │ │
│  │    int Count;        // サイズがプラットフォーム依存               │ │
│  │    long Size;        // Windows: 4byte, Unix: 8byte              │ │
│  │    wchar_t Buffer[]; // Windows: 2byte, Unix: 4byte              │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 付録

### よくあるエラーと解決策

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    よくあるエラーと解決策                                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【コンパイルエラー】                                                    │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  エラー: "PLATFORM_DESKTOP must be defined"                       │ │
│  │  原因:   プラットフォームヘッダで必須マクロ未定義                  │ │
│  │  解決:   NewPlatformPlatform.h に #define PLATFORM_DESKTOP 1 追加 │ │
│  │                                                                   │ │
│  │  ────────────────────────────────────────────────────────────────│ │
│  │                                                                   │ │
│  │  エラー: "NewPlatform/NewPlatformMemory.h not found"             │ │
│  │  原因:   COMPILED_PLATFORM_HEADER の展開失敗                     │ │
│  │  解決:   UBT_COMPILED_PLATFORM が正しく設定されているか確認       │ │
│  │          ディレクトリ/ファイル名が規約通りか確認                   │ │
│  │                                                                   │ │
│  │  ────────────────────────────────────────────────────────────────│ │
│  │                                                                   │ │
│  │  エラー: "undefined reference to NewPlatformMemory::Init"       │ │
│  │  原因:   .cpp ファイルがビルドに含まれていない                    │ │
│  │  解決:   Core.Build.cs でプラットフォーム条件を確認               │ │
│  │          ソースファイルパスが正しいか確認                         │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  【ランタイムエラー】                                                    │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │  エラー: メモリ割り当て失敗                                       │ │
│  │  原因:   BinnedAllocFromOS の実装ミス                            │ │
│  │  確認:   mmap の戻り値チェック、権限フラグ確認                    │ │
│  │                                                                   │ │
│  │  ────────────────────────────────────────────────────────────────│ │
│  │                                                                   │ │
│  │  エラー: DLL ロード失敗                                           │ │
│  │  原因:   GetDllHandle の実装ミス、パス問題                        │ │
│  │  確認:   dlopen のエラーメッセージ (dlerror)                      │ │
│  │          ライブラリ検索パス確認                                   │ │
│  │                                                                   │ │
│  │  ────────────────────────────────────────────────────────────────│ │
│  │                                                                   │ │
│  │  エラー: 時間計測が不正確                                         │ │
│  │  原因:   Seconds() の実装ミス                                    │ │
│  │  確認:   高精度タイマーの使用確認                                 │ │
│  │          周波数/変換係数の計算確認                                │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 次のパート

[第5部：スレッディング・クラッシュ処理・ネットワーク・文字列処理](Platform_Abstraction_Layer_Part5.md) に続く

---

*このドキュメントはUnreal Engine 5.7のソースコードに基づいています。*
