# RHI 実装ガイド Part 6: フォーマット、状態追跡、スレッディング、エラー処理

このドキュメントでは、RHI実装における重要な技術的詳細を解説します：

- ピクセルフォーマット変換
- リソース状態追跡システム
- スレッディングモデル
- 一時リソース/エイリアシング
- シェーダーコンパイルパイプライン
- エラーハンドリング
- 機能レベルとケイパビリティ

---

## 1. ピクセルフォーマット変換

### 1.1 UE フォーマットと API フォーマットのマッピング

```
┌─────────────────────────────────────────────────────────────────┐
│           ピクセルフォーマットマッピング                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  UE5 EPixelFormat と各API フォーマットの対応:                    │
│                                                                  │
│  ┌────────────────┬──────────────────┬─────────────────────┐    │
│  │ UE Format      │ D3D12 (DXGI)     │ Vulkan              │    │
│  ├────────────────┼──────────────────┼─────────────────────┤    │
│  │ PF_Unknown     │ UNKNOWN          │ UNDEFINED           │    │
│  ├────────────────┼──────────────────┼─────────────────────┤    │
│  │ PF_A32B32G32R32F│R32G32B32A32_FLOAT│R32G32B32A32_SFLOAT │    │
│  ├────────────────┼──────────────────┼─────────────────────┤    │
│  │ PF_B8G8R8A8    │ B8G8R8A8_UNORM   │ B8G8R8A8_UNORM     │    │
│  ├────────────────┼──────────────────┼─────────────────────┤    │
│  │ PF_R8G8B8A8    │ R8G8B8A8_UNORM   │ R8G8B8A8_UNORM     │    │
│  ├────────────────┼──────────────────┼─────────────────────┤    │
│  │ PF_R8G8B8A8_SNORM│R8G8B8A8_SNORM  │ R8G8B8A8_SNORM     │    │
│  ├────────────────┼──────────────────┼─────────────────────┤    │
│  │ PF_R8G8B8A8_UINT│R8G8B8A8_UINT    │ R8G8B8A8_UINT      │    │
│  ├────────────────┼──────────────────┼─────────────────────┤    │
│  │ PF_G8          │ R8_UNORM         │ R8_UNORM           │    │
│  ├────────────────┼──────────────────┼─────────────────────┤    │
│  │ PF_G16         │ R16_UNORM        │ R16_UNORM          │    │
│  ├────────────────┼──────────────────┼─────────────────────┤    │
│  │ PF_FloatRGB    │ R11G11B10_FLOAT  │ B10G11R11_UFLOAT   │    │
│  ├────────────────┼──────────────────┼─────────────────────┤    │
│  │ PF_FloatRGBA   │ R16G16B16A16_FLOAT│R16G16B16A16_SFLOAT│    │
│  ├────────────────┼──────────────────┼─────────────────────┤    │
│  │ PF_DepthStencil│ D24_UNORM_S8_UINT│ D24_UNORM_S8_UINT  │    │
│  │                │ or D32_FLOAT_S8X24│or D32_SFLOAT_S8    │    │
│  ├────────────────┼──────────────────┼─────────────────────┤    │
│  │ PF_ShadowDepth │ D16_UNORM        │ D16_UNORM          │    │
│  ├────────────────┼──────────────────┼─────────────────────┤    │
│  │ PF_R32_FLOAT   │ R32_FLOAT        │ R32_SFLOAT         │    │
│  ├────────────────┼──────────────────┼─────────────────────┤    │
│  │ PF_G16R16      │ R16G16_UNORM     │ R16G16_UNORM       │    │
│  ├────────────────┼──────────────────┼─────────────────────┤    │
│  │ PF_G16R16F     │ R16G16_FLOAT     │ R16G16_SFLOAT      │    │
│  ├────────────────┼──────────────────┼─────────────────────┤    │
│  │ PF_G32R32F     │ R32G32_FLOAT     │ R32G32_SFLOAT      │    │
│  ├────────────────┼──────────────────┼─────────────────────┤    │
│  │ PF_A2B10G10R10 │ R10G10B10A2_UNORM│ A2B10G10R10_UNORM  │    │
│  ├────────────────┼──────────────────┼─────────────────────┤    │
│  │ PF_A16B16G16R16│ R16G16B16A16_UNORM│R16G16B16A16_UNORM │    │
│  ├────────────────┼──────────────────┼─────────────────────┤    │
│  │ PF_R16F        │ R16_FLOAT        │ R16_SFLOAT         │    │
│  ├────────────────┼──────────────────┼─────────────────────┤    │
│  │ PF_R32_UINT    │ R32_UINT         │ R32_UINT           │    │
│  ├────────────────┼──────────────────┼─────────────────────┤    │
│  │ PF_R32_SINT    │ R32_SINT         │ R32_SINT           │    │
│  └────────────────┴──────────────────┴─────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 1.2 圧縮テクスチャフォーマット

```
┌─────────────────────────────────────────────────────────────────┐
│              圧縮テクスチャフォーマット                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌────────────────┬──────────────────┬──────────────────────┐   │
│  │ UE Format      │ D3D12            │ 用途                  │   │
│  ├────────────────┼──────────────────┼──────────────────────┤   │
│  │ PF_DXT1        │ BC1_UNORM        │ RGB (1bit alpha)     │   │
│  │ PF_DXT3        │ BC2_UNORM        │ RGBA (sharp alpha)   │   │
│  │ PF_DXT5        │ BC3_UNORM        │ RGBA (smooth alpha)  │   │
│  │ PF_BC4         │ BC4_UNORM        │ 1ch グレースケール    │   │
│  │ PF_BC5         │ BC5_UNORM        │ 2ch 法線マップ        │   │
│  │ PF_BC6H        │ BC6H_UF16        │ HDR RGB              │   │
│  │ PF_BC7         │ BC7_UNORM        │ 高品質 RGBA          │   │
│  └────────────────┴──────────────────┴──────────────────────┘   │
│                                                                  │
│  ブロックサイズ:                                                 │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  BC1-BC5:  4x4 ピクセル = 8 or 16 バイト                │    │
│  │  BC6H-BC7: 4x4 ピクセル = 16 バイト                     │    │
│  │                                                          │    │
│  │  テクスチャサイズは 4 の倍数である必要がある              │    │
│  │  (小さいミップレベルは 1x1 まで許可)                     │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  モバイル向け (ASTC/ETC):                                        │
│  ┌────────────────┬──────────────────┬──────────────────────┐   │
│  │ PF_ASTC_4x4    │ (D3D12非対応)    │ Vulkan/Metal向け     │   │
│  │ PF_ASTC_6x6    │                  │ 可変圧縮率           │   │
│  │ PF_ASTC_8x8    │                  │                      │   │
│  │ PF_ASTC_10x10  │                  │                      │   │
│  │ PF_ASTC_12x12  │                  │                      │   │
│  │ PF_ETC2_RGB    │                  │ Android基本          │   │
│  │ PF_ETC2_RGBA   │                  │                      │   │
│  └────────────────┴──────────────────┴──────────────────────┘   │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 1.3 フォーマット変換の実装

```
┌─────────────────────────────────────────────────────────────────┐
│              フォーマット変換の実装                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  変換関数の構造:                                                 │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  // UE → Platform                                       │    │
│  │  DXGI_FORMAT TranslateFormat(EPixelFormat UEFormat)      │    │
│  │  {                                                       │    │
│  │      static DXGI_FORMAT FormatMap[] = {                 │    │
│  │          DXGI_FORMAT_UNKNOWN,            // PF_Unknown  │    │
│  │          DXGI_FORMAT_R32G32B32A32_FLOAT, // PF_A32B32...│    │
│  │          DXGI_FORMAT_B8G8R8A8_UNORM,     // PF_B8G8R8A8 │    │
│  │          // ... 全フォーマット                          │    │
│  │      };                                                  │    │
│  │      return FormatMap[UEFormat];                        │    │
│  │  }                                                       │    │
│  │                                                          │    │
│  │  // Platform → UE (逆変換)                              │    │
│  │  EPixelFormat TranslateFormat(DXGI_FORMAT DXFormat)      │    │
│  │  {                                                       │    │
│  │      switch (DXFormat) {                                │    │
│  │          case DXGI_FORMAT_R8G8B8A8_UNORM:               │    │
│  │              return PF_R8G8B8A8;                        │    │
│  │          // ... 全フォーマット                          │    │
│  │      }                                                   │    │
│  │  }                                                       │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  ビュー用フォーマット変換 (Typeless):                            │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  // 深度テクスチャの例                                   │    │
│  │  リソース作成: DXGI_FORMAT_R24G8_TYPELESS               │    │
│  │       ↓                                                  │    │
│  │  DSV作成:     DXGI_FORMAT_D24_UNORM_S8_UINT             │    │
│  │       ↓                                                  │    │
│  │  SRV作成:     DXGI_FORMAT_R24_UNORM_X8_TYPELESS         │    │
│  │               (深度をシェーダーで読む場合)               │    │
│  │                                                          │    │
│  │  // sRGB テクスチャの例                                  │    │
│  │  リソース作成: DXGI_FORMAT_R8G8B8A8_TYPELESS            │    │
│  │       ↓                                                  │    │
│  │  SRV作成:     DXGI_FORMAT_R8G8B8A8_UNORM_SRGB           │    │
│  │               (sRGBとして読む場合)                       │    │
│  │  または:      DXGI_FORMAT_R8G8B8A8_UNORM                │    │
│  │               (リニアとして読む場合)                     │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  フォーマットサポートチェック:                                   │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  D3D12_FEATURE_DATA_FORMAT_SUPPORT formatSupport = {};  │    │
│  │  formatSupport.Format = format;                          │    │
│  │  device->CheckFeatureSupport(                            │    │
│  │      D3D12_FEATURE_FORMAT_SUPPORT,                       │    │
│  │      &formatSupport, sizeof(formatSupport));             │    │
│  │                                                          │    │
│  │  // サポートされる操作をチェック                         │    │
│  │  bool canSample = formatSupport.Support1 &               │    │
│  │      D3D12_FORMAT_SUPPORT1_SHADER_SAMPLE;               │    │
│  │  bool canRenderTarget = formatSupport.Support1 &         │    │
│  │      D3D12_FORMAT_SUPPORT1_RENDER_TARGET;               │    │
│  │  bool canUAV = formatSupport.Support1 &                  │    │
│  │      D3D12_FORMAT_SUPPORT1_TYPED_UNORDERED_ACCESS_VIEW; │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 2. リソース状態追跡システム

### 2.1 リソースステートの概念

```
┌─────────────────────────────────────────────────────────────────┐
│               リソースステートの概念                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  D3D12 リソースステート:                                         │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  読み取り専用ステート (複数同時可):                      │    │
│  │  ├── VERTEX_AND_CONSTANT_BUFFER                         │    │
│  │  ├── INDEX_BUFFER                                        │    │
│  │  ├── NON_PIXEL_SHADER_RESOURCE                          │    │
│  │  ├── PIXEL_SHADER_RESOURCE                              │    │
│  │  ├── INDIRECT_ARGUMENT                                  │    │
│  │  ├── COPY_SOURCE                                         │    │
│  │  └── DEPTH_READ (with DEPTH_READ flag)                  │    │
│  │                                                          │    │
│  │  書き込みステート (排他):                                │    │
│  │  ├── RENDER_TARGET                                       │    │
│  │  ├── UNORDERED_ACCESS                                   │    │
│  │  ├── DEPTH_WRITE                                         │    │
│  │  ├── COPY_DEST                                          │    │
│  │  └── STREAM_OUT                                          │    │
│  │                                                          │    │
│  │  特殊ステート:                                           │    │
│  │  ├── COMMON (汎用、暗黙の遷移可能)                       │    │
│  │  ├── PRESENT (スワップチェーン表示用)                    │    │
│  │  └── RAYTRACING_ACCELERATION_STRUCTURE                  │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  ステート遷移の必要性:                                           │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  GPUキャッシュとメモリの一貫性を保証するため:            │    │
│  │                                                          │    │
│  │  書き込み → 読み取り:                                   │    │
│  │  ┌───────────────────────────────────────────────────┐  │    │
│  │  │ RENDER_TARGET で描画                              │  │    │
│  │  │       │                                           │  │    │
│  │  │       ▼ キャッシュフラッシュ必要                  │  │    │
│  │  │ PIXEL_SHADER_RESOURCE でサンプリング             │  │    │
│  │  └───────────────────────────────────────────────────┘  │    │
│  │                                                          │    │
│  │  レイアウト変更:                                         │    │
│  │  ┌───────────────────────────────────────────────────┐  │    │
│  │  │ 圧縮されたRT → サンプリング用レイアウト          │  │    │
│  │  │ (一部のGPUでは物理的なデータ再配置)              │  │    │
│  │  └───────────────────────────────────────────────────┘  │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 自動状態追跡システム

```
┌─────────────────────────────────────────────────────────────────┐
│              自動状態追跡システム                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  UE5のリソース状態追跡:                                          │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  FD3D12Resource内の状態追跡:                             │    │
│  │  ┌───────────────────────────────────────────────────┐  │    │
│  │  │ struct FD3D12ResourceState {                      │  │    │
│  │  │     // サブリソースごとの現在の状態               │  │    │
│  │  │     TArray<D3D12_RESOURCE_STATES> SubresourceStates;│  │    │
│  │  │                                                   │  │    │
│  │  │     // 全サブリソースが同じ状態かどうか           │  │    │
│  │  │     bool bAllSubresourcesSame;                    │  │    │
│  │  │                                                   │  │    │
│  │  │     // 同じなら単一の状態                         │  │    │
│  │  │     D3D12_RESOURCE_STATES UnifiedState;          │  │    │
│  │  │ };                                                │  │    │
│  │  └───────────────────────────────────────────────────┘  │    │
│  │                                                          │    │
│  │  状態遷移の自動挿入:                                     │    │
│  │  ┌───────────────────────────────────────────────────┐  │    │
│  │  │ void TransitionResource(                          │  │    │
│  │  │     FD3D12Resource* Resource,                     │  │    │
│  │  │     D3D12_RESOURCE_STATES DesiredState,          │  │    │
│  │  │     uint32 Subresource = AllSubresources)        │  │    │
│  │  │ {                                                 │  │    │
│  │  │     D3D12_RESOURCE_STATES CurrentState =          │  │    │
│  │  │         Resource->GetCurrentState(Subresource);   │  │    │
│  │  │                                                   │  │    │
│  │  │     if (CurrentState != DesiredState) {           │  │    │
│  │  │         // バリアをペンディングリストに追加       │  │    │
│  │  │         PendingBarriers.Add({                     │  │    │
│  │  │             Resource,                             │  │    │
│  │  │             CurrentState,                         │  │    │
│  │  │             DesiredState,                         │  │    │
│  │  │             Subresource                           │  │    │
│  │  │         });                                       │  │    │
│  │  │                                                   │  │    │
│  │  │         // リソースの追跡状態を更新               │  │    │
│  │  │         Resource->SetCurrentState(                │  │    │
│  │  │             DesiredState, Subresource);           │  │    │
│  │  │     }                                             │  │    │
│  │  │ }                                                 │  │    │
│  │  └───────────────────────────────────────────────────┘  │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  バリアのバッチ処理:                                             │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  // バリアを蓄積                                         │    │
│  │  TransitionResource(TexA, RENDER_TARGET);               │    │
│  │  TransitionResource(TexB, PIXEL_SHADER_RESOURCE);       │    │
│  │  TransitionResource(Buffer, VERTEX_AND_CONSTANT_BUFFER);│    │
│  │                                                          │    │
│  │  // まとめて発行 (効率的)                                │    │
│  │  FlushPendingBarriers();                                 │    │
│  │                                                          │    │
│  │  ┌───────────────────────────────────────────────────┐  │    │
│  │  │ void FlushPendingBarriers() {                     │  │    │
│  │  │     if (PendingBarriers.Num() == 0) return;       │  │    │
│  │  │                                                   │  │    │
│  │  │     // D3D12バリア配列を構築                      │  │    │
│  │  │     TArray<D3D12_RESOURCE_BARRIER> Barriers;      │  │    │
│  │  │     for (auto& Pending : PendingBarriers) {       │  │    │
│  │  │         D3D12_RESOURCE_BARRIER Barrier = {};      │  │    │
│  │  │         Barrier.Type = TRANSITION;                │  │    │
│  │  │         Barrier.Transition.pResource = ...;       │  │    │
│  │  │         Barrier.Transition.StateBefore = ...;     │  │    │
│  │  │         Barrier.Transition.StateAfter = ...;      │  │    │
│  │  │         Barrier.Transition.Subresource = ...;     │  │    │
│  │  │         Barriers.Add(Barrier);                    │  │    │
│  │  │     }                                             │  │    │
│  │  │                                                   │  │    │
│  │  │     // 一括発行                                   │  │    │
│  │  │     CommandList->ResourceBarrier(                 │  │    │
│  │  │         Barriers.Num(), Barriers.GetData());      │  │    │
│  │  │                                                   │  │    │
│  │  │     PendingBarriers.Empty();                      │  │    │
│  │  │ }                                                 │  │    │
│  │  └───────────────────────────────────────────────────┘  │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 2.3 UAV バリアと同期

```
┌─────────────────────────────────────────────────────────────────┐
│               UAV バリアと同期                                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  UAVバリアが必要なケース:                                        │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  同じUAVへの連続アクセス (Read-After-Write):             │    │
│  │  ┌───────────────────────────────────────────────────┐  │    │
│  │  │ Dispatch A: UAV に書き込み                        │  │    │
│  │  │     │                                             │  │    │
│  │  │     ▼ UAVバリア必要                               │  │    │
│  │  │ Dispatch B: 同じ UAV を読み取り                   │  │    │
│  │  └───────────────────────────────────────────────────┘  │    │
│  │                                                          │    │
│  │  バリアの挿入:                                           │    │
│  │  ┌───────────────────────────────────────────────────┐  │    │
│  │  │ D3D12_RESOURCE_BARRIER uavBarrier = {};           │  │    │
│  │  │ uavBarrier.Type = D3D12_RESOURCE_BARRIER_TYPE_UAV;│  │    │
│  │  │ uavBarrier.UAV.pResource = uavResource;           │  │    │
│  │  │ // または nullptr で全UAVにバリア                 │  │    │
│  │  │                                                   │  │    │
│  │  │ CommandList->ResourceBarrier(1, &uavBarrier);     │  │    │
│  │  └───────────────────────────────────────────────────┘  │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  エイリアシングバリア:                                           │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  同じメモリを共有するリソース間の遷移:                   │    │
│  │  ┌───────────────────────────────────────────────────┐  │    │
│  │  │ // 同じヒープ位置にある2つのリソース              │  │    │
│  │  │ ResourceA: [========] (現在アクティブ)            │  │    │
│  │  │ ResourceB: [========] (同じメモリ位置)            │  │    │
│  │  │                                                   │  │    │
│  │  │ D3D12_RESOURCE_BARRIER aliasBarrier = {};         │  │    │
│  │  │ aliasBarrier.Type = D3D12_RESOURCE_BARRIER_TYPE_ALIASING;│  │    │
│  │  │ aliasBarrier.Aliasing.pResourceBefore = ResourceA;│  │    │
│  │  │ aliasBarrier.Aliasing.pResourceAfter = ResourceB; │  │    │
│  │  │                                                   │  │    │
│  │  │ CommandList->ResourceBarrier(1, &aliasBarrier);   │  │    │
│  │  └───────────────────────────────────────────────────┘  │    │
│  │                                                          │    │
│  │  用途: 一時リソースのメモリ再利用                        │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 3. スレッディングモデル

### 3.1 コマンド記録のスレッディング

```
┌─────────────────────────────────────────────────────────────────┐
│             コマンド記録のスレッディング                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  D3D12のスレッドセーフティ:                                      │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  スレッドセーフ:                                         │    │
│  │  ├── ID3D12Device の大部分のメソッド                     │    │
│  │  ├── リソース作成                                        │    │
│  │  └── デスクリプタ作成                                    │    │
│  │                                                          │    │
│  │  スレッドセーフではない:                                 │    │
│  │  ├── ID3D12GraphicsCommandList (各リストは単一スレッド)  │    │
│  │  ├── ID3D12CommandAllocator (各アロケータは単一スレッド) │    │
│  │  └── ID3D12CommandQueue::ExecuteCommandLists             │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  並列コマンド記録パターン:                                       │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  ┌─────────────────────────────────────────────────┐    │    │
│  │  │                  Main Thread                     │    │    │
│  │  │  ┌────────────────────────────────────────────┐ │    │    │
│  │  │  │ フレーム開始                               │ │    │    │
│  │  │  │ タスク分配                                  │ │    │    │
│  │  │  └────────────────────────────────────────────┘ │    │    │
│  │  └────────────────┬────────────────────────────────┘    │    │
│  │                   │                                      │    │
│  │       ┌──────────┼──────────┬──────────┐                │    │
│  │       ▼          ▼          ▼          ▼                │    │
│  │  ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐           │    │
│  │  │Worker 1│ │Worker 2│ │Worker 3│ │Worker 4│           │    │
│  │  │CmdList1│ │CmdList2│ │CmdList3│ │CmdList4│           │    │
│  │  │Alloc 1 │ │Alloc 2 │ │Alloc 3 │ │Alloc 4 │           │    │
│  │  └────────┘ └────────┘ └────────┘ └────────┘           │    │
│  │       │          │          │          │                │    │
│  │       └──────────┴──────────┴──────────┘                │    │
│  │                   │                                      │    │
│  │                   ▼                                      │    │
│  │  ┌─────────────────────────────────────────────────┐    │    │
│  │  │                  Main Thread                     │    │    │
│  │  │  ExecuteCommandLists([List1, List2, List3, List4])│   │    │
│  │  └─────────────────────────────────────────────────┘    │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  注意点:                                                         │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  1. 各ワーカーは専用の CommandList と Allocator を使用  │    │
│  │  2. 状態追跡はスレッドローカルまたはロック必要           │    │
│  │  3. ExecuteCommandLists は実行順序を保証                │    │
│  │  4. 依存関係はコマンドリストの順序で表現                │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 UE5 の RHI スレッディング

```
┌─────────────────────────────────────────────────────────────────┐
│              UE5 の RHI スレッディング                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  スレッドの種類:                                                 │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  Game Thread:                                            │    │
│  │  └── ゲームロジック、アクター更新                        │    │
│  │                                                          │    │
│  │  Render Thread:                                          │    │
│  │  └── 描画コマンドの生成 (高レベル)                       │    │
│  │      FRHICommandList への追加                           │    │
│  │                                                          │    │
│  │  RHI Thread:                                             │    │
│  │  └── RHI コマンドの実行 (プラットフォーム API 呼び出し) │    │
│  │      実際の D3D12/Vulkan コマンド発行                   │    │
│  │                                                          │    │
│  │  Task Threads:                                           │    │
│  │  └── 並列タスク (Parallel For など)                      │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  フレームの流れ:                                                 │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  Frame N        Frame N+1       Frame N+2               │    │
│  │  ┌─────────────────────────────────────────────────┐    │    │
│  │  │ Game:    [Tick N  ][Tick N+1][Tick N+2]         │    │    │
│  │  │                                                  │    │    │
│  │  │ Render:       [Draw N  ][Draw N+1][Draw N+2]    │    │    │
│  │  │                                                  │    │    │
│  │  │ RHI:               [Exec N  ][Exec N+1][Exec..]│    │    │
│  │  │                                                  │    │    │
│  │  │ GPU:                    [GPU N  ][GPU N+1][...] │    │    │
│  │  └─────────────────────────────────────────────────┘    │    │
│  │                                                          │    │
│  │  パイプライン化により各スレッドが並行動作                │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  FRHICommandList の役割:                                         │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  Render Thread:                                          │    │
│  │  ┌───────────────────────────────────────────────────┐  │    │
│  │  │ RHICmdList.SetRenderTarget(...)                   │  │    │
│  │  │ RHICmdList.DrawPrimitive(...)                     │  │    │
│  │  │ // → コマンドをキューに追加 (軽量)                │  │    │
│  │  └───────────────────────────────────────────────────┘  │    │
│  │                     │                                    │    │
│  │                     │ (コマンドキュー)                   │    │
│  │                     ▼                                    │    │
│  │  RHI Thread:                                             │    │
│  │  ┌───────────────────────────────────────────────────┐  │    │
│  │  │ // コマンドをデキューして実行                     │  │    │
│  │  │ Context->SetRenderTargets(...)                    │  │    │
│  │  │ Context->DrawPrimitive(...)                       │  │    │
│  │  │ // → 実際のAPI呼び出し                           │  │    │
│  │  └───────────────────────────────────────────────────┘  │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 4. 一時リソースとエイリアシング

### 4.1 Transient Resource Allocator

```
┌─────────────────────────────────────────────────────────────────┐
│           Transient Resource Allocator                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  概念: フレーム内でのみ使用するリソースのメモリ効率化            │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  非効率な方法 (毎リソースに専用メモリ):                  │    │
│  │  ┌───────────────────────────────────────────────────┐  │    │
│  │  │ GBuffer A: [================]                     │  │    │
│  │  │ GBuffer B: [================]                     │  │    │
│  │  │ Shadow:    [================]                     │  │    │
│  │  │ PostFX A:  [================]                     │  │    │
│  │  │ PostFX B:  [================]                     │  │    │
│  │  │                                                   │  │    │
│  │  │ 合計: 5x メモリ使用                              │  │    │
│  │  └───────────────────────────────────────────────────┘  │    │
│  │                                                          │    │
│  │  効率的な方法 (エイリアシング):                          │    │
│  │  ┌───────────────────────────────────────────────────┐  │    │
│  │  │ 時間: ─────────────────────────────────────────▶  │  │    │
│  │  │                                                   │  │    │
│  │  │ Memory Pool:                                      │  │    │
│  │  │ ┌─────────────────────────────────────────────┐  │  │    │
│  │  │ │[GBuffer A][GBuffer B][ Shadow ][PostFX   ] │  │  │    │
│  │  │ │     │          │         │         │        │  │  │    │
│  │  │ │     ▼          ▼         ▼         ▼        │  │  │    │
│  │  │ │  使用終了   使用終了  使用終了  使用終了    │  │  │    │
│  │  │ │     │          │         │         │        │  │  │    │
│  │  │ │     └──────────┴─────────┘         │        │  │  │    │
│  │  │ │              ↓                     ↓        │  │  │    │
│  │  │ │     [  PostFX A  ][  PostFX B  ]            │  │  │    │
│  │  │ │     (メモリ再利用)                          │  │  │    │
│  │  │ └─────────────────────────────────────────────┘  │  │    │
│  │  │                                                   │  │    │
│  │  │ 合計: 2-3x メモリ使用 (ピーク時)                 │  │    │
│  │  └───────────────────────────────────────────────────┘  │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  実装のポイント:                                                 │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  1. ライフタイム追跡                                     │    │
│  │     - リソースがいつからいつまで使用されるか記録        │    │
│  │                                                          │    │
│  │  2. オーバーラップ検出                                   │    │
│  │     - ライフタイムが重ならないリソースを特定            │    │
│  │                                                          │    │
│  │  3. メモリ割り当て                                       │    │
│  │     - 同じヒープ領域に配置                               │    │
│  │     - Placed Resource として作成                         │    │
│  │                                                          │    │
│  │  4. エイリアシングバリア                                 │    │
│  │     - リソース切り替え時にバリア挿入                     │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 4.2 リソースライフタイム管理

```
┌─────────────────────────────────────────────────────────────────┐
│            リソースライフタイム管理                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  レンダーグラフでのライフタイム計算:                             │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  Pass順序とリソース使用:                                 │    │
│  │  ┌───────────────────────────────────────────────────┐  │    │
│  │  │ Pass 0 (GBuffer):                                 │  │    │
│  │  │   Write: GBufferA, GBufferB, Depth               │  │    │
│  │  │                                                   │  │    │
│  │  │ Pass 1 (Shadow):                                  │  │    │
│  │  │   Write: ShadowMap                                │  │    │
│  │  │                                                   │  │    │
│  │  │ Pass 2 (Lighting):                                │  │    │
│  │  │   Read: GBufferA, GBufferB, Depth, ShadowMap     │  │    │
│  │  │   Write: SceneColor                              │  │    │
│  │  │                                                   │  │    │
│  │  │ Pass 3 (PostProcess):                             │  │    │
│  │  │   Read: SceneColor                               │  │    │
│  │  │   Write: FinalOutput                             │  │    │
│  │  └───────────────────────────────────────────────────┘  │    │
│  │                                                          │    │
│  │  ライフタイム計算結果:                                   │    │
│  │  ┌───────────────────────────────────────────────────┐  │    │
│  │  │ Resource    │ First Use │ Last Use │ Lifetime    │  │    │
│  │  │─────────────┼───────────┼──────────┼─────────────│  │    │
│  │  │ GBufferA    │ Pass 0    │ Pass 2   │ [0, 2]     │  │    │
│  │  │ GBufferB    │ Pass 0    │ Pass 2   │ [0, 2]     │  │    │
│  │  │ Depth       │ Pass 0    │ Pass 2   │ [0, 2]     │  │    │
│  │  │ ShadowMap   │ Pass 1    │ Pass 2   │ [1, 2]     │  │    │
│  │  │ SceneColor  │ Pass 2    │ Pass 3   │ [2, 3]     │  │    │
│  │  │ FinalOutput │ Pass 3    │ Pass 3   │ [3, 3]     │  │    │
│  │  └───────────────────────────────────────────────────┘  │    │
│  │                                                          │    │
│  │  エイリアシング可能:                                     │    │
│  │  - GBufferA/B と FinalOutput (ライフタイム重複なし)     │    │
│  │  - ShadowMap と SceneColor (Pass 2で同時使用のため不可)│    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 5. シェーダーコンパイルパイプライン

### 5.1 シェーダーコンパイルの流れ

```
┌─────────────────────────────────────────────────────────────────┐
│            シェーダーコンパイルの流れ                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  オフラインコンパイル (クック時):                                │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  [.usf/.ush ソース]                                      │    │
│  │         │                                                │    │
│  │         ▼ プリプロセス                                   │    │
│  │  [HLSL (UE拡張)]                                         │    │
│  │         │                                                │    │
│  │         ▼ ShaderCompilerWorker                           │    │
│  │  ┌──────┴──────┬──────────┬───────────┐                 │    │
│  │  ▼             ▼          ▼           ▼                 │    │
│  │ [DXC]       [SPIRV-Cross] [Metal]   [GLSL]              │    │
│  │  │             │          │           │                 │    │
│  │  ▼             ▼          ▼           ▼                 │    │
│  │ [DXIL]      [SPIR-V]   [AIR]     [GLSL ES]             │    │
│  │  │             │          │           │                 │    │
│  │  └──────┬──────┴──────────┴───────────┘                 │    │
│  │         ▼                                                │    │
│  │  [.ushaderbytecode (シリアライズ)]                       │    │
│  │         │                                                │    │
│  │         ▼                                                │    │
│  │  [DDC (Derived Data Cache)]                              │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  ランタイムロード:                                               │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  [.ushaderbytecode]                                      │    │
│  │         │                                                │    │
│  │         ▼ デシリアライズ                                 │    │
│  │  [バイトコード + メタデータ]                             │    │
│  │         │                                                │    │
│  │         ▼ RHI シェーダー作成                             │    │
│  │  ┌──────┴──────────────────────────────┐                │    │
│  │  │ D3D12:                              │                │    │
│  │  │   バイトコードをそのまま保持        │                │    │
│  │  │   (PSO作成時に使用)                 │                │    │
│  │  │                                      │                │    │
│  │  │ Vulkan:                              │                │    │
│  │  │   VkShaderModule 作成               │                │    │
│  │  │                                      │                │    │
│  │  │ Metal:                               │                │    │
│  │  │   MTLLibrary から MTLFunction 取得  │                │    │
│  │  └─────────────────────────────────────┘                │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 5.2 シェーダーリフレクション

```
┌─────────────────────────────────────────────────────────────────┐
│              シェーダーリフレクション                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  リフレクションで取得する情報:                                   │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  リソースバインディング:                                 │    │
│  │  ┌───────────────────────────────────────────────────┐  │    │
│  │  │ struct FShaderResourceBinding {                   │  │    │
│  │  │     FString Name;        // "g_Texture"          │  │    │
│  │  │     EShaderResourceType Type; // SRV, UAV, CBV...│  │    │
│  │  │     uint32 BindPoint;    // register(t0) → 0     │  │    │
│  │  │     uint32 BindCount;    // 配列サイズ            │  │    │
│  │  │     uint32 Space;        // register space       │  │    │
│  │  │ };                                                │  │    │
│  │  └───────────────────────────────────────────────────┘  │    │
│  │                                                          │    │
│  │  コンスタントバッファ詳細:                               │    │
│  │  ┌───────────────────────────────────────────────────┐  │    │
│  │  │ struct FShaderCBMember {                          │  │    │
│  │  │     FString Name;        // "WorldMatrix"        │  │    │
│  │  │     uint32 Offset;       // バイトオフセット      │  │    │
│  │  │     uint32 Size;         // バイトサイズ          │  │    │
│  │  │     EShaderParamType Type; // Float4x4           │  │    │
│  │  │ };                                                │  │    │
│  │  │                                                   │  │    │
│  │  │ struct FShaderCBLayout {                          │  │    │
│  │  │     uint32 TotalSize;    // 全体サイズ            │  │    │
│  │  │     TArray<FShaderCBMember> Members;             │  │    │
│  │  │ };                                                │  │    │
│  │  └───────────────────────────────────────────────────┘  │    │
│  │                                                          │    │
│  │  入力/出力シグネチャ (VS):                               │    │
│  │  ┌───────────────────────────────────────────────────┐  │    │
│  │  │ struct FShaderInputElement {                      │  │    │
│  │  │     FString SemanticName;  // "POSITION"         │  │    │
│  │  │     uint32 SemanticIndex;  // 0                   │  │    │
│  │  │     EPixelFormat Format;   // PF_FloatRGB        │  │    │
│  │  │ };                                                │  │    │
│  │  └───────────────────────────────────────────────────┘  │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  D3D12でのリフレクション:                                        │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  // DXC を使用                                           │    │
│  │  IDxcContainerReflection* reflection;                    │    │
│  │  DxcCreateInstance(CLSID_DxcContainerReflection,         │    │
│  │                    IID_PPV_ARGS(&reflection));           │    │
│  │                                                          │    │
│  │  reflection->Load(shader);                               │    │
│  │  uint32 partIndex;                                       │    │
│  │  reflection->FindFirstPartKind(DXC_PART_DXIL, &partIndex);│    │
│  │                                                          │    │
│  │  ID3D12ShaderReflection* shaderReflection;               │    │
│  │  reflection->GetPartReflection(partIndex,                │    │
│  │      IID_PPV_ARGS(&shaderReflection));                  │    │
│  │                                                          │    │
│  │  // バインディング情報取得                               │    │
│  │  D3D12_SHADER_DESC desc;                                 │    │
│  │  shaderReflection->GetDesc(&desc);                       │    │
│  │  for (uint32 i = 0; i < desc.BoundResources; i++) {      │    │
│  │      D3D12_SHADER_INPUT_BIND_DESC bindDesc;              │    │
│  │      shaderReflection->GetResourceBindingDesc(i,&bindDesc);│    │
│  │      // bindDesc.Name, Type, BindPoint, BindCount...    │    │
│  │  }                                                       │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 6. エラーハンドリング

### 6.1 GPU エラーの種類

```
┌─────────────────────────────────────────────────────────────────┐
│                GPU エラーの種類                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  1. Device Removed (TDR)                                 │    │
│  │                                                          │    │
│  │  原因:                                                   │    │
│  │  ├── GPU ハング (無限ループ等)                          │    │
│  │  ├── ドライバークラッシュ                                │    │
│  │  ├── 不正なメモリアクセス                                │    │
│  │  └── 電力/熱問題                                         │    │
│  │                                                          │    │
│  │  検出:                                                   │    │
│  │  ┌───────────────────────────────────────────────────┐  │    │
│  │  │ HRESULT hr = device->GetDeviceRemovedReason();    │  │    │
│  │  │ // DXGI_ERROR_DEVICE_REMOVED                      │  │    │
│  │  │ // DXGI_ERROR_DEVICE_HUNG                         │  │    │
│  │  │ // DXGI_ERROR_DEVICE_RESET                        │  │    │
│  │  │ // DXGI_ERROR_DRIVER_INTERNAL_ERROR               │  │    │
│  │  └───────────────────────────────────────────────────┘  │    │
│  │                                                          │    │
│  │  対応:                                                   │    │
│  │  ├── DRED で詳細情報取得                                │    │
│  │  ├── デバイス再作成                                      │    │
│  │  └── リソース再構築                                      │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  2. Out of Memory                                        │    │
│  │                                                          │    │
│  │  検出:                                                   │    │
│  │  ┌───────────────────────────────────────────────────┐  │    │
│  │  │ // リソース作成時                                 │  │    │
│  │  │ HRESULT hr = device->CreateCommittedResource(...);│  │    │
│  │  │ if (hr == E_OUTOFMEMORY) {                        │  │    │
│  │  │     // メモリ不足                                 │  │    │
│  │  │ }                                                 │  │    │
│  │  └───────────────────────────────────────────────────┘  │    │
│  │                                                          │    │
│  │  対応:                                                   │    │
│  │  ├── 不要リソース解放                                    │    │
│  │  ├── テクスチャ品質低下                                  │    │
│  │  ├── ストリーミング一時停止                              │    │
│  │  └── 致命的: アプリケーション終了                        │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  3. Validation Errors (Debug Layer)                      │    │
│  │                                                          │    │
│  │  種類:                                                   │    │
│  │  ├── 不正なパラメータ                                    │    │
│  │  ├── リソースステート違反                                │    │
│  │  ├── 不正なデスクリプタ                                  │    │
│  │  └── 同期エラー                                          │    │
│  │                                                          │    │
│  │  コールバック設定:                                       │    │
│  │  ┌───────────────────────────────────────────────────┐  │    │
│  │  │ ID3D12InfoQueue* infoQueue;                       │  │    │
│  │  │ device->QueryInterface(&infoQueue);               │  │    │
│  │  │                                                   │  │    │
│  │  │ // エラー時にブレーク                             │  │    │
│  │  │ infoQueue->SetBreakOnSeverity(                    │  │    │
│  │  │     D3D12_MESSAGE_SEVERITY_ERROR, TRUE);          │  │    │
│  │  │                                                   │  │    │
│  │  │ // 特定メッセージを無視                           │  │    │
│  │  │ D3D12_INFO_QUEUE_FILTER filter = {};              │  │    │
│  │  │ D3D12_MESSAGE_ID denyIds[] = {...};               │  │    │
│  │  │ filter.DenyList.NumIDs = ARRAYSIZE(denyIds);      │  │    │
│  │  │ filter.DenyList.pIDList = denyIds;                │  │    │
│  │  │ infoQueue->AddStorageFilterEntries(&filter);      │  │    │
│  │  └───────────────────────────────────────────────────┘  │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 6.2 堅牢なエラーリカバリー

```
┌─────────────────────────────────────────────────────────────────┐
│              堅牢なエラーリカバリー                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Device Lost からの復旧:                                         │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  ┌───────────────────────────────────────────────────┐  │    │
│  │  │ 1. エラー検出                                     │  │    │
│  │  │    HRESULT hr = Present();                        │  │    │
│  │  │    if (hr == DXGI_ERROR_DEVICE_REMOVED ||         │  │    │
│  │  │        hr == DXGI_ERROR_DEVICE_RESET) {           │  │    │
│  │  │        HandleDeviceLost();                        │  │    │
│  │  │    }                                              │  │    │
│  │  └───────────────────────────────────────────────────┘  │    │
│  │                      │                                   │    │
│  │                      ▼                                   │    │
│  │  ┌───────────────────────────────────────────────────┐  │    │
│  │  │ 2. 診断情報収集                                   │  │    │
│  │  │    // DRED 情報取得                               │  │    │
│  │  │    CollectDREDInfo();                             │  │    │
│  │  │    // Aftermath 情報 (NVIDIA)                     │  │    │
│  │  │    CollectAftermathInfo();                        │  │    │
│  │  │    // ログ出力                                    │  │    │
│  │  │    LogDeviceLostInfo();                           │  │    │
│  │  └───────────────────────────────────────────────────┘  │    │
│  │                      │                                   │    │
│  │                      ▼                                   │    │
│  │  ┌───────────────────────────────────────────────────┐  │    │
│  │  │ 3. リソースクリーンアップ                         │  │    │
│  │  │    // すべての参照を解放                          │  │    │
│  │  │    ReleaseAllResources();                         │  │    │
│  │  │    ReleaseAllCommandLists();                      │  │    │
│  │  │    ReleaseAllDescriptorHeaps();                   │  │    │
│  │  │    ReleaseDevice();                               │  │    │
│  │  │    ReleaseAdapter();                              │  │    │
│  │  │    ReleaseFactory();                              │  │    │
│  │  └───────────────────────────────────────────────────┘  │    │
│  │                      │                                   │    │
│  │                      ▼                                   │    │
│  │  ┌───────────────────────────────────────────────────┐  │    │
│  │  │ 4. デバイス再作成                                 │  │    │
│  │  │    CreateDXGIFactory();                           │  │    │
│  │  │    EnumerateAdapters();                           │  │    │
│  │  │    CreateDevice();                                │  │    │
│  │  │    CreateCommandQueues();                         │  │    │
│  │  └───────────────────────────────────────────────────┘  │    │
│  │                      │                                   │    │
│  │                      ▼                                   │    │
│  │  ┌───────────────────────────────────────────────────┐  │    │
│  │  │ 5. リソース再作成                                 │  │    │
│  │  │    RecreateSwapChain();                           │  │    │
│  │  │    RecreatePipelineStates();                      │  │    │
│  │  │    RecreateRenderTargets();                       │  │    │
│  │  │    ReloadTextures();                              │  │    │
│  │  │    // ... 全リソース再構築                        │  │    │
│  │  └───────────────────────────────────────────────────┘  │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 7. 機能レベルとケイパビリティ

### 7.1 機能レベル検出

```
┌─────────────────────────────────────────────────────────────────┐
│               機能レベル検出                                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  D3D12 Feature Levels:                                           │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  D3D_FEATURE_LEVEL_11_0: 基本 D3D11 機能                │    │
│  │  D3D_FEATURE_LEVEL_11_1: D3D11.1 追加機能               │    │
│  │  D3D_FEATURE_LEVEL_12_0: Resource Binding Tier 2        │    │
│  │  D3D_FEATURE_LEVEL_12_1: RTAS, Wave Operations         │    │
│  │  D3D_FEATURE_LEVEL_12_2: DXR 1.1, Mesh Shaders, Sampler Feedback│
│  │                                                          │    │
│  │  検出:                                                   │    │
│  │  ┌───────────────────────────────────────────────────┐  │    │
│  │  │ D3D_FEATURE_LEVEL featureLevels[] = {             │  │    │
│  │  │     D3D_FEATURE_LEVEL_12_2,                       │  │    │
│  │  │     D3D_FEATURE_LEVEL_12_1,                       │  │    │
│  │  │     D3D_FEATURE_LEVEL_12_0,                       │  │    │
│  │  │     D3D_FEATURE_LEVEL_11_1,                       │  │    │
│  │  │     D3D_FEATURE_LEVEL_11_0,                       │  │    │
│  │  │ };                                                │  │    │
│  │  │                                                   │  │    │
│  │  │ D3D12_FEATURE_DATA_FEATURE_LEVELS featureData;   │  │    │
│  │  │ featureData.NumFeatureLevels = ARRAYSIZE(...);    │  │    │
│  │  │ featureData.pFeatureLevelsRequested = featureLevels;│  │    │
│  │  │                                                   │  │    │
│  │  │ device->CheckFeatureSupport(                      │  │    │
│  │  │     D3D12_FEATURE_FEATURE_LEVELS,                │  │    │
│  │  │     &featureData, sizeof(featureData));          │  │    │
│  │  │                                                   │  │    │
│  │  │ // featureData.MaxSupportedFeatureLevel に結果    │  │    │
│  │  └───────────────────────────────────────────────────┘  │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 7.2 オプショナル機能の検出

```
┌─────────────────────────────────────────────────────────────────┐
│            オプショナル機能の検出                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  主要なオプショナル機能と検出方法                        │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  Ray Tracing:                                                    │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  D3D12_FEATURE_DATA_D3D12_OPTIONS5 options5 = {};       │    │
│  │  device->CheckFeatureSupport(D3D12_FEATURE_D3D12_OPTIONS5,│    │
│  │      &options5, sizeof(options5));                       │    │
│  │                                                          │    │
│  │  bool hasRayTracing =                                    │    │
│  │      options5.RaytracingTier >= D3D12_RAYTRACING_TIER_1_0;│    │
│  │  bool hasInlineRayTracing =                              │    │
│  │      options5.RaytracingTier >= D3D12_RAYTRACING_TIER_1_1;│    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  Mesh Shaders:                                                   │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  D3D12_FEATURE_DATA_D3D12_OPTIONS7 options7 = {};       │    │
│  │  device->CheckFeatureSupport(D3D12_FEATURE_D3D12_OPTIONS7,│    │
│  │      &options7, sizeof(options7));                       │    │
│  │                                                          │    │
│  │  bool hasMeshShaders =                                   │    │
│  │      options7.MeshShaderTier >= D3D12_MESH_SHADER_TIER_1;│    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  Variable Rate Shading:                                          │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  D3D12_FEATURE_DATA_D3D12_OPTIONS6 options6 = {};       │    │
│  │  device->CheckFeatureSupport(D3D12_FEATURE_D3D12_OPTIONS6,│    │
│  │      &options6, sizeof(options6));                       │    │
│  │                                                          │    │
│  │  bool hasVRS =                                           │    │
│  │      options6.VariableShadingRateTier >=                │    │
│  │      D3D12_VARIABLE_SHADING_RATE_TIER_1;                │    │
│  │  bool hasVRSImage =                                      │    │
│  │      options6.VariableShadingRateTier >=                │    │
│  │      D3D12_VARIABLE_SHADING_RATE_TIER_2;                │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  Sampler Feedback:                                               │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  D3D12_FEATURE_DATA_D3D12_OPTIONS7 options7 = {};       │    │
│  │  // ...                                                  │    │
│  │  bool hasSamplerFeedback =                               │    │
│  │      options7.SamplerFeedbackTier >=                    │    │
│  │      D3D12_SAMPLER_FEEDBACK_TIER_0_9;                   │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  Work Graphs:                                                    │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  D3D12_FEATURE_DATA_D3D12_OPTIONS21 options21 = {};     │    │
│  │  device->CheckFeatureSupport(                            │    │
│  │      D3D12_FEATURE_D3D12_OPTIONS21,                     │    │
│  │      &options21, sizeof(options21));                    │    │
│  │                                                          │    │
│  │  bool hasWorkGraphs =                                    │    │
│  │      options21.WorkGraphsTier >=                        │    │
│  │      D3D12_WORK_GRAPHS_TIER_1_0;                        │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  Resource Binding Tier:                                          │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  D3D12_FEATURE_DATA_D3D12_OPTIONS options = {};         │    │
│  │  device->CheckFeatureSupport(D3D12_FEATURE_D3D12_OPTIONS,│    │
│  │      &options, sizeof(options));                        │    │
│  │                                                          │    │
│  │  // Tier 1: 制限あり (最大 64 SRV/UAV)                  │    │
│  │  // Tier 2: 大きなテーブル (最大 1M デスクリプタ)       │    │
│  │  // Tier 3: フルバインドレス                            │    │
│  │  bool hasBindless =                                      │    │
│  │      options.ResourceBindingTier >=                     │    │
│  │      D3D12_RESOURCE_BINDING_TIER_3;                     │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## まとめ: 完全実装チェックリスト

```
┌─────────────────────────────────────────────────────────────────┐
│                完全実装チェックリスト                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Part 1-2: 基盤                                                  │
│  □ モジュール設定                                               │
│  □ FDynamicRHI                                                  │
│  □ Adapter/Device/Queue                                         │
│  □ コマンドコンテキスト/リスト/アロケーター                     │
│  □ Buffer/Texture/View                                          │
│                                                                  │
│  Part 3: パイプライン                                            │
│  □ シェーダー                                                   │
│  □ パイプラインステート (Graphics/Compute)                      │
│  □ ルートシグネチャ                                             │
│  □ フェンス/同期                                                │
│  □ デスクリプタヒープ                                           │
│  □ メモリアロケーター                                           │
│                                                                  │
│  Part 4: 高度な機能                                              │
│  □ レイトレーシング (オプション)                                │
│  □ ワークグラフ (オプション)                                    │
│  □ マルチGPU (オプション)                                       │
│  □ フレーム管理                                                 │
│                                                                  │
│  Part 5: 描画フロー                                              │
│  □ スワップチェーン/Present                                     │
│  □ レンダーパス                                                 │
│  □ 描画コマンド (Draw/DrawIndexed/Indirect/Mesh)                │
│  □ コピーコマンド                                               │
│  □ 状態バインディング                                           │
│  □ クエリシステム                                               │
│  □ デバッグマーカー                                             │
│                                                                  │
│  Part 6: 技術詳細 (このドキュメント)                             │
│  □ ピクセルフォーマット変換テーブル                             │
│  □ フォーマットサポートチェック                                 │
│  □ リソース状態追跡システム                                     │
│  □ バリアのバッチ処理                                           │
│  □ UAV/エイリアシングバリア                                     │
│  □ スレッディングモデル                                         │
│  □ 並列コマンド記録                                             │
│  □ 一時リソース/エイリアシング                                  │
│  □ シェーダーコンパイルパイプライン                             │
│  □ シェーダーリフレクション                                     │
│  □ Device Lost 処理                                             │
│  □ OOM 処理                                                     │
│  □ バリデーションエラー処理                                     │
│  □ 機能レベル検出                                               │
│  □ オプショナル機能検出                                         │
│                                                                  │
│  テスト/検証:                                                    │
│  □ Debug Layer 有効化                                           │
│  □ GPU ベースバリデーション                                     │
│  □ PIX/RenderDoc キャプチャ                                     │
│  □ パフォーマンスプロファイリング                               │
│  □ メモリリーク検出                                             │
│  □ Device Lost テスト                                           │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

これで RHI 実装に必要な全トピックを網羅しました。
