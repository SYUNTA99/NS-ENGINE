# Unreal Engine 5.7 RHI アーキテクチャ解説

## 目次

1. [概要](#1-概要)
2. [全体アーキテクチャ](#2-全体アーキテクチャ)
3. [階層構造](#3-階層構造)
4. [コアインターフェース](#4-コアインターフェース)
5. [リソースシステム](#5-リソースシステム)
6. [コマンド実行フロー](#6-コマンド実行フロー)
7. [メモリ管理](#7-メモリ管理)
8. [同期メカニズム](#8-同期メカニズム)
9. [プラットフォーム実装一覧](#9-プラットフォーム実装一覧)
10. [新規RHI作成ガイド](#10-新規rhi作成ガイド)

---

## 1. 概要

### RHIとは

**RHI（Rendering Hardware Interface）** は、Unreal Engineのレンダリングシステムとグラフィックスハードウェアの間に位置する抽象化レイヤーです。

```
┌─────────────────────────────────────────┐
│         ゲーム / エンジンコード           │
│    （マテリアル、メッシュ、ライティング等）   │
└─────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────┐
│              Renderer                    │
│     （Deferred/Forward、シャドウ等）       │
└─────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────┐
│           RHI 抽象化レイヤー              │  ← ここ
│    （プラットフォーム非依存のAPI）          │
└─────────────────────────────────────────┘
                    │
        ┌───────────┼───────────┐
        ▼           ▼           ▼
   ┌─────────┐ ┌─────────┐ ┌─────────┐
   │ D3D12   │ │ Vulkan  │ │  Metal  │  ...
   │   RHI   │ │   RHI   │ │   RHI   │
   └─────────┘ └─────────┘ └─────────┘
        │           │           │
        ▼           ▼           ▼
   ┌─────────┐ ┌─────────┐ ┌─────────┐
   │DirectX12│ │ Vulkan  │ │  Metal  │
   │  Driver │ │ Driver  │ │ Driver  │
   └─────────┘ └─────────┘ └─────────┘
```

### RHIの役割

| 役割 | 説明 |
|------|------|
| **抽象化** | 異なるグラフィックスAPIの差異を吸収し、統一されたインターフェースを提供 |
| **移植性** | 同一のレンダリングコードが複数プラットフォームで動作可能 |
| **最適化** | 各プラットフォーム固有の最適化をRHI層で実装可能 |
| **拡張性** | 新しいグラフィックスAPIのサポートを追加しやすい設計 |

---

## 2. 全体アーキテクチャ

### モジュール構成

```
Engine/Source/Runtime/
├── RHI/                    # コアRHIモジュール（インターフェース定義）
│   ├── Public/             # 公開ヘッダー（55ファイル）
│   └── Private/            # 実装（32ファイル）
│
├── RHICore/                # 共通ユーティリティ（30ファイル）
│
├── D3D12RHI/               # DirectX 12 実装（109ファイル）
├── VulkanRHI/              # Vulkan 実装（94ファイル）
├── Apple/MetalRHI/         # Metal 実装（101ファイル）
├── Windows/D3D11RHI/       # DirectX 11 実装（34ファイル）
└── OpenGLDrv/              # OpenGL 実装（60ファイル）
```

### 主要ファイルの役割

| ファイル | 役割 |
|----------|------|
| `RHI.h` | RHI全体の定義、グローバル関数、ヘルパー |
| `DynamicRHI.h` | 動的RHIインターフェース（各プラットフォームが実装） |
| `RHIContext.h` | コマンド記録用コンテキストインターフェース |
| `RHIResources.h` | リソース（バッファ、テクスチャ等）の基底クラス |
| `RHICommandList.h` | コマンドリスト（描画コマンドのキュー） |

---

## 3. 階層構造

### RHI → Adapter → Device → Queue

RHIは以下の階層構造で物理ハードウェアを抽象化しています。

```
┌─────────────────────────────────────────────────────────────┐
│                        FDynamicRHI                          │
│                    （RHI最上位オブジェクト）                   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                    Adapter (GPU)                     │   │
│  │              （1つの物理GPU/GPU群を表現）              │   │
│  │                                                      │   │
│  │  ┌──────────────────┐  ┌──────────────────┐        │   │
│  │  │     Device       │  │     Device       │        │   │
│  │  │  （GPUノード0）   │  │  （GPUノード1）   │        │   │
│  │  │                  │  │   ※SLI/CFX時    │        │   │
│  │  │  ┌────────────┐ │  │                  │        │   │
│  │  │  │   Queue    │ │  │                  │        │   │
│  │  │  │ (Graphics) │ │  │                  │        │   │
│  │  │  └────────────┘ │  │                  │        │   │
│  │  │  ┌────────────┐ │  │                  │        │   │
│  │  │  │   Queue    │ │  │                  │        │   │
│  │  │  │ (Compute)  │ │  │                  │        │   │
│  │  │  └────────────┘ │  │                  │        │   │
│  │  │  ┌────────────┐ │  │                  │        │   │
│  │  │  │   Queue    │ │  │                  │        │   │
│  │  │  │  (Copy)    │ │  │                  │        │   │
│  │  │  └────────────┘ │  │                  │        │   │
│  │  └──────────────────┘  └──────────────────┘        │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                 Adapter (別のGPU)                    │   │
│  │            （例：内蔵GPU + 外付けGPU構成時）           │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

### 各階層の説明

#### FDynamicRHI（RHI本体）

- **役割**: RHI全体を管理する最上位オブジェクト
- **責務**:
  - アダプターの列挙と選択
  - リソース作成の統括
  - フレーム管理
- **グローバル変数**: `GDynamicRHI`

#### Adapter（アダプター）

- **役割**: 1つの物理GPU（またはSLI/CrossFireでリンクされたGPU群）を表現
- **責務**:
  - GPUの機能・能力情報の保持
  - 共有リソース（パイプラインステートキャッシュ等）の管理
  - 複数デバイスノードの管理
- **具体例**: NVIDIA RTX 4090、AMD RX 7900 XT等

#### Device（デバイス）

- **役割**: Adapter内の1つのGPUノードを表現
- **責務**:
  - コマンドキューの所有
  - メモリアロケーターの管理
  - デスクリプタヒープの管理
- **備考**: 通常は1 Adapter = 1 Device。SLI時は1 Adapter = 複数 Device

#### Queue（キュー）

- **役割**: GPUへのコマンド送信パイプライン
- **種類**:
  - **Direct (Graphics)**: 描画 + コンピュート
  - **Async Compute**: 非同期コンピュート専用
  - **Copy**: データ転送専用
- **責務**: コマンドリストの実行、フェンス管理

### 構成パターン例

| 構成 | Adapter数 | Device数/Adapter | 説明 |
|------|-----------|------------------|------|
| シングルGPU | 1 | 1 | 最も一般的 |
| SLI/CrossFire | 1 | 2+ | 同種GPUのリンク |
| 内蔵+外付け | 2 | 各1 | ノートPC等 |
| マルチGPU独立 | 複数 | 各1 | ワークステーション |

---

## 4. コアインターフェース

### FDynamicRHI

全プラットフォームRHIが実装する**メインインターフェース**です。

```
┌─────────────────────────────────────────────────────────────┐
│                       FDynamicRHI                           │
├─────────────────────────────────────────────────────────────┤
│ 【初期化/終了】                                              │
│   Init()          - RHI初期化                               │
│   PostInit()      - 初期化後処理                             │
│   Shutdown()      - シャットダウン                           │
│   GetName()       - RHI名取得（"D3D12", "Vulkan"等）         │
├─────────────────────────────────────────────────────────────┤
│ 【ステート作成】                                             │
│   RHICreateSamplerState()      - サンプラー                 │
│   RHICreateRasterizerState()   - ラスタライザ                │
│   RHICreateDepthStencilState() - 深度ステンシル              │
│   RHICreateBlendState()        - ブレンド                   │
├─────────────────────────────────────────────────────────────┤
│ 【シェーダー作成】                                           │
│   RHICreateVertexShader()      - 頂点シェーダー              │
│   RHICreatePixelShader()       - ピクセルシェーダー           │
│   RHICreateComputeShader()     - コンピュートシェーダー       │
│   RHICreateGeometryShader()    - ジオメトリシェーダー         │
│   RHICreateMeshShader()        - メッシュシェーダー           │
├─────────────────────────────────────────────────────────────┤
│ 【パイプライン作成】                                         │
│   RHICreateGraphicsPipelineState() - グラフィックスPSO       │
│   RHICreateComputePipelineState()  - コンピュートPSO         │
├─────────────────────────────────────────────────────────────┤
│ 【リソース作成】                                             │
│   RHICreateBufferInitializer()     - バッファ               │
│   RHICreateTextureInitializer()    - テクスチャ              │
│   RHICreateUniformBuffer()         - ユニフォームバッファ     │
│   RHICreateShaderResourceView()    - SRV                    │
│   RHICreateUnorderedAccessView()   - UAV                    │
├─────────────────────────────────────────────────────────────┤
│ 【Viewport】                                                │
│   RHICreateViewport()              - ビューポート作成        │
│   RHIResizeViewport()              - リサイズ               │
│   RHIGetViewportBackBuffer()       - バックバッファ取得      │
├─────────────────────────────────────────────────────────────┤
│ 【コマンド実行】                                             │
│   RHIGetDefaultContext()           - デフォルトコンテキスト  │
│   RHIGetCommandContext()           - コマンドコンテキスト取得 │
│   RHIFinalizeContext()             - コンテキスト終了        │
│   RHISubmitCommandLists()          - コマンドリスト送信      │
├─────────────────────────────────────────────────────────────┤
│ 【フレーム管理】                                             │
│   RHIEndFrame()                    - フレーム終了            │
│   RHITick()                        - 毎フレーム更新          │
└─────────────────────────────────────────────────────────────┘
```

### IRHICommandContext（コマンドコンテキスト）

GPUコマンドを記録するインターフェースです。

```
┌─────────────────────────────────────────────────────────────┐
│                    IRHIComputeContext                       │
│                  （コンピュート共通機能）                      │
├─────────────────────────────────────────────────────────────┤
│ 【パイプライン設定】                                         │
│   RHISetComputePipelineState()                              │
├─────────────────────────────────────────────────────────────┤
│ 【ディスパッチ】                                             │
│   RHIDispatchComputeShader()                                │
│   RHIDispatchIndirectComputeShader()                        │
├─────────────────────────────────────────────────────────────┤
│ 【リソース遷移】                                             │
│   RHIBeginTransitions()                                     │
│   RHIEndTransitions()                                       │
├─────────────────────────────────────────────────────────────┤
│ 【UAVクリア】                                               │
│   RHIClearUAVFloat()                                        │
│   RHIClearUAVUint()                                         │
├─────────────────────────────────────────────────────────────┤
│ 【シェーダーパラメータ】                                      │
│   RHISetShaderParameters()                                  │
│   RHISetStaticUniformBuffers()                              │
└─────────────────────────────────────────────────────────────┘
                          │
                          │ 継承
                          ▼
┌─────────────────────────────────────────────────────────────┐
│                    IRHICommandContext                       │
│                （グラフィックス固有機能を追加）                │
├─────────────────────────────────────────────────────────────┤
│ 【パイプライン設定】                                         │
│   RHISetGraphicsPipelineState()                             │
├─────────────────────────────────────────────────────────────┤
│ 【レンダーパス】                                             │
│   RHIBeginRenderPass()                                      │
│   RHIEndRenderPass()                                        │
│   RHINextSubpass()                                          │
├─────────────────────────────────────────────────────────────┤
│ 【ビューポート/シザー】                                      │
│   RHISetViewport()                                          │
│   RHISetScissorRect()                                       │
├─────────────────────────────────────────────────────────────┤
│ 【頂点入力】                                                │
│   RHISetStreamSource()                                      │
├─────────────────────────────────────────────────────────────┤
│ 【描画コマンド】                                             │
│   RHIDrawPrimitive()                                        │
│   RHIDrawIndexedPrimitive()                                 │
│   RHIDrawPrimitiveIndirect()                                │
│   RHIDrawIndexedIndirect()                                  │
├─────────────────────────────────────────────────────────────┤
│ 【コピー操作】                                              │
│   RHICopyTexture()                                          │
│   RHICopyBufferRegion()                                     │
└─────────────────────────────────────────────────────────────┘
```

---

## 5. リソースシステム

### リソース階層

```
                      FRHIResource
                     （全リソースの基底）
                           │
           ┌───────────────┼───────────────┐
           │               │               │
           ▼               ▼               ▼
    FRHIViewableResource  FRHIState系    FRHIShader系
    （ビュー作成可能）      （ステート）     （シェーダー）
           │
     ┌─────┴─────┐
     │           │
     ▼           ▼
 FRHITexture  FRHIBuffer
 （テクスチャ）  （バッファ）
```

### リソース種別

#### テクスチャ (FRHITexture)

```
┌─────────────────────────────────────────────────────────────┐
│                       FRHITexture                           │
├─────────────────────────────────────────────────────────────┤
│ 【種類】                                                    │
│   ・Texture2D       - 2Dテクスチャ                          │
│   ・Texture2DArray  - 2Dテクスチャ配列                       │
│   ・Texture3D       - 3Dテクスチャ（ボリューム）              │
│   ・TextureCube     - キューブマップ                         │
│   ・TextureCubeArray- キューブマップ配列                     │
├─────────────────────────────────────────────────────────────┤
│ 【プロパティ】                                              │
│   ・Extent         - サイズ (Width, Height, Depth)          │
│   ・Format         - ピクセルフォーマット (EPixelFormat)     │
│   ・NumMips        - ミップマップ数                          │
│   ・NumSamples     - MSAAサンプル数                         │
│   ・Flags          - 作成フラグ (RenderTarget, UAV等)       │
├─────────────────────────────────────────────────────────────┤
│ 【関連ビュー】                                              │
│   ・ShaderResourceView (SRV)  - シェーダー読み取り用         │
│   ・UnorderedAccessView (UAV) - シェーダー読み書き用         │
│   ・RenderTargetView (RTV)    - レンダーターゲット用         │
│   ・DepthStencilView (DSV)    - 深度ステンシル用             │
└─────────────────────────────────────────────────────────────┘
```

#### バッファ (FRHIBuffer)

```
┌─────────────────────────────────────────────────────────────┐
│                        FRHIBuffer                           │
├─────────────────────────────────────────────────────────────┤
│ 【用途フラグ (EBufferUsageFlags)】                           │
│   ・VertexBuffer    - 頂点バッファ                          │
│   ・IndexBuffer     - インデックスバッファ                   │
│   ・StructuredBuffer- 構造化バッファ                         │
│   ・ByteAddressBuffer- バイトアドレスバッファ                │
│   ・IndirectBuffer  - 間接描画引数                          │
│   ・UnorderedAccess - UAVアクセス可能                       │
│   ・ShaderResource  - SRVアクセス可能                       │
├─────────────────────────────────────────────────────────────┤
│ 【プロパティ】                                              │
│   ・Size           - バッファサイズ（バイト）                │
│   ・Stride         - 要素ストライド                          │
│   ・Usage          - 使用フラグ                             │
└─────────────────────────────────────────────────────────────┘
```

### ビュー（View）システム

ビューは、リソースの特定の「見方」を定義します。

```
┌──────────────────────────────────────────────────────────────────────────┐
│                           リソースとビューの関係                           │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│   ┌─────────────┐                                                        │
│   │  Texture    │───┬──▶ SRV (シェーダーで読み取り)                       │
│   │  (2048x2048 │   │      └─ Mip 0-4, Array 0-5                        │
│   │   8 Mips    │   │                                                    │
│   │   6 Array)  │   ├──▶ UAV (コンピュートで読み書き)                     │
│   │             │   │      └─ Mip 0 only                                │
│   │             │   │                                                    │
│   │             │   ├──▶ RTV (レンダーターゲットとして)                    │
│   │             │   │      └─ Mip 0, Array 0                            │
│   │             │   │                                                    │
│   │             │   └──▶ RTV (別スライスへ)                              │
│   └─────────────┘          └─ Mip 0, Array 1                            │
│                                                                          │
│   ※1つのリソースから複数のビューを作成可能                                │
│   ※ビューごとに見える範囲（Mip、Array Slice等）を指定                     │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘
```

| ビュー種別 | 略称 | 用途 |
|-----------|------|------|
| ShaderResourceView | SRV | シェーダーからの読み取り専用アクセス |
| UnorderedAccessView | UAV | シェーダーからの読み書きアクセス |
| RenderTargetView | RTV | レンダーターゲットとしての書き込み |
| DepthStencilView | DSV | 深度/ステンシルバッファとしての使用 |

---

## 6. コマンド実行フロー

### 基本フロー

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        コマンド実行の流れ                                │
└─────────────────────────────────────────────────────────────────────────┘

    ゲームスレッド              レンダースレッド                 RHIスレッド
         │                          │                              │
         │   ┌──────────────────────┤                              │
         │   │ 1. コンテキスト取得    │                              │
         │   │    RHIGetCommandContext()                           │
         │   └──────────────────────┤                              │
         │                          │                              │
         │   ┌──────────────────────┤                              │
         │   │ 2. コマンド記録        │                              │
         │   │    RHISetPipelineState()                            │
         │   │    RHISetShaderParameters()                         │
         │   │    RHIDrawIndexedPrimitive()                        │
         │   │    ...                │                              │
         │   └──────────────────────┤                              │
         │                          │                              │
         │   ┌──────────────────────┤                              │
         │   │ 3. コンテキスト終了    │                              │
         │   │    RHIFinalizeContext()                             │
         │   │    → IRHIPlatformCommandList を返す                  │
         │   └──────────────────────┤                              │
         │                          │                              │
         │                          │      ┌───────────────────────┤
         │                          │      │ 4. GPUへ送信           │
         │                          │      │    RHISubmitCommandLists()
         │                          │      │    → ドライバへ送信     │
         │                          │      └───────────────────────┤
         │                          │                              │
         ▼                          ▼                              ▼
```

### パイプライン種別

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          ERHIPipeline                                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   Graphics Pipeline                    AsyncCompute Pipeline            │
│   ┌─────────────────────┐             ┌─────────────────────┐          │
│   │ ・頂点シェーダー      │             │ ・コンピュートシェーダー│          │
│   │ ・ピクセルシェーダー   │             │ ・非同期実行           │          │
│   │ ・ジオメトリシェーダー │             │ ・Graphicsと並列動作  │          │
│   │ ・テッセレーション    │             └─────────────────────┘          │
│   │ ・ラスタライズ        │                                             │
│   │ ・コンピュートも可能  │                                             │
│   └─────────────────────┘                                             │
│                                                                         │
│   ※通常の描画はGraphics、GPGPUやポストプロセスはAsyncComputeも利用可能    │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### コマンドリストのライフサイクル

```
    ┌─────────────┐
    │   Obtain    │  ← プールからコマンドリスト/アロケーターを取得
    └──────┬──────┘
           │
           ▼
    ┌─────────────┐
    │   Record    │  ← コマンドを記録（Open状態）
    │             │     RHISetPipelineState, RHIDraw... 等
    └──────┬──────┘
           │
           ▼
    ┌─────────────┐
    │   Close     │  ← コマンドリストを閉じる
    └──────┬──────┘
           │
           ▼
    ┌─────────────┐
    │   Execute   │  ← GPUキューに送信
    └──────┬──────┘
           │
           ▼
    ┌─────────────┐
    │   Complete  │  ← GPU実行完了（フェンスシグナル）
    └──────┬──────┘
           │
           ▼
    ┌─────────────┐
    │   Release   │  ← プールに返却（再利用）
    └─────────────┘
```

---

## 7. メモリ管理

### メモリタイプ

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         GPUメモリタイプ                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   ┌────────────────────────────────────────────────────────────────┐   │
│   │                    DEFAULT (VRAM)                              │   │
│   │  ・GPUローカルメモリ（高速）                                     │   │
│   │  ・テクスチャ、レンダーターゲット、頻繁に使うバッファ              │   │
│   │  ・CPUから直接アクセス不可（Stagingバッファ経由でコピー）          │   │
│   └────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│   ┌────────────────────────────────────────────────────────────────┐   │
│   │                    UPLOAD (CPU → GPU)                          │   │
│   │  ・CPUで書き込み、GPUで読み取り                                  │   │
│   │  ・頂点/インデックスバッファのアップロード                        │   │
│   │  ・定数バッファ（ユニフォームバッファ）                           │   │
│   │  ・Write-Combined メモリ（CPU読み取りは非常に遅い）               │   │
│   └────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│   ┌────────────────────────────────────────────────────────────────┐   │
│   │                    READBACK (GPU → CPU)                        │   │
│   │  ・GPUで書き込み、CPUで読み取り                                  │   │
│   │  ・スクリーンショット、オクルージョンクエリ結果                   │   │
│   │  ・GPUからCPUへのデータ転送用                                    │   │
│   └────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### アロケーター構成

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        メモリアロケーター                                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   FYourDevice                                                           │
│       │                                                                 │
│       ├─── DefaultBufferAllocator                                       │
│       │        └─ 汎用バッファ用                                        │
│       │           ・サブアロケーション（プール）                          │
│       │           ・大きいリソースは専用Committed Resource               │
│       │                                                                 │
│       ├─── UploadHeapAllocator                                          │
│       │        └─ CPU→GPU転送用                                         │
│       │           ・リングバッファ方式                                   │
│       │           ・フレームごとにリセット                               │
│       │                                                                 │
│       ├─── TextureAllocator                                             │
│       │        └─ テクスチャ用                                          │
│       │           ・Placed Resource（ヒープ上に配置）                    │
│       │           ・アラインメント考慮                                   │
│       │                                                                 │
│       └─── TransientAllocator                                           │
│                └─ 一時リソース用                                        │
│                   ・フレーム内でのみ有効                                 │
│                   ・メモリエイリアシング                                 │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### リソース配置戦略

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       リソース配置の種類                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   1. Committed Resource（専用割り当て）                                  │
│      ┌──────────────────────────────┐                                  │
│      │    リソース専用のメモリ領域     │                                  │
│      │    ・大きなリソース向け         │                                  │
│      │    ・レンダーターゲット等       │                                  │
│      └──────────────────────────────┘                                  │
│                                                                         │
│   2. Placed Resource（ヒープ上に配置）                                   │
│      ┌────────────────────────────────────────────────────────┐        │
│      │                      Heap                              │        │
│      │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐     │        │
│      │  │Resource1│ │Resource2│ │Resource3│ │   ...   │     │        │
│      │  └─────────┘ └─────────┘ └─────────┘ └─────────┘     │        │
│      │  ・複数リソースで1つのヒープを共有                       │        │
│      │  ・メモリ効率が良い                                    │        │
│      └────────────────────────────────────────────────────────┘        │
│                                                                         │
│   3. Sub-allocation（サブアロケーション）                                │
│      ┌────────────────────────────────────────────────────────┐        │
│      │                   大きなバッファ                        │        │
│      │  ┌────┐┌────┐┌────┐┌────┐┌────┐┌────┐┌────┐         │        │
│      │  │ A  ││ B  ││ C  ││ D  ││ E  ││ F  ││ G  │  ...    │        │
│      │  └────┘└────┘└────┘└────┘└────┘└────┘└────┘         │        │
│      │  ・小さなバッファを大きなバッファ内に配置               │        │
│      │  ・定数バッファ等で使用                                │        │
│      └────────────────────────────────────────────────────────┘        │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 8. 同期メカニズム

### フェンス（Fence）

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          フェンスの概念                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   CPU                                                                   │
│   ───┬────────────────────────────────────────────────────────────▶    │
│      │                                                                  │
│      │ Submit CmdList1    Submit CmdList2    Wait(Fence, 2)            │
│      │      │                  │                   │                    │
│      │      ▼                  ▼                   ▼                    │
│   GPU│   ┌──────┐          ┌──────┐                                    │
│   ───┼───│CmdL1 │──────────│CmdL2 │──Signal(2)─────▶                   │
│      │   └──────┘          └──────┘          │                         │
│      │                                       │                         │
│      │                              Fence Value: 1 → 2                 │
│      │                                                                  │
│   ・Signal: GPUがフェンス値をインクリメント                              │
│   ・Wait: CPU/GPUが特定のフェンス値に達するまで待機                      │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### リソース状態遷移（Barrier）

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        リソース状態遷移                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   リソースは用途に応じて「状態」を持ち、状態遷移にはバリアが必要           │
│                                                                         │
│   ┌─────────────────┐     Barrier      ┌─────────────────┐            │
│   │  RenderTarget   │ ──────────────▶ │ ShaderResource  │            │
│   │   (書き込み中)   │                  │   (読み取り)     │            │
│   └─────────────────┘                  └─────────────────┘            │
│                                                                         │
│   【主な状態】                                                           │
│   ・Common           - 汎用状態                                         │
│   ・RenderTarget     - レンダーターゲットとして書き込み                   │
│   ・DepthWrite       - 深度書き込み                                     │
│   ・DepthRead        - 深度読み取り                                     │
│   ・ShaderResource   - シェーダーで読み取り (SRV)                       │
│   ・UnorderedAccess  - シェーダーで読み書き (UAV)                       │
│   ・CopyDest         - コピー先                                         │
│   ・CopySource       - コピー元                                         │
│   ・Present          - 画面表示用                                       │
│                                                                         │
│   【バリアの目的】                                                       │
│   ・キャッシュのフラッシュ/無効化                                        │
│   ・メモリ可視性の保証                                                   │
│   ・圧縮状態の解決（一部ハードウェア）                                    │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### GPU-CPU同期パターン

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      同期パターン例                                      │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   【パターン1: フレーム同期】                                             │
│                                                                         │
│   Frame N        Frame N+1      Frame N+2                               │
│   ┌─────────┐   ┌─────────┐   ┌─────────┐                             │
│   │Render   │   │Render   │   │Render   │   ← GPU                     │
│   └────┬────┘   └────┬────┘   └────┬────┘                             │
│        │Signal       │Signal       │Signal                              │
│        ▼             ▼             ▼                                    │
│   ┌─────────┐   ┌─────────┐   ┌─────────┐                             │
│   │Wait&    │   │Wait&    │   │Wait&    │   ← CPU                     │
│   │Update   │   │Update   │   │Update   │                              │
│   └─────────┘   └─────────┘   └─────────┘                             │
│                                                                         │
│   【パターン2: リードバック】                                             │
│                                                                         │
│   GPU: Render ─▶ Copy to Readback ─▶ Signal                            │
│                                         │                               │
│   CPU: ─────────────────────── Wait ◀───┘                              │
│                                   │                                     │
│                                   ▼                                     │
│                            Map & Read Data                              │
│                                                                         │
│   【パターン3: 非同期コンピュート】                                       │
│                                                                         │
│   Graphics Queue: ──Render──┬──Render──                                │
│                             │                                           │
│   Compute Queue:  ───────Compute───────                                │
│                             │                                           │
│                        Sync Point                                       │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 9. プラットフォーム実装一覧

### 実装比較

| 項目 | D3D12RHI | VulkanRHI | MetalRHI | D3D11RHI | OpenGLDrv |
|------|----------|-----------|----------|----------|-----------|
| **対象API** | DirectX 12 | Vulkan | Metal | DirectX 11 | OpenGL/ES |
| **プラットフォーム** | Windows, Xbox | Windows, Linux, Android | iOS, macOS | Windows (Legacy) | Android, Linux |
| **ファイル数** | 109 | 94 | 101 | 34 | 60 |
| **レイトレーシング** | ○ | ○ | ○ | × | × |
| **メッシュシェーダー** | ○ | ○ | ○ | × | × |
| **Bindless** | ○ | ○ | ○ | △ | × |
| **マルチGPU** | ○ | ○ | × | × | × |

### ディレクトリ構造

```
Engine/Source/Runtime/
│
├── D3D12RHI/
│   ├── Public/
│   │   ├── D3D12RHI.h              # 公開定義
│   │   ├── ID3D12DynamicRHI.h      # 動的インターフェース
│   │   └── D3D12ShaderResources.h  # シェーダーリソース
│   └── Private/
│       ├── D3D12Adapter.h/cpp      # アダプター
│       ├── D3D12Device.h/cpp       # デバイス
│       ├── D3D12Queue.h            # キュー
│       ├── D3D12CommandContext.h/cpp # コマンドコンテキスト
│       ├── D3D12Resources.h/cpp    # リソース基底
│       ├── D3D12Texture.h/cpp      # テクスチャ
│       ├── D3D12Buffer.cpp         # バッファ
│       ├── D3D12Shader.h/cpp       # シェーダー
│       ├── D3D12PipelineState.h/cpp # PSO
│       ├── D3D12View.h/cpp         # ビュー (SRV/UAV/RTV/DSV)
│       ├── D3D12Viewport.h/cpp     # ビューポート
│       ├── D3D12Descriptors.h/cpp  # デスクリプタ管理
│       ├── D3D12Allocation.h/cpp   # メモリアロケーション
│       ├── D3D12RayTracing.h/cpp   # レイトレーシング
│       └── ...
│
├── VulkanRHI/
│   └── (同様の構造)
│
├── Apple/MetalRHI/
│   └── (同様の構造)
│
└── ...
```

---

## 10. 新規RHI作成ガイド

### 必要なコンポーネント一覧

新しいRHIバックエンドを作成する際に実装が必要なコンポーネントです。

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    新規RHI 必須コンポーネント                             │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【レベル1: 最小構成（静止画が表示できる）】                               │
│  ────────────────────────────────────────                               │
│  □ モジュール定義 (Build.cs + Module登録)                               │
│  □ FYourDynamicRHI (FDynamicRHI継承)                                    │
│  □ FYourAdapter                                                         │
│  □ FYourDevice                                                          │
│  □ FYourQueue (最低1つ: Graphics)                                       │
│  □ FYourCommandContext (IRHICommandContext実装)                         │
│  □ FYourTexture (FRHITexture継承)                                       │
│  □ FYourBuffer (FRHIBuffer継承)                                         │
│  □ FYourVertexShader / FYourPixelShader                                │
│  □ FYourGraphicsPipelineState                                           │
│  □ FYourViewport (スワップチェーン)                                      │
│  □ 基本ステート (Sampler, Rasterizer, DepthStencil, Blend)              │
│  □ 基本ビュー (SRV, RTV)                                                │
│                                                                         │
│  【レベル2: 基本機能（通常のレンダリング）】                               │
│  ────────────────────────────────────────                               │
│  □ FYourComputeShader + ComputePipelineState                            │
│  □ UAV (UnorderedAccessView)                                            │
│  □ DSV (DepthStencilView)                                               │
│  □ UniformBuffer                                                        │
│  □ フェンス/同期機構                                                     │
│  □ リソース状態遷移 (Transition/Barrier)                                │
│  □ コピーキュー (オプション)                                             │
│                                                                         │
│  【レベル3: 高度な機能】                                                  │
│  ────────────────────────────────────────                               │
│  □ AsyncComputeキュー                                                   │
│  □ ジオメトリシェーダー                                                  │
│  □ テッセレーションシェーダー                                            │
│  □ メッシュシェーダー / アンプリフィケーションシェーダー                  │
│  □ レイトレーシング                                                      │
│  □ Bindlessリソース                                                     │
│  □ マルチGPUサポート                                                     │
│  □ VRS (Variable Rate Shading)                                         │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 実装の流れ

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      RHI実装のロードマップ                               │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   Phase 1: 基盤構築                                                      │
│   ─────────────────                                                     │
│   ┌─────────────────────────────────────────────────────────────┐      │
│   │ 1. モジュール作成                                             │      │
│   │    ・Build.cs でモジュール定義                                │      │
│   │    ・IDynamicRHIModule 実装                                  │      │
│   │    ・アダプター列挙ロジック                                   │      │
│   │                                                              │      │
│   │ 2. 階層構造の実装                                             │      │
│   │    ・FYourDynamicRHI                                         │      │
│   │    ・FYourAdapter                                            │      │
│   │    ・FYourDevice                                             │      │
│   │    ・FYourQueue                                              │      │
│   └─────────────────────────────────────────────────────────────┘      │
│                              │                                          │
│                              ▼                                          │
│   Phase 2: リソース作成                                                  │
│   ─────────────────────                                                 │
│   ┌─────────────────────────────────────────────────────────────┐      │
│   │ 3. メモリ管理                                                 │      │
│   │    ・ヒープ/アロケーター                                      │      │
│   │    ・リソースロケーション                                     │      │
│   │                                                              │      │
│   │ 4. リソース実装                                               │      │
│   │    ・バッファ (FYourBuffer)                                   │      │
│   │    ・テクスチャ (FYourTexture)                                │      │
│   │    ・ビュー (SRV, UAV, RTV, DSV)                             │      │
│   └─────────────────────────────────────────────────────────────┘      │
│                              │                                          │
│                              ▼                                          │
│   Phase 3: パイプライン                                                  │
│   ─────────────────────                                                 │
│   ┌─────────────────────────────────────────────────────────────┐      │
│   │ 5. シェーダー                                                 │      │
│   │    ・各シェーダータイプ (VS, PS, CS, GS, ...)                 │      │
│   │    ・シェーダーバイトコード処理                               │      │
│   │                                                              │      │
│   │ 6. パイプラインステート                                       │      │
│   │    ・GraphicsPipelineState                                   │      │
│   │    ・ComputePipelineState                                    │      │
│   │    ・PSOキャッシュ                                            │      │
│   └─────────────────────────────────────────────────────────────┘      │
│                              │                                          │
│                              ▼                                          │
│   Phase 4: コマンド実行                                                  │
│   ─────────────────────                                                 │
│   ┌─────────────────────────────────────────────────────────────┐      │
│   │ 7. コマンドコンテキスト                                        │      │
│   │    ・IRHICommandContext 全メソッド実装                        │      │
│   │    ・ステートキャッシュ                                       │      │
│   │                                                              │      │
│   │ 8. 同期機構                                                   │      │
│   │    ・フェンス                                                 │      │
│   │    ・バリア/トランジション                                    │      │
│   └─────────────────────────────────────────────────────────────┘      │
│                              │                                          │
│                              ▼                                          │
│   Phase 5: プレゼンテーション                                            │
│   ─────────────────────────                                             │
│   ┌─────────────────────────────────────────────────────────────┐      │
│   │ 9. ビューポート/スワップチェーン                               │      │
│   │    ・FYourViewport                                           │      │
│   │    ・バックバッファ管理                                       │      │
│   │    ・Present処理                                             │      │
│   └─────────────────────────────────────────────────────────────┘      │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### FDynamicRHI 実装必須メソッド

以下は最低限実装が必要な純粋仮想関数です。

```
┌─────────────────────────────────────────────────────────────────────────┐
│                   FDynamicRHI 必須実装メソッド                           │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【初期化/終了】                                                         │
│  ・Init()                                                               │
│  ・Shutdown()                                                           │
│  ・GetName()                                                            │
│                                                                         │
│  【ステート作成】                                                        │
│  ・RHICreateSamplerState()                                              │
│  ・RHICreateRasterizerState()                                           │
│  ・RHICreateDepthStencilState()                                         │
│  ・RHICreateBlendState()                                                │
│  ・RHICreateVertexDeclaration()                                         │
│                                                                         │
│  【シェーダー作成】                                                      │
│  ・RHICreateVertexShader()                                              │
│  ・RHICreatePixelShader()                                               │
│  ・RHICreateComputeShader()                                             │
│  ・RHICreateGeometryShader()                                            │
│                                                                         │
│  【パイプライン】                                                        │
│  ・RHICreateBoundShaderState()                                          │
│  ・RHICreateGraphicsPipelineState()                                     │
│  ・RHICreateComputePipelineState()                                      │
│                                                                         │
│  【リソース】                                                            │
│  ・RHICreateUniformBuffer()                                             │
│  ・RHIUpdateUniformBuffer()                                             │
│  ・RHICreateBufferInitializer()                                         │
│  ・RHICreateTextureInitializer()                                        │
│  ・RHICreateShaderResourceView()                                        │
│  ・RHICreateUnorderedAccessView()                                       │
│  ・RHIReplaceResources()                                                │
│                                                                         │
│  【テクスチャ操作】                                                      │
│  ・RHICalcTexturePlatformSize()                                         │
│  ・RHIGetTextureMemoryStats()                                           │
│  ・RHIGetTextureMemoryVisualizeData()                                   │
│  ・RHIAsyncCreateTexture2D()                                            │
│  ・RHIAsyncReallocateTexture2D()                                        │
│  ・RHILockTexture() / RHIUnlockTexture()                                │
│  ・RHIUpdateTexture2D() / RHIUpdateTexture3D()                          │
│  ・RHIComputeMemorySize()                                               │
│                                                                         │
│  【読み取り】                                                            │
│  ・RHIReadSurfaceData()                                                 │
│  ・RHIMapStagingSurface() / RHIUnmapStagingSurface()                    │
│  ・RHIReadSurfaceFloatData()                                            │
│  ・RHIRead3DSurfaceFloatData()                                          │
│                                                                         │
│  【クエリ】                                                              │
│  ・RHICreateRenderQuery()                                               │
│  ・RHIGetRenderQueryResult()                                            │
│                                                                         │
│  【ビューポート】                                                        │
│  ・RHICreateViewport()                                                  │
│  ・RHIResizeViewport()                                                  │
│  ・RHIGetViewportBackBuffer()                                           │
│  ・RHIAdvanceFrameForGetViewportBackBuffer()                            │
│                                                                         │
│  【フレーム管理】                                                        │
│  ・RHIEndFrame()                                                        │
│  ・RHITick()                                                            │
│  ・RHIBlockUntilGPUIdle()                                               │
│  ・RHIFlushResources()                                                  │
│                                                                         │
│  【コマンド実行】                                                        │
│  ・RHIGetDefaultContext()                                               │
│  ・RHIGetCommandContext()                                               │
│  ・RHIFinalizeContext()                                                 │
│  ・RHISubmitCommandLists()                                              │
│                                                                         │
│  【同期】                                                                │
│  ・RHICreateGPUFence()                                                  │
│                                                                         │
│  【その他】                                                              │
│  ・RHIGetAvailableResolutions()                                         │
│  ・RHIGetSupportedResolution()                                          │
│  ・RHIGetNativeDevice()                                                 │
│  ・RHIGetNativeInstance()                                               │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### デバッグのヒント

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       デバッグ・検証のヒント                             │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【1. バリデーションレイヤーの活用】                                      │
│     ・D3D12: D3D12 Debug Layer                                          │
│     ・Vulkan: Validation Layers                                         │
│     ・Metal: Metal Validation                                           │
│     → APIミスの早期検出                                                 │
│                                                                         │
│  【2. GPUキャプチャツール】                                               │
│     ・RenderDoc                                                         │
│     ・PIX (Windows)                                                     │
│     ・Nsight (NVIDIA)                                                   │
│     ・Xcode GPU Frame Capture (Apple)                                   │
│     → フレーム解析、リソース状態確認                                    │
│                                                                         │
│  【3. GPU Breadcrumbs】                                                  │
│     ・WITH_RHI_BREADCRUMBS マクロ有効化                                  │
│     ・クラッシュ時のGPU実行位置特定                                      │
│                                                                         │
│  【4. 段階的実装】                                                       │
│     ・クリアカラーの表示から開始                                         │
│     ・三角形1枚の描画                                                   │
│     ・テクスチャ付き描画                                                 │
│     ・複雑なシーンへ                                                     │
│                                                                         │
│  【5. 既存RHIとの比較】                                                  │
│     ・D3D12RHIを参考実装として活用                                       │
│     ・同じ入力で同じ出力が得られるか確認                                 │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 参考資料

### 主要ソースファイル

| ファイル | パス | 説明 |
|----------|------|------|
| DynamicRHI.h | `RHI/Public/` | FDynamicRHI定義 |
| RHIContext.h | `RHI/Public/` | IRHICommandContext定義 |
| RHIResources.h | `RHI/Public/` | リソース基底クラス |
| D3D12Adapter.h | `D3D12RHI/Private/` | Adapter実装例 |
| D3D12Device.h | `D3D12RHI/Private/` | Device実装例 |
| D3D12CommandContext.h | `D3D12RHI/Private/` | CommandContext実装例 |

### 関連ドキュメント

- [Unreal Engine Documentation - RHI](https://docs.unrealengine.com/)
- [DirectX 12 Programming Guide](https://docs.microsoft.com/en-us/windows/win32/direct3d12/)
- [Vulkan Specification](https://www.khronos.org/registry/vulkan/)
- [Metal Programming Guide](https://developer.apple.com/metal/)
