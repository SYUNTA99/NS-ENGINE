# RHI 実装ガイド Part 8: ベンダー固有機能

このドキュメントでは、GPU ベンダー固有の最適化機能と拡張を解説します：

- AMD 拡張機能 (HTile, FMask)
- NVIDIA 拡張機能
- Intel 拡張機能
- Enhanced Barriers (D3D12)
- Shader Bundles

---

## 1. AMD 拡張機能

### 1.1 HTile (Hierarchical Tile)

```
┌─────────────────────────────────────────────────────────────────┐
│                     HTile 概要                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  HTileとは:                                                      │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ AMD GPU の深度バッファ最適化用メタデータ                │    │
│  │                                                          │    │
│  │ ┌──────────────────────────────────────────────────┐    │    │
│  │ │  Depth Buffer                                    │    │    │
│  │ │  ┌──────┬──────┬──────┬──────┐                  │    │    │
│  │ │  │ Tile │ Tile │ Tile │ Tile │  ← 8x8 ピクセル  │    │    │
│  │ │  ├──────┼──────┼──────┼──────┤                  │    │    │
│  │ │  │ Tile │ Tile │ Tile │ Tile │                  │    │    │
│  │ │  └──────┴──────┴──────┴──────┘                  │    │    │
│  │ │           │                                      │    │    │
│  │ │           ▼                                      │    │    │
│  │ │  HTile Metadata                                  │    │    │
│  │ │  ┌──────────────────────────────────────────┐   │    │    │
│  │ │  │ Min/Max Z │ Stencil │ Compression Info │   │    │    │
│  │ │  └──────────────────────────────────────────┘   │    │    │
│  │ └──────────────────────────────────────────────────┘    │    │
│  │                                                          │    │
│  │ 利点:                                                    │    │
│  │ ├── Hi-Z (Hierarchical Z) 高速化                        │    │
│  │ ├── 早期深度テストの効率化                              │    │
│  │ └── 深度バッファ圧縮                                    │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  ケイパビリティフラグ:                                           │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ GRHISupportsExplicitHTile     // 明示的HTileアクセス    │    │
│  │ GRHISupportsResummarizeHTile  // HTile再サマリ          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 1.2 HTile API

```
┌─────────────────────────────────────────────────────────────────┐
│                     HTile API                                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  SRV作成 (HTileメタデータ読み取り):                              │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ // HTile用SRVの作成                                     │    │
│  │ if (GRHISupportsExplicitHTile)                          │    │
│  │ {                                                        │    │
│  │     FRHIViewDesc ViewDesc;                              │    │
│  │     ViewDesc.TextureSRVDesc.MetaData =                  │    │
│  │         ERHITextureMetaDataAccess::HTile;               │    │
│  │                                                          │    │
│  │     SRV = RHICreateShaderResourceView(                  │    │
│  │         DepthTexture, ViewDesc);                        │    │
│  │ }                                                        │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  HTile再サマリ:                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ // IRHICommandContext のメソッド                        │    │
│  │ void RHIResummarizeHTile(FRHITexture* DepthTexture);    │    │
│  │                                                          │    │
│  │ // 使用例: 深度バッファ変更後にHTileを更新              │    │
│  │ if (GRHISupportsResummarizeHTile)                       │    │
│  │ {                                                        │    │
│  │     RHICmdList.ResummarizeHTile(DepthTarget);           │    │
│  │ }                                                        │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 1.3 FMask (Fragment Mask)

```
┌─────────────────────────────────────────────────────────────────┐
│                     FMask 概要                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  FMaskとは:                                                      │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ AMD GPU の MSAA 最適化用メタデータ                      │    │
│  │                                                          │    │
│  │ ┌──────────────────────────────────────────────────┐    │    │
│  │ │  MSAA Render Target (4x MSAA)                    │    │    │
│  │ │  ┌────────────────────────────────────────────┐ │    │    │
│  │ │  │ Pixel                                      │ │    │    │
│  │ │  │ ┌────┬────┬────┬────┐                      │ │    │    │
│  │ │  │ │ S0 │ S1 │ S2 │ S3 │  ← 4 サンプル       │ │    │    │
│  │ │  │ └────┴────┴────┴────┘                      │ │    │    │
│  │ │  └────────────────────────────────────────────┘ │    │    │
│  │ │            │                                     │    │    │
│  │ │            ▼                                     │    │    │
│  │ │  FMask Metadata                                  │    │    │
│  │ │  ┌────────────────────────────────────────────┐ │    │    │
│  │ │  │ サンプル間の共有情報 (圧縮用)             │ │    │    │
│  │ │  │ どのサンプルが同じ色を共有しているか      │ │    │    │
│  │ │  └────────────────────────────────────────────┘ │    │    │
│  │ └──────────────────────────────────────────────────┘    │    │
│  │                                                          │    │
│  │ 利点:                                                    │    │
│  │ ├── MSAA メモリ帯域幅の削減                             │    │
│  │ ├── MSAA リゾルブの高速化                               │    │
│  │ └── エッジ検出の効率化                                  │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  ケイパビリティフラグ:                                           │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ GRHISupportsExplicitFMask  // 明示的FMaskアクセス       │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  SRV作成:                                                        │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ if (GRHISupportsExplicitFMask)                          │    │
│  │ {                                                        │    │
│  │     FRHIViewDesc ViewDesc;                              │    │
│  │     ViewDesc.TextureSRVDesc.MetaData =                  │    │
│  │         ERHITextureMetaDataAccess::FMask;               │    │
│  │                                                          │    │
│  │     SRV = RHICreateShaderResourceView(                  │    │
│  │         MSAATexture, ViewDesc);                         │    │
│  │ }                                                        │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 2. NVIDIA 拡張機能

### 2.1 概要

```
┌─────────────────────────────────────────────────────────────────┐
│              NVIDIA 拡張機能                                     │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  D3D12RHI での NVIDIA 拡張:                                      │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ // FD3D12NvidiaExtensions                               │    │
│  │                                                          │    │
│  │ 主な機能:                                                │    │
│  │ ├── DLSS / DLSS-G (Deep Learning Super Sampling)        │    │
│  │ ├── NvAPI 統合                                          │    │
│  │ ├── Aftermath GPU クラッシュダンプ                      │    │
│  │ ├── Variable Rate Shading (VRS) 拡張                    │    │
│  │ └── Ray Tracing 拡張                                     │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  関連するケイパビリティ:                                         │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ GRHISupportsRayTracingAMDHitToken  // AMD Hit Token     │    │
│  │   ※ NVIDIA には独自の RT 最適化                         │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 3. Intel 拡張機能

```
┌─────────────────────────────────────────────────────────────────┐
│              Intel 拡張機能                                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  D3D12RHI での Intel 拡張:                                       │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ // FD3D12IntelExtensions                                │    │
│  │                                                          │    │
│  │ 主な機能:                                                │    │
│  │ ├── Intel Xe / Arc 最適化                               │    │
│  │ ├── GPU Crash Dumps 統合                                │    │
│  │ └── Intel Performance API                               │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 4. Enhanced Barriers (D3D12)

### 4.1 概要

```
┌─────────────────────────────────────────────────────────────────┐
│            Enhanced Barriers (D3D12)                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Enhanced Barriersとは:                                          │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ D3D12 の新しいバリアモデル (Tier 2+)                    │    │
│  │                                                          │    │
│  │ 従来のバリア (Legacy):                                   │    │
│  │ ┌──────────────────────────────────────────────────┐    │    │
│  │ │ D3D12_RESOURCE_BARRIER                           │    │    │
│  │ │   Type: TRANSITION / UAV / ALIASING              │    │    │
│  │ │   StateBefore / StateAfter                       │    │    │
│  │ │                                                   │    │    │
│  │ │ 問題点:                                           │    │    │
│  │ │ ├── 粒度が粗い                                    │    │    │
│  │ │ ├── 過剰な同期                                    │    │    │
│  │ │ └── サブリソース単位での制御が困難                │    │    │
│  │ └──────────────────────────────────────────────────┘    │    │
│  │                                                          │    │
│  │ Enhanced Barriers:                                       │    │
│  │ ┌──────────────────────────────────────────────────┐    │    │
│  │ │ D3D12_BARRIER_GROUP                              │    │    │
│  │ │   ├── Texture Barriers                           │    │    │
│  │ │   │   ├── Layout 遷移                            │    │    │
│  │ │   │   ├── Access 遷移                            │    │    │
│  │ │   │   └── Sync 遷移                              │    │    │
│  │ │   ├── Buffer Barriers                            │    │    │
│  │ │   └── Global Barriers                            │    │    │
│  │ │                                                   │    │    │
│  │ │ 利点:                                             │    │    │
│  │ │ ├── より細かい同期制御                            │    │    │
│  │ │ ├── パフォーマンス向上                            │    │    │
│  │ │ └── 明示的なレイアウト管理                        │    │    │
│  │ └──────────────────────────────────────────────────┘    │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 4.2 D3D12RHI での実装

```
┌─────────────────────────────────────────────────────────────────┐
│         Enhanced Barriers 実装クラス                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  クラス階層:                                                     │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │ FD3D12EnhancedBarriers                                   │    │
│  │   └── Enhanced Barriers の基本実装                       │    │
│  │                                                          │    │
│  │ FD3D12EnhancedBarriersFactory                            │    │
│  │   └── プラットフォーム別のバリアファクトリ              │    │
│  │                                                          │    │
│  │ FD3D12EnhancedBarriersForAdapter                         │    │
│  │   └── アダプター単位のバリア管理                        │    │
│  │                                                          │    │
│  │ FD3D12EnhancedBarriersForContext                         │    │
│  │   └── コンテキスト単位のバリア管理                      │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  レガシーバリアへのフォールバック:                               │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ // Enhanced Barriers 非対応時                           │    │
│  │ if (!Device->SupportsEnhancedBarriers())                │    │
│  │ {                                                        │    │
│  │     // 従来の ResourceBarrier を使用                    │    │
│  │     UseLegacyBarriers();                                │    │
│  │ }                                                        │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 5. Shader Bundles

### 5.1 概要

```
┌─────────────────────────────────────────────────────────────────┐
│                  Shader Bundles                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Shader Bundlesとは:                                             │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ 複数のシェーダーを事前にバンドル化し、                  │    │
│  │ 効率的にディスパッチする機能                            │    │
│  │                                                          │    │
│  │ 従来:                                                    │    │
│  │ ┌──────────────────────────────────────────────────┐    │    │
│  │ │ SetPipelineState(PSO_A);                         │    │    │
│  │ │ SetResources(...);                               │    │    │
│  │ │ Dispatch();                                      │    │    │
│  │ │                                                   │    │    │
│  │ │ SetPipelineState(PSO_B);                         │    │    │
│  │ │ SetResources(...);                               │    │    │
│  │ │ Dispatch();                                      │    │    │
│  │ │                                                   │    │    │
│  │ │ // ... 繰り返し                                  │    │    │
│  │ │ // 状態変更のオーバーヘッド大                    │    │    │
│  │ └──────────────────────────────────────────────────┘    │    │
│  │                                                          │    │
│  │ Shader Bundles:                                          │    │
│  │ ┌──────────────────────────────────────────────────┐    │    │
│  │ │ // バンドル作成 (事前)                           │    │    │
│  │ │ FRHIShaderBundle* Bundle = CreateBundle({        │    │    │
│  │ │     PSO_A, PSO_B, PSO_C, ...                     │    │    │
│  │ │ });                                              │    │    │
│  │ │                                                   │    │    │
│  │ │ // バンドルディスパッチ                          │    │    │
│  │ │ DispatchShaderBundle(Bundle, PerDispatchParams); │    │    │
│  │ │                                                   │    │    │
│  │ │ // 状態変更オーバーヘッド削減                    │    │    │
│  │ └──────────────────────────────────────────────────┘    │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 5.2 API

```
┌─────────────────────────────────────────────────────────────────┐
│              Shader Bundles API                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ケイパビリティフラグ:                                           │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ GRHISupportsShaderBundleDispatch                        │    │
│  │   └── シェーダーバンドルディスパッチのサポート          │    │
│  │                                                          │    │
│  │ GRHISupportsShaderBundleWorkGraphDispatch               │    │
│  │   └── ワークグラフとの組み合わせサポート                │    │
│  │                                                          │    │
│  │ GRHISupportsShaderBundleParallel                        │    │
│  │   └── 並列バンドルディスパッチのサポート                │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  コマンドコンテキストメソッド:                                   │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ // コンピュートシェーダーバンドルのディスパッチ         │    │
│  │ void RHIDispatchComputeShaderBundle(                    │    │
│  │     FRHIShaderBundle* ShaderBundle,                     │    │
│  │     FRHIShaderBundleDispatch* Dispatch);                │    │
│  │                                                          │    │
│  │ // グラフィックスシェーダーバンドルのディスパッチ       │    │
│  │ void RHIDispatchGraphicsShaderBundle(                   │    │
│  │     FRHIShaderBundle* ShaderBundle,                     │    │
│  │     FRHIShaderBundleDispatch* Dispatch);                │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  並列ディスパッチ:                                               │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ // 並列コマンドリストでのバンドル使用制限               │    │
│  │ // RHICommandList.h:496                                 │    │
│  │ if (bUsesShaderBundles && !GRHISupportsShaderBundleParallel)│  │
│  │ {                                                        │    │
│  │     // 並列実行不可 → シリアル実行にフォールバック      │    │
│  │ }                                                        │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 6. Residency Management

### 6.1 概要

```
┌─────────────────────────────────────────────────────────────────┐
│              Residency Management                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  レジデンシー管理とは:                                           │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ GPUメモリの常駐/非常駐状態を管理する機能                │    │
│  │                                                          │    │
│  │ VRAM                                                     │    │
│  │ ┌──────────────────────────────────────────────────┐    │    │
│  │ │ ┌─────────┐ ┌─────────┐ ┌─────────┐            │    │    │
│  │ │ │Resident │ │Resident │ │ Evicted │            │    │    │
│  │ │ │TexA     │ │TexB     │ │TexC     │            │    │    │
│  │ │ └─────────┘ └─────────┘ └─────────┘            │    │    │
│  │ │      ↑           ↑           │                  │    │    │
│  │ │      │           │           ▼                  │    │    │
│  │ │  ┌───────────────────────────────────────┐     │    │    │
│  │ │  │ Residency Manager                      │     │    │    │
│  │ │  │ ├── MakeResident() / Evict()          │     │    │    │
│  │ │  │ ├── LRU トラッキング                  │     │    │    │
│  │ │  │ └── メモリ予算管理                    │     │    │    │
│  │ │  └───────────────────────────────────────┘     │    │    │
│  │ └──────────────────────────────────────────────────┘    │    │
│  │                                                          │    │
│  │ D3D12RHI での実装:                                       │    │
│  │ ├── FD3D12Residency                                      │    │
│  │ └── 自動的なリソースページイン/アウト                   │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  用途:                                                           │
│  ├── メモリ制限のある環境 (統合GPU等)                           │
│  ├── 大規模シーンのストリーミング                                │
│  └── メモリ使用量の最適化                                        │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 7. GPU Defragmentation

```
┌─────────────────────────────────────────────────────────────────┐
│              GPU Memory Defragmentation                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  FGPUDefragAllocator:                                            │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ // Best-fit メモリアロケーター                          │    │
│  │                                                          │    │
│  │ 機能:                                                    │    │
│  │ ├── メモリブロックのコアレッシング (統合)               │    │
│  │ ├── フラグメンテーションの削減                          │    │
│  │ ├── 非同期再配置リクエスト                              │    │
│  │ └── 帯域幅管理                                          │    │
│  │                                                          │    │
│  │ 断片化状態:                                              │    │
│  │ ┌──────────────────────────────────────────────────┐    │    │
│  │ │ Before:                                          │    │    │
│  │ │ [Used][Free][Used][Free][Used][Free][Free][Used]│    │    │
│  │ │                                                   │    │    │
│  │ │ After Defrag:                                    │    │    │
│  │ │ [Used][Used][Used][Used][    Free Space    ]    │    │    │
│  │ └──────────────────────────────────────────────────┘    │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## まとめ: ベンダー固有機能の使用判断

```
┌─────────────────────────────────────────────────────────────────┐
│              使用判断マトリクス                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌──────────────────┬───────┬────────┬───────┬──────────────┐  │
│  │ 機能              │ AMD   │ NVIDIA │ Intel │ 使用ケース   │  │
│  ├──────────────────┼───────┼────────┼───────┼──────────────┤  │
│  │ HTile             │ ✓     │ ×      │ ×     │ 深度最適化   │  │
│  │ FMask             │ ✓     │ ×      │ ×     │ MSAA 最適化  │  │
│  │ Aftermath         │ ×     │ ✓      │ ×     │ クラッシュ診断│  │
│  │ Intel Crash Dumps │ ×     │ ×      │ ✓     │ クラッシュ診断│  │
│  │ Enhanced Barriers │ ✓     │ ✓      │ ✓     │ 同期最適化   │  │
│  │ Shader Bundles    │ ✓     │ ✓      │ ✓     │ 大量描画     │  │
│  └──────────────────┴───────┴────────┴───────┴──────────────┘  │
│                                                                  │
│  使用前のチェックパターン:                                       │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ // 常にケイパビリティフラグをチェック                   │    │
│  │ if (GRHISupportsExplicitHTile)                          │    │
│  │ {                                                        │    │
│  │     // AMD HTile 使用                                   │    │
│  │ }                                                        │    │
│  │ else                                                     │    │
│  │ {                                                        │    │
│  │     // フォールバックパス                               │    │
│  │ }                                                        │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

これらのベンダー固有機能を適切に活用することで、各GPUプラットフォームで最適なパフォーマンスを実現できます。
