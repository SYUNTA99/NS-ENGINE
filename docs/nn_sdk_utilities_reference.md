# NS SDK ユーティリティリファレンス

NS SDK の基盤となるユーティリティ型群の設計思想と使用方法をまとめたドキュメント。

---

## 目次

1. [Result型 - 例外なしの統一エラーハンドリング](#1-result型---例外なしの統一エラーハンドリング)
2. [TimeSpan - フレーム時間の単位ミス防止](#2-timespan---フレーム時間の単位ミス防止)
3. [Span - バッファ渡しの安全化](#3-span---バッファ渡しの安全化)
4. [Assert群 - デバッグ効率向上](#4-assert群---デバッグ効率向上)
5. [マクロ群 - コード品質統一](#5-マクロ群---コード品質統一)

---

## 1. Result型 - 例外なしの統一エラーハンドリング

### 設計思想

ゲーム開発では例外処理のコストが許容できない場面が多い。Result型は**例外を使わずに関数の成功/失敗を型安全に表現**するための仕組み。

```
┌─────────────────────────────────────────────────────────────┐
│                    NS::Result 内部構造                       │
├─────────────────────────────────────────────────────────────┤
│  32bit 整数値                                                │
│  ┌─────────┬───────────────┬──────────────┐                │
│  │ Reserved │  Description  │    Module    │                │
│  │  10bit   │    13bit      │     9bit     │                │
│  └─────────┴───────────────┴──────────────┘                │
│      ↑            ↑               ↑                         │
│   将来拡張用    詳細エラー    モジュールID                    │
│                 (8192種)      (512種)                        │
└─────────────────────────────────────────────────────────────┘
```

### エラー階層構造

```
成功（値 = 0）
    └── すべてのビットが 0

失敗（値 ≠ 0）
    ├── Module: どのモジュールでエラーが発生したか
    │   ├── fs (ファイルシステム)
    │   ├── audio (オーディオ)
    │   ├── account (アカウント)
    │   └── ... 他多数
    │
    └── Description: 具体的なエラー内容
        ├── NotFound
        ├── InvalidArgument
        ├── Timeout
        └── ... モジュール固有のエラー
```

### 使用パターン

```
┌─────────────────────────────────────────────────────────────┐
│              Result を返す関数の典型的なフロー                │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  NS::Result LoadFile(const char* path, Buffer* outBuffer)   │
│  {                                                          │
│      ┌──────────────┐                                       │
│      │ ファイルを開く │                                       │
│      └──────┬───────┘                                       │
│             │                                               │
│             ▼                                               │
│      ┌──────────────┐  失敗                                 │
│      │ 成功した？    ├────────────► return エラーResult      │
│      └──────┬───────┘                                       │
│             │ 成功                                           │
│             ▼                                               │
│      ┌──────────────┐                                       │
│      │ データを読む  │                                       │
│      └──────┬───────┘                                       │
│             │                                               │
│             ▼                                               │
│      ┌──────────────┐  失敗                                 │
│      │ 成功した？    ├────────────► return エラーResult      │
│      └──────┬───────┘                                       │
│             │ 成功                                           │
│             ▼                                               │
│      return ResultSuccess();                                │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 呼び出し側のチェック

```
┌─────────────────────────────────────────────────────────────┐
│                   Result チェックの方法                       │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  NS::Result result = LoadFile("data.bin", &buffer);         │
│                                                             │
│  方法1: IsSuccess() で明示的にチェック                        │
│  ─────────────────────────────────────                      │
│  if (result.IsSuccess()) {                                  │
│      // 成功時の処理                                         │
│  } else {                                                   │
│      // 失敗時の処理                                         │
│      int module = result.GetModule();      // デバッグ用    │
│      int desc   = result.GetDescription(); // デバッグ用    │
│  }                                                          │
│                                                             │
│  方法2: IsFailure() で失敗をチェック                          │
│  ─────────────────────────────────────                      │
│  if (result.IsFailure()) {                                  │
│      return result;  // エラー伝播                           │
│  }                                                          │
│                                                             │
│  方法3: ResultSuccess への変換（失敗時は停止）                │
│  ─────────────────────────────────────                      │
│  NS::ResultSuccess success = result;                        │
│  // ← 失敗していた場合、ここでプログラム停止                   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### Result型の利点

| 観点 | 例外処理 | Result型 |
|------|---------|----------|
| パフォーマンス | スタック巻き戻しコスト | ゼロコスト |
| 制御フロー | 見えない脱出経路 | 明示的な分岐 |
| エラー無視 | 暗黙に握りつぶされる可能性 | 警告が出る |
| バイナリサイズ | 例外テーブルが必要 | 最小限 |

---

## 2. TimeSpan - フレーム時間の単位ミス防止

### 設計思想

ゲームプログラミングにおける**時間単位の混乱を型システムで防止**する。

```
┌─────────────────────────────────────────────────────────────┐
│               なぜ TimeSpan が必要か？                        │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  危険なコード（単位が不明瞭）:                                 │
│  ─────────────────────────────                              │
│  void Wait(int time);           // ミリ秒？秒？フレーム？     │
│  Wait(60);                      // 60秒？60ms？60フレーム？   │
│                                                             │
│  安全なコード（型で単位を強制）:                               │
│  ─────────────────────────────                              │
│  void Wait(NS::TimeSpan time);                              │
│  Wait(NS::TimeSpan::FromMilliSeconds(60));  // 明確に60ms   │
│  Wait(NS::TimeSpan::FromSeconds(1));        // 明確に1秒    │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 内部構造

```
┌─────────────────────────────────────────────────────────────┐
│                    TimeSpan 内部表現                         │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  int64_t _nanoSeconds;   // 64bit ナノ秒で統一管理           │
│                                                             │
│  ┌────────────────────────────────────────┐                 │
│  │         表現可能な範囲                  │                 │
│  │  約 ±292年 をナノ秒精度で表現可能       │                 │
│  │  INT64_MIN ～ INT64_MAX ナノ秒          │                 │
│  └────────────────────────────────────────┘                 │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 時間単位の変換フロー

```
┌─────────────────────────────────────────────────────────────┐
│               TimeSpan 変換の流れ                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│     入力（各単位）           内部表現          出力（各単位）  │
│     ──────────────          ─────────         ──────────── │
│                                                             │
│     FromDays(1)      ──┐                                    │
│     FromHours(24)    ──┤                                    │
│     FromMinutes(60)  ──┤   ┌─────────────┐   ┌──► GetDays() │
│     FromSeconds(60)  ──┼──►│  ナノ秒値   │──┼──► GetHours()│
│     FromMilliSeconds ──┤   │  (int64_t)  │   ├──► GetMinutes│
│     FromMicroSeconds ──┤   └─────────────┘   ├──► GetSeconds│
│     FromNanoSeconds  ──┘                     └──► Get...()  │
│                                                             │
│  ※ 全ての単位で constexpr 対応（コンパイル時計算）            │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 演算サポート

```
┌─────────────────────────────────────────────────────────────┐
│                 TimeSpan の演算                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  加算・減算:                                                 │
│  ──────────                                                 │
│  TimeSpan a = TimeSpan::FromSeconds(10);                    │
│  TimeSpan b = TimeSpan::FromMilliSeconds(500);              │
│  TimeSpan c = a + b;  // 10.5秒                             │
│  TimeSpan d = a - b;  // 9.5秒                              │
│                                                             │
│  比較:                                                       │
│  ────                                                       │
│  if (elapsed > TimeSpan::FromSeconds(5)) { ... }            │
│  if (timeout <= 0) { ... }  // 0は暗黙変換される             │
│                                                             │
│  std::chrono との相互運用:                                   │
│  ──────────────────────                                     │
│  using namespace std::chrono;                               │
│  TimeSpan ts = 100ms;           // C++14 リテラルから変換    │
│  TimeSpan ts2 = seconds(5);     // std::chrono から変換     │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### フレームレート計算での活用例

```
┌─────────────────────────────────────────────────────────────┐
│            フレーム時間管理の実践例                           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  constexpr TimeSpan kTargetFrameTime =                      │
│      TimeSpan::FromMicroSeconds(16667);  // 約60fps         │
│                                                             │
│  constexpr TimeSpan kMaxDeltaTime =                         │
│      TimeSpan::FromMilliSeconds(100);    // スパイク対策     │
│                                                             │
│  void GameLoop()                                            │
│  {                                                          │
│      TimeSpan deltaTime = GetDeltaTime();                   │
│                                                             │
│      // スパイク時のデルタ時間制限                            │
│      if (deltaTime > kMaxDeltaTime)                         │
│          deltaTime = kMaxDeltaTime;                         │
│                                                             │
│      // 物理更新（秒単位で計算したい場合）                    │
│      float dtSeconds = deltaTime.GetNanoSeconds() / 1e9f;   │
│      UpdatePhysics(dtSeconds);                              │
│  }                                                          │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 3. Span - バッファ渡しの安全化

### 設計思想

**C++20 std::span のサブセット**として、連続メモリ領域への安全なビューを提供。
ポインタ＋サイズのペアを型安全にまとめ、境界チェックを可能にする。

```
┌─────────────────────────────────────────────────────────────┐
│                   Span vs 生ポインタ                         │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  危険なコード:                                               │
│  ───────────                                                │
│  void Process(int* data, size_t size);                      │
│  // サイズと配列の不一致リスク                                │
│  // NULLチェック漏れリスク                                    │
│                                                             │
│  安全なコード:                                               │
│  ───────────                                                │
│  void Process(NS::Span<int> data);                          │
│  // サイズ情報が型に含まれる                                  │
│  // 範囲外アクセスを検出可能                                  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 内部構造

```
┌─────────────────────────────────────────────────────────────┐
│                    Span<T> 内部構造                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  template<typename T>                                       │
│  class Span {                                               │
│      T*         m_Data;   // 先頭ポインタ                    │
│      size_t     m_Size;   // 要素数                         │
│  };                                                         │
│                                                             │
│  メモリレイアウト:                                           │
│  ────────────────                                           │
│  Span<int> ─────► [ ptr ][ size ]                          │
│                      │                                      │
│                      ▼                                      │
│              ┌───┬───┬───┬───┬───┐                         │
│  元の配列:   │ 0 │ 1 │ 2 │ 3 │ 4 │                         │
│              └───┴───┴───┴───┴───┘                         │
│                                                             │
│  ※ Span は所有しない（参照のみ）                             │
│  ※ 元データの寿命管理は呼び出し側の責任                       │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 生成パターン

```
┌─────────────────────────────────────────────────────────────┐
│              Span の生成方法                                 │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. 配列から自動生成:                                        │
│  ─────────────────                                          │
│  int arr[5] = {1, 2, 3, 4, 5};                              │
│  Span<int> span1 = arr;              // 暗黙変換            │
│  Span<int> span2 = MakeSpan(arr);    // 明示的              │
│                                                             │
│  2. ポインタ + サイズ:                                       │
│  ─────────────────                                          │
│  int* ptr = allocate(100);                                  │
│  Span<int> span3(ptr, 100);                                 │
│  Span<int> span4 = MakeSpan(ptr, 100);                      │
│                                                             │
│  3. 開始 + 終了ポインタ:                                     │
│  ─────────────────                                          │
│  Span<int> span5(begin, end);  // end - begin 個の要素      │
│                                                             │
│  4. std::array から:                                        │
│  ─────────────────                                          │
│  std::array<int, 5> arr;                                    │
│  Span<int> span6 = arr;              // 暗黙変換            │
│                                                             │
│  5. const への変換:                                          │
│  ─────────────────                                          │
│  Span<int> mutable_span = arr;                              │
│  Span<const int> const_span = mutable_span;  // OK          │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### サブスパン操作

```
┌─────────────────────────────────────────────────────────────┐
│             Span のスライシング操作                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  元の Span:                                                  │
│  ┌───┬───┬───┬───┬───┬───┬───┬───┬───┬───┐                │
│  │ 0 │ 1 │ 2 │ 3 │ 4 │ 5 │ 6 │ 7 │ 8 │ 9 │                │
│  └───┴───┴───┴───┴───┴───┴───┴───┴───┴───┘                │
│    0   1   2   3   4   5   6   7   8   9                    │
│                                                             │
│  first(3): 先頭から3要素                                     │
│  ┌───┬───┬───┐                                              │
│  │ 0 │ 1 │ 2 │                                              │
│  └───┴───┴───┘                                              │
│                                                             │
│  last(3): 末尾から3要素                                      │
│                          ┌───┬───┬───┐                      │
│                          │ 7 │ 8 │ 9 │                      │
│                          └───┴───┴───┘                      │
│                                                             │
│  subspan(2, 4): オフセット2から4要素                         │
│          ┌───┬───┬───┬───┐                                  │
│          │ 2 │ 3 │ 4 │ 5 │                                  │
│          └───┴───┴───┴───┘                                  │
│                                                             │
│  subspan(5): オフセット5から末尾まで                         │
│                      ┌───┬───┬───┬───┬───┐                  │
│                      │ 5 │ 6 │ 7 │ 8 │ 9 │                  │
│                      └───┴───┴───┴───┴───┘                  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### イテレータサポート

```
┌─────────────────────────────────────────────────────────────┐
│               Span のイテレータ対応                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  範囲for文:                                                  │
│  ─────────                                                  │
│  for (int& value : span) {                                  │
│      value *= 2;  // 要素を直接変更可能                      │
│  }                                                          │
│                                                             │
│  STLアルゴリズム:                                            │
│  ───────────────                                            │
│  std::sort(span.begin(), span.end());                       │
│  std::find(span.begin(), span.end(), target);               │
│  std::copy(src.begin(), src.end(), dst.begin());            │
│                                                             │
│  逆順イテレーション:                                         │
│  ─────────────────                                          │
│  for (auto it = span.rbegin(); it != span.rend(); ++it) {   │
│      process(*it);                                          │
│  }                                                          │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 4. Assert群 - デバッグ効率向上

### 設計思想

**2層構造のアサーション**で、ユーザーコードとSDK内部で異なる動作制御を可能にする。

```
┌─────────────────────────────────────────────────────────────┐
│               アサーション階層構造                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              ユーザーアサート (NS_ASSERT)             │   │
│  │  ─────────────────────────────────────────────────   │   │
│  │  • アプリケーションコードのバグ検出用                 │   │
│  │  • NS_DETAIL_ENABLE_ASSERT で有効化                   │   │
│  │  • Debug/Develop ビルドで有効                         │   │
│  └─────────────────────────────────────────────────────┘   │
│                          │                                  │
│                          ▼                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │            SDKアサート (NS_SDK_ASSERT)               │   │
│  │  ─────────────────────────────────────────────────   │   │
│  │  • SDK内部の前提条件検証用                            │   │
│  │  • NS_DETAIL_ENABLE_SDK_ASSERT で有効化               │   │
│  │  • Releaseでも有効にできる（API誤用検出）             │   │
│  └─────────────────────────────────────────────────────┘   │
│                          │                                  │
│                          ▼                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │           事前条件チェック (NS_SDK_REQUIRES)          │   │
│  │  ─────────────────────────────────────────────────   │   │
│  │  • 関数の事前条件（引数の妥当性など）                 │   │
│  │  • SDK_ASSERT と同じ制御だが意味が明確               │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 特殊アサートマクロ

```
┌─────────────────────────────────────────────────────────────┐
│             名前付きアサートマクロ一覧                        │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────┬─────────────────────────────┐ │
│  │ マクロ名                │ 検証内容                     │ │
│  ├─────────────────────────┼─────────────────────────────┤ │
│  │ NS_ASSERT(cond)         │ cond が true               │ │
│  │ NS_ASSERT_NULL(ptr)     │ ptr == nullptr             │ │
│  │ NS_ASSERT_NOT_NULL(ptr) │ ptr != nullptr             │ │
│  │ NS_ASSERT_POINTER(ptr)  │ 有効なアドレス             │ │
│  │ NS_ASSERT_EQUAL(a, b)   │ a == b                     │ │
│  │ NS_ASSERT_NOT_EQUAL     │ a != b                     │ │
│  │ NS_ASSERT_LESS(a, b)    │ a < b                      │ │
│  │ NS_ASSERT_LESS_EQUAL    │ a <= b                     │ │
│  │ NS_ASSERT_GREATER(a, b) │ a > b                      │ │
│  │ NS_ASSERT_GREATER_EQUAL │ a >= b                     │ │
│  │ NS_ASSERT_ALIGNED(p, a) │ p が a にアライン          │ │
│  │ NS_ASSERT_STRING_EQUAL  │ strcmp(a,b) == 0           │ │
│  │ NS_ASSERT_RANGE(v,b,e)  │ b <= v < e                 │ │
│  │ NS_ASSERT_MINMAX(v,m,M) │ m <= v <= M                │ │
│  └─────────────────────────┴─────────────────────────────┘ │
│                                                             │
│  ※ 全てに NS_SDK_ プレフィックス版も存在                     │
│  ※ NS_SDK_REQUIRES_* も同様のバリエーションあり              │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### アサーション失敗時のフロー

```
┌─────────────────────────────────────────────────────────────┐
│              アサーション失敗時の動作                         │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  NS_ASSERT(condition, "message", args...)                   │
│              │                                              │
│              ▼                                              │
│  ┌─────────────────┐                                        │
│  │ condition 評価  │                                        │
│  └────────┬────────┘                                        │
│           │                                                 │
│     true  │  false                                          │
│     ──────┼───────                                          │
│           │                                                 │
│   何もせず │     ▼                                          │
│   続行    │  ┌─────────────────────────┐                   │
│           │  │ OnAssertionFailure()    │                   │
│           │  │                         │                   │
│           │  │ • 条件式の文字列化      │                   │
│           │  │ • 関数名                │                   │
│           │  │ • ファイル名            │                   │
│           │  │ • 行番号                │                   │
│           │  │ • フォーマットメッセージ │                   │
│           │  └───────────┬─────────────┘                   │
│           │              │                                  │
│           │              ▼                                  │
│           │  ┌─────────────────────────┐                   │
│           │  │ AbortHandler 呼び出し    │                   │
│           │  │ (ログ出力/デバッガ停止)  │                   │
│           │  └─────────────────────────┘                   │
│           │                                                 │
└───────────┴─────────────────────────────────────────────────┘
```

### ビルド設定による切り替え

```
┌─────────────────────────────────────────────────────────────┐
│          ビルドタイプ別アサート有効/無効                      │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┬─────────────┬─────────────┬────────────┐  │
│  │  ビルド     │ NS_ASSERT   │ NS_SDK_     │ NS_SDK_    │  │
│  │  タイプ     │             │ ASSERT      │ REQUIRES   │  │
│  ├─────────────┼─────────────┼─────────────┼────────────┤  │
│  │  Debug      │     ✓       │     ✓       │     ✓      │  │
│  │  Develop    │     ✓       │     ✓       │     ✓      │  │
│  │  Release    │     ✗       │   設定次第   │   設定次第  │  │
│  │  Master     │     ✗       │     ✗       │     ✗      │  │
│  └─────────────┴─────────────┴─────────────┴────────────┘  │
│                                                             │
│  Release でも SDK_ASSERT を有効にすると:                     │
│  • API の誤用を早期発見                                      │
│  • パフォーマンスコストは発生                                │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 5. マクロ群 - コード品質統一

### カテゴリ分類

```
┌─────────────────────────────────────────────────────────────┐
│                 マクロのカテゴリ                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │           1. 言語サポートマクロ                       │   │
│  │  ─────────────────────────────────────────────────   │   │
│  │  NS_ALIGNAS(n)      // アライメント指定               │   │
│  │  NS_ALIGNOF(type)   // アライメント取得               │   │
│  │  NS_NORETURN        // 戻らない関数                   │   │
│  │  NS_NOEXCEPT        // 例外を投げない                 │   │
│  │  NS_OVERRIDE        // 仮想関数オーバーライド         │   │
│  │  NS_NODISCARD       // 戻り値無視警告                 │   │
│  │  NS_CONSTINIT       // 定数初期化                     │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │           2. インライン制御マクロ                     │   │
│  │  ─────────────────────────────────────────────────   │   │
│  │  NS_NOINLINE        // インライン化禁止               │   │
│  │  NS_FORCEINLINE     // インライン化強制               │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │           3. 警告抑制マクロ                           │   │
│  │  ─────────────────────────────────────────────────   │   │
│  │  NS_UNUSED(var)     // 未使用変数警告抑制             │   │
│  │  NS_IMPLICIT        // 暗黙変換の意図明示             │   │
│  │  NS_STATIC_CONDITION// 定数条件分岐の意図明示         │   │
│  │  NS_DEPRECATED      // 非推奨マーク                   │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │           4. メモリレイアウト制御                     │   │
│  │  ─────────────────────────────────────────────────   │   │
│  │  NS_PACK            // パディング抑止（非MSVC）       │   │
│  │  NS_PACK_BEGIN/END  // パディング抑止（MSVC）         │   │
│  │  NS_PADDING1～8     // 明示的パディング挿入           │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │           5. ユーティリティマクロ                     │   │
│  │  ─────────────────────────────────────────────────   │   │
│  │  NS_DISALLOW_COPY(T)    // コピー禁止                 │   │
│  │  NS_DISALLOW_MOVE(T)    // ムーブ禁止                 │   │
│  │  NS_BITSIZEOF(T)        // ビットサイズ取得           │   │
│  │  NS_ARRAY_SIZE(arr)     // 配列要素数取得             │   │
│  │  NS_MACRO_STRINGIZE(x)  // 文字列化                   │   │
│  │  NS_MACRO_CONCATENATE   // トークン連結               │   │
│  │  NS_FALL_THROUGH        // switch フォールスルー      │   │
│  │  NS_UNEXPECTED_DEFAULT  // 到達不能 default           │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### コピー/ムーブ禁止パターン

```
┌─────────────────────────────────────────────────────────────┐
│            NS_DISALLOW_COPY / MOVE の使用                    │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  class ResourceHandle                                       │
│  {                                                          │
│      NS_DISALLOW_COPY(ResourceHandle);  // コピー禁止       │
│      NS_DISALLOW_MOVE(ResourceHandle);  // ムーブ禁止       │
│                                                             │
│  public:                                                    │
│      ResourceHandle() = default;                            │
│      // ...                                                 │
│  };                                                         │
│                                                             │
│  展開後:                                                     │
│  ─────                                                      │
│  private:                                                   │
│      ResourceHandle(const ResourceHandle&) = delete;        │
│      ResourceHandle& operator=(const ResourceHandle&)       │
│          = delete;                                          │
│      ResourceHandle(ResourceHandle&&) = delete;             │
│      ResourceHandle& operator=(ResourceHandle&&) = delete;  │
│                                                             │
│  ※ 使用後は private スコープになることに注意                 │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### パディング制御

```
┌─────────────────────────────────────────────────────────────┐
│              パッキングマクロの使用                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  バイナリフォーマット定義の例:                               │
│  ─────────────────────────                                  │
│  NS_PACK_BEGIN                                              │
│  struct FileHeader                                          │
│  {                                                          │
│      uint8_t   magic[4];    // "DATA"                       │
│      uint8_t   version;     // 1                            │
│      uint8_t   flags;       // ビットフラグ                 │
│      uint16_t  entryCount;  // エントリ数                   │
│      uint32_t  dataOffset;  // データ開始位置               │
│  } NS_PACK;                                                 │
│  NS_PACK_END                                                │
│                                                             │
│  メモリレイアウト:                                           │
│  ─────────────                                              │
│  パック前（通常）:           パック後:                       │
│  ┌────┬────┬────┬────┐     ┌────┬────┬────┬────┐          │
│  │mag │ver │flag│pad │     │mag │ver │flag│cnt │          │
│  │4B  │1B  │1B  │2B  │     │4B  │1B  │1B  │2B  │          │
│  ├────┴────┴────┴────┤     ├────┴────┴────┴────┤          │
│  │  count   │  pad   │     │      offset       │          │
│  │    2B    │   2B   │     │        4B         │          │
│  ├──────────┴────────┤     └───────────────────┘          │
│  │      offset       │     合計: 12バイト                  │
│  │        4B         │                                     │
│  └───────────────────┘                                     │
│  合計: 16バイト                                             │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 警告プラグマ制御

```
┌─────────────────────────────────────────────────────────────┐
│              警告の一時的な無効化                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  NS_PRAGMA_PUSH_WARNINGS                                    │
│  NS_DISABLE_WARNING_UNUSED_PARAMETER                        │
│  NS_DISABLE_WARNING_DEPRECATED_DECLARATIONS                 │
│                                                             │
│  void LegacyCallback(int oldParam, void* userData)          │
│  {                                                          │
│      // oldParam は後方互換性のために残されているが未使用    │
│      CallNewAPI(userData);                                  │
│  }                                                          │
│                                                             │
│  NS_PRAGMA_POP_WARNINGS                                     │
│                                                             │
│  利用可能な警告抑制マクロ:                                   │
│  ────────────────────────                                   │
│  • NS_DISABLE_WARNING_OVERFLOW           // 定数オーバーフロー
│  • NS_DISABLE_WARNING_LOCAL_STATIC       // ローカル静的変数 │
│  • NS_DISABLE_WARNING_UNUSED_PARAMETER   // 未使用引数      │
│  • NS_DISABLE_WARNING_UNUSED_VAR         // 未使用変数      │
│  • NS_DISABLE_WARNING_UNUSED_FUNCTION    // 未使用関数      │
│  • NS_DISABLE_WARNING_SHADOW             // シンボル隠蔽    │
│  • NS_DISABLE_WARNING_DEPRECATED_DECLARATIONS               │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## まとめ: 設計原則

| ユーティリティ | 解決する問題 | 核心的なアイデア |
|---------------|-------------|-----------------|
| **Result** | 例外のコスト | 戻り値でエラーを型安全に表現 |
| **TimeSpan** | 単位の混乱 | 型で単位を強制、内部はナノ秒統一 |
| **Span** | バッファ渡しの危険性 | ポインタ＋サイズを型でまとめる |
| **Assert群** | デバッグ困難 | 2層構造＋豊富な検証マクロ |
| **マクロ群** | コンパイラ差異 | 統一インターフェースで吸収 |

これらのユーティリティは**ゲーム開発特有の制約**（パフォーマンス、確定的動作、クロスプラットフォーム）を考慮して設計されており、C++標準ライブラリを補完・代替する形で提供されている。
