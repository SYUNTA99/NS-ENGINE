//----------------------------------------------------------------------------
//! @file   memory_system.h
//! @brief  メモリシステム - アロケータの中央管理
//----------------------------------------------------------------------------
#pragma once

#include "common/stl/stl_common.h"
#include "common/utility/non_copyable.h"
#include "allocator.h"
#include "heap_allocator.h"
#include "linear_allocator.h"
#include "pool_allocator.h"

namespace Memory {

//============================================================================
//! @brief メモリシステム
//!
//! エンジン全体のメモリアロケータを一元管理するシングルトン。
//! 用途別のアロケータを提供し、統計情報の収集と出力を行う。
//!
//! @note シングルトンパターン
//! @note Engine::Initialize()で初期化、Engine::Shutdown()で終了
//============================================================================
class MemorySystem final : private NonCopyableNonMovable {
public:
    //! フレームアロケータのデフォルト容量（1MB）
    static constexpr size_t kFrameAllocatorCapacity = 1 * 1024 * 1024;

    //! ECS Chunkプール用ブロックサイズ（16KB）
    //! @note ECS::Chunkは純粋な16KBバッファ（sizeof(Chunk) == 16KB保証）
    static constexpr size_t kChunkBlockSize = 16 * 1024;

    //------------------------------------------------------------------------
    //! @brief シングルトンインスタンス取得
    //! @return MemorySystemのインスタンス
    //------------------------------------------------------------------------
    [[nodiscard]] static MemorySystem& Get() {
        static MemorySystem instance;
        return instance;
    }

    //------------------------------------------------------------------------
    // ライフサイクル
    //------------------------------------------------------------------------

    //------------------------------------------------------------------------
    //! @brief 初期化
    //!
    //! Engine::Initialize()から呼び出される。
    //! 各種アロケータを初期化し、使用可能な状態にする。
    //------------------------------------------------------------------------
    void Initialize();

    //------------------------------------------------------------------------
    //! @brief 終了処理
    //!
    //! Engine::Shutdown()から呼び出される。
    //! 統計情報を出力し、リソースを解放する。
    //------------------------------------------------------------------------
    void Shutdown();

    //------------------------------------------------------------------------
    //! @brief 初期化済みか確認
    //! @return 初期化済みの場合はtrue
    //------------------------------------------------------------------------
    [[nodiscard]] bool IsInitialized() const noexcept {
        return initialized_;
    }

    //------------------------------------------------------------------------
    // アロケータ取得
    //------------------------------------------------------------------------

    //------------------------------------------------------------------------
    //! @brief デフォルトアロケータ取得（HeapAllocator）
    //! @return デフォルトアロケータへの参照
    //------------------------------------------------------------------------
    [[nodiscard]] IAllocator& GetDefault() noexcept {
        return defaultAllocator_;
    }

    //------------------------------------------------------------------------
    //! @brief デフォルトアロケータ取得（const版）
    //------------------------------------------------------------------------
    [[nodiscard]] const IAllocator& GetDefault() const noexcept {
        return defaultAllocator_;
    }

    //------------------------------------------------------------------------
    //! @brief フレームアロケータ取得（LinearAllocator）
    //!
    //! フレーム内でのみ有効な一時データ用。
    //! BeginFrame()でリセットされる。
    //!
    //! @return フレームアロケータへの参照
    //------------------------------------------------------------------------
    [[nodiscard]] LinearAllocator& GetFrame() noexcept {
        return *frameAllocator_;
    }

    //------------------------------------------------------------------------
    //! @brief フレームアロケータ取得（const版）
    //------------------------------------------------------------------------
    [[nodiscard]] const LinearAllocator& GetFrame() const noexcept {
        return *frameAllocator_;
    }

    //------------------------------------------------------------------------
    //! @brief Chunk用プールアロケータ取得
    //!
    //! ECS Chunk（16KB）専用の高速アロケータ。
    //!
    //! @return Chunkプールへの参照
    //------------------------------------------------------------------------
    [[nodiscard]] PoolAllocator<kChunkBlockSize>& GetChunkPool() noexcept {
        return *chunkPool_;
    }

    //------------------------------------------------------------------------
    //! @brief Chunk用プールアロケータ取得（const版）
    //------------------------------------------------------------------------
    [[nodiscard]] const PoolAllocator<kChunkBlockSize>& GetChunkPool() const noexcept {
        return *chunkPool_;
    }

    //------------------------------------------------------------------------
    // フレーム処理
    //------------------------------------------------------------------------

    //------------------------------------------------------------------------
    //! @brief フレーム開始処理
    //!
    //! フレームアロケータのリセットなどを行う。
    //------------------------------------------------------------------------
    void BeginFrame();

    //------------------------------------------------------------------------
    //! @brief フレーム終了処理
    //!
    //! 統計情報の更新などを行う。
    //------------------------------------------------------------------------
    void EndFrame();

    //------------------------------------------------------------------------
    // デバッグ・統計
    //------------------------------------------------------------------------

    //------------------------------------------------------------------------
    //! @brief 全アロケータの統計情報を出力
    //------------------------------------------------------------------------
    void DumpStats() const;

    //------------------------------------------------------------------------
    //! @brief 総メモリ使用量を取得
    //! @return 全アロケータの合計使用量（バイト）
    //------------------------------------------------------------------------
    [[nodiscard]] size_t GetTotalAllocated() const noexcept;

    //------------------------------------------------------------------------
    //! @brief ピークメモリ使用量を取得
    //! @return 全アロケータの合計ピーク使用量（バイト）
    //------------------------------------------------------------------------
    [[nodiscard]] size_t GetPeakAllocated() const noexcept;

private:
    MemorySystem() = default;
    ~MemorySystem() = default;

private:
    HeapAllocator defaultAllocator_;                            //!< デフォルトアロケータ
    std::unique_ptr<LinearAllocator> frameAllocator_;           //!< フレーム一時用
    std::unique_ptr<PoolAllocator<kChunkBlockSize>> chunkPool_;      //!< Chunk用プール
    bool initialized_ = false;                                  //!< 初期化フラグ
};

//============================================================================
// グローバルアクセスヘルパー
//============================================================================

//----------------------------------------------------------------------------
//! @brief デフォルトアロケータを取得（ショートカット）
//! @return デフォルトアロケータへの参照
//----------------------------------------------------------------------------
[[nodiscard]] inline IAllocator& GetDefaultAllocator() noexcept {
    return MemorySystem::Get().GetDefault();
}

//----------------------------------------------------------------------------
//! @brief フレームアロケータを取得（ショートカット）
//! @return フレームアロケータへの参照
//----------------------------------------------------------------------------
[[nodiscard]] inline LinearAllocator& GetFrameAllocator() noexcept {
    return MemorySystem::Get().GetFrame();
}

//----------------------------------------------------------------------------
//! @brief Chunkプールを取得（ショートカット）
//! @return Chunkプールへの参照
//----------------------------------------------------------------------------
[[nodiscard]] inline PoolAllocator<MemorySystem::kChunkBlockSize>& GetChunkPool() noexcept {
    return MemorySystem::Get().GetChunkPool();
}

} // namespace Memory
