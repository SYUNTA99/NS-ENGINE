//----------------------------------------------------------------------------
//! @file   system.h
//! @brief  ECS System基底クラス
//----------------------------------------------------------------------------
#pragma once

namespace ECS {

// 前方宣言
class World;

//============================================================================
//! @brief 更新システムの基底クラス
//!
//! 全てのECS更新システムはこれを継承する。
//! finalクラスとして実装し、LTOで仮想関数をインライン化可能にする。
//!
//! ライフサイクル:
//! 1. OnCreate() - 登録時に1回
//! 2. OnUpdate() - 毎フレーム
//! 3. OnDestroy() - 破棄時に1回
//!
//! @code
//! class MovementSystem final : public ISystem {
//! public:
//!     void OnCreate(World& world) override { }
//!     void OnUpdate(World& world, float dt) override {
//!         world.Actors().Query<InOut<TransformData>, In<VelocityData>>()
//!             .ForEach([dt](Actor e, TransformData& t, const VelocityData& v) {
//!                 t.position += v.velocity * dt;
//!             });
//!     }
//!     const char* Name() const override { return "MovementSystem"; }
//! };
//! @endcode
//============================================================================
class ISystem {
public:
    virtual ~ISystem() = default;

    //========================================================================
    // ライフサイクル
    //========================================================================

    //------------------------------------------------------------------------
    //! @brief システム作成時（登録時に1回呼ばれる）
    //! @param world ワールド参照
    //------------------------------------------------------------------------
    virtual void OnCreate(World& world) { (void)world; }

    //------------------------------------------------------------------------
    //! @brief システム更新（毎フレーム呼ばれる）
    //! @param world ワールド参照
    //! @param dt デルタタイム
    //------------------------------------------------------------------------
    virtual void OnUpdate(World& world, float dt) = 0;

    //------------------------------------------------------------------------
    //! @brief システム破棄時（破棄時に1回呼ばれる）
    //! @param world ワールド参照
    //------------------------------------------------------------------------
    virtual void OnDestroy(World& world) { (void)world; }

    //========================================================================
    // メタ情報
    //========================================================================

    //------------------------------------------------------------------------
    //! @brief 優先度取得（小さいほど先に実行）
    //! @return 優先度
    //------------------------------------------------------------------------
    virtual int Priority() const { return 0; }

    //------------------------------------------------------------------------
    //! @brief システム名取得（デバッグ用）
    //! @return システム名
    //------------------------------------------------------------------------
    virtual const char* Name() const { return "ISystem"; }

};

//============================================================================
//! @brief 描画システムの基底クラス
//!
//! 全てのECS描画システムはこれを継承する。
//! finalクラスとして実装し、LTOで仮想関数をインライン化可能にする。
//!
//! ライフサイクル:
//! 1. OnCreate() - 登録時に1回
//! 2. OnRender() - 毎フレーム
//! 3. OnDestroy() - 破棄時に1回
//============================================================================
class IRenderSystem {
public:
    virtual ~IRenderSystem() = default;

    //========================================================================
    // ライフサイクル
    //========================================================================

    //------------------------------------------------------------------------
    //! @brief システム作成時（登録時に1回呼ばれる）
    //! @param world ワールド参照
    //------------------------------------------------------------------------
    virtual void OnCreate(World& world) { (void)world; }

    //------------------------------------------------------------------------
    //! @brief 描画実行（毎フレーム呼ばれる）
    //! @param world ワールド参照
    //! @param alpha 補間係数（0.0〜1.0）
    //------------------------------------------------------------------------
    virtual void OnRender(World& world, float alpha) = 0;

    //------------------------------------------------------------------------
    //! @brief システム破棄時（破棄時に1回呼ばれる）
    //! @param world ワールド参照
    //------------------------------------------------------------------------
    virtual void OnDestroy(World& world) { (void)world; }

    //========================================================================
    // メタ情報
    //========================================================================

    //------------------------------------------------------------------------
    //! @brief 優先度取得（小さいほど先に実行）
    //! @return 優先度
    //------------------------------------------------------------------------
    virtual int Priority() const { return 0; }

    //------------------------------------------------------------------------
    //! @brief システム名取得（デバッグ用）
    //! @return システム名
    //------------------------------------------------------------------------
    virtual const char* Name() const { return "IRenderSystem"; }

};

} // namespace ECS
