name: Discord PR Notification

on:
  pull_request:
    types: [opened, ready_for_review]

jobs:
  notify:
    runs-on: ubuntu-latest
    # Draft PRã¯é€šçŸ¥ã—ãªã„
    if: github.event.pull_request.draft == false

    steps:
      - name: Send PR notification to Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          # æ”¹è¡Œã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
          BODY=$(cat <<'BODY_EOF'
          ${{ github.event.pull_request.body }}
          BODY_EOF
          )
          # JSONç”¨ã«ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ï¼ˆæ”¹è¡Œâ†’\nã€"â†’\"ï¼‰
          BODY_ESCAPED=$(echo "$BODY" | head -c 1800 | sed 's/\\/\\\\/g; s/"/\\"/g' | awk '{printf "%s\\n", $0}' | sed 's/\\n$//')

          # Discord Embed JSONä½œæˆ
          JSON=$(cat <<EOF
          {
            "embeds": [{
              "title": "ğŸ”€ ${{ github.event.pull_request.title }}",
              "url": "${{ github.event.pull_request.html_url }}",
              "color": 5814783,
              "author": {
                "name": "${{ github.event.pull_request.user.login }}",
                "icon_url": "${{ github.event.pull_request.user.avatar_url }}"
              },
              "description": "${BODY_ESCAPED}",
              "fields": [
                {
                  "name": "ãƒ–ãƒ©ãƒ³ãƒ",
                  "value": "\`${{ github.head_ref }}\` â†’ \`${{ github.base_ref }}\`",
                  "inline": true
                },
                {
                  "name": "å¤‰æ›´",
                  "value": "+${{ github.event.pull_request.additions }} / -${{ github.event.pull_request.deletions }}",
                  "inline": true
                }
              ],
              "footer": {
                "text": "PR #${{ github.event.pull_request.number }}"
              },
              "timestamp": "${{ github.event.pull_request.created_at }}"
            }]
          }
          EOF
          )

          # Discordã«é€ä¿¡
          curl -s -H "Content-Type: application/json" -d "$JSON" "$DISCORD_WEBHOOK"
